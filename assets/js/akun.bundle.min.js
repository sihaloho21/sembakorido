window.FrontendSanitize={escapeHtml:function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},sanitizeUrl:function(e,t=""){if(!e)return t;const n=String(e).trim();return/^(https?:\/\/|\/(?!\/)|\.\/|\.\.\/|#)/i.test(n)?n:t},ensureImageFallbackHandler:function(){window.__imageFallbackHandlerAdded||(window.__imageFallbackHandlerAdded=!0,document.addEventListener("error",e=>{const t=e.target;if(!t||t.tagName!=="IMG")return;const n=t.getAttribute("data-fallback-src"),a=t.getAttribute("data-fallback-action");n&&t.src!==n?t.src=n:a==="hide"&&(t.style.display="none")},!0))}},window.sanitizeUrl||(window.sanitizeUrl=window.FrontendSanitize.sanitizeUrl),window.ensureImageFallbackHandler||(window.ensureImageFallbackHandler=window.FrontendSanitize.ensureImageFallbackHandler),window.AdminSanitize||(window.AdminSanitize=window.FrontendSanitize);function getPaylaterConfigSafe(){return typeof CONFIG<"u"&&typeof CONFIG.getPaylaterConfig=="function"?CONFIG.getPaylaterConfig():{enabled:!1,profitToLimitPercent:10,tenorFees:{1:5,2:10,3:15,4:20},dailyPenaltyPercent:.5,penaltyCapPercent:15,maxActiveInvoices:1,maxLimit:1e6,minOrderAmount:0,freezeOverdueDays:7,lockOverdueDays:30}}function toMoneyInt(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.round(t)):0}function normalizeTenorWeeks(e){const t=parseInt(e,10);return Number.isFinite(t)?Math.min(4,Math.max(1,t)):1}function getTenorFeePercent(e,t){const n=t||getPaylaterConfigSafe(),a=normalizeTenorWeeks(e),r=n&&n.tenorFees?n.tenorFees[a]:0,o=Number(r);return Number.isFinite(o)?Math.max(0,o):0}function calculatePaylaterInvoice(e,t,n){const a=toMoneyInt(e),r=getTenorFeePercent(t,n),o=toMoneyInt(a*r/100),i=a+o;return{principal:a,tenorWeeks:normalizeTenorWeeks(t),feePercent:r,feeAmount:o,totalBeforePenalty:i}}function calculatePenaltyAmount(e,t,n){const a=n||getPaylaterConfigSafe(),r=toMoneyInt(e),o=Math.max(0,parseInt(t,10)||0),i=Number(a.dailyPenaltyPercent)||0,s=Number(a.penaltyCapPercent)||0,l=toMoneyInt(r*i*o/100),d=toMoneyInt(r*s/100);return Math.min(l,d)}function calculateTotalDueWithPenalty(e,t,n){const a=e||{},r=toMoneyInt(a.totalBeforePenalty||a.total_due||0),o=calculatePenaltyAmount(r,t,n);return{totalBeforePenalty:r,penaltyAmount:o,totalDue:r+o}}function calculateLimitIncreaseFromProfit(e,t){const n=t||getPaylaterConfigSafe(),a=toMoneyInt(e);return toMoneyInt(a*(Number(n.profitToLimitPercent)||0)/100)}function evaluatePaylaterEligibility(e,t){const n=t||getPaylaterConfigSafe(),a=e||{},r=a.account||{};if(!n.enabled)return{eligible:!1,reason:"paylater_disabled"};if(!r||!r.status)return{eligible:!1,reason:"account_not_found"};const o=String(r.status).toLowerCase();if(o==="frozen")return{eligible:!1,reason:"account_frozen"};if(o==="locked")return{eligible:!1,reason:"account_locked"};if(o!=="active")return{eligible:!1,reason:"account_inactive"};if((parseInt(a.activeInvoicesCount,10)||0)>=(parseInt(n.maxActiveInvoices,10)||1))return{eligible:!1,reason:"active_invoice_exists"};const i=toMoneyInt(a.orderTotal);if(i<toMoneyInt(n.minOrderAmount))return{eligible:!1,reason:"below_min_order"};const s=toMoneyInt(r.available_limit||r.availableLimit||0);return s<i?{eligible:!1,reason:"insufficient_limit"}:{eligible:!0,reason:"ok",availableLimit:s,orderTotal:i}}const PaylaterLogic={getPaylaterConfigSafe,toMoneyInt,normalizeTenorWeeks,getTenorFeePercent,calculatePaylaterInvoice,calculatePenaltyAmount,calculateTotalDueWithPenalty,calculateLimitIncreaseFromProfit,evaluatePaylaterEligibility};typeof window<"u"&&(window.PaylaterLogic=PaylaterLogic);var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>String(e||"")),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});function getApiUrl(){const e=CONFIG.getMainApiUrl();return console.log("Using API URL:",e),e}ensureImageFallbackHandler();let API_URL=getApiUrl();function refreshApiUrl(){const e=API_URL;API_URL=getApiUrl(),console.log("Old API URL:",e),console.log("New API URL:",API_URL),e!==API_URL&&(console.log("\u{1F504} API URL changed, clearing cache and reloading..."),typeof ApiService<"u"&&ApiService.clearCache()),fetchProducts()}let cart=JSON.parse(localStorage.getItem("sembako_cart"))||[],allProducts=[],allCategories=[],currentCategory="Semua",currentPage=1;const itemsPerPage=12;let filteredProducts=[],storeClosed=CONFIG.isStoreClosed(),selectedVariation=null,currentModalProduct=null,paylaterCheckoutState={loading:!1,eligible:!1,reason:"not_checked",message:"Belum dicek",account:null,summary:null,config:null,simulation:null},paylaterCheckoutRequestSeq=0;function normalizePhoneNumber(e){if(!e)return null;let t=String(e).replace(/[^0-9]/g,"");return t.startsWith("62")&&(t="0"+t.substring(2)),t.startsWith("8")&&!t.startsWith("08")&&(t="0"+t),!t.startsWith("08")||t.length<10||t.length>13?null:t}function createSlug(e){return e?e.toLowerCase().replace(/[^\w\s-]/g,"").trim().replace(/[-\s]+/g,"-"):""}function ensureProductId(e,t){const n=e.id||e.sku||e.slug||createSlug(e.nama)||"product";return e.id||e.sku?String(n):`${n}-${t}`}function findProductById(e){return e&&allProducts.find(t=>String(t.productId)===String(e))||null}function normalizeCategoryLabel(e){return String(e||"").trim()}function extractCategoryName(e){if(!e||typeof e!="object")return"";const t=["nama","name","kategori","category","judul","title"];for(let n=0;n<t.length;n+=1){const a=normalizeCategoryLabel(e[t[n]]);if(a)return a}return""}function extractCategorySortOrder(e,t){if(!e||typeof e!="object")return t;const n=["sort_order","urutan","order","sort","no","id"];for(let a=0;a<n.length;a+=1){const r=parseInt(e[n[a]],10);if(Number.isFinite(r))return r}return t}function deriveCategoriesFromProducts(){const e=new Set;return allProducts.forEach(t=>{const n=normalizeCategoryLabel(t.category||t.kategori||"");n&&e.add(n)}),Array.from(e).sort((t,n)=>t.localeCompare(n,"id"))}function getDisplayCategories(){const e=deriveCategoriesFromProducts();if(!Array.isArray(allCategories)||allCategories.length===0)return e;const t=[],n={},a=r=>{const o=normalizeCategoryLabel(r);if(!o)return;const i=o.toLowerCase();n[i]||(n[i]=!0,t.push(o))};return allCategories.forEach(a),e.forEach(a),t}async function fetchCategories(){try{const e=await ApiService.get("?sheet=categories",{cacheDuration:3e5});if(!Array.isArray(e)||e.length===0)return[];const t=e.map((r,o)=>({name:extractCategoryName(r),order:extractCategorySortOrder(r,o)})).filter(r=>r.name!=="").sort((r,o)=>r.order!==o.order?r.order-o.order:r.name.localeCompare(o.name,"id")).map(r=>r.name),n=[],a={};return t.forEach(r=>{const o=r.toLowerCase();a[o]||(a[o]=!0,n.push(r))}),n}catch(e){return console.warn("Categories endpoint unavailable, fallback ke kategori produk:",e),[]}}function getItemMaxStock(e){if(!e)return 0;const t=e.selectedVariation||e,n=parseInt(t.stok,10);return Number.isFinite(n)&&n>0?n:0}function getCurrentModalMaxStock(){return selectedVariation?getItemMaxStock(selectedVariation):currentModalProduct?getItemMaxStock(currentModalProduct):0}function getLatestStockForCartItem(e){if(!e)return 0;const t=String(e.productId||e.id||"").trim(),n=allProducts.find(r=>String(r.productId||r.id||"").trim()===t);if(!n)return getItemMaxStock(e);if(e.selectedVariation&&e.selectedVariation.sku&&Array.isArray(n.variations)){const r=String(e.selectedVariation.sku||"").trim(),o=n.variations.find(i=>String(i.sku||"").trim()===r);if(o){const i=parseInt(o.stok,10);return Number.isFinite(i)&&i>0?i:0}}const a=parseInt(n.stok,10);return Number.isFinite(a)&&a>0?a:0}function syncCartWithStockLimits(){if(!Array.isArray(cart)||cart.length===0)return;const e=[];let t=!1;cart.forEach(n=>{const a=getLatestStockForCartItem(n);if(a<=0)return void(t=!0);const r=Math.max(1,parseInt(n.qty,10)||1),o=Math.min(r,a),i={...n,stok:a,qty:o};i.selectedVariation&&typeof i.selectedVariation=="object"&&(i.selectedVariation={...i.selectedVariation,stok:a}),o!==r&&(t=!0),e.push(i)}),t&&(cart=e,saveCart())}async function fetchProducts(){try{const[e,t]=await Promise.all([ApiService.get("?sheet=products",{cacheDuration:3e5}),fetchCategories()]);console.log("Products received:",e),allCategories=t,allProducts=e.map((n,a)=>{const r=parseInt(n.harga)||0,o=typeof calculateGajianPrice=="function"?calculateGajianPrice(r):{price:r,daysLeft:0,markupPercent:0};let i=n.kategori||"Bahan Pokok";n.kategori||(r>=15e4?i="Paket Lengkap":r>=5e4&&(i="Paket Hemat"));let s=[];if(n.variasi)try{s=JSON.parse(n.variasi)}catch(c){console.error("Error parsing variations for product:",n.id,c)}const l=n.slug||createSlug(n.nama),d=ensureProductId({...n,slug:l},a);return{...n,slug:l,productId:d,harga:r,hargaCoret:parseInt(n.harga_coret)||0,hargaGajian:o.price,stok:parseInt(n.stok)||0,category:i,deskripsi:n.deskripsi&&n.deskripsi.trim()!==""?n.deskripsi:"Kualitas Terjamin, Stok Selalu Baru, Harga Kompetitif",variations:s}}),syncCartWithStockLimits(),renderCategoryFilters(),filterProducts(),updateCartUI(),checkStoreStatus(),startNotificationLoop()}catch(e){console.error("Error fetching products:",e);const t=document.getElementById("product-grid");t&&(t.innerHTML='<p class="text-center col-span-full text-red-500">Gagal memuat produk. Silakan coba lagi nanti.</p>')}}function renderCategoryFilters(){const e=document.getElementById("category-filters");if(!e||!allProducts||allProducts.length===0)return;console.log("Rendering category filters...");const t=getDisplayCategories();console.log("Categories found:",t),currentCategory!=="Semua"&&t.indexOf(currentCategory)===-1&&(currentCategory="Semua");let n=`<button type="button" data-action="set-category" data-category="Semua" class="${currentCategory==="Semua"?"filter-btn active snap-start flex-shrink-0 px-6 py-2 rounded-full border-2 border-green-500 bg-green-50 text-green-700 text-sm font-bold transition hover:border-green-600 hover:bg-green-100":"filter-btn snap-start flex-shrink-0 px-6 py-2 rounded-full border-2 border-gray-300 bg-white text-gray-700 text-sm font-bold transition hover:border-green-500 hover:bg-green-50"}">Semua</button>`;t.forEach(a=>{const r=escapeHtml(a);n+=`<button type="button" data-action="set-category" data-category="${r}" class="${currentCategory===a?"filter-btn active snap-start flex-shrink-0 px-6 py-2 rounded-full border-2 border-green-500 bg-green-50 text-green-700 text-sm font-bold transition hover:border-green-600 hover:bg-green-100":"filter-btn snap-start flex-shrink-0 px-6 py-2 rounded-full border-2 border-gray-300 bg-white text-gray-700 text-sm font-bold transition hover:border-green-500 hover:bg-green-50"}">${r}</button>`}),e.innerHTML=n,console.log("Category filters rendered:",t.length,"categories"),initCategoryCarouselScroll()}function initCategoryCarouselScroll(){const e=document.getElementById("category-filters");if(!e)return;e.addEventListener("wheel",r=>{r.deltaY!==0&&(r.preventDefault(),e.scrollLeft+=r.deltaY)},{passive:!1});let t,n,a=!1;e.addEventListener("mousedown",r=>{r.target.classList.contains("filter-btn")||(a=!0,e.style.cursor="grabbing",t=r.pageX-e.offsetLeft,n=e.scrollLeft)}),e.addEventListener("mouseleave",()=>{a=!1,e.style.cursor="grab"}),e.addEventListener("mouseup",()=>{a=!1,e.style.cursor="grab"}),e.addEventListener("mousemove",r=>{if(!a)return;r.preventDefault();const o=2*(r.pageX-e.offsetLeft-t);e.scrollLeft=n-o}),e.style.cursor="grab",updateCategoryArrowsVisibility(),e.addEventListener("scroll",updateCategoryArrowsVisibility)}function scrollCategoryCarousel(e){const t=document.getElementById("category-filters");t&&(e==="left"?t.scrollLeft-=300:e==="right"&&(t.scrollLeft+=300))}function updateCategoryArrowsVisibility(){const e=document.getElementById("category-filters"),t=document.getElementById("category-scroll-left"),n=document.getElementById("category-scroll-right");if(!e||!t||!n)return;const a=e.scrollLeft<=10,r=e.scrollLeft+e.clientWidth>=e.scrollWidth-10;a?t.classList.add("opacity-0","pointer-events-none"):t.classList.remove("opacity-0","pointer-events-none"),r?n.classList.add("opacity-0","pointer-events-none"):n.classList.remove("opacity-0","pointer-events-none")}function findProductBySlug(e){return e&&allProducts&&allProducts.length!==0?allProducts.find(t=>t.slug===e):null}function renderProducts(e){const t=document.getElementById("product-grid");if(!t)return;if(e.length===0)return t.innerHTML='<p class="text-center col-span-full text-gray-500 py-10">Tidak ada produk yang ditemukan.</p>',void(document.getElementById("pagination-container").innerHTML="");const n=Math.ceil(e.length/12);currentPage>n&&(currentPage=n||1);const a=12*(currentPage-1),r=a+12,o=e.slice(a,r);t.innerHTML="",o.forEach(i=>{let s="";s=i.stok>10?'<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Tersedia</span>':i.stok>5?`<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Menipis (${i.stok})</span>`:i.stok>0?`<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Hanya sisa ${i.stok}</span>`:'<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Habis</span>';const l=(i.gambar?i.gambar.split(","):[])[0]||"https://placehold.co/300x200?text=Produk",d=sanitizeUrl(l,"https://placehold.co/300x200?text=Produk"),c=calculateRewardPoints(i.harga,i.nama);let g="",h=!1;if(i.grosir)try{const y=JSON.parse(i.grosir);Array.isArray(y)&&y.length>0&&(h=!0,g=`
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            ${[...y].sort((w,x)=>w.min_qty-x.min_qty).map(w=>`
                        <div class="bg-green-50 border border-green-100 rounded-lg p-1.5 text-center">
                            <p class="text-[8px] text-green-600 font-bold uppercase leading-tight">Min. ${w.min_qty}</p>
                            <p class="text-[10px] text-green-700 font-black">Rp ${w.price.toLocaleString("id-ID")}</p>
                        </div>
                    `).join("")}
                        </div>
                    `)}catch(y){console.error("Error parsing grosir data for product:",i.id,y)}let u="";if(i.hargaCoret>i.harga){const y=Math.round((i.hargaCoret-i.harga)/i.hargaCoret*100);u=`
                <div class="flex items-center gap-1 mb-0.5">
                    <span class="text-[10px] text-gray-400 line-through">Rp ${i.hargaCoret.toLocaleString("id-ID")}</span>
                    <span class="bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded font-bold">-${y}%</span>
                </div>
            `}const m=i.variations&&i.variations.length>0,p=i.productId,f=isProductInWishlist(p)?'<svg class="w-5 h-5 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>':'<svg class="w-5 h-5 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>';t.innerHTML+=`
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300 relative" data-product-id="${p}">
                <!-- Wishlist Heart Button -->
                <button id="wishlist-btn-${p}" data-action="toggle-wishlist" data-product-id="${p}" class="absolute top-3 right-3 z-20 p-2 bg-white/90 hover:bg-white rounded-full shadow-md transition active:scale-95">
                    ${f}
                </button>
                <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">
                    <div class="bg-amber-400 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        +${c} Poin
                    </div>
                    ${h?`
                    <div class="bg-green-600 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7c.78.78.78 2.047 0 2.828l-7 7c-.78.78-2.047.78-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                        Harga Grosir Tersedia
                    </div>
                    `:""}
                </div>
                <div class="lazy-image-wrapper">
                    <div class="skeleton skeleton-product-image"></div>
                    <img src="${d}" alt="${escapeHtml(i.nama)}" data-action="show-detail" data-product-id="${p}" class="w-full h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity ${i.stok===0?"grayscale opacity-60":""}" loading="lazy" data-fallback-src="https://placehold.co/300x200?text=Produk" onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';">
                </div>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-lg font-bold text-gray-800">${escapeHtml(i.nama)}</h4>
                        ${s}
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <button data-action="share-product" data-product-id="${p}" class="text-green-600 hover:text-green-700 flex items-center gap-1 text-xs font-medium">
                            <span>Share</span>
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-[10px] text-green-600 font-bold uppercase">Harga Cash</p>
                            <div class="flex flex-col">
                                ${u}
                                <p class="text-lg font-bold text-green-700">Rp ${i.harga.toLocaleString("id-ID")}</p>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-[10px] text-blue-600 font-bold uppercase">Bayar Gajian</p>
                            <div class="flex flex-col">
                                <p class="text-[8px] text-blue-400 mb-0.5">Harga Per Tgl ${new Date().toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}</p>
                                <p class="text-lg font-bold text-blue-700">Rp ${i.hargaGajian.toLocaleString("id-ID")}</p>
                            </div>
                        </div>
                    </div>
                    ${g}
                    ${m?`
                    <button data-action="show-detail" data-product-id="${p}" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 mb-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        Pilih Variasi
                    </button>
                    `:`
                    <button data-action="add-to-cart" data-product-id="${p}" ${i.stok===0?"disabled":""} class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 mb-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Tambah ke Keranjang
                    </button>
                    `}
                    <div class="grid grid-cols-2 gap-2">
                        <button data-action="show-detail" data-product-id="${p}" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 rounded-lg text-sm transition">Rincian</button>
                        <button data-action="direct-order" data-product-id="${p}" ${i.stok===0?"disabled":""} class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 rounded-lg text-sm transition">Beli Sekarang</button>
                    </div>

                </div>
            </div>
        `})}function filterProducts(){const e=document.getElementById("search-input"),t=e?normalizeSearch(e.value):"",n=document.getElementById("sort-select"),a=n?n.value:"default";filteredProducts=allProducts.filter(r=>{const o=matchesQuery(r,t),i=normalizeCategoryLabel(currentCategory),s=normalizeCategoryLabel(r.category||r.kategori),l=i==="Semua"||s.toLowerCase()===i.toLowerCase();return o&&l}),filteredProducts=sortProducts(filteredProducts,a),currentPage=1,renderProducts(filteredProducts),renderPagination(filteredProducts.length),renderSearchSuggestions(t)}function sortProducts(e,t){const n=[...e];return t==="price-asc"?(n.sort((a,r)=>(a.harga||0)-(r.harga||0)),n):t==="price-desc"?(n.sort((a,r)=>(r.harga||0)-(a.harga||0)),n):(t==="promo"&&n.sort((a,r)=>promoScore(r)-promoScore(a)),n)}function promoScore(e){const t=e.harga||0,n=e.hargaCoret||e.harga_coret||0;return!t||!n||n<=t?0:Math.round((n-t)/n*100)}function normalizeSearch(e){return String(e||"").toLowerCase().replace(/[^a-z0-9\\s]/g," ").replace(/\\s+/g," ").trim()}function tokenize(e){return normalizeSearch(e).split(" ").filter(Boolean)}function matchesQuery(e,t){if(!t)return!0;const n=`${normalizeSearch(e.nama)} ${normalizeSearch(e.deskripsi||"")}`.trim(),a=t.replace(/\s+/g,""),r=n.replace(/\s+/g,"");return!!n.includes(t)||!(!a||!r.includes(a))||tokenize(t).every(o=>n.includes(o))}function renderSearchSuggestions(e){const t=document.getElementById("search-suggestions"),n=document.getElementById("search-suggestions-header"),a=n&&window.innerWidth<768?n:t;if(!a)return;if(!e)return a.classList.add("hidden"),void(a.innerHTML="");const r=getSearchSuggestions(e,6);if(r.length===0)return a.classList.add("hidden"),void(a.innerHTML="");a.innerHTML=r.map(o=>`
        <button type="button" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-green-50 transition" data-action="search-suggestion" data-value="${escapeHtml(o)}">${escapeHtml(o)}</button>
    `).join(""),a.classList.remove("hidden")}function closeSearchSuggestions(){[document.getElementById("search-suggestions"),document.getElementById("search-suggestions-header")].forEach(e=>{e&&(e.classList.add("hidden"),e.innerHTML="")})}function getSearchSuggestions(e,t=6){const n=tokenize(e);if(n.length===0)return[];const a=allProducts.map(o=>{const i=[...tokenize(o.nama),...tokenize(o.deskripsi||"")];let s=0;return n.forEach(l=>{i.forEach(d=>{d===l?s=Math.max(s,3):d.includes(l)?s=Math.max(s,2):l.length>2&&d.length>2&&levenshtein(d,l)<=1&&(s=Math.max(s,1))})}),{name:o.nama,score:s}}).filter(o=>o.score>0),r=new Map;return a.sort((o,i)=>i.score-o.score).forEach(o=>{r.has(o.name)||r.set(o.name,o)}),Array.from(r.values()).slice(0,t).map(o=>o.name)}function levenshtein(e,t){const n=e.length,a=t.length;if(n===0)return a;if(a===0)return n;const r=Array.from({length:n+1},()=>new Array(a+1).fill(0));for(let o=0;o<=n;o+=1)r[o][0]=o;for(let o=0;o<=a;o+=1)r[0][o]=o;for(let o=1;o<=n;o+=1)for(let i=1;i<=a;i+=1){const s=e[o-1]===t[i-1]?0:1;r[o][i]=Math.min(r[o-1][i]+1,r[o][i-1]+1,r[o-1][i-1]+s)}return r[n][a]}function renderPagination(e){const t=document.getElementById("pagination-container");if(!t)return;const n=Math.ceil(e/12);if(n<=1)return void(t.innerHTML="");let a="";a+=`
        <button type="button" data-action="change-page" data-page="${currentPage-1}" ${currentPage===1?"disabled":""} 
            class="w-10 h-10 flex items-center justify-center rounded-lg border-2 border-gray-200 text-gray-600 hover:border-green-500 hover:text-green-600 disabled:opacity-30 disabled:cursor-not-allowed transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
    `;for(let r=1;r<=n;r++)r===1||r===n||r>=currentPage-1&&r<=currentPage+1?a+=`
                <button type="button" data-action="change-page" data-page="${r}" 
                    class="w-10 h-10 flex items-center justify-center rounded-lg border-2 font-bold transition ${r===currentPage?"bg-green-600 border-green-600 text-white":"border-gray-200 text-gray-600 hover:border-green-500 hover:text-green-600"}">
                    ${r}
                </button>
            `:r!==currentPage-2&&r!==currentPage+2||(a+='<span class="text-gray-400">...</span>');a+=`
        <button type="button" data-action="change-page" data-page="${currentPage+1}" ${currentPage===n?"disabled":""} 
            class="w-10 h-10 flex items-center justify-center rounded-lg border-2 border-gray-200 text-gray-600 hover:border-green-500 hover:text-green-600 disabled:opacity-30 disabled:cursor-not-allowed transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
    `,t.innerHTML=a}function changePage(e){const t=Math.ceil(filteredProducts.length/12);e<1||e>t||(currentPage=e,renderProducts(filteredProducts),renderPagination(filteredProducts.length),document.getElementById("katalog").scrollIntoView({behavior:"smooth"}))}function setCategory(e){currentCategory=e,document.querySelectorAll(".filter-btn").forEach(t=>{t.innerText===e?(t.classList.add("active"),t.classList.remove("border-gray-300","bg-white","text-gray-700"),t.classList.add("border-green-500","bg-green-50","text-green-700"),t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})):(t.classList.remove("active"),t.classList.remove("border-green-500","bg-green-50","text-green-700"),t.classList.add("border-gray-300","bg-white","text-gray-700"))}),filterProducts()}function addToCart(e,t,n=1){storeClosed?showStoreWarning(()=>{proceedAddToCart(e,t,n)}):proceedAddToCart(e,t,n)}function proceedAddToCart(e,t,n=1){if(e.variations&&e.variations.length>0&&!selectedVariation)return void showDetail(e);const a={...e};if(selectedVariation){a.selectedVariation=selectedVariation,a.harga=selectedVariation.harga,a.sku=selectedVariation.sku,a.stok=selectedVariation.stok;const s=typeof calculateGajianPrice=="function"?calculateGajianPrice(selectedVariation.harga):{price:selectedVariation.harga,daysLeft:0,markupPercent:0};a.hargaGajian=s.price}const r=getItemMaxStock(a);if(r<=0)return void showToast("Stok produk habis.");const o=Math.max(1,parseInt(n,10)||1),i=cart.find(s=>{const l=s.id===a.id,d=!s.selectedVariation&&!a.selectedVariation||s.selectedVariation&&a.selectedVariation&&s.selectedVariation.sku===a.selectedVariation.sku;return l&&d});if(i){const s=Math.max(0,parseInt(i.qty,10)||0),l=Math.min(r,s+o);if(l<=s)return void showToast(`Maksimal stok untuk produk ini: ${r}`);i.qty=l,l<s+o&&showToast(`Qty disesuaikan ke stok maksimal: ${r}`)}else{const s=Math.min(r,o);cart.push({...a,qty:s}),s<o&&showToast(`Qty disesuaikan ke stok maksimal: ${r}`)}if(saveCart(),updateCartUI(),selectedVariation=null,t&&t.currentTarget){const s=(t.currentTarget.closest(".bg-white")||document.getElementById("detail-modal")).querySelector("img"),l=document.querySelector("header button");if(s&&l){const d=s.getBoundingClientRect(),c=l.getBoundingClientRect(),g=document.createElement("img");g.src=s.src,g.className="fly-item",g.style.top=`${d.top}px`,g.style.left=`${d.left}px`,g.style.width=`${d.width}px`,g.style.height=`${d.height}px`,g.style.borderRadius="12px",document.body.appendChild(g),requestAnimationFrame(()=>{g.style.top=`${c.top+c.height/2}px`,g.style.left=`${c.left+c.width/2}px`,g.style.width="20px",g.style.height="20px",g.style.opacity="0.5",g.style.borderRadius="50%"}),setTimeout(()=>{g.remove(),l.classList.add("cart-pop"),setTimeout(()=>l.classList.remove("cart-pop"),400)},800)}}else{const s=document.querySelector("header button");s&&(s.classList.add("cart-pop"),setTimeout(()=>s.classList.remove("cart-pop"),400))}showToast(`${a.nama}${a.selectedVariation?" ("+a.selectedVariation.nama+")":""} ditambahkan ke keranjang`)}function showToast(e){let t=document.querySelector(".toast-container");t||(t=document.createElement("div"),t.className="toast-container",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),document.body.appendChild(t));const n=document.createElement("div");n.className="toast",n.setAttribute("role","status"),n.setAttribute("aria-live","polite"),n.setAttribute("aria-atomic","true"),n.innerHTML=`
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>${escapeHtml(e)}</span>
    `,t.appendChild(n),setTimeout(()=>n.remove(),3e3)}function showSuccessNotification(e,t){const n=document.createElement("div");n.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] animate-fade-in",n.style.animation="fadeIn 0.3s ease-out";const a=document.createElement("div");a.className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm mx-4 text-center transform scale-95 relative",a.style.animation="scaleIn 0.3s ease-out forwards";const r=sanitizeUrl("assets/images/success-shield.gif","assets/images/success-shield.gif");a.innerHTML=`
        <button type="button" data-action="dismiss-notification" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition p-1 rounded-full hover:bg-gray-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <div class="mb-4">
            <div class="w-32 h-32 flex items-center justify-center mx-auto mb-4">
                <img src="${r}" alt="Success" class="w-full h-full object-contain" data-fallback-src="assets/images/success-shield.gif">
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Pesanan Berhasil Dikirim!</h3>
            <p class="text-gray-600 mb-4">Order ID: <span class="font-mono font-semibold text-green-600">${escapeHtml(e)}</span></p>
            <p class="text-sm text-gray-500 mb-6">Pesanan Anda telah tercatat dan akan segera diproses. Silakan lanjutkan ke WhatsApp untuk konfirmasi.</p>
        </div>
        <a href="${t}" target="_blank" class="block w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg flex items-center justify-center gap-3 mt-4">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            <span>Lanjut ke WhatsApp</span>
        </a>
    `,n.appendChild(a),document.body.appendChild(n);const o=a.querySelector('[data-action="dismiss-notification"]');if(o&&o.addEventListener("click",()=>n.remove()),!document.getElementById("success-notification-styles")){const i=document.createElement("style");i.id="success-notification-styles",i.textContent=`
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes scaleIn {
                from { transform: scale(0.95); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            @keyframes successCircle {
                0% {
                    transform: scale(0);
                    opacity: 0;
                }
                50% {
                    transform: scale(1.1);
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            @keyframes successCheck {
                0% {
                    stroke-dashoffset: 50;
                    opacity: 0;
                }
                50% {
                    opacity: 1;
                }
                100% {
                    stroke-dashoffset: 0;
                }
            }
            @keyframes bounce {
                0%, 100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }
            .animate-success-circle {
                animation: successCircle 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            }
            .animate-success-check {
                animation: successCheck 0.6s ease-in-out 0.3s forwards, bounce 0.6s ease-in-out 0.9s;
            }
            .checkmark-path {
                stroke-dasharray: 50;
                stroke-dashoffset: 50;
            }
        `,document.head.appendChild(i)}n.addEventListener("click",i=>{i.target===n&&(n.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>n.remove(),300))})}function saveCart(){localStorage.setItem("sembako_cart",JSON.stringify(cart))}function updateCartUI(){const e=cart.reduce((o,i)=>o+i.qty,0),t=document.getElementById("cart-count");t&&(e>0?(t.innerText=e,t.classList.remove("hidden")):t.classList.add("hidden"));const n=document.getElementById("cart-items"),a=document.getElementById("cart-footer"),r=document.getElementById("cart-empty");if(n)if(cart.length===0)n.innerHTML="",a&&a.classList.add("hidden"),r&&r.classList.remove("hidden");else{r&&r.classList.add("hidden"),a&&a.classList.remove("hidden");let o=0;n.innerHTML=cart.map((d,c)=>{const g=calculateTieredPrice(d.harga,d.qty,d.grosir),h=g<d.harga,u=g*d.qty;o+=u;let m=(d.gambar?d.gambar.split(","):[])[0]||"https://placehold.co/100x100?text=Produk";return d.selectedVariation&&d.selectedVariation.gambar&&(m=d.selectedVariation.gambar),`
                <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-xl">
                    <img src="${sanitizeUrl(m,"https://placehold.co/100x100?text=Produk")}" class="w-16 h-16 object-cover rounded-lg" data-fallback-src="https://placehold.co/100x100?text=Produk">
                    <div class="flex-1">
                        <h5 class="font-bold text-gray-800 text-sm">${d.nama}${d.selectedVariation?" ("+d.selectedVariation.nama+")":""}</h5>
                        <div class="flex flex-col">
                            ${h?`<span class="text-[10px] text-gray-400 line-through">Rp ${d.harga.toLocaleString("id-ID")}</span>`:""}
                            <p class="text-green-600 font-bold text-xs">Rp ${g.toLocaleString("id-ID")} ${h?'<span class="bg-green-100 text-green-700 text-[8px] px-1 rounded ml-1">Grosir</span>':""}</p>
                        </div>
                        <div class="flex items-center gap-3 mt-2">
                            <button type="button" data-action="update-cart-qty" data-index="${c}" data-delta="-1" class="w-6 h-6 bg-white border border-gray-200 rounded-full flex items-center justify-center text-gray-500">-</button>
                            <span class="text-sm font-bold">${d.qty}</span>
                            <button type="button" data-action="update-cart-qty" data-index="${c}" data-delta="1" class="w-6 h-6 bg-white border border-gray-200 rounded-full flex items-center justify-center text-gray-500">+</button>
                        </div>
                    </div>
                    <button type="button" data-action="remove-cart-item" data-index="${c}" class="text-red-400 hover:text-red-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `}).join("");const i=document.getElementById("cart-total");i&&(i.innerText=`Rp ${o.toLocaleString("id-ID")}`);const s=document.getElementById("order-summary-total");s&&(s.innerText=`Rp ${o.toLocaleString("id-ID")}`);const l=document.getElementById("sticky-order-total");l&&(l.innerText=`Rp ${o.toLocaleString("id-ID")}`)}}function updateQty(e,t){const n=cart[e];if(!n)return;const a=parseInt(n.qty,10)||0,r=getItemMaxStock(n);let o=a+t;t>0&&r>0&&o>r&&(o=r,showToast(`Maksimal stok untuk produk ini: ${r}`)),n.qty=o,(n.qty<1||r<=0&&t>0)&&cart.splice(e,1),saveCart(),updateCartUI()}function removeItem(e){cart.splice(e,1),saveCart(),updateCartUI()}function openCartModal(){const e=document.getElementById("cart-modal");e&&(e.classList.remove("hidden"),document.body.classList.add("modal-active"))}function closeCartModal(){const e=document.getElementById("cart-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}function updateModalQty(e){const t=document.getElementById("modal-qty");if(!t)return;let n=parseInt(t.value)||1;n+=e,n<1&&(n=1);const a=getCurrentModalMaxStock();a>0&&n>a&&(n=a,showToast(`Maksimal stok untuk produk ini: ${a}`)),t.value=n,t.oninput({target:t})}function showDetail(e){closeWishlistModal(),console.log("showDetail called for product:",e.nama);const t=document.getElementById("detail-modal");if(!t)return;currentModalProduct=e,t.dataset.productId=e.productId||"",selectedVariation=null;const n=document.getElementById("modal-qty");n&&(n.value=1);const a=document.getElementById("modal-product-name"),r=document.getElementById("modal-product-image"),o=(document.getElementById("modal-cash-price"),document.getElementById("modal-gajian-price"),document.getElementById("modal-price-date")),i=document.getElementById("modal-items-list"),s=document.getElementById("modal-badges"),l=(document.getElementById("savings-highlight"),document.getElementById("savings-amount"),document.getElementById("modal-variation-container"));a&&(a.innerText=e.nama),n&&(n.oninput=c=>{let g=parseInt(c.target.value,10)||1;g<1&&(g=1);const h=getCurrentModalMaxStock();h>0&&g>h&&(g=h,showToast(`Maksimal stok untuk produk ini: ${h}`)),c.target.value=g;const u=selectedVariation?selectedVariation.harga:e.harga,m=selectedVariation?selectedVariation.grosir:e.grosir,p=selectedVariation?selectedVariation.harga_coret||0:e.hargaCoret||0;typeof updateTieredPricingUI=="function"&&updateTieredPricingUI({...e,harga:u,grosir:m},g);const f=typeof calculateTieredPrice=="function"?calculateTieredPrice(u,g,m):u;updateModalPrices(f*g,(typeof calculateGajianPrice=="function"?calculateGajianPrice(f):{price:f}).price*g,p*g)}),l?e.variations&&e.variations.length>0?(l.classList.remove("hidden"),document.getElementById("modal-variation-list").innerHTML=e.variations.map((c,g)=>`
	                <button type="button" data-action="select-variation" data-index="${g}" class="variation-btn border-2 border-gray-200 rounded-xl p-3 text-left transition hover:border-green-500 focus:outline-none">
                    <p class="text-xs font-bold text-gray-800">${escapeHtml(c.nama)}</p>
                    <p class="text-[10px] text-green-600 font-bold">Rp ${c.harga.toLocaleString("id-ID")}</p>
                    ${c.stok<=0?'<p class="text-[8px] text-red-500 font-bold">Stok Habis</p>':""}
                </button>
            `).join(""),selectVariation(e.variations[0],0)):(l.classList.add("hidden"),updateModalPrices(e.harga,e.hargaGajian,e.hargaCoret)):updateModalPrices(e.harga,e.hargaGajian,e.hargaCoret),o&&(o.innerText=`Harga Per Tgl ${new Date().toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}`),s&&(s.innerHTML=`
            <span class="bg-green-100 text-green-700 text-[10px] px-2.5 py-1 rounded-lg font-bold">${escapeHtml(e.category)}</span>
            ${e.stok>0?`<span class="bg-blue-100 text-blue-700 text-[10px] px-2.5 py-1 rounded-lg font-bold">Stok: ${e.stok}</span>`:'<span class="bg-red-100 text-red-700 text-[10px] px-2.5 py-1 rounded-lg font-bold">Stok Habis</span>'}
        `);const d=e.gambar?e.gambar.split(","):[];if(typeof initializeSlider=="function"?initializeSlider(d):r&&(r.src=d.length>0?d[0]:"https://placehold.co/300x200?text=Produk",r.onerror=function(){this.src="https://placehold.co/300x200?text=Produk"}),i){const c=String(e.deskripsi||"").replace(/\r\n?/g,`
`).replace(/\\r\\n/g,`
`).replace(/\\n/g,`
`).split(`
`).map(h=>h.trim()).filter(h=>h!==""&&!/^isi paket\s*:\s*$/i.test(h)).map(h=>h.replace(/^[\-â€¢]\s*/,"").trim()).filter(h=>h!==""),g=["\u{1F35C}","\u{1F372}","\u{1F4E6}","\u2615","\u{1F35A}","\u{1F373}","\u{1F9C2}"];i.innerHTML=c.map((h,u)=>`
            <div class="flex items-center gap-4 bg-gray-50/50 p-3 rounded-xl border border-gray-100/50">
                <span class="text-xl">${g[u%g.length]}</span>
                <span class="text-sm font-medium text-gray-700">\u2022${escapeHtml(h)}</span>
            </div>
        `).join("")}typeof updateTieredPricingUI=="function"&&updateTieredPricingUI(e,1),t.classList.remove("hidden"),document.body.classList.add("modal-active")}function selectVariation(e,t){if(selectedVariation=e,document.querySelectorAll(".variation-btn").forEach((a,r)=>{r===t?(a.classList.add("border-green-500","bg-green-50"),a.classList.remove("border-gray-200")):(a.classList.remove("border-green-500","bg-green-50"),a.classList.add("border-gray-200"))}),e.gambar&&typeof initializeSlider=="function"){const a=e.gambar.split(",");initializeSlider(a)}const n=document.getElementById("modal-qty");if(n)n.oninput({target:n});else{const a=typeof calculateGajianPrice=="function"?calculateGajianPrice(e.harga):{price:e.harga,daysLeft:0,markupPercent:0};updateModalPrices(e.harga,a.price,e.harga_coret||0)}}function updateModalPrices(e,t,n){const a=document.getElementById("modal-cash-price"),r=document.getElementById("modal-gajian-price"),o=document.getElementById("savings-highlight"),i=document.getElementById("savings-amount");a&&(a.innerText=`Rp ${e.toLocaleString("id-ID")}`),r&&(r.innerText=`Rp ${t.toLocaleString("id-ID")}`),n>e?(o&&o.classList.remove("hidden"),i&&(i.innerText=`Rp ${(n-e).toLocaleString("id-ID")}`)):o&&o.classList.add("hidden")}function closeDetailModal(){const e=document.getElementById("detail-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active")),selectedVariation=null}function directOrder(e){storeClosed?showStoreWarning(()=>{proceedDirectOrder(e)}):proceedDirectOrder(e)}function proceedDirectOrder(e){if(e.variations&&e.variations.length>0&&!selectedVariation)return void showDetail(e);const t={...e};if(selectedVariation){t.selectedVariation=selectedVariation,t.harga=selectedVariation.harga,t.sku=selectedVariation.sku,t.stok=selectedVariation.stok;const i=typeof calculateGajianPrice=="function"?calculateGajianPrice(selectedVariation.harga):{price:selectedVariation.harga,daysLeft:0,markupPercent:0};t.hargaGajian=i.price}const n=getItemMaxStock(t);if(n<=0)return void showToast("Stok produk habis.");const a=document.getElementById("modal-qty"),r=a&&parseInt(a.value,10)||1,o=Math.min(n,Math.max(1,r));o<r&&showToast(`Qty disesuaikan ke stok maksimal: ${n}`),cart=[{...t,qty:o}],saveCart(),updateCartUI(),openOrderModal(),selectedVariation=null}function directOrderFromModal(){const e=document.getElementById("detail-modal"),t=findProductById(e?e.dataset.productId:null);t&&(directOrder(t),closeDetailModal())}function checkStoreStatus(){storeClosed=CONFIG.isStoreClosed();const e=document.getElementById("store-closed-banner"),t=document.getElementById("main-header");storeClosed?(e&&e.classList.remove("hidden"),t&&(t.style.top="36px"),sessionStorage.getItem("store_closed_modal_shown")||setTimeout(()=>{document.getElementById("store-closed-modal").classList.remove("hidden"),sessionStorage.setItem("store_closed_modal_shown","true")},1e3)):(e&&e.classList.add("hidden"),t&&(t.style.top="0"))}function closeStoreClosedModal(){document.getElementById("store-closed-modal").classList.add("hidden")}function showStoreWarning(e){const t=document.getElementById("store-warning-modal"),n=document.getElementById("confirm-store-warning");t.classList.remove("hidden"),n.onclick=()=>{t.classList.add("hidden"),e&&e()}}function closeStoreWarningModal(){document.getElementById("store-warning-modal").classList.add("hidden")}function openOrderModal(){if(cart.length===0)return;closeCartModal(),prefillCustomerInfo();const e=document.getElementById("order-summary"),t=document.querySelector('input[name="pay-method"]:checked'),n=t&&t.value==="Bayar Gajian";if(e){let r=0;e.innerHTML=cart.map(o=>{const i=n?o.hargaGajian:o.harga,s=calculateTieredPrice(i,o.qty,o.grosir),l=s<i,d=calculateRewardPoints(o.harga,o.nama)*o.qty;return r+=d,`
                <div class="flex justify-between items-center py-1">
                    <div class="flex flex-col">
                        <span class="font-medium">${escapeHtml(o.nama)}${o.selectedVariation?" ("+escapeHtml(o.selectedVariation.nama)+")":""} (x${o.qty})</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-amber-600 font-bold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                +${d.toFixed(1)} Poin
                            </span>
                            ${l?'<span class="bg-green-100 text-green-700 text-[8px] px-1 rounded font-bold">Harga Grosir</span>':""}
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        ${l?`<span class="text-[10px] text-gray-400 line-through">Rp ${(i*o.qty).toLocaleString("id-ID")}</span>`:""}
                        <span class="font-bold">Rp ${(s*o.qty).toLocaleString("id-ID")}</span>
                    </div>
                </div>
            `}).join(""),e.innerHTML+=`
            <div class="border-t border-dashed border-gray-200 mt-2 pt-2 flex justify-between items-center">
                <span class="text-xs font-bold text-amber-700">Total Poin Didapat:</span>
                <span class="text-sm font-black text-amber-700 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                    ${escapeHtml(r.toFixed(1))} Poin
                </span>
            </div>
        `}updateOrderTotal(),updateOrderCTAState();const a=document.getElementById("order-modal");a&&(a.classList.remove("hidden"),document.body.classList.add("modal-active"))}function prefillCustomerInfo(){const e=document.getElementById("customer-name"),t=document.getElementById("customer-phone");if(!e||!t)return;const n=getStoredLoggedInUser();if(!n)return;const a=(n.nama||"").trim(),r=normalizePhoneNumber(n.whatsapp||n.phone||"");!e.value.trim()&&a&&(e.value=a),!t.value.trim()&&r&&(t.value=r)}function closeOrderModal(){const e=document.getElementById("order-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}function shareProduct(e){const t=`Cek paket sembako murah "${e}" di GoSembako! Kualitas terjamin, harga bersahabat.`,n=window.location.href,a=`https://wa.me/?text=${encodeURIComponent(t+" "+n)}`;window.open(a,"_blank")}function startNotificationLoop(){const e=["Siti","Budi","Ani","Joko","Rina","Agus","Dewi","Eko"],t=allProducts.length>0?allProducts.map(n=>n.nama):["Paket Sembako"];setInterval(()=>{Math.random()>.7&&showNotification(`${e[Math.floor(Math.random()*e.length)]} baru saja membeli ${t[Math.floor(Math.random()*t.length)]}`)},15e3)}function showNotification(e){const t=document.createElement("div");t.className="fixed bottom-24 left-4 bg-white/90 backdrop-blur shadow-lg rounded-xl p-3 flex items-center gap-3 border border-green-100 z-50 animate-bounce",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.innerHTML=`
            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"></path></svg>
            </div>
        <p class="text-xs font-medium text-gray-700">${escapeHtml(e)}</p>
    `,document.body.appendChild(t),setTimeout(()=>t.remove(),5e3)}function toggleLocationField(){const e=document.querySelector('input[name="ship-method"]:checked'),t=document.getElementById("location-field"),n=document.getElementById("delivery-location-ui"),a=document.getElementById("pickup-location-ui");e&&(e.value==="Antar Nikomas"?(t.classList.add("hidden"),n.classList.add("hidden"),a.classList.add("hidden")):e.value==="Antar Kerumah"?(t.classList.remove("hidden"),n.classList.remove("hidden"),a.classList.add("hidden")):e.value==="Ambil Ditempat"&&(t.classList.remove("hidden"),n.classList.add("hidden"),a.classList.remove("hidden"))),updateOrderTotal()}function getCurrentLocation(){const e=document.getElementById("get-location-btn"),t=document.getElementById("location-link");navigator.geolocation?(e.disabled=!0,e.innerHTML="<span>\u231B Mengambil Lokasi...</span>",navigator.geolocation.getCurrentPosition(n=>{const a=`https://www.google.com/maps?q=${n.coords.latitude},${n.coords.longitude}`;t.value=a,e.classList.remove("bg-white","text-blue-700","border-blue-200"),e.classList.add("bg-green-600","text-white","border-green-600"),e.innerHTML="<span>\u2705 Lokasi Berhasil Dibagikan</span>",alert("Lokasi berhasil diambil!")},n=>{e.disabled=!1,e.innerHTML="<span>\u{1F4CD} Bagikan Lokasi Saya</span>";let a="Gagal mengambil lokasi.";n.code===1&&(a="Mohon izinkan akses lokasi untuk fitur ini."),alert(a)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})):alert("Geolocation tidak didukung oleh browser Anda")}function getSelectedPayMethodValue(){const e=document.querySelector('input[name="pay-method"]:checked');return e?String(e.value||"").trim():""}function isPaylaterSelected(){return getSelectedPayMethodValue()==="PayLater"}function getOrderSubtotalByPayMethod(e){const t=String(e||"")==="Bayar Gajian";let n=0;return cart.forEach(a=>{const r=t?a.hargaGajian:a.harga,o=calculateTieredPrice(r,a.qty,a.grosir);n+=o*a.qty}),n}function getShippingFeeBySelection(){const e=document.querySelector('input[name="ship-method"]:checked');return e&&e.value==="Antar Nikomas"?2e3:0}function getCurrentOrderGrandTotal(){return getOrderSubtotalByPayMethod(getSelectedPayMethodValue())+getShippingFeeBySelection()}function getStoredLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;try{const t=JSON.parse(e);if(!t||typeof t!="object")return null;const n=normalizePhone(t.whatsapp||t.phone||"")||String(t.whatsapp||t.phone||"").trim(),a=String(t.session_token||t.sessionToken||t.st||"").trim();return{...t,whatsapp:n,phone:n,session_token:a}}catch{return null}}function getSessionQueryFromStoredUser(){const e=getStoredLoggedInUser();if(!e)return"";const t=String(e.session_token||e.sessionToken||e.st||"").trim();return t?"&session_token="+encodeURIComponent(t):""}function getPaylaterEligibilityMessage(e){return{ok:"PayLater bisa dipakai untuk pesanan ini.",loading:"Sedang cek eligibility PayLater...",not_checked:"Belum dicek.",login_required:"Login akun dulu untuk memakai PayLater.",phone_mismatch:"Nomor checkout harus sama dengan nomor akun yang login.",session_invalid:"Session login tidak valid. Silakan login ulang.",paylater_disabled:"PayLater sedang nonaktif.",pilot_not_included:"PayLater masih tahap pilot. Akun Anda belum termasuk whitelist.",account_not_found:"Akun kredit belum tersedia untuk nomor ini.",account_frozen:"Akun kredit sedang freeze.",account_locked:"Akun kredit sedang lock.",account_inactive:"Akun kredit belum aktif.",active_invoice_exists:"Masih ada tagihan aktif/overdue.",below_min_order:"Total belanja belum memenuhi minimum PayLater.",insufficient_limit:"Limit tersedia tidak mencukupi.",fetch_failed:"Gagal cek data PayLater, coba lagi."}[String(e||"").toLowerCase()]||"PayLater belum memenuhi syarat."}function getPaylaterCheckoutConfigFallback(){try{return typeof CONFIG<"u"&&typeof CONFIG.getPaylaterConfig=="function"?CONFIG.getPaylaterConfig():{enabled:!1,tenorFees:{1:5,2:10,3:15,4:20},dailyPenaltyPercent:.5,penaltyCapPercent:15,maxActiveInvoices:1,minOrderAmount:0}}catch{return{enabled:!1,tenorFees:{1:5,2:10,3:15,4:20},dailyPenaltyPercent:.5,penaltyCapPercent:15,maxActiveInvoices:1,minOrderAmount:0}}}async function fetchPublicPaylaterConfig(){try{const e=await ApiService.get("?action=public_paylater_config",{cache:!1});if(e&&e.success)return{enabled:String(e.paylater_enabled||"false").toLowerCase()==="true",tenorFees:{1:parseFloat(e.fee_week_1||5)||5,2:parseFloat(e.fee_week_2||10)||10,3:parseFloat(e.fee_week_3||15)||15,4:parseFloat(e.fee_week_4||20)||20},dailyPenaltyPercent:parseFloat(e.daily_penalty_percent||.5)||.5,penaltyCapPercent:parseFloat(e.penalty_cap_percent||15)||15,maxActiveInvoices:parseInt(e.max_active_invoices||1,10)||1,minOrderAmount:parseInt(e.min_order_amount||0,10)||0}}catch(e){console.warn("public_paylater_config unavailable, fallback to local config:",e)}return getPaylaterCheckoutConfigFallback()}function renderPaylaterCheckoutState(){const e=document.getElementById("paylater-checkout-panel"),t=document.getElementById("paylater-eligibility-badge"),n=document.getElementById("paylater-eligibility-message"),a=document.getElementById("paylater-limit-available"),r=document.getElementById("paylater-active-invoices"),o=document.getElementById("paylater-sim-principal"),i=document.getElementById("paylater-sim-fee"),s=document.getElementById("paylater-sim-penalty-daily"),l=document.getElementById("paylater-sim-penalty-cap"),d=document.getElementById("paylater-sim-total-due");if(!e)return;if(!isPaylaterSelected())return void e.classList.add("hidden");e.classList.remove("hidden");const c=paylaterCheckoutState||{},g=c.loading?"loading":c.reason||"not_checked",h=!!c.eligible,u=c.loading?"Mengecek...":h?"Eligible":"Tidak Eligible",m=c.loading?"bg-amber-100 text-amber-700":h?"bg-green-100 text-green-700":"bg-red-100 text-red-700";t&&(t.className=`text-[10px] font-bold px-2 py-1 rounded-full ${m}`,t.textContent=u),n&&(n.textContent=c.message||getPaylaterEligibilityMessage(g));const p=c.account||{},f=c.summary||{},y=c.simulation||{};a&&(a.textContent=`Rp ${(parseInt(p.available_limit||0,10)||0).toLocaleString("id-ID")}`),r&&(r.textContent=String(parseInt(f.invoice_count_active||0,10)||0)),o&&(o.textContent=`Rp ${(parseInt(y.principal||0,10)||0).toLocaleString("id-ID")}`),i&&(i.textContent=`Rp ${(parseInt(y.feeAmount||0,10)||0).toLocaleString("id-ID")}`),s&&(s.textContent=`Rp ${(parseInt(y.dailyPenaltyAmount||0,10)||0).toLocaleString("id-ID")}`),l&&(l.textContent=`Rp ${(parseInt(y.penaltyCapAmount||0,10)||0).toLocaleString("id-ID")}`),d&&(d.textContent=`Rp ${(parseInt(y.totalBeforePenalty||0,10)||0).toLocaleString("id-ID")}`)}async function refreshPaylaterCheckoutState(e){if(!isPaylaterSelected())return paylaterCheckoutState={loading:!1,eligible:!1,reason:"not_checked",message:getPaylaterEligibilityMessage("not_checked"),account:null,summary:null,config:null,simulation:null},renderPaylaterCheckoutState(),paylaterCheckoutState;const t=++paylaterCheckoutRequestSeq;paylaterCheckoutState.loading=!0,paylaterCheckoutState.message=getPaylaterEligibilityMessage("loading"),paylaterCheckoutState.reason="loading",renderPaylaterCheckoutState();const n=document.getElementById("customer-phone"),a=normalizePhone(n?n.value:""),r=getStoredLoggedInUser(),o=normalizePhone(r&&(r.whatsapp||r.phone)||""),i=getSessionQueryFromStoredUser();if(!i)return paylaterCheckoutState={loading:!1,eligible:!1,reason:"login_required",message:getPaylaterEligibilityMessage("login_required"),account:null,summary:null,config:null,simulation:null},renderPaylaterCheckoutState(),paylaterCheckoutState;if(!a||!o||a!==o)return paylaterCheckoutState={loading:!1,eligible:!1,reason:"phone_mismatch",message:getPaylaterEligibilityMessage("phone_mismatch"),account:null,summary:null,config:null,simulation:null},renderPaylaterCheckoutState(),paylaterCheckoutState;try{const s=CONFIG.getMainApiUrl(),[l,d]=await Promise.all([fetch(`${s}?action=public_paylater_summary${i}&_t=${Date.now()}`),fetchPublicPaylaterConfig()]);let c=null;if(l.ok&&(c=await l.json()),!c||c.success!==!0){const v=(c&&(c.error||c.error_code))==="UNAUTHORIZED_SESSION"?"session_invalid":"fetch_failed";return paylaterCheckoutState={loading:!1,eligible:!1,reason:v,message:getPaylaterEligibilityMessage(v),account:null,summary:null,config:d,simulation:null},renderPaylaterCheckoutState(),paylaterCheckoutState}const g=getCurrentOrderGrandTotal(),h=document.getElementById("paylater-tenor"),u=h&&parseInt(h.value||"1",10)||1,m=typeof PaylaterLogic<"u"?PaylaterLogic:null,p=c.account||{},f=c.summary||{},y=c.pilot||{},w=parseInt(f.invoice_count_active||0,10)||0;let x={eligible:!1,reason:"fetch_failed"};m&&typeof m.evaluatePaylaterEligibility=="function"&&(x=m.evaluatePaylaterEligibility({account:p,activeInvoicesCount:w,orderTotal:g},d)),y&&y.active===!0&&y.eligible===!1&&(x={eligible:!1,reason:"pilot_not_included"});let I=null;if(m&&typeof m.calculatePaylaterInvoice=="function"){const v=m.calculatePaylaterInvoice(g,u,d),k=parseInt(v.principal||0,10)||0,L=parseFloat(d.dailyPenaltyPercent||0)||0,E=parseFloat(d.penaltyCapPercent||0)||0;I={tenorWeeks:u,feePercent:parseFloat(v.feePercent||0)||0,principal:k,feeAmount:parseInt(v.feeAmount||0,10)||0,totalBeforePenalty:parseInt(v.totalBeforePenalty||0,10)||0,dailyPenaltyAmount:Math.max(0,Math.round(k*L/100)),penaltyCapAmount:Math.max(0,Math.round(k*E/100))}}return(t===paylaterCheckoutRequestSeq||e)&&(paylaterCheckoutState={loading:!1,eligible:!!x.eligible,reason:x.reason||(x.eligible?"ok":"fetch_failed"),message:getPaylaterEligibilityMessage(x.reason||(x.eligible?"ok":"fetch_failed")),account:p,summary:f,config:d,simulation:I},renderPaylaterCheckoutState()),paylaterCheckoutState}catch(s){return console.error("Failed refresh PayLater checkout state:",s),paylaterCheckoutState={loading:!1,eligible:!1,reason:"fetch_failed",message:getPaylaterEligibilityMessage("fetch_failed"),account:null,summary:null,config:null,simulation:null},renderPaylaterCheckoutState(),paylaterCheckoutState}}function updateOrderTotal(){const e=getOrderSubtotalByPayMethod(getSelectedPayMethodValue()),t=getShippingFeeBySelection(),n=e+t,a=document.getElementById("sticky-order-total"),r=document.getElementById("order-summary-total");a&&(a.innerText=`Rp ${n.toLocaleString("id-ID")}`),r&&(r.innerText=`Rp ${n.toLocaleString("id-ID")}`);const o=document.getElementById("order-subtotal"),i=document.getElementById("order-shipping");o&&(o.innerText=`Rp ${e.toLocaleString("id-ID")}`),i&&(i.innerText=`Rp ${t.toLocaleString("id-ID")}`),updateOrderCTAState(),isPaylaterSelected()?refreshPaylaterCheckoutState():renderPaylaterCheckoutState()}function isOrderFormValid(){const e=document.getElementById("customer-name"),t=document.getElementById("customer-phone"),n=document.querySelector('input[name="pay-method"]:checked'),a=document.querySelector('input[name="ship-method"]:checked');if(!e||!t)return!1;const r=e.value.trim(),o=r.replace(/\s/g,"");if(!r||o.length<4)return!1;const i=t.value.trim();return!!i&&!(normalizePhone(i).replace(/[^0-9]/g,"").length<10)&&!!(n&&a)}function updateOrderCTAState(){const e=document.getElementById("send-order-btn")||document.querySelector('[data-action="send-wa"]');if(!e)return;let t=isOrderFormValid();t&&isPaylaterSelected()&&(t=!!(paylaterCheckoutState&&paylaterCheckoutState.eligible&&!paylaterCheckoutState.loading)),e.disabled=!t,e.setAttribute("aria-disabled",String(!t))}function normalizePhone(e){if(!e)return"";let t=e.toString().replace(/[^0-9]/g,"");return t.startsWith("62")?t="0"+t.slice(2):t.startsWith("8")?t="0"+t:t.startsWith("0")||(t="0"+t),t.startsWith("0")&&!t.startsWith("08")&&t.length,t}function generateOrderId(){let e="";for(let t=0;t<6;t++)e+="0123456789".charAt(Math.floor(10*Math.random()));return`ORD-${e}`}async function logOrderToGAS(e){const t=String(e.order_id||e.id||"").trim()||generateOrderId(),n={id:String(e.id||"").trim()||t,order_id:t,pelanggan:e.pelanggan||"",produk:e.produk||"",qty:e.qty||0,total:e.total||0,status:e.status||"Pending",tanggal:e.tanggal||new Date().toLocaleString("id-ID"),phone:e.phone||"",poin:e.poin||0,point_processed:e.point_processed||"No"};console.log("\u{1F4DD} Logging order to GAS:",n);try{const a=await GASActions.create("orders",n);return console.log("\u2705 Order logged successfully:",a),a}catch(a){throw console.error("\u274C Error logging order to GAS:",a),a}}async function sendToWA(){const e=event?.target||document.querySelector('[data-action="send-wa"]');if(e&&e.disabled)return;const t=document.getElementById("customer-name").value,n=document.getElementById("customer-phone").value,a=document.querySelector('input[name="pay-method"]:checked')?.value,r=document.querySelector('input[name="ship-method"]:checked')?.value;if(!t||t.trim().length===0)return void alert("Masukkan Nama Lengkap");const o=t.replace(/\s/g,"");if(o.length<4)return void alert("Masukkan Nama Lengkap");const i=o.toLowerCase(),s=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const b of s)if(b.test(i))return void alert("Masukkan Nama Lengkap");if(!n||n.trim().length===0)return void alert("Nomor WhatsApp tidak valid");const l=n.replace(/[^0-9]/g,"");if(l.length<10)return void alert("Nomor WhatsApp tidak valid");const d=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const b of d)if(b.test(l))return void alert("Nomor WhatsApp tidak valid");if(!a)return void alert("Pilih metode pembayaran terlebih dahulu");if(!r)return void alert("Pilih metode pengiriman terlebih dahulu");e&&(e.disabled=!0,e.innerHTML=`
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Memproses Pesanan...</span>
        `,e.classList.add("opacity-75","cursor-not-allowed"));let c="";c=r==="Antar Nikomas"?"Antar Nikomas (Area PT Nikomas Gemilang)":r==="Antar Kerumah"?"Antar Kerumah (Area Serang & sekitarnya)":"Ambil Ditempat (Kp. Baru, Kec. Kibin)";const g=a==="Bayar Gajian",h=a==="PayLater";let u=0,m=0,p="",f="";cart.forEach((b,P)=>{const B=g?b.hargaGajian:b.harga,S=calculateTieredPrice(B,b.qty,b.grosir),M=S<B,_=S*b.qty;u+=_,m+=b.qty;const C=b.selectedVariation?` (${b.selectedVariation.nama})`:"",T=M?` (Harga Grosir: Rp ${S.toLocaleString("id-ID")}/unit)`:"";p+=`${P+1}. ${b.nama}${C} x${b.qty}${T} = Rp ${_.toLocaleString("id-ID")}
`,f+=`${b.nama}${C} (x${b.qty}) | `});const y=r==="Antar Nikomas"?2e3:0;u+=y;let w="",x={};if(h){const b=await refreshPaylaterCheckoutState(!0);if(!b||!b.eligible||!b.simulation)return void alert(b&&b.message||"PayLater belum memenuhi syarat untuk pesanan ini.");x={paylater_tenor_weeks:b.simulation.tenorWeeks,paylater_fee_percent:b.simulation.feePercent,paylater_fee_amount:b.simulation.feeAmount,paylater_total_due:b.simulation.totalBeforePenalty,payment_method:"paylater"},w=`*PayLater Simulasi:*
- Pokok: Rp ${Number(b.simulation.principal||0).toLocaleString("id-ID")}
- Tenor: ${Number(b.simulation.tenorWeeks||1)} minggu
- Fee (${Number(b.simulation.feePercent||0)}%): Rp ${Number(b.simulation.feeAmount||0).toLocaleString("id-ID")}
- Denda Harian: Rp ${Number(b.simulation.dailyPenaltyAmount||0).toLocaleString("id-ID")}
- Cap Denda: Rp ${Number(b.simulation.penaltyCapAmount||0).toLocaleString("id-ID")}
- Total Jatuh Tempo: Rp ${Number(b.simulation.totalBeforePenalty||0).toLocaleString("id-ID")}

`}const I=CONFIG.getRewardConfig().pointValue||1e4,v=Math.floor(u/I),k=generateOrderId(),L=document.getElementById("location-link")?.value||"",E=`*PESANAN BARU - GOSEMBAKO*

*Order ID: ${k}*
*Data Pelanggan:*
Nama: ${t}
WhatsApp: ${n}

*Detail Pesanan:*
${p}
*Metode Pembayaran:* ${a}
*Metode Pengiriman:* ${r}
*Lokasi/Titik:* ${c}${L?`
*Lokasi Maps:* ${L}`:""}

*Ongkir:* Rp ${y.toLocaleString("id-ID")}
*TOTAL BAYAR: Rp ${u.toLocaleString("id-ID")}*
${w}*Estimasi Poin:* +${v} Poin

Mohon segera diproses ya, terima kasih!`,$=`https://wa.me/628993370200?text=${encodeURIComponent(E)}`,A={id:k,order_id:k,pelanggan:t,produk:f.slice(0,-3),qty:m,total:u,status:h?"Pending PayLater":"Pending",tanggal:new Date().toLocaleString("id-ID"),phone:normalizePhone(n),poin:v,point_processed:"No",payment_method:h?"paylater":g?"gajian":a==="QRIS"?"qris":"cash",...x};try{await logOrderToGAS(A),console.log("\u2705 Order logged to spreadsheet successfully"),cart=[],saveCart(),updateCartUI(),closeOrderModal(),showSuccessNotification(k,$)}catch(b){console.error("\u274C Error logging order:",b),alert("Gagal menyimpan pesanan. Silakan coba lagi atau hubungi admin.")}finally{e&&setTimeout(()=>{e.disabled=!1,e.innerHTML=`
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    Kirim Pesanan ke WhatsApp
                `,e.classList.remove("opacity-75","cursor-not-allowed")},500)}}function handleLogoClick(){let e=parseInt(sessionStorage.getItem("logo_clicks")||0)+1;sessionStorage.setItem("logo_clicks",e),e>=5&&(sessionStorage.setItem("logo_clicks",0),window.location.href="admin/login.html"),setTimeout(()=>sessionStorage.setItem("logo_clicks",0),3e3)}function hideGlobalRewardLoader(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchTukarPoin(){const e=document.getElementById("reward-items-list");if(e)try{renderRewardItems(await ApiService.get("?sheet=tukar_poin",{cacheDuration:18e4}))}catch(t){console.error("Error fetching reward items:",t),e.innerHTML=`
            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">
                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>
            </div>
        `}finally{hideGlobalRewardLoader()}}function renderRewardItems(e){const t=document.getElementById("reward-items-list");t&&(e&&e.length!==0?t.innerHTML=e.map(n=>{const a=n.id||"",r=n.nama||n.judul||"Hadiah",o=n.poin||0,i=n.gambar||"https://via.placeholder.com/100?text=Reward",s=sanitizeUrl(i,"https://via.placeholder.com/100?text=Reward"),l=n.deskripsi||"",d=escapeHtml(r);return`
            <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 hover:border-green-500 transition-all group shadow-sm">
                <div class="flex gap-4">
                    <div class="w-20 h-20 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0">
                        <img src="${s}" alt="${d}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" data-fallback-src="https://via.placeholder.com/100?text=Reward">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h5 class="font-bold text-gray-800 truncate">${d}</h5>
                        <p class="text-[10px] text-gray-500 line-clamp-2 mb-2">${escapeHtml(l)}</p>
                        <div class="flex items-center justify-between">
                            <div class="bg-amber-100 text-amber-700 px-2 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                ${o} Poin
                            </div>
                            <button type="button" data-action="show-confirm-tukar" data-reward-id="${escapeHtml(a)}" class="bg-green-600 hover:bg-green-700 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg transition active:scale-95">
                                Tukar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `}).join(""):t.innerHTML=`
            <div class="text-center py-10 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl border-2 border-dashed border-gray-300">
                <p class="text-sm text-gray-600 font-semibold">Belum ada hadiah yang tersedia.</p>
            </div>
        `)}function closeRewardModal(){const e=document.getElementById("reward-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}function checkUserPoints(){const e=document.getElementById("reward-phone"),t=e?e.value.trim():"";if(!t)return void alert("Mohon masukkan nomor WhatsApp.");const n=normalizePhone(t),a=event.target,r=a?a.innerText:"Cek Poin";a&&a.tagName==="BUTTON"&&(a.innerText="Mencari...",a.disabled=!0),ApiService.get("?sheet=user_points",{cache:!1}).then(o=>{const i=o.find(d=>normalizePhone(d.phone||d.whatsapp||"")===n),s=document.getElementById("points-display"),l=document.querySelector("#points-display h4");if(i){const d=(i.points||i.poin||"0").toString().replace(",","."),c=parseFloat(d)||0;l.innerHTML=`${escapeHtml(c.toFixed(1))} <span class="text-sm font-bold">Poin</span>`,sessionStorage.setItem("user_points",c),sessionStorage.setItem("reward_phone",n),sessionStorage.setItem("reward_customer_name",i.nama||i.pelanggan||n),showToast(`Ditemukan ${c.toFixed(1)} poin untuk nomor ini!`)}else l.innerHTML=`${escapeHtml("0.0")} <span class="text-sm font-bold">Poin</span>`,sessionStorage.setItem("user_points",0),sessionStorage.setItem("reward_phone",n),sessionStorage.setItem("reward_customer_name",n),showToast("Nomor tidak ditemukan atau belum memiliki poin.");s.classList.remove("hidden")}).catch(o=>{console.error("Error checking points:",o),alert("Gagal mengecek poin. Silakan coba lagi.")}).finally(()=>{a&&a.tagName==="BUTTON"&&(a.innerText=r,a.disabled=!1)})}async function claimReward(e){const t=sessionStorage.getItem("reward_phone");if(t)try{const n=await ApiService.get(`?sheet=tukar_poin&action=search&id=${e}`,{cache:!1});if(!n||n.length===0)return void alert("Data hadiah tidak ditemukan.");const a=n[0],r=parseFloat(a.poin)||0,o=a.nama||a.judul||"Hadiah",i=parseFloat(sessionStorage.getItem("user_points"))||0,s=`Tukar ${r} poin Anda dengan "${o}"?
Saldo poin saat ini: ${i.toFixed(1)}`;if(!confirm(s))return;let l=prompt("Silakan masukkan nama Anda untuk klaim ini:",sessionStorage.getItem("reward_customer_name")||"");if(l===null)return;l=l.trim()||"Pelanggan",showToast("Sedang memproses penukaran...");const d=`RW-${Date.now()}-${Math.floor(1e5*Math.random())}`,c=await GASActions.post({action:"claim_reward",sheet:"tukar_poin",data:{reward_id:e,phone:t,customer_name:l,request_id:d}}),g=c.claim_id||"CLM-"+Date.now().toString().slice(-6),h=parseFloat(c.points_used||r)||0,u=parseFloat(c.balance_after),m=Number.isNaN(u)?Math.max(0,i-h):u;sessionStorage.setItem("user_points",m);const p=document.querySelector("#points-display h4");p&&(p.innerHTML=`${escapeHtml(m.toFixed(1))} <span class="text-sm font-bold">Poin</span>`);const f=`*KLAIM REWARD POIN BERHASIL*

ID Klaim: ${g}
Pelanggan: ${l}
Nomor WhatsApp: ${t}
Reward: ${o}
Poin Ditukar: ${h}
Sisa Poin: ${m.toFixed(1)}

Mohon segera diproses. Terima kasih!`,y=`https://wa.me/628993370200?text=${encodeURIComponent(f)}`;showToast("Penukaran poin berhasil!"),setTimeout(()=>{window.open(y,"_blank")},1500)}catch(n){console.error("Error in claimReward:",n);const a=buildClaimRewardErrorMessage(n);alert(a)}else alert("Mohon cek poin Anda terlebih dahulu.")}document.addEventListener("DOMContentLoaded",()=>{fetchProducts(),fetchTukarPoin();const e=document.getElementById("product-grid");e&&e.addEventListener("click",u=>{const m=u.target.closest("[data-action]");if(!m||m.disabled)return;const p=m.getAttribute("data-action"),f=m.getAttribute("data-product-id")||m.closest("[data-product-id]")?.getAttribute("data-product-id"),y=findProductById(f);switch(p){case"toggle-wishlist":f&&toggleWishlist(f);break;case"show-detail":y&&showDetail(y);break;case"add-to-cart":y&&addToCart(y,u);break;case"direct-order":y&&directOrder(y);break;case"share-product":y&&shareProduct(y.nama)}});const t=document.getElementById("category-filters");t&&t.addEventListener("click",u=>{const m=u.target.closest('[data-action="set-category"]');if(!m)return;const p=m.getAttribute("data-category");p&&setCategory(p)});const n=document.getElementById("pagination-container");n&&n.addEventListener("click",u=>{const m=u.target.closest('[data-action="change-page"]');if(!m||m.disabled)return;const p=parseInt(m.getAttribute("data-page"),10);Number.isNaN(p)||changePage(p)});const a=document.getElementById("modal-add-cart");a&&a.addEventListener("click",u=>{const m=document.getElementById("detail-modal"),p=findProductById(m?m.dataset.productId:null);if(p){const f=document.getElementById("modal-qty");addToCart(p,u,f?parseInt(f.value):1),closeDetailModal()}});const r=document.getElementById("order-modal");if(r){r.querySelectorAll('input[name="ship-method"], input[name="pay-method"], #customer-name, #customer-phone').forEach(p=>{const f=p.type==="radio"?"change":"input";p.addEventListener(f,updateOrderCTAState)});const u=document.getElementById("customer-phone");u&&u.addEventListener("input",()=>{isPaylaterSelected()&&refreshPaylaterCheckoutState()});const m=document.getElementById("paylater-tenor");m&&m.addEventListener("change",()=>{isPaylaterSelected()&&refreshPaylaterCheckoutState(!0)}),updateOrderCTAState()}const o=document.getElementById("detail-modal");o&&o.addEventListener("click",u=>{const m=u.target.closest('[data-action="select-variation"]');if(!m||m.disabled)return;const p=parseInt(m.getAttribute("data-index"),10);if(!currentModalProduct||!currentModalProduct.variations||Number.isNaN(p))return;const f=currentModalProduct.variations[p];f&&selectVariation(f,p)});const i=document.getElementById("wishlist-items-container");i&&i.addEventListener("click",u=>{const m=u.target.closest("[data-action]");if(!m||m.disabled)return;const p=m.getAttribute("data-action"),f=m.getAttribute("data-product-id"),y=findProductById(f);p==="wishlist-toggle"&&f?toggleWishlist(f):p==="wishlist-buy"&&y&&showDetail(y)});const s=document.getElementById("cart-items");s&&s.addEventListener("click",u=>{const m=u.target.closest("[data-action]");if(!m||m.disabled)return;const p=m.getAttribute("data-action"),f=parseInt(m.getAttribute("data-index"),10),y=parseInt(m.getAttribute("data-delta"),10);p!=="update-cart-qty"||Number.isNaN(f)||Number.isNaN(y)||updateQty(f,y),p!=="remove-cart-item"||Number.isNaN(f)||removeItem(f)});const l=document.getElementById("search-suggestions");l&&l.addEventListener("click",u=>{const m=u.target.closest('[data-action="search-suggestion"]');if(!m)return;const p=m.getAttribute("data-value")||"",f=document.getElementById("search-input");f&&(f.value=p,filterProducts()),closeSearchSuggestions()});const d=document.getElementById("search-suggestions-header");d&&d.addEventListener("click",u=>{const m=u.target.closest('[data-action="search-suggestion"]');if(!m)return;const p=m.getAttribute("data-value")||"",f=document.getElementById("search-input-header"),y=document.getElementById("search-input");f&&(f.value=p),y&&(y.value=p),filterProducts(),closeSearchSuggestions()});const c=document.getElementById("search-input");c&&c.addEventListener("keydown",u=>{u.key==="Escape"&&closeSearchSuggestions(),u.key==="Enter"&&(closeSearchSuggestions(),u.preventDefault(),c.blur())});const g=document.getElementById("search-input-header");g&&g.addEventListener("keydown",u=>{u.key==="Escape"&&closeSearchSuggestions(),u.key==="Enter"&&(closeSearchSuggestions(),u.preventDefault(),g.blur())}),document.addEventListener("click",u=>{u.target.closest("#search-input")||u.target.closest("#search-suggestions")||u.target.closest("#search-input-header")||u.target.closest("#search-suggestions-header")||closeSearchSuggestions()});const h=document.getElementById("search-input-header");h&&(h.addEventListener("input",u=>{const m=u.target.value||"",p=document.getElementById("search-input");p&&(p.value=m),filterProducts()}),h.addEventListener("focus",()=>{const u=document.getElementById("main-header");u&&u.classList.add("header-search-active")}),h.addEventListener("blur",()=>{const u=document.getElementById("main-header");u&&setTimeout(()=>u.classList.remove("header-search-active"),120)}))});let pendingRewardData={id:null,nama:null,poin:null,gambar:null,deskripsi:null};async function showConfirmTukarModal(e){const t=parseFloat(sessionStorage.getItem("user_points"))||0;if(sessionStorage.getItem("reward_phone"))try{const n=await ApiService.get(`?sheet=tukar_poin&action=search&id=${e}`,{cache:!1});if(!n||n.length===0)return void showToast("Data hadiah tidak ditemukan.");const a=n[0],r=parseFloat(a.poin)||0,o=a.nama||a.judul||"Hadiah";if(t<r)return void showToast(`Poin Anda tidak cukup. Dibutuhkan ${r} poin, saldo Anda ${t.toFixed(1)} poin.`);pendingRewardData={id:e,nama:o,poin:r,gambar:a.gambar||"",deskripsi:a.deskripsi||""},document.getElementById("confirm-reward-name").textContent=o,document.getElementById("confirm-reward-points").textContent=r,document.getElementById("confirm-remaining-points").textContent=(t-r).toFixed(1),document.getElementById("confirm-tukar-modal").classList.remove("hidden"),document.body.classList.add("modal-active")}catch(n){console.error("Error showing confirm modal:",n),showToast("Terjadi kesalahan saat memproses permintaan Anda.")}else showToast("Mohon cek poin Anda terlebih dahulu.")}function cancelTukarModal(){document.getElementById("confirm-tukar-modal").classList.add("hidden"),document.body.classList.remove("modal-active"),pendingRewardData={id:null,nama:null,poin:null,gambar:null,deskripsi:null}}function proceedToNameInput(){document.getElementById("confirm-tukar-modal").classList.add("hidden"),document.getElementById("name-input-modal").classList.remove("hidden"),setTimeout(()=>{document.getElementById("claim-name-input").focus()},100)}function backToConfirmModal(){document.getElementById("name-input-modal").classList.add("hidden"),document.getElementById("confirm-tukar-modal").classList.remove("hidden"),document.getElementById("claim-name-input").value=""}async function submitNameAndClaim(){const e=document.getElementById("claim-name-input").value.trim();e?e.length<3?showToast("Nama harus minimal 3 karakter."):(document.getElementById("name-input-modal").classList.add("hidden"),document.body.classList.remove("modal-active"),await processClaimReward(pendingRewardData.id,e)):showToast("Mohon masukkan nama Anda terlebih dahulu.")}async function processClaimReward(e,t){const n=sessionStorage.getItem("reward_phone");try{const a=await ApiService.get(`?sheet=tukar_poin&action=search&id=${e}`,{cache:!1});if(!a||a.length===0)return void showToast("Data hadiah tidak ditemukan.");const r=a[0],o=parseFloat(r.poin)||0,i=r.nama||r.judul||"Hadiah",s=parseFloat(sessionStorage.getItem("user_points"))||0;showToast("Sedang memproses penukaran...");const l=`RW-${Date.now()}-${Math.floor(1e5*Math.random())}`,d=await GASActions.post({action:"claim_reward",sheet:"tukar_poin",data:{reward_id:e,phone:n,customer_name:t,request_id:l}}),c=d.claim_id||"CLM-"+Date.now().toString().slice(-6),g=parseFloat(d.points_used||o)||0,h=parseFloat(d.balance_after),u=Number.isNaN(h)?Math.max(0,s-g):h;sessionStorage.setItem("user_points",u);const m=document.querySelector("#points-display h4");m&&(m.innerHTML=`${escapeHtml(u.toFixed(1))} <span class="text-sm font-bold">Poin</span>`);const p=`*KLAIM REWARD POIN BERHASIL*

ID Klaim: ${c}
Pelanggan: ${t}
Nomor WhatsApp: ${n}
Reward: ${i}
Poin Ditukar: ${g}
Sisa Poin: ${u.toFixed(1)}

Mohon segera diproses. Terima kasih!`,f=`https://wa.me/628993370200?text=${encodeURIComponent(p)}`;window.claimWhatsAppUrl=f,pendingRewardData={id:null,nama:null,poin:null,gambar:null,deskripsi:null},document.getElementById("name-input-modal").classList.add("hidden"),document.getElementById("confirm-tukar-modal").classList.add("hidden"),setTimeout(()=>{showClaimSuccessModal(c)},300)}catch(a){console.error("Error processing claim:",a),showToast(buildClaimRewardErrorMessage(a))}}function buildClaimRewardErrorMessage(e){const t=String(e&&e.message||e||"").toLowerCase();return t.includes("reward_stock_empty")?"Stok reward sedang habis.":t.includes("reward_daily_quota_reached")?"Quota harian reward sudah habis.":t.includes("points_insufficient")?"Poin Anda tidak cukup untuk reward ini.":t.includes("user_not_found")?"Data poin pengguna tidak ditemukan.":t.includes("rate_limited")?"Terlalu banyak percobaan klaim, coba lagi sebentar.":"Gagal memproses penukaran. Silakan coba lagi."}const WISHLIST_KEY="gos_wishlist";function getWishlist(){const e=localStorage.getItem(WISHLIST_KEY);return e?JSON.parse(e):[]}function saveWishlist(e){localStorage.setItem(WISHLIST_KEY,JSON.stringify(e)),updateWishlistCount()}function toggleWishlist(e){let t=getWishlist();const n=t.indexOf(e);n>-1?(t.splice(n,1),showToast("Produk dihapus dari Wishlist.")):(t.push(e),showToast("Produk ditambahkan ke Wishlist!")),saveWishlist(t),updateProductWishlistIcon(e);const a=document.getElementById("wishlist-modal");a&&!a.classList.contains("hidden")&&renderWishlistItems()}function isProductInWishlist(e){return getWishlist().includes(e)}function updateWishlistCount(){const e=getWishlist().length,t=document.getElementById("wishlist-count");t&&(t.textContent=e,e>0?t.classList.remove("hidden"):t.classList.add("hidden"))}function updateProductWishlistIcon(e){const t=document.getElementById(`wishlist-btn-${e}`);if(!t)return;const n=isProductInWishlist(e)?'<svg class="w-5 h-5 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>':'<svg class="w-5 h-5 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>';t.innerHTML=n}function openWishlistModal(){const e=document.getElementById("wishlist-modal");e&&(e.classList.remove("hidden"),document.body.classList.add("modal-active"),renderWishlistItems())}function closeWishlistModal(){const e=document.getElementById("wishlist-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}async function renderWishlistItems(){const e=getWishlist(),t=document.getElementById("wishlist-items-container");if(console.log("\u{1F50D} Rendering wishlist items:",{wishlistIds:e,containerFound:!!t}),!t)return;if(e.length===0)return void(t.innerHTML=`
            <div class="text-center py-10">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                <p class="text-gray-500 font-semibold">Wishlist Anda kosong.</p>
                <p class="text-gray-400 text-sm mt-2">Tambahkan produk favorit Anda!</p>
            </div>
        `);if(!allProducts||allProducts.length===0){console.log("\u{1F4E6} Fetching products for wishlist...");try{await fetchProducts(),console.log("\u2705 Products fetched:",allProducts.length)}catch(r){return console.error("\u274C Failed to fetch products:",r),void(t.innerHTML='<p class="text-center text-red-500 py-4">Gagal memuat produk. Silakan refresh halaman.</p>')}}const n=new Set(e.map(r=>String(r).trim()));console.log("\u{1F50D} Wishlist Set:",Array.from(n));const a=allProducts.filter(r=>{const o=String(r.productId||"").trim(),i=n.has(o);return i&&console.log("\u2705 Found wishlist product:",o,r.nama),i});console.log("\u{1F4CA} Wishlist products found:",a.length),a.length!==0?(t.innerHTML=a.map(r=>{const o=r.productId,i=parseFloat(r.harga_tunai||r.harga||0),s=r.gambar?String(r.gambar).split(",")[0].trim():"";return`
            <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 transition">
                <div class="flex items-center gap-3 flex-1">
                    <img src="${sanitizeUrl(s,"https://placehold.co/100x100?text=Produk")}" alt="${escapeHtml(r.nama)}" class="w-16 h-16 object-cover rounded-lg shadow-sm" data-fallback-src="https://placehold.co/100x100?text=Produk">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-800">${escapeHtml(r.nama)}</p>
                        <p class="text-xs text-green-600 font-bold mt-1">Rp ${i.toLocaleString("id-ID")}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="button" data-action="wishlist-toggle" data-product-id="${o}" class="text-red-500 hover:text-red-700 p-2 transition active:scale-95" title="Hapus dari Wishlist">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </button>
                    <button type="button" data-action="wishlist-buy" data-product-id="${o}" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition active:scale-95">
                        Beli
                    </button>
                </div>
            </div>
        `}).join(""),console.log("\u2705 Wishlist rendered successfully")):t.innerHTML='<p class="text-center text-gray-500 py-4">Produk tidak ditemukan. Mungkin produk sudah tidak tersedia.</p>'}function showQRISModal(){const e=document.getElementById("qris-modal");e&&e.classList.remove("hidden")}function closeQRISModal(){const e=document.getElementById("qris-modal");e&&e.classList.add("hidden")}async function handleDeepLink(){if(console.log("[DeepLink] Checking for hash:",window.location.hash),allProducts.length===0)return console.log("[DeepLink] Products not loaded yet, waiting..."),void setTimeout(handleDeepLink,500);if(window.location.hash){const e=window.location.hash.substring(1);if(console.log("[DeepLink] Hash found:",e),e.startsWith("produk-")){const t=e.substring(7);console.log("[DeepLink] Looking for product with slug:",t);const n=findProductBySlug(t);n?(console.log("[DeepLink] Product found:",n.nama),setTimeout(()=>{showDetail(n)},500)):console.warn("[DeepLink] Product with slug not found:",t)}}}function showClaimSuccessModal(e){console.log("showClaimSuccessModal called with claimId:",e);const t=document.getElementById("claim-success-modal"),n=document.getElementById("claim-success-id");console.log("Modal element:",t),console.log("Claim ID element:",n),t&&n?(n.textContent=e,t.classList.remove("hidden"),console.log("Modal should now be visible")):console.error("Modal or claimIdElement not found!")}function closeClaimSuccessModal(){const e=document.getElementById("claim-success-modal");e&&e.classList.add("hidden")}function openClaimWhatsApp(){window.claimWhatsAppUrl&&(window.open(window.claimWhatsAppUrl,"_blank"),setTimeout(()=>{closeClaimSuccessModal()},500))}function updatePaymentMethodInfo(e){const t=document.getElementById("payment-method-info"),n=document.getElementById("payment-method-info-text"),a=document.getElementById("qris-display");if(!t||!n)return;const r={tunai:"Pembayaran dilakukan secara tunai saat pesanan diterima atau diambil.",qris:"Pembayaran dilakukan melalui QRIS menggunakan e-wallet atau mobile banking.",gajian:"Pembayaran ditagihkan pada periode gajian berikutnya, jatuh tempo tanggal 6-7.",paylater:"PayLater membutuhkan akun login yang valid, limit cukup, dan tanpa tagihan aktif. Simulasi biaya ditampilkan sebelum konfirmasi."};t.classList.contains("hidden")||t.classList.add("opacity-0","scale-95"),a&&!a.classList.contains("hidden")&&a.classList.add("opacity-0","scale-95"),setTimeout(()=>{r[e]?(n.textContent=r[e],t.classList.remove("hidden"),t.offsetWidth,setTimeout(()=>{t.classList.remove("opacity-0","scale-95"),t.classList.add("opacity-100","scale-100")},10)):t.classList.add("hidden"),a&&(e==="qris"?(a.classList.remove("hidden"),a.offsetWidth,setTimeout(()=>{a.classList.remove("opacity-0","scale-95"),a.classList.add("opacity-100","scale-100")},10)):a.classList.add("hidden")),e==="paylater"?refreshPaylaterCheckoutState():renderPaylaterCheckoutState()},150)}function openCategorySidebar(){const e=document.getElementById("category-sidebar"),t=document.getElementById("sidebar-overlay");e&&t&&(t.classList.remove("hidden"),setTimeout(()=>{e.classList.remove("-translate-x-full"),e.classList.add("translate-x-0")},10),document.body.style.overflow="hidden",loadSidebarCategories())}function closeCategorySidebar(){const e=document.getElementById("category-sidebar"),t=document.getElementById("sidebar-overlay");e&&t&&(e.classList.remove("translate-x-0"),e.classList.add("-translate-x-full"),setTimeout(()=>{t.classList.add("hidden")},300),document.body.style.overflow="")}function loadSidebarCategories(){const e=document.getElementById("sidebar-category-list");if(!e)return;const t=getDisplayCategories().map(a=>{const r=getCategoryIcon(a),o=escapeHtml(a);return`
            <li class="border-b border-gray-100 last:border-0">
                <button type="button" data-action="select-sidebar-category" data-category="${o}" class="flex items-center gap-3 py-3 px-2 hover:bg-green-50 rounded-lg transition group">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition">
                        ${r}
                    </div>
                    <span class="font-semibold text-gray-700 group-hover:text-green-700">${o}</span>
                </button>
            </li>
        `}).join(""),n=e.querySelector("li");e.innerHTML=n?n.outerHTML+t:t}function getCategoryIcon(e){return`
        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
        </svg>
    `}function selectSidebarCategory(e){setCategory(e),closeCategorySidebar();const t=document.getElementById("products");t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function updateMobileCartCount(){const e=document.getElementById("mobile-cart-count"),t=document.getElementById("cart-count");if(e&&t){const n=cart.length;n>0?(e.textContent=n,e.classList.remove("hidden")):e.classList.add("hidden")}}document.addEventListener("DOMContentLoaded",updateWishlistCount),window.addEventListener("hashchange",handleDeepLink,!1),document.addEventListener("DOMContentLoaded",()=>{setTimeout(handleDeepLink,1e3)});const originalUpdateCartUI=updateCartUI;updateCartUI=function(){typeof originalUpdateCartUI=="function"&&originalUpdateCartUI(),updateMobileCartCount()},document.addEventListener("DOMContentLoaded",function(){updateMobileCartCount()});const normalizePhoneTo08=e=>{const t=String(e??"").replace(/[^0-9]/g,"");if(!t)return"";let n=t;return n.startsWith("62")&&(n=n.slice(2)),n.startsWith("0")&&(n=n.slice(1)),n.startsWith("8")?"0"+n:""},phoneLookupVariants=e=>{const t=normalizePhoneTo08(e);if(!t)return[];const n=t.slice(1);return[t,`+62${n}`,`62${n}`,n]},displayPhone=e=>normalizePhoneTo08(e)||e||"",parseSheetResponse=e=>Array.isArray(e)?e:e&&Array.isArray(e.result)?e.result:e&&e.result?Array.isArray(e.result)?e.result:[e.result]:[],buildSessionQuery=e=>{const t=String(e&&e.session_token||"").trim();return t?`&session_token=${encodeURIComponent(t)}`:""},hasPublicSession=e=>String(e&&e.session_token||"").trim()!=="",SESSION_INVALID_MESSAGE="Session login tidak valid. Silakan login ulang.",NETWORK_ERROR_MESSAGE="Gagal memuat data. Periksa koneksi lalu coba lagi.",SECTION_UI_MAP={referral:{loadingId:"referral-loading",errorId:"referral-error",errorTextId:"referral-error-text",loginCtaId:"referral-login-cta",retryAction:"retry-referral"},paylater:{loadingId:"paylater-loading",errorId:"paylater-error",errorTextId:"paylater-error-text",loginCtaId:"paylater-login-cta",retryAction:"retry-paylater"},orders:{loadingId:"order-loading",errorId:"order-error",errorTextId:"order-error-text",loginCtaId:"orders-login-cta",retryAction:"retry-orders"},points:{loadingId:"points-loading",errorId:"points-error",errorTextId:"points-error-text",loginCtaId:"points-login-cta",retryAction:"retry-points"}};let lastPaylaterDetailInvoiceId="";function createAkunError(e,t){const n=new Error(e||"Unknown error");return n.code=String(t||"").toUpperCase(),n.isSessionError=n.code==="UNAUTHORIZED_SESSION",n}function setPointsStaleNotice(e){const t=document.getElementById("points-stale-note");t&&t.classList.toggle("hidden",!e)}function setSectionLoading(e,t){const n=SECTION_UI_MAP[e];if(!n||!n.loadingId)return;const a=document.getElementById(n.loadingId);a&&a.classList.toggle("hidden",!t)}function clearSectionError(e){const t=SECTION_UI_MAP[e];if(!t)return;const n=t.errorId?document.getElementById(t.errorId):null,a=t.errorTextId?document.getElementById(t.errorTextId):null,r=t.loginCtaId?document.getElementById(t.loginCtaId):null;n&&n.classList.add("hidden"),a&&(a.textContent=""),r&&r.classList.add("hidden")}function setSectionError(e,t,n){const a=SECTION_UI_MAP[e];if(!a)return;const r=a.errorId?document.getElementById(a.errorId):null,o=a.errorTextId?document.getElementById(a.errorTextId):null,i=a.loginCtaId?document.getElementById(a.loginCtaId):null,s=r?r.querySelector('[data-action^="retry-"]'):null,l=String(t||NETWORK_ERROR_MESSAGE);if(o&&(o.textContent=l),s&&s.setAttribute("data-action",n||a.retryAction),i){const d=l.indexOf(SESSION_INVALID_MESSAGE)!==-1;i.classList.toggle("hidden",!d)}r&&r.classList.remove("hidden")}function isSessionError(e){if(!e||typeof e!="object")return!1;const t=String(e.error||e.error_code||"").toLowerCase(),n=String(e.message||"").toLowerCase();return t==="unauthorized_session"||t==="session_unavailable"||n.indexOf("session login tidak valid")!==-1}function parsePublicSuccess(e,t){if(e&&e.success===!0)return e;throw isSessionError(e)?createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION"):createAkunError(String(e&&(e.message||e.error||e.error_code)||t||NETWORK_ERROR_MESSAGE).trim(),String(e&&(e.error||e.error_code)||"").toUpperCase())}function resolvePublicErrorMessage(e,t){if(!e)return t||NETWORK_ERROR_MESSAGE;const n=String(e.code||"").toUpperCase(),a=String(e.message||"").trim(),r=a.toLowerCase();return e.isSessionError||n==="UNAUTHORIZED_SESSION"||r.indexOf("session")!==-1?SESSION_INVALID_MESSAGE:r.indexOf("failed to fetch")!==-1||r.indexOf("network")!==-1||r.indexOf("rate limit")!==-1||r.indexOf("http ")!==-1||r.indexOf("timeout")!==-1?NETWORK_ERROR_MESSAGE:a||t||NETWORK_ERROR_MESSAGE}async function akunApiGet(e,t={}){if(typeof ApiService>"u"||typeof ApiService.get!="function")throw createAkunError("ApiService belum tersedia.","API_SERVICE_UNAVAILABLE");return ApiService.get(e,{cache:!1,maxRetries:3,...t})}async function akunApiPost(e,t={}){if(typeof ApiService>"u"||typeof ApiService.post!="function")throw createAkunError("ApiService belum tersedia.","API_SERVICE_UNAVAILABLE");return ApiService.post("",e,{cache:!1,maxRetries:2,...t})}let referralProfileCache=null,pendingReferralCodeFromUrl="",referralConfigCache={rewardReferrerPoints:20,rewardRefereePoints:10,minFirstOrder:5e4};function toReferralCodeValue(e){return String(e||"").trim().toUpperCase()}function getReferralCodeFromUrl(){try{const e=new URLSearchParams(window.location.search||"");return toReferralCodeValue(e.get("ref")||e.get("referral")||e.get("kode_referral")||"")}catch(e){return console.warn("Failed parsing referral code from URL:",e),""}}function buildReferralShareUrl(e){const t=toReferralCodeValue(e);if(!t||t==="-")return"";const n=new URL(`${window.location.origin}${window.location.pathname}`);return n.searchParams.set("ref",t),n.toString()}function updateRegisterReferralInfo(){const e=document.getElementById("register-referral-info"),t=document.getElementById("register-referral-info-text");e&&t&&(pendingReferralCodeFromUrl?(t.textContent=`Referral dari link aktif: ${pendingReferralCodeFromUrl}`,e.classList.remove("hidden")):e.classList.add("hidden"))}function buildReferralShareMessage(e,t){const n=toReferralCodeValue(e);if(!n||n==="-"||!t)return"";const a=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,r=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,o=parseInt(referralConfigCache.minFirstOrder||0,10)||0;return["Halo, yuk daftar GoSembako pakai link referral saya.","",`Link: ${t}`,`Kode Referral: ${n}`,"",`Bonus pengguna baru: ${r} poin`,`Bonus pengajak: ${a} poin`,`Bonus aktif setelah pesanan pertama selesai (minimal ${o>0?formatCurrency(o):"sesuai ketentuan program"}).`,"","Terima kasih."].join(`
`)}function updateReferralShareUI(e){const t=toReferralCodeValue(e&&e.kode_referral||referralProfileCache&&referralProfileCache.kode_referral||getLoggedInUser()&&getLoggedInUser().kode_referral||""),n=buildReferralShareUrl(t),a=document.getElementById("referral-code-display"),r=document.getElementById("referral-share-message"),o=document.getElementById("referral-reward-info");if(a&&(a.value=n||"-",a.dataset.referralCode=t||""),r&&(r.textContent=n?buildReferralShareMessage(t,n):"Link referral akan muncul setelah kode referral tersedia."),o){const i=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,s=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,l=parseInt(referralConfigCache.minFirstOrder||0,10)||0;o.textContent=`Pengajak: ${i} poin, Pengguna baru: ${s} poin (setelah pesanan pertama selesai${l>0?`, minimal ${formatCurrency(l)}`:""}).`}}function getCurrentReferralCode(){const e=document.getElementById("referral-code-display"),t=toReferralCodeValue(e?.dataset?.referralCode||"");return t||toReferralCodeValue(getLoggedInUser()?.kode_referral||"")}async function loadPublicReferralConfig(){try{const e=parsePublicSuccess(await akunApiGet("?action=public_referral_config",{cache:!0,cacheDuration:3e5}),"Gagal memuat konfigurasi referral.");referralConfigCache={rewardReferrerPoints:parseInt(e.reward_referrer_points||referralConfigCache.rewardReferrerPoints,10)||referralConfigCache.rewardReferrerPoints,rewardRefereePoints:parseInt(e.reward_referee_points||referralConfigCache.rewardRefereePoints,10)||referralConfigCache.rewardRefereePoints,minFirstOrder:parseInt(e.min_first_order||referralConfigCache.minFirstOrder,10)||referralConfigCache.minFirstOrder}}catch(e){console.warn("Failed to load public referral config:",e)}}function setReferralStatus(e,t){const n=document.getElementById("referral-status");n&&(n.textContent=e||"",n.className="text-xs",t==="success"?n.classList.add("text-green-600"):t==="error"?n.classList.add("text-red-600"):t==="warning"?n.classList.add("text-amber-600"):n.classList.add("text-gray-500"))}function applyReferralDataToUI(e){const t=document.getElementById("referral-code-display"),n=document.getElementById("referral-input"),a=document.getElementById("apply-referral-btn"),r=document.getElementById("referral-count"),o=document.getElementById("referral-points-total");t&&(t.value="-"),r&&(r.textContent=String(parseInt(e.referral_count||0,10)||0)),o&&(o.textContent=String(parseInt(e.referral_points_total||0,10)||0));const i=toReferralCodeValue(e.referred_by)!=="";n&&(n.value=i?toReferralCodeValue(e.referred_by):"",n.disabled=i),a&&(a.disabled=i),i?setReferralStatus(`Referral aktif dengan kode: ${toReferralCodeValue(e.referred_by)}`,"success"):setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info"),updateReferralShareUI(e)}function buildReferralProfileFallback(e){return{id:e&&e.id?e.id:"",nama:e&&e.nama?e.nama:"User",whatsapp:normalizePhoneTo08(e&&(e.whatsapp||e.phone)||""),kode_referral:toReferralCodeValue(e&&e.kode_referral?e.kode_referral:""),referred_by:toReferralCodeValue(e&&e.referred_by?e.referred_by:""),referral_count:parseInt(e&&e.referral_count||0,10)||0,referral_points_total:parseInt(e&&e.referral_points_total||0,10)||0}}function getReferralStatusBadge(e){const t=String(e||"").toLowerCase();return t==="approved"?'<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold">Approved</span>':t==="rejected"||t==="void"?'<span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold">Rejected</span>':'<span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">Pending</span>'}async function loadReferralHistory(e){const t=document.getElementById("referral-history-list"),n=document.getElementById("referral-history-badge");if(!t||!n)return;const a=buildSessionQuery(e);if(!a)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const r=parsePublicSuccess(await akunApiGet(`?action=public_referral_history${a}`),"Gagal memuat riwayat referral."),o=normalizePhoneTo08(e.whatsapp),i=(Array.isArray(r.referrals)?r.referrals:[]).filter(s=>{const l=normalizePhoneTo08(s.referrer_phone||""),d=normalizePhoneTo08(s.referee_phone||"");return l===o||d===o}).sort((s,l)=>new Date(l.created_at||0).getTime()-new Date(s.created_at||0).getTime()).slice(0,10);n.textContent=`${i.length} data`,i.length!==0?t.innerHTML=i.map(s=>{const l=normalizePhoneTo08(s.referrer_phone||"")===o?"Anda mengajak":"Anda diajak",d=normalizePhoneTo08(l==="Anda mengajak"?s.referee_phone||"":s.referrer_phone||""),c=l==="Anda mengajak"?parseInt(s.reward_referrer_points||0,10)||0:parseInt(s.reward_referee_points||0,10)||0;return`
            <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                <div class="flex items-center justify-between mb-1">
                    <span class="font-bold text-gray-700">${escapeHtml(l)}</span>
                    ${getReferralStatusBadge(s.status)}
                </div>
                <p class="text-gray-600">No: ${escapeHtml(d||"-")}</p>
                <p class="text-green-700 font-semibold">Reward: ${escapeHtml(String(c))} poin</p>
            </div>
        `}).join(""):t.innerHTML='<p class="text-gray-400">Belum ada riwayat referral.</p>'}async function fetchPublicReferralProfile(e){const t=buildSessionQuery(e);if(!t)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");return parsePublicSuccess(await akunApiGet(`?action=public_user_profile${t}`),"Gagal memuat profil referral.").user||null}async function loadReferralData(e){clearSectionError("referral"),setSectionLoading("referral",!0);try{const t=await fetchPublicReferralProfile(e);if(!t)throw createAkunError("Profil referral tidak tersedia","REFERRAL_PROFILE_NOT_FOUND");referralProfileCache=t,applyReferralDataToUI(t),await loadReferralHistory({...e,session_token:String(e.session_token||t.session_token||"").trim()})}catch(t){console.error("Error loading referral data:",t),applyReferralDataToUI(buildReferralProfileFallback(e)),setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info");const n=document.getElementById("referral-history-list"),a=document.getElementById("referral-history-badge");a&&(a.textContent="error"),n&&(n.innerHTML='<p class="text-red-500">Gagal memuat riwayat referral.</p>'),setSectionError("referral",resolvePublicErrorMessage(t),"retry-referral")}finally{setSectionLoading("referral",!1)}}function showLogin(){document.getElementById("login-section").classList.remove("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showDashboard(e){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.remove("hidden"),document.getElementById("user-name").textContent=e.nama,document.getElementById("user-whatsapp").textContent=displayPhone(e.whatsapp),loadLoyaltyPoints(e),loadReferralData(e),loadPaylaterData(e),loadOrderHistory(e)}function retryReferralSection(){const e=getLoggedInUser();e?loadReferralData(e):showLogin()}function retryPaylaterSection(){const e=getLoggedInUser();e?loadPaylaterData(e):showLogin()}function retryOrdersSection(){const e=getLoggedInUser();e?loadOrderHistory(e):showLogin()}function retryPointsSection(){const e=getLoggedInUser();e?loadLoyaltyPoints(e):showLogin()}function mapPublicLoginError(e){const t=String(e&&(e.error||e.error_code)||"").toUpperCase();return t==="LOGIN_FAILED"?"Nomor WhatsApp atau PIN salah":t==="ACCOUNT_INACTIVE"?"Akun Anda tidak aktif. Hubungi admin.":t==="RATE_LIMITED"?String(e.message||"Terlalu banyak percobaan login, coba lagi."):t==="UNAUTHORIZED_SESSION"?SESSION_INVALID_MESSAGE:String(e&&e.message||"Login gagal. Silakan coba lagi.")}function showError(e){const t=document.getElementById("login-error");document.getElementById("login-error-text").textContent=e,t.classList.remove("hidden")}function resetLoginButton(){const e=document.getElementById("login-btn");e.disabled=!1,e.innerHTML=`
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
        </svg>
        Masuk
    `}function saveLoggedInUser(e){const t=normalizePhoneTo08(e.whatsapp||e.phone||"");localStorage.setItem("gosembako_user",JSON.stringify({id:e.id,nama:e.nama,whatsapp:t||e.whatsapp,tanggal_daftar:e.tanggal_daftar,status:e.status||"",total_points:parseInt(e.total_points||e.points||e.poin||0,10)||0,kode_referral:toReferralCodeValue(e.kode_referral||""),referred_by:toReferralCodeValue(e.referred_by||""),referral_count:parseInt(e.referral_count||0,10)||0,referral_points_total:parseInt(e.referral_points_total||0,10)||0,session_token:String(e.session_token||"").trim()}))}function getLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?(t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||"")||t.whatsapp||"",t.session_token=String(t.session_token||t.sessionToken||t.st||"").trim(),t):null}catch(t){return console.warn("Invalid gosembako_user payload:",t),null}}function logout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("gosembako_user"),window.location.reload())}async function copyReferralCode(){const e=getCurrentReferralCode();if(!e||e==="-")return void setReferralStatus("Link referral belum tersedia.","warning");const t=buildReferralShareUrl(e);if(t)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t);else{const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}setReferralStatus("Link referral berhasil disalin.","success")}catch(n){console.error("Copy referral failed:",n),setReferralStatus("Gagal menyalin link referral.","error")}else setReferralStatus("Link referral tidak tersedia.","warning")}function shareReferralWhatsApp(){const e=getCurrentReferralCode(),t=buildReferralShareUrl(e);if(!t)return void setReferralStatus("Link referral belum tersedia.","warning");const n=buildReferralShareMessage(e,t),a=`https://wa.me/?text=${encodeURIComponent(n)}`;window.open(a,"_blank","noopener"),setReferralStatus("Link referral siap dibagikan ke WhatsApp.","success")}async function applyReferralCode(){const e=getLoggedInUser();if(!e)return void setReferralStatus("Silakan login ulang.","error");const t=document.getElementById("referral-input"),n=document.getElementById("apply-referral-btn"),a=toReferralCodeValue(t?t.value:"");if(!a)return void setReferralStatus("Masukkan kode referral terlebih dahulu.","warning");const r=getCurrentReferralCode();if(r&&a===r)return void setReferralStatus("Kode referral sendiri tidak bisa dipakai.","error");if(t&&t.disabled)return void setReferralStatus("Kode referral sudah pernah diterapkan.","warning");const o=n?n.textContent:"";try{n&&(n.disabled=!0,n.textContent="Memproses...");const i=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:normalizePhoneTo08(e.whatsapp),ref_code:a}});if(!i||i.success===!1)return setReferralStatus(i&&(i.message||i.error||i.error_code)||"Gagal menerapkan referral","error"),void(n&&(n.disabled=!1,n.textContent=o||"Terapkan"));t&&(t.value=a,t.disabled=!0),n&&(n.disabled=!0,n.textContent="Terapkan"),setReferralStatus("Kode referral berhasil diterapkan.","success"),await loadReferralData(e)}catch(i){console.error("applyReferralCode error:",i),setReferralStatus(i.message||"Gagal menerapkan kode referral.","error"),n&&(n.disabled=!1,n.textContent=o||"Terapkan")}}async function loadLoyaltyPoints(e){const t=document.getElementById("loyalty-points");if(!t)return;const n=parseInt(e.total_points||e.points||e.poin||0,10)||0;clearSectionError("points"),setSectionLoading("points",!0),setPointsStaleNotice(!1);try{const a=buildSessionQuery(e);if(!a)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const r=parsePublicSuccess(await akunApiGet(`?action=public_user_points${a}`),"Gagal memuat poin loyalitas."),o=parseInt(r.points||0,10)||0;t.textContent=String(o),setRewardContextFromAkun(e.whatsapp,o,e.nama)}catch(a){console.error("Error loading loyalty points:",a),t.textContent=String(n),setRewardContextFromAkun(e.whatsapp,n,e.nama),setPointsStaleNotice(!0),setSectionError("points",`${resolvePublicErrorMessage(a)} data bisa tidak terbaru`,"retry-points")}finally{setSectionLoading("points",!1)}}function getPaylaterStatusBadgeClass(e){const t=String(e||"").toLowerCase().trim();return t==="active"?"bg-green-100 text-green-700":t==="frozen"?"bg-amber-100 text-amber-700":t==="locked"||t==="overdue"?"bg-red-100 text-red-700":t==="paid"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}function renderPaylaterSummary(e){const t=e&&e.account||{},n=e&&e.summary||{},a=String(t.status||"inactive").toLowerCase().trim(),r=document.getElementById("paylater-account-status"),o=document.getElementById("paylater-credit-limit"),i=document.getElementById("paylater-available-limit"),s=document.getElementById("paylater-used-limit"),l=document.getElementById("paylater-invoice-total"),d=document.getElementById("paylater-invoice-active"),c=document.getElementById("paylater-invoice-overdue"),g=document.getElementById("paylater-remaining-open");r&&(r.textContent=a||"inactive",r.className=`text-xs font-bold px-2 py-1 rounded-full ${getPaylaterStatusBadgeClass(a)}`),o&&(o.textContent=formatCurrency(t.credit_limit||0)),i&&(i.textContent=formatCurrency(t.available_limit||0)),s&&(s.textContent=formatCurrency(t.used_limit||0)),l&&(l.textContent=String(parseInt(n.invoice_count_total||0,10)||0)),d&&(d.textContent=String(parseInt(n.invoice_count_active||0,10)||0)),c&&(c.textContent=String(parseInt(n.invoice_count_overdue||0,10)||0)),g&&(g.textContent=formatCurrency(n.remaining_open||0))}function renderPaylaterInvoices(e){const t=document.getElementById("paylater-invoice-list"),n=document.getElementById("paylater-history-badge");if(!t)return;const a=Array.isArray(e)?e:[];n&&(n.textContent=`${a.length} data`),a.length?t.innerHTML=a.slice(0,10).map(r=>{const o=String(r.invoice_id||r.id||"-"),i=String(r.status||"active").toLowerCase(),s=parseCurrencyValue(r.total_due||0),l=parseCurrencyValue(r.paid_amount||0),d=Math.max(0,s-l),c=formatDate(r.due_date||r.created_at||"");return`
            <div class="rounded-xl border border-gray-200 p-3 bg-white">
                <div class="flex items-center justify-between gap-2 mb-2">
                    <p class="font-bold text-gray-800">${escapeHtml(o)}</p>
                    <span class="text-[10px] font-bold px-2 py-1 rounded-full ${getPaylaterStatusBadgeClass(i)}">${escapeHtml(i)}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[11px] text-gray-600">
                    <p>Total Due: <span class="font-bold text-gray-800">${escapeHtml(formatCurrency(s))}</span></p>
                    <p>Sisa: <span class="font-bold text-red-600">${escapeHtml(formatCurrency(d))}</span></p>
                    <p>Paid: <span class="font-bold text-green-700">${escapeHtml(formatCurrency(l))}</span></p>
                    <p>Jatuh Tempo: <span class="font-bold text-gray-800">${escapeHtml(c)}</span></p>
                </div>
                <div class="mt-2">
                    <button type="button" data-action="view-paylater-invoice" data-invoice-id="${escapeHtml(o)}" class="text-xs font-bold px-3 py-1.5 rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-700 transition">Lihat Detail</button>
                </div>
            </div>
        `}).join(""):t.innerHTML='<p class="text-gray-400">Belum ada riwayat invoice.</p>'}function closePaylaterDetailModal(){const e=document.getElementById("paylater-detail-modal");e&&e.classList.add("hidden")}async function openPaylaterDetailModal(e){const t=getLoggedInUser();if(!t||!e)return;const n=document.getElementById("paylater-detail-modal"),a=document.getElementById("paylater-detail-content");if(n&&a){lastPaylaterDetailInvoiceId=String(e||"").trim(),n.classList.remove("hidden"),a.innerHTML='<p class="text-gray-500">Memuat detail tagihan...</p>';try{const r=buildSessionQuery(t);if(!r)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const o=parsePublicSuccess(await akunApiGet(`?action=public_paylater_invoice_detail&invoice_id=${encodeURIComponent(e)}${r}`),"Gagal memuat detail tagihan."),i=o.invoice||{},s=Array.isArray(o.ledger)?o.ledger:[],l=parseCurrencyValue(i.total_due||0),d=parseCurrencyValue(i.paid_amount||0),c=Math.max(0,l-d),g=String(i.status||"").toLowerCase().trim(),h=c>0&&!["paid","cancelled","defaulted"].includes(g),u=String(i.invoice_id||i.id||e||"-"),m=`https://wa.me/628993370200?text=${`KONFIRMASI PEMBAYARAN PAYLATER%0A%0AInvoice: ${encodeURIComponent(u)}%0ATotal Due: ${encodeURIComponent(formatCurrency(l))}%0ASudah Dibayar: ${encodeURIComponent(formatCurrency(d))}%0ASisa Tagihan: ${encodeURIComponent(formatCurrency(c))}%0AMohon verifikasi pembayaran saya.`}`,p=s.length?s.map(y=>`
                    <div class="rounded-lg border border-gray-200 p-2">
                        <p class="text-xs font-bold text-gray-700">${escapeHtml(String(y.type||"-"))}</p>
                        <p class="text-xs text-gray-600">${escapeHtml(formatDate(y.created_at||""))}</p>
                        <p class="text-xs text-gray-700">Amount: <span class="font-bold">${escapeHtml(formatCurrency(y.amount||0))}</span></p>
                        <p class="text-xs text-gray-500">${escapeHtml(String(y.note||"-"))}</p>
                    </div>
                `).join(""):'<p class="text-xs text-gray-500">Belum ada ledger untuk invoice ini.</p>',f=h?`
                <div class="pt-3 border-t border-gray-100">
                    <button type="button" data-action="confirm-paylater-payment" data-wa-link="${escapeHtml(m)}" class="w-full bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 rounded-lg transition">
                        Konfirmasi Bayar via WhatsApp
                    </button>
                </div>
              `:"";a.innerHTML=`
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">
                    <p class="text-xs text-gray-500">Invoice ID</p>
                    <p class="font-bold text-gray-800">${escapeHtml(String(i.invoice_id||i.id||"-"))}</p>
                </div>
                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">
                    <p class="text-xs text-gray-500">Status</p>
                    <p class="font-bold text-gray-800">${escapeHtml(String(i.status||"-"))}</p>
                </div>
                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">
                    <p class="text-xs text-gray-500">Total Due</p>
                    <p class="font-bold text-gray-800">${escapeHtml(formatCurrency(l))}</p>
                </div>
                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">
                    <p class="text-xs text-gray-500">Sisa Tagihan</p>
                    <p class="font-bold text-red-700">${escapeHtml(formatCurrency(c))}</p>
                </div>
                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">
                    <p class="text-xs text-gray-500">Jatuh Tempo</p>
                    <p class="font-bold text-gray-800">${escapeHtml(formatDate(i.due_date||"-"))}</p>
                </div>
                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">
                    <p class="text-xs text-gray-500">Tenor</p>
                    <p class="font-bold text-gray-800">${escapeHtml(String(i.tenor_weeks||"-"))} minggu</p>
                </div>
            </div>
            <div class="pt-3 border-t border-gray-100">
                <p class="text-sm font-bold text-gray-800 mb-2">Riwayat Ledger</p>
                <div class="space-y-2">${p}</div>
            </div>
            ${f}
        `}catch(r){console.error("Error load paylater detail:",r);const o=resolvePublicErrorMessage(r,"Gagal memuat detail tagihan."),i=o===SESSION_INVALID_MESSAGE;a.innerHTML=`
            <div class="rounded-xl border border-red-200 bg-red-50 p-3">
                <p class="text-red-700 text-sm font-semibold">${escapeHtml(o)}</p>
                <div class="flex items-center gap-2 mt-3">
                    <button type="button" data-action="retry-paylater-detail" class="px-3 py-1.5 rounded-lg bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition">
                        Coba Lagi
                    </button>
                    ${i?'<button type="button" data-action="show-login" class="px-3 py-1.5 rounded-lg bg-white text-red-700 text-xs font-bold border border-red-200 hover:bg-red-100 transition">Login Ulang</button>':""}
                </div>
            </div>
        `}}}async function loadPaylaterData(e){clearSectionError("paylater"),setSectionLoading("paylater",!0);try{const t=buildSessionQuery(e);if(!t)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const[n,a]=await Promise.all([akunApiGet(`?action=public_paylater_summary${t}`),akunApiGet(`?action=public_paylater_invoices${t}`)]),r=parsePublicSuccess(n,"Gagal memuat ringkasan PayLater."),o=parsePublicSuccess(a,"Gagal memuat daftar invoice PayLater.");renderPaylaterSummary(r),renderPaylaterInvoices(o.invoices||[])}catch(t){console.error("Error loading paylater data:",t),setSectionError("paylater",resolvePublicErrorMessage(t),"retry-paylater")}finally{setSectionLoading("paylater",!1)}}async function loadOrderHistory(e){document.getElementById("order-loading");const t=document.getElementById("order-empty"),n=document.getElementById("order-list"),a=document.getElementById("order-error"),r=document.getElementById("order-pagination"),o=document.getElementById("total-accepted-spend");clearSectionError("orders"),setSectionLoading("orders",!0),t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),n&&(n.innerHTML=""),r&&(r.classList.add("hidden"),r.innerHTML=""),o&&(o.textContent="Rp 0");try{const i=buildSessionQuery(e);if(!i)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const s=parsePublicSuccess(await akunApiGet(`?action=public_user_orders${i}`),"Gagal memuat riwayat pesanan.");let l=Array.isArray(s.orders)?s.orders:[];if(setSectionLoading("orders",!1),!l||l.length===0||(l=l.filter(d=>normalizePhoneTo08(d.phone||d.whatsapp||"")===normalizePhoneTo08(e.whatsapp)),l.length===0))return void(t&&t.classList.remove("hidden"));if(l.sort((d,c)=>{const g=new Date(d.tanggal_pesanan||d.timestamp||0);return new Date(c.tanggal_pesanan||c.timestamp||0)-g}),window.allOrders=l,window.currentPage=1,window.ordersPerPage=10,o){const d=new Set(["terima","diterima","selesai"]),c=l.reduce((g,h)=>{const u=String(h.status||"").toLowerCase().trim();return d.has(u)?g+parseCurrencyValue(h.total||h.total_bayar||0):g},0);o.textContent=formatCurrency(c)}displayOrderPage(1)}catch(i){console.error("Error loading order history:",i),setSectionLoading("orders",!1),t&&t.classList.add("hidden"),n&&(n.innerHTML=""),r&&r.classList.add("hidden"),setSectionError("orders",resolvePublicErrorMessage(i),"retry-orders")}}function parseCurrencyValue(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),n=parseFloat(t);return Number.isNaN(n)?0:n}function displayOrderPage(e){const t=document.getElementById("order-list"),n=document.getElementById("order-pagination");if(!window.allOrders||window.allOrders.length===0)return;const a=window.allOrders.length,r=Math.ceil(a/window.ordersPerPage),o=(e-1)*window.ordersPerPage,i=Math.min(o+window.ordersPerPage,a);t.innerHTML="";for(let s=o;s<i;s++){const l=createOrderCard(window.allOrders[s]);t.appendChild(l)}r>1?(n.classList.remove("hidden"),n.innerHTML=createPagination(e,r)):n.classList.add("hidden"),window.currentPage=e}function createPagination(e,t){let n='<div class="flex justify-center items-center gap-2 mt-6">';e>1&&(n+=`<button onclick="displayOrderPage(${e-1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">\u2190 Prev</button>`),n+='<div class="flex gap-1">';for(let a=1;a<=t;a++)a===e?n+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm">${a}</button>`:a===1||a===t||a>=e-1&&a<=e+1?n+=`<button onclick="displayOrderPage(${a})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm">${a}</button>`:a!==e-2&&a!==e+2||(n+='<span class="px-2 py-2 text-gray-500">...</span>');return n+="</div>",e<t&&(n+=`<button onclick="displayOrderPage(${e+1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">Next \u2192</button>`),n+="</div>",n}function createOrderCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-3 hover:border-green-300 transition cursor-pointer",formatDate(e.tanggal_pesanan||e.timestamp);const n=formatCurrency(e.total||e.total_bayar||0),a=getStatusBadge(e.status||"Menunggu"),r=e.produk||e.items||e.product_name||"N/A",o=truncateText(r,20),i=e.id||"N/A";return t.innerHTML=`
        <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
                <p class="text-[10px] font-bold text-gray-700 mb-1">Order ID: <span class="text-green-600">${escapeHtml(i)}</span></p>
            </div>
            ${a}
        </div>
        
        <div class="border-t border-gray-100 pt-2 space-y-1.5">
            <div class="text-sm">
                <p class="text-gray-600 text-xs mb-0.5">Produk:</p>
                <p class="font-semibold text-gray-800 lg:hidden">${escapeHtml(o)}</p>
                <p class="font-semibold text-gray-800 hidden lg:block">${escapeHtml(r)}</p>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Qty:</span>
                <span class="font-semibold text-gray-800">${e.qty||e.quantity||e.jumlah||"N/A"}</span>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Poin:</span>
                <span class="font-semibold text-amber-600">+${e.poin||e.points||0}</span>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Total Bayar:</span>
                <span class="font-bold text-green-600">${n}</span>
            </div>
        </div>
        
        <div class="mt-3 pt-2 border-t border-gray-100">
            <button onclick="window.location.href='index.html'" class="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-bold py-1.5 rounded-lg transition text-xs">
                Belanja Lagi
            </button>
        </div>
    `,t.addEventListener("click",s=>{s.target.tagName!=="BUTTON"&&s.target.tagName!=="A"&&showOrderDetailModal(e)}),t}function getStatusBadge(e){const t={Menunggu:{bg:"bg-yellow-100",text:"text-yellow-700",label:"Menunggu"},Diproses:{bg:"bg-blue-100",text:"text-blue-700",label:"Diproses"},Dikirim:{bg:"bg-purple-100",text:"text-purple-700",label:"Dikirim"},Diterima:{bg:"bg-green-100",text:"text-green-700",label:"Diterima"},Dibatalkan:{bg:"bg-red-100",text:"text-red-700",label:"Dibatalkan"}},n=t[normalizeStatus(e)]||t.Menunggu;return`<span class="${n.bg} ${n.text} text-xs font-bold px-3 py-1 rounded-full">${n.label}</span>`}function normalizeStatus(e){return e?{menunggu:"Menunggu",pending:"Menunggu",diproses:"Diproses",proses:"Diproses",processing:"Diproses",dikirim:"Dikirim",kirim:"Dikirim",shipped:"Dikirim",diterima:"Diterima",terima:"Diterima",selesai:"Diterima",completed:"Diterima",dibatalkan:"Dibatalkan",batal:"Dibatalkan",cancelled:"Dibatalkan",canceled:"Dibatalkan"}[e.toLowerCase().trim()]||e:"Menunggu"}function formatDate(e){if(!e||e==="N/A"||e==="")return"N/A";let t;if(typeof e=="number")t=new Date(e);else if(typeof e=="string"){let n=e.split(",")[0].trim();if(t=new Date(e),isNaN(t.getTime())&&n.includes("/")){const a=n.split("/");if(a.length===3){const r=parseInt(a[0]),o=parseInt(a[1]),i=parseInt(a[2]);r<=31&&o<=12&&i>1900&&(t=new Date(i,o-1,r))}}}else t=new Date(e);return isNaN(t.getTime())?"N/A":t.toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"})}function truncateText(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":"N/A"}function formatCurrency(e){const t=parseInt(e)||0;return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t)}function showRegisterInfo(){alert(`Untuk mendaftar, silakan hubungi admin GoSembako melalui WhatsApp.

Anda akan diberikan akun dengan nomor WhatsApp dan PIN untuk login.`)}function showRegister(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.remove("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden"),updateRegisterReferralInfo()}function showForgotPIN(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.remove("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function openEditProfile(){const e=getLoggedInUser();e&&(document.getElementById("edit-name").value=e.nama,document.getElementById("edit-old-pin").value="",document.getElementById("edit-new-pin").value="",document.getElementById("edit-confirm-pin").value="",document.getElementById("edit-error").classList.add("hidden"),document.getElementById("edit-profile-modal").classList.remove("hidden"))}function closeEditProfile(){document.getElementById("edit-profile-modal").classList.add("hidden")}function showOrderDetailModal(e){document.getElementById("tracking-order-id").textContent=e.id||"N/A";const t=e.tanggal||e.tanggal_pesanan||e.timestamp||e.date||e.created_at;document.getElementById("tracking-order-date").textContent=formatDate(t);const n=normalizeStatus(e.status||"Menunggu"),a=getStatusBadge(n),r=document.getElementById("tracking-status-badge");r&&(r.innerHTML=a),document.getElementById("tracking-products").textContent=e.produk||e.items||e.product_name||"N/A",document.getElementById("tracking-total").textContent=formatCurrency(e.total||e.total_bayar||0);const o=createAnimatedTimeline(n);document.getElementById("tracking-timeline").innerHTML=o,document.getElementById("order-tracking-modal").classList.remove("hidden")}function createAnimatedTimeline(e){const t=[{name:"Menunggu",gif:"wait.gif",key:"Menunggu"},{name:"Diproses",gif:"grocery-basket.gif",key:"Diproses"},{name:"Dikirim",gif:"grocery.gif",key:"Dikirim"},{name:"Diterima",gif:"shipping.gif",key:"Diterima"}];let n=t.findIndex(a=>a.key===e);return e==="Dibatalkan"?`
            <div class="flex items-center justify-center gap-3 py-4">
                <div class="bg-red-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div>
                    <p class="font-bold text-red-600">Dibatalkan</p>
                    <p class="text-xs text-gray-500">Pesanan telah dibatalkan</p>
                </div>
            </div>
        `:(n===-1&&(n=0),`
        <div class="flex items-center justify-between gap-2 py-2">
            ${t.map((a,r)=>{const o=r<=n,i=r===n,s=r===t.length-1,l=`./assets/images/${a.gif}`;return`
                    <div class="flex flex-col items-center flex-1">
                        <div class="${o?"bg-green-50":"bg-gray-100"} w-12 h-12 rounded-full flex items-center justify-center ${i?"ring-2 ring-green-500 ring-offset-2":""}">
                            <img src="${sanitizeUrl(l,"./assets/images/wait.gif")}" alt="${a.name}" class="w-8 h-8 object-contain ${o?"":"opacity-40"}" data-fallback-src="${l}">
                        </div>
                        <p class="text-[10px] font-semibold mt-2 text-center ${o?"text-gray-800":"text-gray-400"}">${a.name}</p>
                        ${i?'<p class="text-[8px] text-green-600 font-bold mt-0.5">\u25CF Saat ini</p>':'<p class="text-[8px] text-transparent mt-0.5">\u25CF</p>'}
                    </div>
                    ${s?"":`
                        <div class="flex-shrink-0 w-8 h-0.5 ${o&&r<n?"bg-green-500":"bg-gray-300"} transition-all duration-500 mb-6"></div>
                    `}
                `}).join("")}
        </div>
    `)}function closeOrderTracking(){document.getElementById("order-tracking-modal").classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{pendingReferralCodeFromUrl=getReferralCodeFromUrl(),updateRegisterReferralInfo(),loadPublicReferralConfig().then(()=>{referralProfileCache&&updateReferralShareUI(referralProfileCache)});const e=getLoggedInUser(),t=document.getElementById("referral-input");t&&t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),applyReferralCode())}),document.addEventListener("click",n=>{if(n.target.closest('[data-action="show-login"]'))return void showLogin();if(n.target.closest('[data-action="retry-paylater-detail"]'))return void(lastPaylaterDetailInvoiceId&&openPaylaterDetailModal(lastPaylaterDetailInvoiceId));const a=n.target.closest('[data-action="view-paylater-invoice"]');if(a)return void openPaylaterDetailModal(a.getAttribute("data-invoice-id"));const r=n.target.closest('[data-action="confirm-paylater-payment"]');if(r){const o=String(r.getAttribute("data-wa-link")||"").trim();o&&window.open(o,"_blank")}}),e?showDashboard(e):showLogin()}),document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-whatsapp").value.trim(),n=document.getElementById("login-pin").value.trim(),a=document.getElementById("login-btn"),r=document.getElementById("login-error");if(document.getElementById("login-error-text"),!t||!n)return void showError("Mohon lengkapi semua field");const o=normalizePhoneTo08(t);if(o)if(o.length<10||o.length>13)showError("Panjang nomor tidak valid");else if(n.length===6){a.disabled=!0,a.innerHTML=`
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Memproses...</span>
    `,r.classList.add("hidden");try{const i=await akunApiGet(`?action=public_login&phone=${encodeURIComponent(o)}&pin=${encodeURIComponent(n)}`);if(!i||i.success!==!0||!i.user)return showError(mapPublicLoginError(i)),void resetLoginButton();const s=i.user;if(s.status&&s.status.toLowerCase()!=="aktif")return showError("Akun Anda tidak aktif. Hubungi admin."),void resetLoginButton();s.whatsapp=normalizePhoneTo08(s.whatsapp||s.phone||o),saveLoggedInUser(s),showDashboard(s),document.getElementById("dashboard-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(i){console.error("Login error:",i),showError(resolvePublicErrorMessage(i,NETWORK_ERROR_MESSAGE)),resetLoginButton()}}else showError("PIN harus 6 digit");else showError("Gunakan format 08xxxxxxxxxx")}),document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-name").value.trim(),n=document.getElementById("register-whatsapp").value.trim(),a=document.getElementById("register-pin").value.trim(),r=document.getElementById("register-pin-confirm").value.trim(),o=pendingReferralCodeFromUrl,i=document.getElementById("register-error"),s=document.getElementById("register-error-text"),l=document.getElementById("register-success"),d=document.getElementById("register-btn");i.classList.add("hidden"),l.classList.add("hidden");const c=t.replace(/\s/g,"");if(c.length<4)return s.textContent="Masukkan Nama Lengkap",void i.classList.remove("hidden");const g=c.toLowerCase(),h=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const f of h)if(f.test(g))return s.textContent="Masukkan Nama Lengkap",void i.classList.remove("hidden");const u=normalizePhoneTo08(n);if(!u)return s.textContent="Gunakan format 08xxxxxxxxxx",void i.classList.remove("hidden");const m=u.replace(/[^0-9]/g,"");if(m.length<10||m.length>13)return s.textContent="Nomor WhatsApp tidak valid",void i.classList.remove("hidden");const p=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const f of p)if(f.test(m))return s.textContent="Nomor WhatsApp tidak valid",void i.classList.remove("hidden");if(a.length!==6||!/^\d{6}$/.test(a))return s.textContent="PIN harus 6 digit angka",void i.classList.remove("hidden");if(a!==r)return s.textContent="PIN tidak cocok",void i.classList.remove("hidden");d.disabled=!0,d.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const f=`USR-${Date.now().toString().slice(-6)}`,y=new Date().toISOString().split("T")[0],w=new Date().toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),x=await akunApiPost({action:"create",sheet:"users",data:{id:f,nama:t,whatsapp:u,pin:a,tanggal_daftar:y,status:"aktif",total_points:0,created_at:w,referred_by:"",referred_by_phone:"",referral_count:0,referral_points_total:0,kode_referral:""}});if(x&&x.error)throw createAkunError(String(x.message||x.error||"Gagal mendaftar"),String(x.error||""));if(!x||x.success!==!0||!x.created||x.created<1)throw new Error(String(x&&(x.message||x.error||x.error_code)||"Gagal mendaftar"));let I="";if(o)try{const k=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:u,ref_code:o}});I=k&&k.success?" Kode referral berhasil diterapkan.":" Akun dibuat, namun kode referral tidak valid."}catch(k){console.warn("Referral attach failed after registration:",k),I=" Akun dibuat, namun kode referral gagal diproses."}l.classList.remove("hidden");const v=l.querySelector("span");v&&(v.textContent="Pendaftaran berhasil! Silakan login."+I),document.getElementById("register-form").reset(),setTimeout(()=>{showLogin()},2e3)}catch(f){console.error("Registration error:",f);const y=String(f.code||f.message||"").toUpperCase();y.indexOf("DUPLICATE_PHONE")!==-1?s.textContent="Nomor WhatsApp sudah terdaftar":y.indexOf("RATE_LIMITED")!==-1?s.textContent="Terlalu banyak percobaan pendaftaran. Coba lagi sebentar.":s.textContent="Terjadi kesalahan. Silakan coba lagi.",i.classList.remove("hidden")}finally{d.disabled=!1,d.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar'}}),document.getElementById("forgot-pin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("forgot-whatsapp").value.trim(),n=document.getElementById("forgot-error"),a=document.getElementById("forgot-error-text"),r=document.getElementById("forgot-btn"),o=normalizePhoneTo08(t);if(!o)return n.classList.remove("hidden"),void(a.textContent="Gunakan format 08xxxxxxxxxx");n.classList.add("hidden"),r.disabled=!0,r.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{alert(`Untuk reset PIN, hubungi admin melalui WhatsApp terdaftar: ${o}.`);const i=o.replace(/^0/,"62");window.open(`https://wa.me/628993370200?text=Halo, saya ingin reset PIN akun saya. Nomor WhatsApp: ${i}`,"_blank"),setTimeout(()=>{showLogin()},1e3)}catch(i){console.error("Forgot PIN error:",i),a.textContent="Terjadi kesalahan. Silakan coba lagi.",n.classList.remove("hidden")}finally{r.disabled=!1,r.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi'}}),document.getElementById("edit-profile-form").addEventListener("submit",async e=>{e.preventDefault();const t=getLoggedInUser();if(!t)return;const n=document.getElementById("edit-name").value.trim(),a=document.getElementById("edit-old-pin").value.trim(),r=document.getElementById("edit-new-pin").value.trim(),o=document.getElementById("edit-confirm-pin").value.trim(),i=document.getElementById("edit-error"),s=document.getElementById("edit-error-text"),l=document.getElementById("edit-save-btn");if(i.classList.add("hidden"),n.replace(/\s/g,"").length<4)return s.textContent="Masukkan Nama Lengkap",void i.classList.remove("hidden");if(a||r||o){if(!a||!r||!o)return s.textContent="Lengkapi semua field PIN",void i.classList.remove("hidden");if(r.length!==6||!/^\d{6}$/.test(r))return s.textContent="PIN baru harus 6 digit angka",void i.classList.remove("hidden");if(r!==o)return s.textContent="PIN baru tidak cocok",void i.classList.remove("hidden")}l.disabled=!0,l.textContent="Menyimpan...";try{const d=String(t.session_token||"").trim();if(!d)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const c=parsePublicSuccess(await akunApiPost({action:"public_update_profile",data:{session_token:d,nama:n,old_pin:a,new_pin:r,confirm_pin:o}}),"Gagal memperbarui profil."),g=c&&c.user?c.user:t;saveLoggedInUser(g),document.getElementById("user-name").textContent=g.nama||n,closeEditProfile(),alert("Profil berhasil diperbarui!")}catch(d){console.error("Edit profile error:",d);const c=String(d.code||d.message||"").toUpperCase();c.indexOf("OLD_PIN_INVALID")!==-1?s.textContent="PIN lama salah":c.indexOf("UNAUTHORIZED_SESSION")!==-1?s.textContent=SESSION_INVALID_MESSAGE:s.textContent="Terjadi kesalahan. Silakan coba lagi.",i.classList.remove("hidden")}finally{l.disabled=!1,l.textContent="Simpan"}});const originalCreateOrderCard=createOrderCard;function switchRewardTab(e){const t=document.getElementById("tab-exchange"),n=document.getElementById("tab-history"),a=document.getElementById("exchange-content"),r=document.getElementById("history-content");e==="exchange"?(t.classList.add("text-amber-600","border-amber-600"),t.classList.remove("text-gray-400","border-transparent"),n.classList.add("text-gray-400","border-transparent"),n.classList.remove("text-amber-600","border-amber-600"),a.classList.remove("hidden"),r.classList.add("hidden"),fetchRewardItemsForAkun()):e==="history"&&(n.classList.add("text-amber-600","border-amber-600"),n.classList.remove("text-gray-400","border-transparent"),t.classList.add("text-gray-400","border-transparent"),t.classList.remove("text-amber-600","border-amber-600"),r.classList.remove("hidden"),a.classList.add("hidden"),loadClaimsHistory())}async function loadClaimsHistory(){const e=getLoggedInUser();if(!e)return;const t=document.getElementById("claims-loading"),n=document.getElementById("claims-empty"),a=document.getElementById("claims-list");t.classList.remove("hidden"),n.classList.add("hidden"),a.innerHTML="";try{const r=buildSessionQuery(e);if(!r)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const o=parsePublicSuccess(await akunApiGet(`?action=public_claim_history${r}`),"Gagal memuat riwayat klaim."),i=Array.isArray(o.claims)?o.claims:[];if(t.classList.add("hidden"),!i||i.length===0)return void n.classList.remove("hidden");i.sort((s,l)=>{const d=new Date(s.tanggal||s.date||0);return new Date(l.tanggal||l.date||0)-d}),i.forEach(s=>{const l=createClaimCard(s);a.appendChild(l)})}catch(r){console.error("Error loading claims history:",r),t.classList.add("hidden"),n.classList.remove("hidden")}}function createClaimCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition";const n=(e.status||"pending").toLowerCase(),a={pending:"bg-yellow-100 text-yellow-700",approved:"bg-green-100 text-green-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-red-100 text-red-700"}[n]||"bg-gray-100 text-gray-700",r={pending:"Menunggu",approved:"Disetujui",completed:"Selesai",rejected:"Ditolak"}[n]||e.status||"Menunggu",o=new Date(e.tanggal||e.date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return t.innerHTML=`
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <h5 class="font-bold text-gray-800">${escapeHtml(e.hadiah||e.reward||"Reward")}</h5>
                <p class="text-xs text-gray-500 mt-1">${o}</p>
            </div>
            <span class="${a} text-xs font-bold px-3 py-1 rounded-full">${escapeHtml(r)}</span>
        </div>
        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-gray-700">${e.poin||0} Poin</span>
            </div>
            ${e.id?`<span class="text-xs text-gray-400">#${escapeHtml(e.id)}</span>`:""}
        </div>
    `,t}function closeLoyaltyModal(){document.getElementById("loyalty-modal").classList.add("hidden"),switchRewardTab("exchange")}async function openRewardModal(){const e=getLoggedInUser();if(!e)return;await loadModalPoints();const t=document.getElementById("loyalty-modal-points"),n=t?parseInt(t.textContent||"0"):0;setRewardContextFromAkun(e.whatsapp,n,e.nama),document.getElementById("loyalty-modal").classList.remove("hidden"),switchRewardTab("exchange"),fetchRewardItemsForAkun()}async function loadModalPoints(){const e=getLoggedInUser();if(!e)return;const t=parseInt(e.total_points||e.points||e.poin||0,10)||0,n=document.getElementById("loyalty-modal-points");if(n)try{const a=buildSessionQuery(e);if(!a)return void(n.textContent=String(t));const r=parsePublicSuccess(await akunApiGet(`?action=public_user_points${a}`),"Gagal memuat poin.");n.textContent=String(parseInt(r.points||0,10)||0)}catch(a){console.error("Error loading modal points:",a),n.textContent=String(t)}}createOrderCard=function(e){const t=originalCreateOrderCard(e);return t.style.cursor="pointer",t.addEventListener("click",()=>{showOrderDetailModal(e)}),t};var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});function hideRewardLoaders(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchRewardItemsForAkun(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n.innerHTML="";try{const a=getLoggedInUser(),r=buildSessionQuery(a);if(!r)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const o=parsePublicSuccess(await akunApiGet(`?action=public_rewards_catalog${r}`),"Gagal memuat daftar hadiah.");renderRewardItemsListAkun(Array.isArray(o.rewards)?o.rewards:[])}catch(a){console.error("Error fetching reward items:",a),t&&t.classList.add("hidden"),n.innerHTML=`
            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">
                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>
            </div>
        `}finally{hideRewardLoaders()}}}function renderRewardItemsListAkun(e){const t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){if(!e||e.length===0)return t&&t.classList.remove("hidden"),void(n.innerHTML="");t&&t.classList.add("hidden"),n.innerHTML=e.map(a=>{const r=escapeHtml((a.id||"").toString()),o=escapeHtml((a.nama||a.judul||"Hadiah").toString()),i=parseInt(a.poin||a.Poin||0),s=(a.gambar||"https://via.placeholder.com/80?text=Reward").toString();return`
            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-amber-500 transition">
                <div class="flex gap-3 mb-3">
                    <!-- Left: Image -->
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${sanitizeUrl(s,"https://via.placeholder.com/80?text=Reward")}" alt="${o}" class="w-full h-full object-cover" data-fallback-src="https://via.placeholder.com/80?text=Reward">
                    </div>
                    
                    <!-- Middle: Title & Description -->
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 text-sm mb-1">${o}</p>
                        <p class="text-xs text-gray-500 line-clamp-2">${escapeHtml((a.deskripsi||"").toString())}</p>
                    </div>
                    
                    <!-- Right: Badge -->
                    <div class="flex-shrink-0">
                        <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">${i} Poin</span>
                    </div>
                </div>
                
                <!-- Full-width Button -->
                <button class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg transition text-sm" onclick="handleTukarSekarangAkun('${r}')">
                    Tukar Sekarang
                </button>
            </div>
        `}).join("")}}function setRewardContextFromAkun(e,t,n){e&&(sessionStorage.setItem("reward_phone",e),console.log("\u2705 Reward context set - phone:",e)),t!=null&&(sessionStorage.setItem("user_points",t.toString()),console.log("\u2705 Reward context set - points:",t)),n&&(sessionStorage.setItem("reward_customer_name",n),console.log("\u2705 Reward context set - name:",n))}function handleTukarSekarangAkun(e){const t=getLoggedInUser();if(!t)return void showToast("Mohon login terlebih dahulu.");const n=document.getElementById("loyalty-points"),a=n?parseInt(n.textContent||"0"):0;setRewardContextFromAkun(t.whatsapp,a,t.nama),typeof showConfirmTukarModal=="function"?showConfirmTukarModal(e):typeof window.claimReward=="function"?window.claimReward(e):showToast("Fitur tukar poin akan segera hadir!")}function hideMobileBottomNavOnDashboard(){const e=document.getElementById("mobile-bottom-nav"),t=document.getElementById("dashboard-section");e&&t&&(t.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}ensureImageFallbackHandler(),document.addEventListener("DOMContentLoaded",function(){setTimeout(hideMobileBottomNavOnDashboard,100)});const originalShowDashboard=showDashboard;showDashboard=function(e){typeof originalShowDashboard=="function"&&originalShowDashboard(e),setTimeout(hideMobileBottomNavOnDashboard,100)};const originalShowLogin=showLogin;showLogin=function(){typeof originalShowLogin=="function"&&originalShowLogin();const e=document.getElementById("mobile-bottom-nav");e&&e.classList.remove("hidden")};
