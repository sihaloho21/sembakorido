
/* ===== assets/js/sanitize.min.js ===== */
window.FrontendSanitize={escapeHtml:function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},sanitizeUrl:function(e,n=""){if(!e)return n;const a=String(e).trim();return/^(https?:\/\/|\/(?!\/)|\.\/|\.\.\/|#)/i.test(a)?a:n},ensureImageFallbackHandler:function(){window.__imageFallbackHandlerAdded||(window.__imageFallbackHandlerAdded=!0,document.addEventListener("error",e=>{const n=e.target;if(!n||"IMG"!==n.tagName)return;const a=n.getAttribute("data-fallback-src"),t=n.getAttribute("data-fallback-action");a&&n.src!==a?n.src=a:"hide"===t&&(n.style.display="none")},!0))}},window.sanitizeUrl||(window.sanitizeUrl=window.FrontendSanitize.sanitizeUrl),window.ensureImageFallbackHandler||(window.ensureImageFallbackHandler=window.FrontendSanitize.ensureImageFallbackHandler),window.AdminSanitize||(window.AdminSanitize=window.FrontendSanitize);


/* ===== assets/js/script.min.js ===== */
var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>String(e||"")),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});function getApiUrl(){const e=CONFIG.getMainApiUrl();return console.log("Using API URL:",e),e}ensureImageFallbackHandler();let API_URL=getApiUrl();function refreshApiUrl(){const e=API_URL;API_URL=getApiUrl(),console.log("Old API URL:",e),console.log("New API URL:",API_URL),e!==API_URL&&(console.log("üîÑ API URL changed, clearing cache and reloading..."),"undefined"!=typeof ApiService&&ApiService.clearCache()),fetchProducts()}let cart=JSON.parse(localStorage.getItem("sembako_cart"))||[],allProducts=[],currentCategory="Semua",currentPage=1;const itemsPerPage=12;let filteredProducts=[],storeClosed=CONFIG.isStoreClosed(),selectedVariation=null,currentModalProduct=null;function normalizePhoneNumber(e){if(!e)return null;let t=String(e).replace(/[^0-9]/g,"");return t.startsWith("62")&&(t="0"+t.substring(2)),t.startsWith("8")&&!t.startsWith("08")&&(t="0"+t),!t.startsWith("08")||t.length<10||t.length>13?null:t}function createSlug(e){return e?e.toLowerCase().replace(/[^\w\s-]/g,"").trim().replace(/[-\s]+/g,"-"):""}function ensureProductId(e,t){const n=e.id||e.sku||e.slug||createSlug(e.nama)||"product";return!(e.id||e.sku)?`${n}-${t}`:String(n)}function findProductById(e){return e&&allProducts.find(t=>String(t.productId)===String(e))||null}async function fetchProducts(){try{const e=await ApiService.get("?sheet=products",{cacheDuration:3e5});console.log("Products received:",e),allProducts=e.map((e,t)=>{const n=parseInt(e.harga)||0,a="function"==typeof calculateGajianPrice?calculateGajianPrice(n):{price:n,daysLeft:0,markupPercent:0};let o=e.kategori||"Bahan Pokok";e.kategori||(n>=15e4?o="Paket Lengkap":n>=5e4&&(o="Paket Hemat"));let r=[];if(e.variasi)try{r=JSON.parse(e.variasi)}catch(t){console.error("Error parsing variations for product:",e.id,t)}const s=e.slug||createSlug(e.nama),i=ensureProductId({...e,slug:s},t);return{...e,slug:s,productId:i,harga:n,hargaCoret:parseInt(e.harga_coret)||0,hargaGajian:a.price,stok:parseInt(e.stok)||0,category:o,deskripsi:e.deskripsi&&""!==e.deskripsi.trim()?e.deskripsi:"Kualitas Terjamin, Stok Selalu Baru, Harga Kompetitif",variations:r}}),renderCategoryFilters(),filterProducts(),updateCartUI(),checkStoreStatus(),startNotificationLoop()}catch(e){console.error("Error fetching products:",e);const t=document.getElementById("product-grid");t&&(t.innerHTML='<p class="text-center col-span-full text-red-500">Gagal memuat produk. Silakan coba lagi nanti.</p>')}}function renderCategoryFilters(){const e=document.getElementById("category-filters");if(!e||!allProducts||0===allProducts.length)return;console.log("üè∑Ô∏è Rendering category filters...");const t=new Set;allProducts.forEach(e=>{e.category&&""!==e.category.trim()&&t.add(e.category.trim())});const n=Array.from(t).sort();console.log("üìä Categories found:",n);let a='<button type="button" data-action="set-category" data-category="Semua" class="filter-btn active snap-start flex-shrink-0 px-6 py-2 rounded-full border-2 border-green-500 bg-green-50 text-green-700 text-sm font-bold transition hover:border-green-600 hover:bg-green-100">Semua</button>';n.forEach(e=>{const t=escapeHtml(e);a+=`<button type="button" data-action="set-category" data-category="${t}" class="filter-btn snap-start flex-shrink-0 px-6 py-2 rounded-full border-2 border-gray-300 bg-white text-gray-700 text-sm font-bold transition hover:border-green-500 hover:bg-green-50">${t}</button>`}),e.innerHTML=a,console.log("‚úÖ Category filters rendered:",n.length,"categories"),initCategoryCarouselScroll()}function initCategoryCarouselScroll(){const e=document.getElementById("category-filters");if(!e)return;e.addEventListener("wheel",t=>{0!==t.deltaY&&(t.preventDefault(),e.scrollLeft+=t.deltaY)},{passive:!1});let t,n,a=!1;e.addEventListener("mousedown",o=>{o.target.classList.contains("filter-btn")||(a=!0,e.style.cursor="grabbing",t=o.pageX-e.offsetLeft,n=e.scrollLeft)}),e.addEventListener("mouseleave",()=>{a=!1,e.style.cursor="grab"}),e.addEventListener("mouseup",()=>{a=!1,e.style.cursor="grab"}),e.addEventListener("mousemove",o=>{if(!a)return;o.preventDefault();const r=2*(o.pageX-e.offsetLeft-t);e.scrollLeft=n-r}),e.style.cursor="grab",updateCategoryArrowsVisibility(),e.addEventListener("scroll",updateCategoryArrowsVisibility)}function scrollCategoryCarousel(e){const t=document.getElementById("category-filters");if(!t)return;"left"===e?t.scrollLeft-=300:"right"===e&&(t.scrollLeft+=300)}function updateCategoryArrowsVisibility(){const e=document.getElementById("category-filters"),t=document.getElementById("category-scroll-left"),n=document.getElementById("category-scroll-right");if(!e||!t||!n)return;const a=e.scrollLeft<=10,o=e.scrollLeft+e.clientWidth>=e.scrollWidth-10;a?t.classList.add("opacity-0","pointer-events-none"):t.classList.remove("opacity-0","pointer-events-none"),o?n.classList.add("opacity-0","pointer-events-none"):n.classList.remove("opacity-0","pointer-events-none")}function findProductBySlug(e){return e&&allProducts&&0!==allProducts.length?allProducts.find(t=>t.slug===e):null}function renderProducts(e){const t=document.getElementById("product-grid");if(!t)return;if(0===e.length)return t.innerHTML='<p class="text-center col-span-full text-gray-500 py-10">Tidak ada produk yang ditemukan.</p>',void(document.getElementById("pagination-container").innerHTML="");const n=Math.ceil(e.length/12);currentPage>n&&(currentPage=n||1);const a=12*(currentPage-1),o=a+12,r=e.slice(a,o);t.innerHTML="",r.forEach(e=>{let n="";n=e.stok>10?'<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Tersedia</span>':e.stok>5?`<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Menipis (${e.stok})</span>`:e.stok>0?`<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Hanya sisa ${e.stok}</span>`:'<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Habis</span>';const a=(e.gambar?e.gambar.split(","):[])[0]||"https://placehold.co/300x200?text=Produk",o=sanitizeUrl(a,"https://placehold.co/300x200?text=Produk"),r=calculateRewardPoints(e.harga,e.nama);let s="",i=!1;if(e.grosir)try{const t=JSON.parse(e.grosir);if(Array.isArray(t)&&t.length>0){i=!0;const e=[...t].sort((e,t)=>e.min_qty-t.min_qty);s=`\n                        <div class="grid grid-cols-3 gap-2 mb-3">\n                            ${e.map(e=>`\n                        <div class="bg-green-50 border border-green-100 rounded-lg p-1.5 text-center">\n                            <p class="text-[8px] text-green-600 font-bold uppercase leading-tight">Min. ${e.min_qty}</p>\n                            <p class="text-[10px] text-green-700 font-black">Rp ${e.price.toLocaleString("id-ID")}</p>\n                        </div>\n                    `).join("")}\n                        </div>\n                    `}}catch(t){console.error("Error parsing grosir data for product:",e.id,t)}let d="";if(e.hargaCoret>e.harga){const t=Math.round((e.hargaCoret-e.harga)/e.hargaCoret*100);d=`\n                <div class="flex items-center gap-1 mb-0.5">\n                    <span class="text-[10px] text-gray-400 line-through">Rp ${e.hargaCoret.toLocaleString("id-ID")}</span>\n                    <span class="bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded font-bold">-${t}%</span>\n                </div>\n            `}const l=e.variations&&e.variations.length>0,c=e.productId,u=isProductInWishlist(c)?'<svg class="w-5 h-5 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>':'<svg class="w-5 h-5 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>';t.innerHTML+=`\n            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300 relative" data-product-id="${c}">\n                \x3c!-- Wishlist Heart Button --\x3e\n                <button id="wishlist-btn-${c}" data-action="toggle-wishlist" data-product-id="${c}" class="absolute top-3 right-3 z-20 p-2 bg-white/90 hover:bg-white rounded-full shadow-md transition active:scale-95">\n                    ${u}\n                </button>\n                <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">\n                    <div class="bg-amber-400 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1">\n                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>\n                        +${r} Poin\n                    </div>\n                    ${i?'\n                    <div class="bg-green-600 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1">\n                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7c.78.78.78 2.047 0 2.828l-7 7c-.78.78-2.047.78-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>\n                        Harga Grosir Tersedia\n                    </div>\n                    ':""}\n                </div>\n                <div class="lazy-image-wrapper">\n                    <div class="skeleton skeleton-product-image"></div>\n                    <img src="${o}" alt="${escapeHtml(e.nama)}" data-action="show-detail" data-product-id="${c}" class="w-full h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity ${0===e.stok?"grayscale opacity-60":""}" loading="lazy" data-fallback-src="https://placehold.co/300x200?text=Produk" onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';">\n                </div>\n                <div class="p-6">\n                    <div class="flex justify-between items-start mb-2">\n                        <h4 class="text-lg font-bold text-gray-800">${escapeHtml(e.nama)}</h4>\n                        ${n}\n                    </div>\n                    <div class="flex justify-between items-center mb-4">\n                        <button data-action="share-product" data-product-id="${c}" class="text-green-600 hover:text-green-700 flex items-center gap-1 text-xs font-medium">\n                            <span>Share</span>\n                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n                        </button>\n                    </div>\n                    <div class="grid grid-cols-2 gap-4 mb-6">\n                        <div class="bg-green-50 p-3 rounded-lg">\n                            <p class="text-[10px] text-green-600 font-bold uppercase">Harga Cash</p>\n                            <div class="flex flex-col">\n                                ${d}\n                                <p class="text-lg font-bold text-green-700">Rp ${e.harga.toLocaleString("id-ID")}</p>\n                            </div>\n                        </div>\n                        <div class="bg-blue-50 p-3 rounded-lg">\n                            <p class="text-[10px] text-blue-600 font-bold uppercase">Bayar Gajian</p>\n                            <div class="flex flex-col">\n                                <p class="text-[8px] text-blue-400 mb-0.5">Harga Per Tgl ${(new Date).toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}</p>\n                                <p class="text-lg font-bold text-blue-700">Rp ${e.hargaGajian.toLocaleString("id-ID")}</p>\n                            </div>\n                        </div>\n                    </div>\n                    ${s}\n                    ${l?`\n                    <button data-action="show-detail" data-product-id="${c}" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 mb-3">\n                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>\n                        Pilih Variasi\n                    </button>\n                    `:`\n                    <button data-action="add-to-cart" data-product-id="${c}" ${0===e.stok?"disabled":""} class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 mb-3">\n                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>\n                        Tambah ke Keranjang\n                    </button>\n                    `}\n                    <div class="grid grid-cols-2 gap-2">\n                        <button data-action="show-detail" data-product-id="${c}" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 rounded-lg text-sm transition">Rincian</button>\n                        <button data-action="direct-order" data-product-id="${c}" ${0===e.stok?"disabled":""} class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 rounded-lg text-sm transition">Beli Sekarang</button>\n                    </div>\n\n                </div>\n            </div>\n        `})}function filterProducts(){const e=document.getElementById("search-input"),t=e?normalizeSearch(e.value):"",n=document.getElementById("sort-select"),a=n?n.value:"default";filteredProducts=allProducts.filter(e=>{const n=matchesQuery(e,t),a="Semua"===currentCategory||e.category===currentCategory;return n&&a}),filteredProducts=sortProducts(filteredProducts,a),currentPage=1,renderProducts(filteredProducts),renderPagination(filteredProducts.length),renderSearchSuggestions(t)}function sortProducts(e,t){const n=[...e];return"price-asc"===t?(n.sort((e,t)=>(e.harga||0)-(t.harga||0)),n):"price-desc"===t?(n.sort((e,t)=>(t.harga||0)-(e.harga||0)),n):"promo"===t?(n.sort((e,t)=>promoScore(t)-promoScore(e)),n):n}function promoScore(e){const t=e.harga||0,n=e.hargaCoret||e.harga_coret||0;return!t||!n||n<=t?0:Math.round((n-t)/n*100)}function normalizeSearch(e){return String(e||"").toLowerCase().replace(/[^a-z0-9\\s]/g," ").replace(/\\s+/g," ").trim()}function tokenize(e){return normalizeSearch(e).split(" ").filter(Boolean)}function matchesQuery(e,t){if(!t)return!0;const n=`${normalizeSearch(e.nama)} ${normalizeSearch(e.deskripsi||"")}`.trim(),a=t.replace(/\s+/g,""),o=n.replace(/\s+/g,"");if(n.includes(t))return!0;if(a&&o.includes(a))return!0;return tokenize(t).every(e=>n.includes(e))}function renderSearchSuggestions(e){const t=document.getElementById("search-suggestions"),n=document.getElementById("search-suggestions-header"),a=n&&window.innerWidth<768?n:t;if(!a)return;if(!e)return a.classList.add("hidden"),void(a.innerHTML="");const o=getSearchSuggestions(e,6);if(0===o.length)return a.classList.add("hidden"),void(a.innerHTML="");a.innerHTML=o.map(e=>`\n        <button type="button" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-green-50 transition" data-action="search-suggestion" data-value="${escapeHtml(e)}">${escapeHtml(e)}</button>\n    `).join(""),a.classList.remove("hidden")}function closeSearchSuggestions(){[document.getElementById("search-suggestions"),document.getElementById("search-suggestions-header")].forEach(e=>{e&&(e.classList.add("hidden"),e.innerHTML="")})}function getSearchSuggestions(e,t=6){const n=tokenize(e);if(0===n.length)return[];const a=allProducts.map(e=>{const t=[...tokenize(e.nama),...tokenize(e.deskripsi||"")];let a=0;return n.forEach(e=>{t.forEach(t=>{t===e?a=Math.max(a,3):t.includes(e)?a=Math.max(a,2):e.length>2&&t.length>2&&levenshtein(t,e)<=1&&(a=Math.max(a,1))})}),{name:e.nama,score:a}}).filter(e=>e.score>0),o=new Map;return a.sort((e,t)=>t.score-e.score).forEach(e=>{o.has(e.name)||o.set(e.name,e)}),Array.from(o.values()).slice(0,t).map(e=>e.name)}function levenshtein(e,t){const n=e.length,a=t.length;if(0===n)return a;if(0===a)return n;const o=Array.from({length:n+1},()=>new Array(a+1).fill(0));for(let e=0;e<=n;e+=1)o[e][0]=e;for(let e=0;e<=a;e+=1)o[0][e]=e;for(let r=1;r<=n;r+=1)for(let n=1;n<=a;n+=1){const a=e[r-1]===t[n-1]?0:1;o[r][n]=Math.min(o[r-1][n]+1,o[r][n-1]+1,o[r-1][n-1]+a)}return o[n][a]}function renderPagination(e){const t=document.getElementById("pagination-container");if(!t)return;const n=Math.ceil(e/12);if(n<=1)return void(t.innerHTML="");let a="";a+=`\n        <button type="button" data-action="change-page" data-page="${currentPage-1}" ${1===currentPage?"disabled":""} \n            class="w-10 h-10 flex items-center justify-center rounded-lg border-2 border-gray-200 text-gray-600 hover:border-green-500 hover:text-green-600 disabled:opacity-30 disabled:cursor-not-allowed transition">\n            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>\n        </button>\n    `;for(let e=1;e<=n;e++)1===e||e===n||e>=currentPage-1&&e<=currentPage+1?a+=`\n                <button type="button" data-action="change-page" data-page="${e}" \n                    class="w-10 h-10 flex items-center justify-center rounded-lg border-2 font-bold transition ${e===currentPage?"bg-green-600 border-green-600 text-white":"border-gray-200 text-gray-600 hover:border-green-500 hover:text-green-600"}">\n                    ${e}\n                </button>\n            `:e!==currentPage-2&&e!==currentPage+2||(a+='<span class="text-gray-400">...</span>');a+=`\n        <button type="button" data-action="change-page" data-page="${currentPage+1}" ${currentPage===n?"disabled":""} \n            class="w-10 h-10 flex items-center justify-center rounded-lg border-2 border-gray-200 text-gray-600 hover:border-green-500 hover:text-green-600 disabled:opacity-30 disabled:cursor-not-allowed transition">\n            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>\n        </button>\n    `,t.innerHTML=a}function changePage(e){const t=Math.ceil(filteredProducts.length/12);e<1||e>t||(currentPage=e,renderProducts(filteredProducts),renderPagination(filteredProducts.length),document.getElementById("katalog").scrollIntoView({behavior:"smooth"}))}function setCategory(e){currentCategory=e,document.querySelectorAll(".filter-btn").forEach(t=>{t.innerText===e?(t.classList.add("active"),t.classList.remove("border-gray-300","bg-white","text-gray-700"),t.classList.add("border-green-500","bg-green-50","text-green-700"),t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})):(t.classList.remove("active"),t.classList.remove("border-green-500","bg-green-50","text-green-700"),t.classList.add("border-gray-300","bg-white","text-gray-700"))}),filterProducts()}function addToCart(e,t,n=1){storeClosed?showStoreWarning(()=>{proceedAddToCart(e,t,n)}):proceedAddToCart(e,t,n)}function proceedAddToCart(e,t,n=1){if(e.variations&&e.variations.length>0&&!selectedVariation)return void showDetail(e);const a={...e};if(selectedVariation){a.selectedVariation=selectedVariation,a.harga=selectedVariation.harga,a.sku=selectedVariation.sku,a.stok=selectedVariation.stok;const e="function"==typeof calculateGajianPrice?calculateGajianPrice(selectedVariation.harga):{price:selectedVariation.harga,daysLeft:0,markupPercent:0};a.hargaGajian=e.price}const o=cart.find(e=>{const t=e.id===a.id,n=!e.selectedVariation&&!a.selectedVariation||e.selectedVariation&&a.selectedVariation&&e.selectedVariation.sku===a.selectedVariation.sku;return t&&n});if(o?o.qty+=n:cart.push({...a,qty:n}),saveCart(),updateCartUI(),selectedVariation=null,t&&t.currentTarget){const e=(t.currentTarget.closest(".bg-white")||document.getElementById("detail-modal")).querySelector("img"),n=document.querySelector("header button");if(e&&n){const t=e.getBoundingClientRect(),a=n.getBoundingClientRect(),o=document.createElement("img");o.src=e.src,o.className="fly-item",o.style.top=`${t.top}px`,o.style.left=`${t.left}px`,o.style.width=`${t.width}px`,o.style.height=`${t.height}px`,o.style.borderRadius="12px",document.body.appendChild(o),requestAnimationFrame(()=>{o.style.top=`${a.top+a.height/2}px`,o.style.left=`${a.left+a.width/2}px`,o.style.width="20px",o.style.height="20px",o.style.opacity="0.5",o.style.borderRadius="50%"}),setTimeout(()=>{o.remove(),n.classList.add("cart-pop"),setTimeout(()=>n.classList.remove("cart-pop"),400)},800)}}else{const e=document.querySelector("header button");e&&(e.classList.add("cart-pop"),setTimeout(()=>e.classList.remove("cart-pop"),400))}showToast(`${a.nama}${a.selectedVariation?" ("+a.selectedVariation.nama+")":""} ditambahkan ke keranjang`)}function showToast(e){let t=document.querySelector(".toast-container");t||(t=document.createElement("div"),t.className="toast-container",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),document.body.appendChild(t));const n=document.createElement("div");n.className="toast",n.setAttribute("role","status"),n.setAttribute("aria-live","polite"),n.setAttribute("aria-atomic","true"),n.innerHTML=`\n        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>\n        </svg>\n        <span>${escapeHtml(e)}</span>\n    `,t.appendChild(n),setTimeout(()=>n.remove(),3e3)}function showSuccessNotification(e,t){const n=document.createElement("div");n.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] animate-fade-in",n.style.animation="fadeIn 0.3s ease-out";const a=document.createElement("div");a.className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm mx-4 text-center transform scale-95 relative",a.style.animation="scaleIn 0.3s ease-out forwards";const o=sanitizeUrl("assets/images/success-shield.gif","assets/images/success-shield.gif");a.innerHTML=`\n        <button type="button" data-action="dismiss-notification" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition p-1 rounded-full hover:bg-gray-100">\n            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n            </svg>\n        </button>\n        <div class="mb-4">\n            <div class="w-32 h-32 flex items-center justify-center mx-auto mb-4">\n                <img src="${o}" alt="Success" class="w-full h-full object-contain" data-fallback-src="assets/images/success-shield.gif">\n            </div>\n            <h3 class="text-2xl font-bold text-gray-800 mb-2">Pesanan Berhasil Dikirim!</h3>\n            <p class="text-gray-600 mb-4">Order ID: <span class="font-mono font-semibold text-green-600">${escapeHtml(e)}</span></p>\n            <p class="text-sm text-gray-500 mb-6">Pesanan Anda telah tercatat dan akan segera diproses. Silakan lanjutkan ke WhatsApp untuk konfirmasi.</p>\n        </div>\n        <a href="${t}" target="_blank" class="block w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg flex items-center justify-center gap-3 mt-4">\n            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n            <span>Lanjut ke WhatsApp</span>\n        </a>\n    `,n.appendChild(a),document.body.appendChild(n);const r=a.querySelector('[data-action="dismiss-notification"]');if(r&&r.addEventListener("click",()=>n.remove()),!document.getElementById("success-notification-styles")){const e=document.createElement("style");e.id="success-notification-styles",e.textContent="\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n            @keyframes scaleIn {\n                from { transform: scale(0.95); opacity: 0; }\n                to { transform: scale(1); opacity: 1; }\n            }\n            @keyframes fadeOut {\n                from { opacity: 1; }\n                to { opacity: 0; }\n            }\n            @keyframes successCircle {\n                0% {\n                    transform: scale(0);\n                    opacity: 0;\n                }\n                50% {\n                    transform: scale(1.1);\n                }\n                100% {\n                    transform: scale(1);\n                    opacity: 1;\n                }\n            }\n            @keyframes successCheck {\n                0% {\n                    stroke-dashoffset: 50;\n                    opacity: 0;\n                }\n                50% {\n                    opacity: 1;\n                }\n                100% {\n                    stroke-dashoffset: 0;\n                }\n            }\n            @keyframes bounce {\n                0%, 100% {\n                    transform: translateY(0);\n                }\n                50% {\n                    transform: translateY(-10px);\n                }\n            }\n            .animate-success-circle {\n                animation: successCircle 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;\n            }\n            .animate-success-check {\n                animation: successCheck 0.6s ease-in-out 0.3s forwards, bounce 0.6s ease-in-out 0.9s;\n            }\n            .checkmark-path {\n                stroke-dasharray: 50;\n                stroke-dashoffset: 50;\n            }\n        ",document.head.appendChild(e)}n.addEventListener("click",e=>{e.target===n&&(n.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>n.remove(),300))})}function saveCart(){localStorage.setItem("sembako_cart",JSON.stringify(cart))}function updateCartUI(){const e=cart.reduce((e,t)=>e+t.qty,0),t=document.getElementById("cart-count");t&&(e>0?(t.innerText=e,t.classList.remove("hidden")):t.classList.add("hidden"));const n=document.getElementById("cart-items"),a=document.getElementById("cart-footer"),o=document.getElementById("cart-empty");if(n)if(0===cart.length)n.innerHTML="",a&&a.classList.add("hidden"),o&&o.classList.remove("hidden");else{o&&o.classList.add("hidden"),a&&a.classList.remove("hidden");let e=0;n.innerHTML=cart.map((t,n)=>{const a=calculateTieredPrice(t.harga,t.qty,t.grosir),o=a<t.harga,r=a*t.qty;e+=r;let s=(t.gambar?t.gambar.split(","):[])[0]||"https://placehold.co/100x100?text=Produk";t.selectedVariation&&t.selectedVariation.gambar&&(s=t.selectedVariation.gambar);return`\n                <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-xl">\n                    <img src="${sanitizeUrl(s,"https://placehold.co/100x100?text=Produk")}" class="w-16 h-16 object-cover rounded-lg" data-fallback-src="https://placehold.co/100x100?text=Produk">\n                    <div class="flex-1">\n                        <h5 class="font-bold text-gray-800 text-sm">${t.nama}${t.selectedVariation?" ("+t.selectedVariation.nama+")":""}</h5>\n                        <div class="flex flex-col">\n                            ${o?`<span class="text-[10px] text-gray-400 line-through">Rp ${t.harga.toLocaleString("id-ID")}</span>`:""}\n                            <p class="text-green-600 font-bold text-xs">Rp ${a.toLocaleString("id-ID")} ${o?'<span class="bg-green-100 text-green-700 text-[8px] px-1 rounded ml-1">Grosir</span>':""}</p>\n                        </div>\n                        <div class="flex items-center gap-3 mt-2">\n                            <button type="button" data-action="update-cart-qty" data-index="${n}" data-delta="-1" class="w-6 h-6 bg-white border border-gray-200 rounded-full flex items-center justify-center text-gray-500">-</button>\n                            <span class="text-sm font-bold">${t.qty}</span>\n                            <button type="button" data-action="update-cart-qty" data-index="${n}" data-delta="1" class="w-6 h-6 bg-white border border-gray-200 rounded-full flex items-center justify-center text-gray-500">+</button>\n                        </div>\n                    </div>\n                    <button type="button" data-action="remove-cart-item" data-index="${n}" class="text-red-400 hover:text-red-600">\n                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                    </button>\n                </div>\n            `}).join("");const t=document.getElementById("cart-total");t&&(t.innerText=`Rp ${e.toLocaleString("id-ID")}`);const r=document.getElementById("order-summary-total");r&&(r.innerText=`Rp ${e.toLocaleString("id-ID")}`);const s=document.getElementById("sticky-order-total");s&&(s.innerText=`Rp ${e.toLocaleString("id-ID")}`)}}function updateQty(e,t){cart[e].qty+=t,cart[e].qty<1&&cart.splice(e,1),saveCart(),updateCartUI()}function removeItem(e){cart.splice(e,1),saveCart(),updateCartUI()}function openCartModal(){const e=document.getElementById("cart-modal");e&&(e.classList.remove("hidden"),document.body.classList.add("modal-active"))}function closeCartModal(){const e=document.getElementById("cart-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}function updateModalQty(e){const t=document.getElementById("modal-qty");if(!t)return;let n=parseInt(t.value)||1;n+=e,n<1&&(n=1),t.value=n,t.oninput({target:t})}function showDetail(e){closeWishlistModal(),console.log("showDetail called for product:",e.nama);const t=document.getElementById("detail-modal");if(!t)return;currentModalProduct=e,t.dataset.productId=e.productId||"",selectedVariation=null;const n=document.getElementById("modal-qty");n&&(n.value=1);const a=document.getElementById("modal-product-name"),o=document.getElementById("modal-product-image"),r=(document.getElementById("modal-cash-price"),document.getElementById("modal-gajian-price"),document.getElementById("modal-price-date")),s=document.getElementById("modal-items-list"),i=document.getElementById("modal-badges"),d=(document.getElementById("savings-highlight"),document.getElementById("savings-amount"),document.getElementById("modal-variation-container"));if(a&&(a.innerText=e.nama),n&&(n.oninput=t=>{const n=parseInt(t.target.value)||1,a=selectedVariation?selectedVariation.harga:e.harga,o=selectedVariation?selectedVariation.grosir:e.grosir,r=selectedVariation?selectedVariation.harga_coret||0:e.hargaCoret||0;"function"==typeof updateTieredPricingUI&&updateTieredPricingUI({...e,harga:a,grosir:o},n);const s="function"==typeof calculateTieredPrice?calculateTieredPrice(a,n,o):a;updateModalPrices(s*n,("function"==typeof calculateGajianPrice?calculateGajianPrice(s):{price:s}).price*n,r*n)}),d)if(e.variations&&e.variations.length>0){d.classList.remove("hidden");document.getElementById("modal-variation-list").innerHTML=e.variations.map((e,t)=>`\n\t                <button type="button" data-action="select-variation" data-index="${t}" class="variation-btn border-2 border-gray-200 rounded-xl p-3 text-left transition hover:border-green-500 focus:outline-none">\n                    <p class="text-xs font-bold text-gray-800">${escapeHtml(e.nama)}</p>\n                    <p class="text-[10px] text-green-600 font-bold">Rp ${e.harga.toLocaleString("id-ID")}</p>\n                    ${e.stok<=0?'<p class="text-[8px] text-red-500 font-bold">Stok Habis</p>':""}\n                </button>\n            `).join(""),selectVariation(e.variations[0],0)}else d.classList.add("hidden"),updateModalPrices(e.harga,e.hargaGajian,e.hargaCoret);else updateModalPrices(e.harga,e.hargaGajian,e.hargaCoret);r&&(r.innerText=`Harga Per Tgl ${(new Date).toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}`),i&&(i.innerHTML=`\n            <span class="bg-green-100 text-green-700 text-[10px] px-2.5 py-1 rounded-lg font-bold">${escapeHtml(e.category)}</span>\n            ${e.stok>0?`<span class="bg-blue-100 text-blue-700 text-[10px] px-2.5 py-1 rounded-lg font-bold">Stok: ${e.stok}</span>`:'<span class="bg-red-100 text-red-700 text-[10px] px-2.5 py-1 rounded-lg font-bold">Stok Habis</span>'}\n        `);const l=e.gambar?e.gambar.split(","):[];if("function"==typeof initializeSlider?initializeSlider(l):o&&(o.src=l.length>0?l[0]:"https://placehold.co/300x200?text=Produk",o.onerror=function(){this.src="https://placehold.co/300x200?text=Produk"}),s){const t=String(e.deskripsi||"").replace(/\r\n?/g,"\n").replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n").split("\n").map(e=>e.trim()).filter(e=>""!==e&&!/^isi paket\s*:\s*$/i.test(e)).map(e=>e.replace(/^[\-‚Ä¢]\s*/,"").trim()).filter(e=>""!==e),n=["üçú","üç≤","üì¶","‚òï","üçö","üç≥","üßÇ"];s.innerHTML=t.map((e,t)=>`\n            <div class="flex items-center gap-4 bg-gray-50/50 p-3 rounded-xl border border-gray-100/50">\n                <span class="text-xl">${n[t%n.length]}</span>\n                <span class="text-sm font-medium text-gray-700">‚Ä¢${escapeHtml(e)}</span>\n            </div>\n        `).join("")}"function"==typeof updateTieredPricingUI&&updateTieredPricingUI(e,1),t.classList.remove("hidden"),document.body.classList.add("modal-active")}function selectVariation(e,t){if(selectedVariation=e,document.querySelectorAll(".variation-btn").forEach((e,n)=>{n===t?(e.classList.add("border-green-500","bg-green-50"),e.classList.remove("border-gray-200")):(e.classList.remove("border-green-500","bg-green-50"),e.classList.add("border-gray-200"))}),e.gambar&&"function"==typeof initializeSlider){const t=e.gambar.split(",");initializeSlider(t)}const n=document.getElementById("modal-qty");if(n)n.oninput({target:n});else{const t="function"==typeof calculateGajianPrice?calculateGajianPrice(e.harga):{price:e.harga,daysLeft:0,markupPercent:0};updateModalPrices(e.harga,t.price,e.harga_coret||0)}}function updateModalPrices(e,t,n){const a=document.getElementById("modal-cash-price"),o=document.getElementById("modal-gajian-price"),r=document.getElementById("savings-highlight"),s=document.getElementById("savings-amount");a&&(a.innerText=`Rp ${e.toLocaleString("id-ID")}`),o&&(o.innerText=`Rp ${t.toLocaleString("id-ID")}`),n>e?(r&&r.classList.remove("hidden"),s&&(s.innerText=`Rp ${(n-e).toLocaleString("id-ID")}`)):r&&r.classList.add("hidden")}function closeDetailModal(){const e=document.getElementById("detail-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active")),selectedVariation=null}function directOrder(e){storeClosed?showStoreWarning(()=>{proceedDirectOrder(e)}):proceedDirectOrder(e)}function proceedDirectOrder(e){if(e.variations&&e.variations.length>0&&!selectedVariation)return void showDetail(e);const t={...e};if(selectedVariation){t.selectedVariation=selectedVariation,t.harga=selectedVariation.harga,t.sku=selectedVariation.sku,t.stok=selectedVariation.stok;const e="function"==typeof calculateGajianPrice?calculateGajianPrice(selectedVariation.harga):{price:selectedVariation.harga,daysLeft:0,markupPercent:0};t.hargaGajian=e.price}const n=document.getElementById("modal-qty"),a=n&&parseInt(n.value)||1;cart=[{...t,qty:a}],saveCart(),updateCartUI(),openOrderModal(),selectedVariation=null}function directOrderFromModal(){const e=document.getElementById("detail-modal"),t=findProductById(e?e.dataset.productId:null);t&&(directOrder(t),closeDetailModal())}function checkStoreStatus(){storeClosed=CONFIG.isStoreClosed();const e=document.getElementById("store-closed-banner"),t=document.getElementById("main-header");storeClosed?(e&&e.classList.remove("hidden"),t&&(t.style.top="36px"),sessionStorage.getItem("store_closed_modal_shown")||setTimeout(()=>{document.getElementById("store-closed-modal").classList.remove("hidden"),sessionStorage.setItem("store_closed_modal_shown","true")},1e3)):(e&&e.classList.add("hidden"),t&&(t.style.top="0"))}function closeStoreClosedModal(){document.getElementById("store-closed-modal").classList.add("hidden")}function showStoreWarning(e){const t=document.getElementById("store-warning-modal"),n=document.getElementById("confirm-store-warning");t.classList.remove("hidden"),n.onclick=()=>{t.classList.add("hidden"),e&&e()}}function closeStoreWarningModal(){document.getElementById("store-warning-modal").classList.add("hidden")}function openOrderModal(){if(0===cart.length)return;closeCartModal(),prefillCustomerInfo();const e=document.getElementById("order-summary"),t=document.querySelector('input[name="pay-method"]:checked'),n=t&&"Bayar Gajian"===t.value;if(e){let t=0;e.innerHTML=cart.map(e=>{const a=n?e.hargaGajian:e.harga,o=calculateTieredPrice(a,e.qty,e.grosir),r=o<a,s=calculateRewardPoints(e.harga,e.nama)*e.qty;return t+=s,`\n                <div class="flex justify-between items-center py-1">\n                    <div class="flex flex-col">\n                        <span class="font-medium">${escapeHtml(e.nama)}${e.selectedVariation?" ("+escapeHtml(e.selectedVariation.nama)+")":""} (x${e.qty})</span>\n                        <div class="flex items-center gap-2">\n                            <span class="text-[10px] text-amber-600 font-bold flex items-center gap-1">\n                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>\n                                +${s.toFixed(1)} Poin\n                            </span>\n                            ${r?'<span class="bg-green-100 text-green-700 text-[8px] px-1 rounded font-bold">Harga Grosir</span>':""}\n                        </div>\n                    </div>\n                    <div class="flex flex-col items-end">\n                        ${r?`<span class="text-[10px] text-gray-400 line-through">Rp ${(a*e.qty).toLocaleString("id-ID")}</span>`:""}\n                        <span class="font-bold">Rp ${(o*e.qty).toLocaleString("id-ID")}</span>\n                    </div>\n                </div>\n            `}).join(""),e.innerHTML+=`\n            <div class="border-t border-dashed border-gray-200 mt-2 pt-2 flex justify-between items-center">\n                <span class="text-xs font-bold text-amber-700">Total Poin Didapat:</span>\n                <span class="text-sm font-black text-amber-700 flex items-center gap-1">\n                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>\n                    ${escapeHtml(t.toFixed(1))} Poin\n                </span>\n            </div>\n        `}updateOrderTotal(),updateOrderCTAState();const a=document.getElementById("order-modal");a&&(a.classList.remove("hidden"),document.body.classList.add("modal-active"))}function prefillCustomerInfo(){const e=document.getElementById("customer-name"),t=document.getElementById("customer-phone");if(!e||!t)return;const n=localStorage.getItem("gosembako_user");if(!n)return;let a;try{a=JSON.parse(n)}catch(e){return}const o=(a.nama||"").trim(),r=normalizePhoneNumber(a.whatsapp||a.phone||"");!e.value.trim()&&o&&(e.value=o),!t.value.trim()&&r&&(t.value=r)}function closeOrderModal(){const e=document.getElementById("order-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}function shareProduct(e){const t=`Cek paket sembako murah "${e}" di GoSembako! Kualitas terjamin, harga bersahabat.`,n=window.location.href,a=`https://wa.me/?text=${encodeURIComponent(t+" "+n)}`;window.open(a,"_blank")}function startNotificationLoop(){const e=["Siti","Budi","Ani","Joko","Rina","Agus","Dewi","Eko"],t=allProducts.length>0?allProducts.map(e=>e.nama):["Paket Sembako"];setInterval(()=>{if(Math.random()>.7){showNotification(`${e[Math.floor(Math.random()*e.length)]} baru saja membeli ${t[Math.floor(Math.random()*t.length)]}`)}},15e3)}function showNotification(e){const t=document.createElement("div");t.className="fixed bottom-24 left-4 bg-white/90 backdrop-blur shadow-lg rounded-xl p-3 flex items-center gap-3 border border-green-100 z-50 animate-bounce",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.innerHTML=`\n            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600">\n                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"></path></svg>\n            </div>\n        <p class="text-xs font-medium text-gray-700">${escapeHtml(e)}</p>\n    `,document.body.appendChild(t),setTimeout(()=>t.remove(),5e3)}function toggleLocationField(){const e=document.querySelector('input[name="ship-method"]:checked'),t=document.getElementById("location-field"),n=document.getElementById("delivery-location-ui"),a=document.getElementById("pickup-location-ui");e&&("Antar Nikomas"===e.value?(t.classList.add("hidden"),n.classList.add("hidden"),a.classList.add("hidden")):"Antar Kerumah"===e.value?(t.classList.remove("hidden"),n.classList.remove("hidden"),a.classList.add("hidden")):"Ambil Ditempat"===e.value&&(t.classList.remove("hidden"),n.classList.add("hidden"),a.classList.remove("hidden"))),updateOrderTotal()}function getCurrentLocation(){const e=document.getElementById("get-location-btn"),t=document.getElementById("location-link");navigator.geolocation?(e.disabled=!0,e.innerHTML="<span>‚åõ Mengambil Lokasi...</span>",navigator.geolocation.getCurrentPosition(n=>{const a=`https://www.google.com/maps?q=${n.coords.latitude},${n.coords.longitude}`;t.value=a,e.classList.remove("bg-white","text-blue-700","border-blue-200"),e.classList.add("bg-green-600","text-white","border-green-600"),e.innerHTML="<span>‚úÖ Lokasi Berhasil Dibagikan</span>",alert("Lokasi berhasil diambil!")},t=>{e.disabled=!1,e.innerHTML="<span>üìç Bagikan Lokasi Saya</span>";let n="Gagal mengambil lokasi.";1===t.code&&(n="Mohon izinkan akses lokasi untuk fitur ini."),alert(n)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})):alert("Geolocation tidak didukung oleh browser Anda")}function updateOrderTotal(){const e=document.querySelector('input[name="pay-method"]:checked'),t=document.querySelector('input[name="ship-method"]:checked'),n=e&&"Bayar Gajian"===e.value,a=t&&"Antar Nikomas"===t.value;let o=0;cart.forEach(e=>{const t=n?e.hargaGajian:e.harga,a=calculateTieredPrice(t,e.qty,e.grosir);o+=a*e.qty});const r=a?2e3:0,s=o+r,i=document.getElementById("sticky-order-total"),d=document.getElementById("order-summary-total");i&&(i.innerText=`Rp ${s.toLocaleString("id-ID")}`),d&&(d.innerText=`Rp ${s.toLocaleString("id-ID")}`);const l=document.getElementById("order-subtotal"),c=document.getElementById("order-shipping");l&&(l.innerText=`Rp ${o.toLocaleString("id-ID")}`),c&&(c.innerText=`Rp ${r.toLocaleString("id-ID")}`),updateOrderCTAState()}function isOrderFormValid(){const e=document.getElementById("customer-name"),t=document.getElementById("customer-phone"),n=document.querySelector('input[name="pay-method"]:checked'),a=document.querySelector('input[name="ship-method"]:checked');if(!e||!t)return!1;const o=e.value.trim(),r=o.replace(/\s/g,"");if(!o||r.length<4)return!1;const s=t.value.trim();if(!s)return!1;return!(normalizePhone(s).replace(/[^0-9]/g,"").length<10)&&Boolean(n&&a)}function updateOrderCTAState(){const e=document.getElementById("send-order-btn")||document.querySelector('[data-action="send-wa"]');if(!e)return;const t=isOrderFormValid();e.disabled=!t,e.setAttribute("aria-disabled",String(!t))}function normalizePhone(e){if(!e)return"";let t=e.toString().replace(/[^0-9]/g,"");return t.startsWith("62")?t="0"+t.slice(2):t.startsWith("8")?t="0"+t:t.startsWith("0")||(t="0"+t),t.startsWith("0")&&!t.startsWith("08")&&t.length,t}function generateOrderId(){const e="0123456789";let t="";for(let n=0;n<6;n++)t+=e.charAt(Math.floor(10*Math.random()));return`ORD-${t}`}async function logOrderToGAS(e){const t={id:e.id||generateOrderId(),pelanggan:e.pelanggan||"",produk:e.produk||"",qty:e.qty||0,total:e.total||0,status:e.status||"Pending",tanggal:e.tanggal||(new Date).toLocaleString("id-ID"),phone:e.phone||"",poin:e.poin||0,point_processed:e.point_processed||"No"};console.log("üìù Logging order to GAS:",t);try{const e=await GASActions.create("orders",t);return console.log("‚úÖ Order logged successfully:",e),e}catch(e){throw console.error("‚ùå Error logging order to GAS:",e),e}}async function sendToWA(){const e=event?.target||document.querySelector('[data-action="send-wa"]');if(e&&e.disabled)return;const t=document.getElementById("customer-name").value,n=document.getElementById("customer-phone").value,a=document.querySelector('input[name="pay-method"]:checked')?.value,o=document.querySelector('input[name="ship-method"]:checked')?.value;if(!t||0===t.trim().length)return void alert("Masukkan Nama Lengkap");const r=t.replace(/\s/g,"");if(r.length<4)return void alert("Masukkan Nama Lengkap");const s=r.toLowerCase(),i=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const e of i)if(e.test(s))return void alert("Masukkan Nama Lengkap");if(!n||0===n.trim().length)return void alert("Nomor WhatsApp tidak valid");const d=n.replace(/[^0-9]/g,"");if(d.length<10)return void alert("Nomor WhatsApp tidak valid");const l=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const e of l)if(e.test(d))return void alert("Nomor WhatsApp tidak valid");if(!a)return void alert("Pilih metode pembayaran terlebih dahulu");if(!o)return void alert("Pilih metode pengiriman terlebih dahulu");e&&(e.disabled=!0,e.innerHTML='\n            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n            </svg>\n            <span>Memproses Pesanan...</span>\n        ',e.classList.add("opacity-75","cursor-not-allowed"));let c="";c="Antar Nikomas"===o?"Antar Nikomas (Area PT Nikomas Gemilang)":"Antar Kerumah"===o?"Antar Kerumah (Area Serang & sekitarnya)":"Ambil Ditempat (Kp. Baru, Kec. Kibin)";const u="Bayar Gajian"===a;let g=0,m=0,p="",h="";cart.forEach((e,t)=>{const n=u?e.hargaGajian:e.harga,a=calculateTieredPrice(n,e.qty,e.grosir),o=a<n,r=a*e.qty;g+=r,m+=e.qty;const s=e.selectedVariation?` (${e.selectedVariation.nama})`:"",i=o?` (Harga Grosir: Rp ${a.toLocaleString("id-ID")}/unit)`:"";p+=`${t+1}. ${e.nama}${s} x${e.qty}${i} = Rp ${r.toLocaleString("id-ID")}\n`,h+=`${e.nama}${s} (x${e.qty}) | `});const f="Antar Nikomas"===o?2e3:0;g+=f;const y=CONFIG.getRewardConfig().pointValue||1e4,b=Math.floor(g/y),v=generateOrderId(),x=document.getElementById("location-link")?.value||"",k=`*PESANAN BARU - GOSEMBAKO*\n\n*Order ID: ${v}*\n*Data Pelanggan:*\nNama: ${t}\nWhatsApp: ${n}\n\n*Detail Pesanan:*\n${p}\n*Metode Pembayaran:* ${a}\n*Metode Pengiriman:* ${o}\n*Lokasi/Titik:* ${c}${x?`\n*Lokasi Maps:* ${x}`:""}\n\n*Ongkir:* Rp ${f.toLocaleString("id-ID")}\n*TOTAL BAYAR: Rp ${g.toLocaleString("id-ID")}*\n*Estimasi Poin:* +${b} Poin\n\nMohon segera diproses ya, terima kasih!`,w=`https://wa.me/628993370200?text=${encodeURIComponent(k)}`,I={id:v,pelanggan:t,produk:h.slice(0,-3),qty:m,total:g,status:"Pending",tanggal:(new Date).toLocaleString("id-ID"),phone:normalizePhone(n),poin:b,point_processed:"No"};try{await logOrderToGAS(I),console.log("‚úÖ Order logged to spreadsheet successfully"),cart=[],saveCart(),updateCartUI(),closeOrderModal(),showSuccessNotification(v,w)}catch(e){console.error("‚ùå Error logging order:",e),alert("Gagal menyimpan pesanan. Silakan coba lagi atau hubungi admin.")}finally{e&&setTimeout(()=>{e.disabled=!1,e.innerHTML='\n                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n                    Kirim Pesanan ke WhatsApp\n                ',e.classList.remove("opacity-75","cursor-not-allowed")},500)}}function handleLogoClick(){let e=parseInt(sessionStorage.getItem("logo_clicks")||0)+1;sessionStorage.setItem("logo_clicks",e),e>=5&&(sessionStorage.setItem("logo_clicks",0),window.location.href="admin/login.html"),setTimeout(()=>sessionStorage.setItem("logo_clicks",0),3e3)}function hideGlobalRewardLoader(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchTukarPoin(){const e=document.getElementById("reward-items-list");if(e)try{renderRewardItems(await ApiService.get("?sheet=tukar_poin",{cacheDuration:18e4}))}catch(t){console.error("Error fetching reward items:",t),e.innerHTML='\n            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">\n                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>\n            </div>\n        '}finally{hideGlobalRewardLoader()}}function renderRewardItems(e){const t=document.getElementById("reward-items-list");t&&(e&&0!==e.length?t.innerHTML=e.map(e=>{const t=e.id||"",n=e.nama||e.judul||"Hadiah",a=e.poin||0,o=e.gambar||"https://via.placeholder.com/100?text=Reward",r=sanitizeUrl(o,"https://via.placeholder.com/100?text=Reward"),s=e.deskripsi||"",i=escapeHtml(n);return`\n            <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 hover:border-green-500 transition-all group shadow-sm">\n                <div class="flex gap-4">\n                    <div class="w-20 h-20 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0">\n                        <img src="${r}" alt="${i}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" data-fallback-src="https://via.placeholder.com/100?text=Reward">\n                    </div>\n                    <div class="flex-1 min-w-0">\n                        <h5 class="font-bold text-gray-800 truncate">${i}</h5>\n                        <p class="text-[10px] text-gray-500 line-clamp-2 mb-2">${escapeHtml(s)}</p>\n                        <div class="flex items-center justify-between">\n                            <div class="bg-amber-100 text-amber-700 px-2 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1">\n                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>\n                                ${a} Poin\n                            </div>\n                            <button type="button" data-action="show-confirm-tukar" data-reward-id="${escapeHtml(t)}" class="bg-green-600 hover:bg-green-700 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg transition active:scale-95">\n                                Tukar\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}).join(""):t.innerHTML='\n            <div class="text-center py-10 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl border-2 border-dashed border-gray-300">\n                <p class="text-sm text-gray-600 font-semibold">Belum ada hadiah yang tersedia.</p>\n            </div>\n        ')}function openRewardModal(){const e=document.getElementById("reward-modal");e&&(e.classList.remove("hidden"),document.body.classList.add("modal-active"),fetchTukarPoin())}function closeRewardModal(){const e=document.getElementById("reward-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}function checkUserPoints(){const e=document.getElementById("reward-phone"),t=e?e.value.trim():"";if(!t)return void alert("Mohon masukkan nomor WhatsApp.");const n=normalizePhone(t),a=event.target,o=a?a.innerText:"Cek Poin";a&&"BUTTON"===a.tagName&&(a.innerText="Mencari...",a.disabled=!0),ApiService.get("?sheet=user_points",{cache:!1}).then(e=>{const t=e.find(e=>normalizePhone(e.phone||e.whatsapp||"")===n),a=document.getElementById("points-display"),o=document.querySelector("#points-display h4");if(t){const e=(t.points||t.poin||"0").toString().replace(",","."),a=parseFloat(e)||0;o.innerHTML=`${escapeHtml(a.toFixed(1))} <span class="text-sm font-bold">Poin</span>`,sessionStorage.setItem("user_points",a),sessionStorage.setItem("reward_phone",n),sessionStorage.setItem("reward_customer_name",t.nama||t.pelanggan||n),showToast(`Ditemukan ${a.toFixed(1)} poin untuk nomor ini!`)}else o.innerHTML=`${escapeHtml("0.0")} <span class="text-sm font-bold">Poin</span>`,sessionStorage.setItem("user_points",0),sessionStorage.setItem("reward_phone",n),sessionStorage.setItem("reward_customer_name",n),showToast("Nomor tidak ditemukan atau belum memiliki poin.");a.classList.remove("hidden")}).catch(e=>{console.error("Error checking points:",e),alert("Gagal mengecek poin. Silakan coba lagi.")}).finally(()=>{a&&"BUTTON"===a.tagName&&(a.innerText=o,a.disabled=!1)})}async function claimReward(e){const t=sessionStorage.getItem("reward_phone");if(t)try{const n=await ApiService.get(`?sheet=tukar_poin&action=search&id=${e}`,{cache:!1});if(!n||0===n.length)return void alert("Data hadiah tidak ditemukan.");const a=n[0],o=parseFloat(a.poin)||0,r=a.nama||a.judul||"Hadiah",s=parseFloat(sessionStorage.getItem("user_points"))||0,i=`Tukar ${o} poin Anda dengan "${r}"?\nSaldo poin saat ini: ${s.toFixed(1)}`;if(!confirm(i))return;let d=prompt("Silakan masukkan nama Anda untuk klaim ini:",sessionStorage.getItem("reward_customer_name")||"");if(null===d)return;d=d.trim()||"Pelanggan",showToast("Sedang memproses penukaran...");const l=`RW-${Date.now()}-${Math.floor(1e5*Math.random())}`,c=await GASActions.post({action:"claim_reward",sheet:"tukar_poin",data:{reward_id:e,phone:t,customer_name:d,request_id:l}}),u=c.claim_id||"CLM-"+Date.now().toString().slice(-6),g=parseFloat(c.points_used||o)||0,m=parseFloat(c.balance_after),p=Number.isNaN(m)?Math.max(0,s-g):m;sessionStorage.setItem("user_points",p);const h=document.querySelector("#points-display h4");h&&(h.innerHTML=`${escapeHtml(p.toFixed(1))} <span class="text-sm font-bold">Poin</span>`);const f=`*KLAIM REWARD POIN BERHASIL*\n\nID Klaim: ${u}\nPelanggan: ${d}\nNomor WhatsApp: ${t}\nReward: ${r}\nPoin Ditukar: ${g}\nSisa Poin: ${p.toFixed(1)}\n\nMohon segera diproses. Terima kasih!`,y=`https://wa.me/628993370200?text=${encodeURIComponent(f)}`;showToast("Penukaran poin berhasil!"),setTimeout(()=>{window.open(y,"_blank")},1500)}catch(e){console.error("Error in claimReward:",e);const t=buildClaimRewardErrorMessage(e);alert(t)}else alert("Mohon cek poin Anda terlebih dahulu.")}document.addEventListener("DOMContentLoaded",()=>{fetchProducts(),fetchTukarPoin();const e=document.getElementById("product-grid");e&&e.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t||t.disabled)return;const n=t.getAttribute("data-action"),a=t.getAttribute("data-product-id")||t.closest("[data-product-id]")?.getAttribute("data-product-id"),o=findProductById(a);switch(n){case"toggle-wishlist":a&&toggleWishlist(a);break;case"show-detail":o&&showDetail(o);break;case"add-to-cart":o&&addToCart(o,e);break;case"direct-order":o&&directOrder(o);break;case"share-product":o&&shareProduct(o.nama)}});const t=document.getElementById("category-filters");t&&t.addEventListener("click",e=>{const t=e.target.closest('[data-action="set-category"]');if(!t)return;const n=t.getAttribute("data-category");n&&setCategory(n)});const n=document.getElementById("pagination-container");n&&n.addEventListener("click",e=>{const t=e.target.closest('[data-action="change-page"]');if(!t||t.disabled)return;const n=parseInt(t.getAttribute("data-page"),10);Number.isNaN(n)||changePage(n)});const a=document.getElementById("modal-add-cart");a&&a.addEventListener("click",e=>{const t=document.getElementById("detail-modal"),n=findProductById(t?t.dataset.productId:null);if(n){const t=document.getElementById("modal-qty");addToCart(n,e,t?parseInt(t.value):1),closeDetailModal()}});const o=document.getElementById("order-modal");if(o){o.querySelectorAll('input[name="ship-method"], input[name="pay-method"], #customer-name, #customer-phone').forEach(e=>{const t="radio"===e.type?"change":"input";e.addEventListener(t,updateOrderCTAState)}),updateOrderCTAState()}const r=document.getElementById("detail-modal");r&&r.addEventListener("click",e=>{const t=e.target.closest('[data-action="select-variation"]');if(!t||t.disabled)return;const n=parseInt(t.getAttribute("data-index"),10);if(!currentModalProduct||!currentModalProduct.variations||Number.isNaN(n))return;const a=currentModalProduct.variations[n];a&&selectVariation(a,n)});const s=document.getElementById("wishlist-items-container");s&&s.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t||t.disabled)return;const n=t.getAttribute("data-action"),a=t.getAttribute("data-product-id"),o=findProductById(a);"wishlist-toggle"===n&&a?toggleWishlist(a):"wishlist-buy"===n&&o&&showDetail(o)});const i=document.getElementById("cart-items");i&&i.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t||t.disabled)return;const n=t.getAttribute("data-action"),a=parseInt(t.getAttribute("data-index"),10),o=parseInt(t.getAttribute("data-delta"),10);"update-cart-qty"!==n||Number.isNaN(a)||Number.isNaN(o)||updateQty(a,o),"remove-cart-item"!==n||Number.isNaN(a)||removeItem(a)});const d=document.getElementById("search-suggestions");d&&d.addEventListener("click",e=>{const t=e.target.closest('[data-action="search-suggestion"]');if(!t)return;const n=t.getAttribute("data-value")||"",a=document.getElementById("search-input");a&&(a.value=n,filterProducts()),closeSearchSuggestions()});const l=document.getElementById("search-suggestions-header");l&&l.addEventListener("click",e=>{const t=e.target.closest('[data-action="search-suggestion"]');if(!t)return;const n=t.getAttribute("data-value")||"",a=document.getElementById("search-input-header"),o=document.getElementById("search-input");a&&(a.value=n),o&&(o.value=n),filterProducts(),closeSearchSuggestions()});const c=document.getElementById("search-input");c&&c.addEventListener("keydown",e=>{"Escape"===e.key&&closeSearchSuggestions(),"Enter"===e.key&&(closeSearchSuggestions(),e.preventDefault(),c.blur())});const u=document.getElementById("search-input-header");u&&u.addEventListener("keydown",e=>{"Escape"===e.key&&closeSearchSuggestions(),"Enter"===e.key&&(closeSearchSuggestions(),e.preventDefault(),u.blur())}),document.addEventListener("click",e=>{e.target.closest("#search-input")||e.target.closest("#search-suggestions")||e.target.closest("#search-input-header")||e.target.closest("#search-suggestions-header")||closeSearchSuggestions()});const g=document.getElementById("search-input-header");g&&(g.addEventListener("input",e=>{const t=e.target.value||"",n=document.getElementById("search-input");n&&(n.value=t),filterProducts()}),g.addEventListener("focus",()=>{const e=document.getElementById("main-header");e&&e.classList.add("header-search-active")}),g.addEventListener("blur",()=>{const e=document.getElementById("main-header");e&&setTimeout(()=>e.classList.remove("header-search-active"),120)}))});let pendingRewardData={id:null,nama:null,poin:null,gambar:null,deskripsi:null};async function showConfirmTukarModal(e){const t=parseFloat(sessionStorage.getItem("user_points"))||0;if(sessionStorage.getItem("reward_phone"))try{const n=await ApiService.get(`?sheet=tukar_poin&action=search&id=${e}`,{cache:!1});if(!n||0===n.length)return void showToast("Data hadiah tidak ditemukan.");const a=n[0],o=parseFloat(a.poin)||0,r=a.nama||a.judul||"Hadiah";if(t<o)return void showToast(`Poin Anda tidak cukup. Dibutuhkan ${o} poin, saldo Anda ${t.toFixed(1)} poin.`);pendingRewardData={id:e,nama:r,poin:o,gambar:a.gambar||"",deskripsi:a.deskripsi||""},document.getElementById("confirm-reward-name").textContent=r,document.getElementById("confirm-reward-points").textContent=o,document.getElementById("confirm-remaining-points").textContent=(t-o).toFixed(1);document.getElementById("confirm-tukar-modal").classList.remove("hidden"),document.body.classList.add("modal-active")}catch(e){console.error("Error showing confirm modal:",e),showToast("Terjadi kesalahan saat memproses permintaan Anda.")}else showToast("Mohon cek poin Anda terlebih dahulu.")}function cancelTukarModal(){document.getElementById("confirm-tukar-modal").classList.add("hidden"),document.body.classList.remove("modal-active"),pendingRewardData={id:null,nama:null,poin:null,gambar:null,deskripsi:null}}function proceedToNameInput(){document.getElementById("confirm-tukar-modal").classList.add("hidden");document.getElementById("name-input-modal").classList.remove("hidden"),setTimeout(()=>{document.getElementById("claim-name-input").focus()},100)}function backToConfirmModal(){document.getElementById("name-input-modal").classList.add("hidden"),document.getElementById("confirm-tukar-modal").classList.remove("hidden"),document.getElementById("claim-name-input").value=""}async function submitNameAndClaim(){const e=document.getElementById("claim-name-input").value.trim();e?e.length<3?showToast("Nama harus minimal 3 karakter."):(document.getElementById("name-input-modal").classList.add("hidden"),document.body.classList.remove("modal-active"),await processClaimReward(pendingRewardData.id,e)):showToast("Mohon masukkan nama Anda terlebih dahulu.")}async function processClaimReward(e,t){const n=sessionStorage.getItem("reward_phone");try{const a=await ApiService.get(`?sheet=tukar_poin&action=search&id=${e}`,{cache:!1});if(!a||0===a.length)return void showToast("Data hadiah tidak ditemukan.");const o=a[0],r=parseFloat(o.poin)||0,s=o.nama||o.judul||"Hadiah",i=parseFloat(sessionStorage.getItem("user_points"))||0;showToast("Sedang memproses penukaran...");const d=`RW-${Date.now()}-${Math.floor(1e5*Math.random())}`,l=await GASActions.post({action:"claim_reward",sheet:"tukar_poin",data:{reward_id:e,phone:n,customer_name:t,request_id:d}}),c=l.claim_id||"CLM-"+Date.now().toString().slice(-6),u=parseFloat(l.points_used||r)||0,g=parseFloat(l.balance_after),m=Number.isNaN(g)?Math.max(0,i-u):g;sessionStorage.setItem("user_points",m);const p=document.querySelector("#points-display h4");p&&(p.innerHTML=`${escapeHtml(m.toFixed(1))} <span class="text-sm font-bold">Poin</span>`);const h=`*KLAIM REWARD POIN BERHASIL*\n\nID Klaim: ${c}\nPelanggan: ${t}\nNomor WhatsApp: ${n}\nReward: ${s}\nPoin Ditukar: ${u}\nSisa Poin: ${m.toFixed(1)}\n\nMohon segera diproses. Terima kasih!`,f=`https://wa.me/628993370200?text=${encodeURIComponent(h)}`;window.claimWhatsAppUrl=f,pendingRewardData={id:null,nama:null,poin:null,gambar:null,deskripsi:null},document.getElementById("name-input-modal").classList.add("hidden"),document.getElementById("confirm-tukar-modal").classList.add("hidden"),setTimeout(()=>{showClaimSuccessModal(c)},300)}catch(e){console.error("Error processing claim:",e),showToast(buildClaimRewardErrorMessage(e))}}function buildClaimRewardErrorMessage(e){const t=String(e&&e.message||e||"").toLowerCase();return t.includes("reward_stock_empty")?"Stok reward sedang habis.":t.includes("reward_daily_quota_reached")?"Quota harian reward sudah habis.":t.includes("points_insufficient")?"Poin Anda tidak cukup untuk reward ini.":t.includes("user_not_found")?"Data poin pengguna tidak ditemukan.":t.includes("rate_limited")?"Terlalu banyak percobaan klaim, coba lagi sebentar.":"Gagal memproses penukaran. Silakan coba lagi."}const WISHLIST_KEY="gos_wishlist";function getWishlist(){const e=localStorage.getItem(WISHLIST_KEY);return e?JSON.parse(e):[]}function saveWishlist(e){localStorage.setItem(WISHLIST_KEY,JSON.stringify(e)),updateWishlistCount()}function toggleWishlist(e){let t=getWishlist();const n=t.indexOf(e);n>-1?(t.splice(n,1),showToast("Produk dihapus dari Wishlist.")):(t.push(e),showToast("Produk ditambahkan ke Wishlist!")),saveWishlist(t),updateProductWishlistIcon(e);const a=document.getElementById("wishlist-modal");a&&!a.classList.contains("hidden")&&renderWishlistItems()}function isProductInWishlist(e){return getWishlist().includes(e)}function updateWishlistCount(){const e=getWishlist().length,t=document.getElementById("wishlist-count");t&&(t.textContent=e,e>0?t.classList.remove("hidden"):t.classList.add("hidden"))}function updateProductWishlistIcon(e){const t=document.getElementById(`wishlist-btn-${e}`);if(!t)return;const n=isProductInWishlist(e)?'<svg class="w-5 h-5 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>':'<svg class="w-5 h-5 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>';t.innerHTML=n}function openWishlistModal(){const e=document.getElementById("wishlist-modal");e&&(e.classList.remove("hidden"),document.body.classList.add("modal-active"),renderWishlistItems())}function closeWishlistModal(){const e=document.getElementById("wishlist-modal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-active"))}async function renderWishlistItems(){const e=getWishlist(),t=document.getElementById("wishlist-items-container");if(console.log("üîç Rendering wishlist items:",{wishlistIds:e,containerFound:!!t}),!t)return;if(0===e.length)return void(t.innerHTML='\n            <div class="text-center py-10">\n                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>\n                </svg>\n                <p class="text-gray-500 font-semibold">Wishlist Anda kosong.</p>\n                <p class="text-gray-400 text-sm mt-2">Tambahkan produk favorit Anda!</p>\n            </div>\n        ');if(!allProducts||0===allProducts.length){console.log("üì¶ Fetching products for wishlist...");try{await fetchProducts(),console.log("‚úÖ Products fetched:",allProducts.length)}catch(e){return console.error("‚ùå Failed to fetch products:",e),void(t.innerHTML='<p class="text-center text-red-500 py-4">Gagal memuat produk. Silakan refresh halaman.</p>')}}const n=new Set(e.map(e=>String(e).trim()));console.log("üîç Wishlist Set:",Array.from(n));const a=allProducts.filter(e=>{const t=String(e.productId||"").trim(),a=n.has(t);return a&&console.log("‚úÖ Found wishlist product:",t,e.nama),a});console.log("üìä Wishlist products found:",a.length),0!==a.length?(t.innerHTML=a.map(e=>{const t=e.productId,n=parseFloat(e.harga_tunai||e.harga||0),a=e.gambar?String(e.gambar).split(",")[0].trim():"";return`\n            <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 transition">\n                <div class="flex items-center gap-3 flex-1">\n                    <img src="${sanitizeUrl(a,"https://placehold.co/100x100?text=Produk")}" alt="${escapeHtml(e.nama)}" class="w-16 h-16 object-cover rounded-lg shadow-sm" data-fallback-src="https://placehold.co/100x100?text=Produk">\n                    <div class="flex-1">\n                        <p class="font-semibold text-sm text-gray-800">${escapeHtml(e.nama)}</p>\n                        <p class="text-xs text-green-600 font-bold mt-1">Rp ${n.toLocaleString("id-ID")}</p>\n                    </div>\n                </div>\n                <div class="flex gap-2">\n                    <button type="button" data-action="wishlist-toggle" data-product-id="${t}" class="text-red-500 hover:text-red-700 p-2 transition active:scale-95" title="Hapus dari Wishlist">\n                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>\n                    </button>\n                    <button type="button" data-action="wishlist-buy" data-product-id="${t}" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition active:scale-95">\n                        Beli\n                    </button>\n                </div>\n            </div>\n        `}).join(""),console.log("‚úÖ Wishlist rendered successfully")):t.innerHTML='<p class="text-center text-gray-500 py-4">Produk tidak ditemukan. Mungkin produk sudah tidak tersedia.</p>'}function showQRISModal(){const e=document.getElementById("qris-modal");e&&e.classList.remove("hidden")}function closeQRISModal(){const e=document.getElementById("qris-modal");e&&e.classList.add("hidden")}async function handleDeepLink(){if(console.log("[DeepLink] Checking for hash:",window.location.hash),0===allProducts.length)return console.log("[DeepLink] Products not loaded yet, waiting..."),void setTimeout(handleDeepLink,500);if(window.location.hash){const e=window.location.hash.substring(1);if(console.log("[DeepLink] Hash found:",e),e.startsWith("produk-")){const t=e.substring(7);console.log("[DeepLink] Looking for product with slug:",t);const n=findProductBySlug(t);n?(console.log("[DeepLink] Product found:",n.nama),setTimeout(()=>{showDetail(n)},500)):console.warn("[DeepLink] Product with slug not found:",t)}}}function showClaimSuccessModal(e){console.log("showClaimSuccessModal called with claimId:",e);const t=document.getElementById("claim-success-modal"),n=document.getElementById("claim-success-id");console.log("Modal element:",t),console.log("Claim ID element:",n),t&&n?(n.textContent=e,t.classList.remove("hidden"),console.log("Modal should now be visible")):console.error("Modal or claimIdElement not found!")}function closeClaimSuccessModal(){const e=document.getElementById("claim-success-modal");e&&e.classList.add("hidden")}function openClaimWhatsApp(){window.claimWhatsAppUrl&&(window.open(window.claimWhatsAppUrl,"_blank"),setTimeout(()=>{closeClaimSuccessModal()},500))}function updatePaymentMethodInfo(e){const t=document.getElementById("payment-method-info"),n=document.getElementById("payment-method-info-text"),a=document.getElementById("qris-display");if(!t||!n)return;const o={tunai:"Pembayaran dilakukan secara tunai saat pesanan diterima atau diambil.",qris:"Pembayaran dilakukan melalui QRIS menggunakan e-wallet atau mobile banking.",gajian:"Pembayaran ditagihkan pada periode gajian berikutnya, jatuh tempo tanggal 6‚Äì7."};t.classList.contains("hidden")||t.classList.add("opacity-0","scale-95"),a&&!a.classList.contains("hidden")&&a.classList.add("opacity-0","scale-95"),setTimeout(()=>{o[e]?(n.textContent=o[e],t.classList.remove("hidden"),t.offsetWidth,setTimeout(()=>{t.classList.remove("opacity-0","scale-95"),t.classList.add("opacity-100","scale-100")},10)):t.classList.add("hidden"),a&&("qris"===e?(a.classList.remove("hidden"),a.offsetWidth,setTimeout(()=>{a.classList.remove("opacity-0","scale-95"),a.classList.add("opacity-100","scale-100")},10)):a.classList.add("hidden"))},150)}function openCategorySidebar(){const e=document.getElementById("category-sidebar"),t=document.getElementById("sidebar-overlay");e&&t&&(t.classList.remove("hidden"),setTimeout(()=>{e.classList.remove("-translate-x-full"),e.classList.add("translate-x-0")},10),document.body.style.overflow="hidden",loadSidebarCategories())}function closeCategorySidebar(){const e=document.getElementById("category-sidebar"),t=document.getElementById("sidebar-overlay");e&&t&&(e.classList.remove("translate-x-0"),e.classList.add("-translate-x-full"),setTimeout(()=>{t.classList.add("hidden")},300),document.body.style.overflow="")}function loadSidebarCategories(){const e=document.getElementById("sidebar-category-list");if(!e)return;const t=[...new Set(allProducts.map(e=>e.kategori).filter(e=>e))];t.sort();const n=t.map(e=>{const t=getCategoryIcon(e),n=escapeHtml(e);return`\n            <li class="border-b border-gray-100 last:border-0">\n                <button type="button" data-action="select-sidebar-category" data-category="${n}" class="flex items-center gap-3 py-3 px-2 hover:bg-green-50 rounded-lg transition group">\n                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition">\n                        ${t}\n                    </div>\n                    <span class="font-semibold text-gray-700 group-hover:text-green-700">${n}</span>\n                </button>\n            </li>\n        `}).join(""),a=e.querySelector("li");e.innerHTML=a?a.outerHTML+n:n}function getCategoryIcon(e){return'\n        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">\n            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>\n        </svg>\n    '}function selectSidebarCategory(e){setCategory(e),closeCategorySidebar();const t=document.getElementById("products");t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function updateMobileCartCount(){const e=document.getElementById("mobile-cart-count"),t=document.getElementById("cart-count");if(e&&t){const t=cart.length;t>0?(e.textContent=t,e.classList.remove("hidden")):e.classList.add("hidden")}}document.addEventListener("DOMContentLoaded",updateWishlistCount),window.addEventListener("hashchange",handleDeepLink,!1),document.addEventListener("DOMContentLoaded",()=>{setTimeout(handleDeepLink,1e3)});const originalUpdateCartUI=updateCartUI;updateCartUI=function(){"function"==typeof originalUpdateCartUI&&originalUpdateCartUI(),updateMobileCartCount()},document.addEventListener("DOMContentLoaded",function(){updateMobileCartCount()});


/* ===== assets/js/akun.min.js ===== */
const normalizePhoneTo08=e=>{const t=String(null==e?"":e).replace(/[^0-9]/g,"");if(!t)return"";let n=t;return n.startsWith("62")&&(n=n.slice(2)),n.startsWith("0")&&(n=n.slice(1)),n.startsWith("8")?"0"+n:""},phoneLookupVariants=e=>{const t=normalizePhoneTo08(e);if(!t)return[];const n=t.slice(1);return[t,`+62${n}`,`62${n}`,n]},displayPhone=e=>normalizePhoneTo08(e)||e||"",parseSheetResponse=e=>Array.isArray(e)?e:e&&Array.isArray(e.result)?e.result:e&&e.result?Array.isArray(e.result)?e.result:[e.result]:[],isUnauthorizedApiResponse=e=>Boolean(e&&"object"==typeof e&&!Array.isArray(e)&&"unauthorized"===String(e.error||"").toLowerCase()),buildSessionQuery=e=>{const t=String(e&&e.session_token||"").trim();return t?`&session_token=${encodeURIComponent(t)}`:""},hasPublicSession=e=>""!==String(e&&e.session_token||"").trim();let referralProfileCache=null,pendingReferralCodeFromUrl="",referralConfigCache={rewardReferrerPoints:20,rewardRefereePoints:10,minFirstOrder:5e4};function toReferralCodeValue(e){return String(e||"").trim().toUpperCase()}function getReferralCodeFromUrl(){try{const e=new URLSearchParams(window.location.search||"");return toReferralCodeValue(e.get("ref")||e.get("referral")||e.get("kode_referral")||"")}catch(e){return console.warn("Failed parsing referral code from URL:",e),""}}function buildReferralShareUrl(e){const t=toReferralCodeValue(e);if(!t||"-"===t)return"";const n=new URL(`${window.location.origin}${window.location.pathname}`);return n.searchParams.set("ref",t),n.toString()}function updateRegisterReferralInfo(){const e=document.getElementById("register-referral-info"),t=document.getElementById("register-referral-info-text");e&&t&&(pendingReferralCodeFromUrl?(t.textContent=`Referral dari link aktif: ${pendingReferralCodeFromUrl}`,e.classList.remove("hidden")):e.classList.add("hidden"))}function buildReferralShareMessage(e,t){const n=toReferralCodeValue(e);if(!n||"-"===n||!t)return"";const r=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,a=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,o=parseInt(referralConfigCache.minFirstOrder||0,10)||0;return["Halo, yuk daftar GoSembako pakai link referral saya.","",`Link: ${t}`,`Kode Referral: ${n}`,"",`Bonus pengguna baru: ${a} poin`,`Bonus pengajak: ${r} poin`,`Bonus aktif setelah pesanan pertama selesai (minimal ${o>0?formatCurrency(o):"sesuai ketentuan program"}).`,"","Terima kasih."].join("\n")}function updateReferralShareUI(e){const t=toReferralCodeValue(e&&e.kode_referral?e.kode_referral:""),n=buildReferralShareUrl(t),r=document.getElementById("referral-link-display"),a=document.getElementById("referral-share-message"),o=document.getElementById("referral-reward-info");if(r&&(r.value=n||"-"),a&&(a.textContent=n?buildReferralShareMessage(t,n):"Link referral akan muncul setelah kode referral tersedia."),o){const e=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,t=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,n=parseInt(referralConfigCache.minFirstOrder||0,10)||0;o.textContent=`Pengajak: ${e} poin, Pengguna baru: ${t} poin (setelah pesanan pertama selesai${n>0?`, minimal ${formatCurrency(n)}`:""}).`}}async function loadPublicReferralConfig(){try{const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?action=public_referral_config&_t=${Date.now()}`);if(!t.ok)return;const n=await t.json();if(!n||!0!==n.success)return;referralConfigCache={rewardReferrerPoints:parseInt(n.reward_referrer_points||referralConfigCache.rewardReferrerPoints,10)||referralConfigCache.rewardReferrerPoints,rewardRefereePoints:parseInt(n.reward_referee_points||referralConfigCache.rewardRefereePoints,10)||referralConfigCache.rewardRefereePoints,minFirstOrder:parseInt(n.min_first_order||referralConfigCache.minFirstOrder,10)||referralConfigCache.minFirstOrder}}catch(e){console.warn("Failed to load public referral config:",e)}}function setReferralStatus(e,t){const n=document.getElementById("referral-status");n&&(n.textContent=e||"",n.className="text-xs","success"===t?n.classList.add("text-green-600"):"error"===t?n.classList.add("text-red-600"):"warning"===t?n.classList.add("text-amber-600"):n.classList.add("text-gray-500"))}function generateReferralCode(e,t,n){const r=String(e||"USER").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6)||"USER",a=normalizePhoneTo08(t).replace(/\D/g,"").slice(-4)||Math.floor(1e3+9e3*Math.random()).toString();let o=`${r}${a}`.slice(0,24);if(!n.has(o))return o;for(let e=1;e<=2e3;e+=1){const t=`${r}${a}${e}`.slice(0,24);if(!n.has(t))return t}return`${r}${Date.now().toString().slice(-6)}`.slice(0,24)}async function fetchUsersList(){const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=users&_t=${Date.now()}`);if(!t.ok)throw new Error("Gagal memuat data users");return parseSheetResponse(await t.json())}async function ensureUserReferralCode(e,t){const n=t.find(t=>String(t.id)===String(e.id))||t.find(t=>normalizePhoneTo08(t.whatsapp||t.phone||"")===normalizePhoneTo08(e.whatsapp));if(!n)return{user:{id:e.id||"",nama:e.nama||"User",whatsapp:normalizePhoneTo08(e.whatsapp||e.phone||""),kode_referral:"",referred_by:"",referral_count:0,referral_points_total:0},code:"",missingProfile:!0};const r=toReferralCodeValue(n.kode_referral);if(r)return{user:n,code:r};const a=new Set(t.map(e=>toReferralCodeValue(e.kode_referral)).filter(Boolean)),o=generateReferralCode(n.nama,n.whatsapp||n.phone,a);return await GASActions.update("users",n.id,{kode_referral:o}),n.kode_referral=o,{user:n,code:o}}function applyReferralDataToUI(e){const t=document.getElementById("referral-code-display"),n=document.getElementById("referral-input"),r=document.getElementById("apply-referral-btn"),a=document.getElementById("referral-count"),o=document.getElementById("referral-points-total");t&&(t.value=toReferralCodeValue(e.kode_referral)||"-"),a&&(a.textContent=String(parseInt(e.referral_count||0,10)||0)),o&&(o.textContent=String(parseInt(e.referral_points_total||0,10)||0));const s=""!==toReferralCodeValue(e.referred_by);n&&(n.value=s?toReferralCodeValue(e.referred_by):"",n.disabled=s),r&&(r.disabled=s),s?setReferralStatus(`Referral aktif dengan kode: ${toReferralCodeValue(e.referred_by)}`,"success"):setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info"),updateReferralShareUI(e)}function buildReferralProfileFallback(e){return{id:e&&e.id?e.id:"",nama:e&&e.nama?e.nama:"User",whatsapp:normalizePhoneTo08(e&&(e.whatsapp||e.phone)||""),kode_referral:toReferralCodeValue(e&&e.kode_referral?e.kode_referral:""),referred_by:toReferralCodeValue(e&&e.referred_by?e.referred_by:""),referral_count:parseInt(e&&e.referral_count||0,10)||0,referral_points_total:parseInt(e&&e.referral_points_total||0,10)||0}}function getReferralStatusBadge(e){const t=String(e||"").toLowerCase();return"approved"===t?'<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold">Approved</span>':"rejected"===t||"void"===t?'<span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold">Rejected</span>':'<span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">Pending</span>'}async function loadReferralHistory(e){const t=document.getElementById("referral-history-list"),n=document.getElementById("referral-history-badge");if(t&&n)try{const r=CONFIG.getMainApiUrl(),a=normalizePhoneTo08(e.whatsapp);let o=[];const s=buildSessionQuery(e);if(s){const e=await fetch(`${r}?action=public_referral_history${s}&_t=${Date.now()}`);if(e.ok){const t=await e.json();t&&t.success&&Array.isArray(t.referrals)&&(o=t.referrals)}}if(!o.length){const e=await fetch(`${r}?sheet=referrals&phone=${encodeURIComponent(a)}&_t=${Date.now()}`);if(!e.ok)throw new Error("Gagal memuat riwayat referral");o=parseSheetResponse(await e.json())}const i=o.filter(e=>{const t=normalizePhoneTo08(e.referrer_phone||""),n=normalizePhoneTo08(e.referee_phone||"");return t===a||n===a}).sort((e,t)=>new Date(t.created_at||0).getTime()-new Date(e.created_at||0).getTime()).slice(0,5);if(n.textContent=`${i.length} data`,0===i.length)return void(t.innerHTML='<p class="text-gray-400">Belum ada riwayat referral.</p>');t.innerHTML=i.map(e=>{const t=normalizePhoneTo08(e.referrer_phone||"")===a?"Anda mengajak":"Anda diajak",n=normalizePhoneTo08("Anda mengajak"===t?e.referee_phone||"":e.referrer_phone||""),r="Anda mengajak"===t?parseInt(e.reward_referrer_points||0,10)||0:parseInt(e.reward_referee_points||0,10)||0;return`\n                <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">\n                    <div class="flex items-center justify-between mb-1">\n                        <span class="font-bold text-gray-700">${escapeHtml(t)}</span>\n                        ${getReferralStatusBadge(e.status)}\n                    </div>\n                    <p class="text-gray-600">No: ${escapeHtml(n||"-")}</p>\n                    <p class="text-green-700 font-semibold">Reward: ${escapeHtml(String(r))} poin</p>\n                </div>\n            `}).join("")}catch(e){console.error("Error loading referral history:",e),n.textContent="error",t.innerHTML='<p class="text-red-500">Gagal memuat riwayat referral.</p>'}}async function loadReferralData(e){try{const t=await fetchUsersList(),n=await ensureUserReferralCode(e,t);if(referralProfileCache=n.user,applyReferralDataToUI(n.user),n.missingProfile)return applyReferralDataToUI(buildReferralProfileFallback(e)),void setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info");await loadReferralHistory(e)}catch(t){console.error("Error loading referral data:",t),applyReferralDataToUI(buildReferralProfileFallback(e)),setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info")}}function showLogin(){document.getElementById("login-section").classList.remove("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showDashboard(e){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.remove("hidden"),document.getElementById("user-name").textContent=e.nama,document.getElementById("user-whatsapp").textContent=displayPhone(e.whatsapp),loadLoyaltyPoints(e),loadReferralData(e),loadOrderHistory(e)}function showError(e){const t=document.getElementById("login-error");document.getElementById("login-error-text").textContent=e,t.classList.remove("hidden")}function resetLoginButton(){const e=document.getElementById("login-btn");e.disabled=!1,e.innerHTML='\n        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>\n        </svg>\n        Masuk\n    '}function saveLoggedInUser(e){const t=normalizePhoneTo08(e.whatsapp||e.phone||"");localStorage.setItem("gosembako_user",JSON.stringify({id:e.id,nama:e.nama,whatsapp:t||e.whatsapp,tanggal_daftar:e.tanggal_daftar,status:e.status||"",total_points:parseInt(e.total_points||e.points||e.poin||0,10)||0,kode_referral:toReferralCodeValue(e.kode_referral||""),referred_by:toReferralCodeValue(e.referred_by||""),referral_count:parseInt(e.referral_count||0,10)||0,referral_points_total:parseInt(e.referral_points_total||0,10)||0,session_token:String(e.session_token||"").trim()}))}function getLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;const t=JSON.parse(e);return t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||"")||t.whatsapp,t.session_token=String(t.session_token||"").trim(),t}function logout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("gosembako_user"),window.location.reload())}async function copyReferralCode(){const e=document.getElementById("referral-code-display"),t=toReferralCodeValue(e?e.value:"");if(!t||"-"===t)return void setReferralStatus("Kode referral belum tersedia.","warning");const n=buildReferralShareUrl(t);if(n)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(n);else{const e=document.createElement("textarea");e.value=n,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}setReferralStatus("Link referral berhasil disalin.","success")}catch(e){console.error("Copy referral failed:",e),setReferralStatus("Gagal menyalin link referral.","error")}else setReferralStatus("Link referral tidak tersedia.","warning")}function shareReferralWhatsApp(){const e=toReferralCodeValue(document.getElementById("referral-code-display")?.value||""),t=buildReferralShareUrl(e);if(!t)return void setReferralStatus("Link referral belum tersedia.","warning");const n=buildReferralShareMessage(e,t),r=`https://wa.me/?text=${encodeURIComponent(n)}`;window.open(r,"_blank","noopener"),setReferralStatus("Link referral siap dibagikan ke WhatsApp.","success")}async function applyReferralCode(){const e=getLoggedInUser();if(!e)return void setReferralStatus("Silakan login ulang.","error");const t=document.getElementById("referral-input"),n=document.getElementById("apply-referral-btn"),r=toReferralCodeValue(t?t.value:"");if(!r)return void setReferralStatus("Masukkan kode referral terlebih dahulu.","warning");const a=toReferralCodeValue(document.getElementById("referral-code-display")?.value);if(a&&r===a)return void setReferralStatus("Kode referral sendiri tidak bisa dipakai.","error");if(t&&t.disabled)return void setReferralStatus("Kode referral sudah pernah diterapkan.","warning");const o=n?n.textContent:"";try{n&&(n.disabled=!0,n.textContent="Memproses...");const a=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:normalizePhoneTo08(e.whatsapp),ref_code:r}});if(!a||!1===a.success)return setReferralStatus(a&&(a.message||a.error||a.error_code)||"Gagal menerapkan referral","error"),void(n&&(n.disabled=!1,n.textContent=o||"Terapkan"));t&&(t.value=r,t.disabled=!0),n&&(n.disabled=!0,n.textContent="Terapkan"),setReferralStatus("Kode referral berhasil diterapkan.","success"),await loadReferralData(e)}catch(e){console.error("applyReferralCode error:",e),setReferralStatus(e.message||"Gagal menerapkan kode referral.","error"),n&&(n.disabled=!1,n.textContent=o||"Terapkan")}}async function loadLoyaltyPoints(e){try{const t=CONFIG.getMainApiUrl(),n=normalizePhoneTo08(e.whatsapp),r=parseInt(e.total_points||e.points||e.poin||0,10)||0;if(!n)return console.warn("‚ö†Ô∏è Invalid phone number for loyalty points lookup"),document.getElementById("loyalty-points").textContent=String(r),void setRewardContextFromAkun(e.whatsapp,r,e.nama);console.log(`üîç Loading loyalty points for phone: ${n}`);let a=null;const o=buildSessionQuery(e);if(o){const e=await fetch(`${t}?action=public_user_points${o}&_t=${Date.now()}`);if(e.ok){const t=await e.json();t&&t.success&&(a=parseInt(t.points||0,10)||0)}}if(null!==a)return document.getElementById("loyalty-points").textContent=String(a),void setRewardContextFromAkun(e.whatsapp,a,e.nama);if(!hasPublicSession(e))return document.getElementById("loyalty-points").textContent=String(r),void setRewardContextFromAkun(e.whatsapp,r,e.nama);const s=await fetch(`${t}?sheet=user_points`);if(!s.ok)return console.error("‚ùå Failed to fetch loyalty points"),void(document.getElementById("loyalty-points").textContent="0");const i=await s.json();if(console.log("üì• Points data received:",i),i&&"object"==typeof i&&"unauthorized"===String(i.error||"").toLowerCase())return console.warn("‚ö†Ô∏è Unauthorized access to user_points. Falling back to user profile points."),document.getElementById("loyalty-points").textContent=String(r),void setRewardContextFromAkun(e.whatsapp,r,e.nama);let l=Array.isArray(i)?i:i.result||[];if(!Array.isArray(l))return console.warn("‚ö†Ô∏è Unexpected points data format"),void(document.getElementById("loyalty-points").textContent="0");const d=phoneLookupVariants(n);let c=null;for(const e of d)if(c=l.find(t=>normalizePhoneTo08(t.phone||t.whatsapp||"")===normalizePhoneTo08(e)),c){console.log(`‚úÖ Found points record for ${e}:`,c);break}if(c){const t=parseInt(c.points||c.poin||0);console.log(`‚úÖ User points: ${t}`),document.getElementById("loyalty-points").textContent=t,setRewardContextFromAkun(e.whatsapp,t,e.nama)}else console.log("‚ö†Ô∏è No points record found for user"),document.getElementById("loyalty-points").textContent=String(r),setRewardContextFromAkun(e.whatsapp,r,e.nama)}catch(t){console.error("‚ùå Error loading loyalty points:",t);const n=parseInt(e.total_points||e.points||e.poin||0,10)||0;document.getElementById("loyalty-points").textContent=String(n),setRewardContextFromAkun(e.whatsapp,n,e.nama)}}async function loadOrderHistory(e){const t=document.getElementById("order-loading"),n=document.getElementById("order-empty"),r=document.getElementById("order-list"),a=document.getElementById("total-accepted-spend");t.classList.remove("hidden"),n.classList.add("hidden"),r.innerHTML="",a&&(a.textContent="Rp 0");try{const r=CONFIG.getMainApiUrl();let o=[];const s=buildSessionQuery(e);if(s){const e=await fetch(`${r}?action=public_user_orders${s}&_t=${Date.now()}`);if(e.ok){const t=await e.json();t&&t.success&&Array.isArray(t.orders)&&(o=t.orders)}}if(!o.length){let t=await fetch(`${r}?sheet=orders`);if(!t.ok)throw new Error("Gagal memuat riwayat pesanan");let n=await t.json();o=Array.isArray(n)?n.filter(t=>normalizePhoneTo08(t.phone)===normalizePhoneTo08(e.whatsapp)):[]}if(t.classList.add("hidden"),!o||0===o.length)return void n.classList.remove("hidden");if(o=o.filter(t=>normalizePhoneTo08(t.phone||t.whatsapp||"")===normalizePhoneTo08(e.whatsapp)),0===o.length)return void n.classList.remove("hidden");if(o.sort((e,t)=>{const n=new Date(e.tanggal_pesanan||e.timestamp||0);return new Date(t.tanggal_pesanan||t.timestamp||0)-n}),window.allOrders=o,window.currentPage=1,window.ordersPerPage=10,a){const e=new Set(["terima","diterima","selesai"]),t=o.reduce((t,n)=>{const r=String(n.status||"").toLowerCase().trim();return e.has(r)?t+parseCurrencyValue(n.total||n.total_bayar||0):t},0);a.textContent=formatCurrency(t)}displayOrderPage(1)}catch(e){console.error("Error loading order history:",e),t.classList.add("hidden"),r.innerHTML='\n            <div class="text-center py-8 text-red-600">\n                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <p class="text-sm">Gagal memuat riwayat pesanan</p>\n                <button onclick="location.reload()" class="mt-3 text-green-600 hover:underline text-sm font-bold">Coba Lagi</button>\n            </div>\n        '}}function parseCurrencyValue(e){if("number"==typeof e)return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),n=parseFloat(t);return Number.isNaN(n)?0:n}function displayOrderPage(e){const t=document.getElementById("order-list"),n=document.getElementById("order-pagination");if(!window.allOrders||0===window.allOrders.length)return;const r=window.allOrders.length,a=Math.ceil(r/window.ordersPerPage),o=(e-1)*window.ordersPerPage,s=Math.min(o+window.ordersPerPage,r);t.innerHTML="";for(let e=o;e<s;e++){const n=createOrderCard(window.allOrders[e]);t.appendChild(n)}a>1?(n.classList.remove("hidden"),n.innerHTML=createPagination(e,a)):n.classList.add("hidden"),window.currentPage=e}function createPagination(e,t){let n='<div class="flex justify-center items-center gap-2 mt-6">';e>1&&(n+=`<button onclick="displayOrderPage(${e-1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">‚Üê Prev</button>`),n+='<div class="flex gap-1">';for(let r=1;r<=t;r++)r===e?n+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm">${r}</button>`:1===r||r===t||r>=e-1&&r<=e+1?n+=`<button onclick="displayOrderPage(${r})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm">${r}</button>`:r!==e-2&&r!==e+2||(n+='<span class="px-2 py-2 text-gray-500">...</span>');return n+="</div>",e<t&&(n+=`<button onclick="displayOrderPage(${e+1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">Next ‚Üí</button>`),n+="</div>",n}function createOrderCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-3 hover:border-green-300 transition cursor-pointer",formatDate(e.tanggal_pesanan||e.timestamp);const n=formatCurrency(e.total||e.total_bayar||0),r=getStatusBadge(e.status||"Menunggu"),a=e.produk||e.items||e.product_name||"N/A",o=truncateText(a,20),s=e.id||"N/A";return t.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n            <div class="flex-1">\n                <p class="text-[10px] font-bold text-gray-700 mb-1">Order ID: <span class="text-green-600">${escapeHtml(s)}</span></p>\n            </div>\n            ${r}\n        </div>\n        \n        <div class="border-t border-gray-100 pt-2 space-y-1.5">\n            <div class="text-sm">\n                <p class="text-gray-600 text-xs mb-0.5">Produk:</p>\n                <p class="font-semibold text-gray-800 lg:hidden">${escapeHtml(o)}</p>\n                <p class="font-semibold text-gray-800 hidden lg:block">${escapeHtml(a)}</p>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Qty:</span>\n                <span class="font-semibold text-gray-800">${e.qty||e.quantity||e.jumlah||"N/A"}</span>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Poin:</span>\n                <span class="font-semibold text-amber-600">+${e.poin||e.points||0}</span>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Total Bayar:</span>\n                <span class="font-bold text-green-600">${n}</span>\n            </div>\n        </div>\n        \n        <div class="mt-3 pt-2 border-t border-gray-100">\n            <button onclick="window.location.href='index.html'" class="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-bold py-1.5 rounded-lg transition text-xs">\n                Belanja Lagi\n            </button>\n        </div>\n    `,t.addEventListener("click",t=>{"BUTTON"!==t.target.tagName&&"A"!==t.target.tagName&&showOrderDetailModal(e)}),t}function getStatusBadge(e){const t={Menunggu:{bg:"bg-yellow-100",text:"text-yellow-700",label:"Menunggu"},Diproses:{bg:"bg-blue-100",text:"text-blue-700",label:"Diproses"},Dikirim:{bg:"bg-purple-100",text:"text-purple-700",label:"Dikirim"},Diterima:{bg:"bg-green-100",text:"text-green-700",label:"Diterima"},Dibatalkan:{bg:"bg-red-100",text:"text-red-700",label:"Dibatalkan"}},n=t[normalizeStatus(e)]||t.Menunggu;return`<span class="${n.bg} ${n.text} text-xs font-bold px-3 py-1 rounded-full">${n.label}</span>`}function normalizeStatus(e){return e?{menunggu:"Menunggu",pending:"Menunggu",diproses:"Diproses",proses:"Diproses",processing:"Diproses",dikirim:"Dikirim",kirim:"Dikirim",shipped:"Dikirim",diterima:"Diterima",terima:"Diterima",selesai:"Diterima",completed:"Diterima",dibatalkan:"Dibatalkan",batal:"Dibatalkan",cancelled:"Dibatalkan",canceled:"Dibatalkan"}[e.toLowerCase().trim()]||e:"Menunggu"}function formatDate(e){if(!e||"N/A"===e||""===e)return"N/A";let t;if("number"==typeof e)t=new Date(e);else if("string"==typeof e){let n=e.split(",")[0].trim();if(t=new Date(e),isNaN(t.getTime())&&n.includes("/")){const e=n.split("/");if(3===e.length){const n=parseInt(e[0]),r=parseInt(e[1]),a=parseInt(e[2]);n<=31&&r<=12&&a>1900&&(t=new Date(a,r-1,n))}}}else t=new Date(e);return isNaN(t.getTime())?"N/A":t.toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"})}function truncateText(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":"N/A"}function formatCurrency(e){const t=parseInt(e)||0;return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t)}function showRegisterInfo(){alert("Untuk mendaftar, silakan hubungi admin GoSembako melalui WhatsApp.\n\nAnda akan diberikan akun dengan nomor WhatsApp dan PIN untuk login.")}function showRegister(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.remove("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden"),updateRegisterReferralInfo()}function showForgotPIN(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.remove("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function openEditProfile(){const e=getLoggedInUser();e&&(document.getElementById("edit-name").value=e.nama,document.getElementById("edit-old-pin").value="",document.getElementById("edit-new-pin").value="",document.getElementById("edit-confirm-pin").value="",document.getElementById("edit-error").classList.add("hidden"),document.getElementById("edit-profile-modal").classList.remove("hidden"))}function closeEditProfile(){document.getElementById("edit-profile-modal").classList.add("hidden")}function showOrderDetailModal(e){document.getElementById("tracking-order-id").textContent=e.id||"N/A";const t=e.tanggal||e.tanggal_pesanan||e.timestamp||e.date||e.created_at;document.getElementById("tracking-order-date").textContent=formatDate(t);const n=normalizeStatus(e.status||"Menunggu"),r=getStatusBadge(n),a=document.getElementById("tracking-status-badge");a&&(a.innerHTML=r),document.getElementById("tracking-products").textContent=e.produk||e.items||e.product_name||"N/A",document.getElementById("tracking-total").textContent=formatCurrency(e.total||e.total_bayar||0);const o=createAnimatedTimeline(n);document.getElementById("tracking-timeline").innerHTML=o,document.getElementById("order-tracking-modal").classList.remove("hidden")}function createAnimatedTimeline(e){const t=[{name:"Menunggu",gif:"wait.gif",key:"Menunggu"},{name:"Diproses",gif:"grocery-basket.gif",key:"Diproses"},{name:"Dikirim",gif:"grocery.gif",key:"Dikirim"},{name:"Diterima",gif:"shipping.gif",key:"Diterima"}];let n=t.findIndex(t=>t.key===e);return"Dibatalkan"===e?'\n            <div class="flex items-center justify-center gap-3 py-4">\n                <div class="bg-red-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">\n                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </div>\n                <div>\n                    <p class="font-bold text-red-600">Dibatalkan</p>\n                    <p class="text-xs text-gray-500">Pesanan telah dibatalkan</p>\n                </div>\n            </div>\n        ':(-1===n&&(n=0),`\n        <div class="flex items-center justify-between gap-2 py-2">\n            ${t.map((e,r)=>{const a=r<=n,o=r===n,s=r===t.length-1,i=`./assets/images/${e.gif}`;return`\n                    <div class="flex flex-col items-center flex-1">\n                        <div class="${a?"bg-green-50":"bg-gray-100"} w-12 h-12 rounded-full flex items-center justify-center ${o?"ring-2 ring-green-500 ring-offset-2":""}">\n                            <img src="${sanitizeUrl(i,"./assets/images/wait.gif")}" alt="${e.name}" class="w-8 h-8 object-contain ${a?"":"opacity-40"}" data-fallback-src="${i}">\n                        </div>\n                        <p class="text-[10px] font-semibold mt-2 text-center ${a?"text-gray-800":"text-gray-400"}">${e.name}</p>\n                        ${o?'<p class="text-[8px] text-green-600 font-bold mt-0.5">‚óè Saat ini</p>':'<p class="text-[8px] text-transparent mt-0.5">‚óè</p>'}\n                    </div>\n                    ${s?"":`\n                        <div class="flex-shrink-0 w-8 h-0.5 ${a&&r<n?"bg-green-500":"bg-gray-300"} transition-all duration-500 mb-6"></div>\n                    `}\n                `}).join("")}\n        </div>\n    `)}function closeOrderTracking(){document.getElementById("order-tracking-modal").classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{pendingReferralCodeFromUrl=getReferralCodeFromUrl(),updateRegisterReferralInfo(),loadPublicReferralConfig().then(()=>{referralProfileCache&&updateReferralShareUI(referralProfileCache)});const e=getLoggedInUser(),t=document.getElementById("referral-input");t&&t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),applyReferralCode())}),e?showDashboard(e):showLogin()}),document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-whatsapp").value.trim(),n=document.getElementById("login-pin").value.trim(),r=document.getElementById("login-btn"),a=document.getElementById("login-error");if(document.getElementById("login-error-text"),!t||!n)return void showError("Mohon lengkapi semua field");const o=normalizePhoneTo08(t);if(o)if(o.length<10||o.length>13)showError("Panjang nomor tidak valid");else if(6===n.length){r.disabled=!0,r.innerHTML='\n        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n        </svg>\n        <span>Memproses...</span>\n    ',a.classList.add("hidden");try{const e=CONFIG.getMainApiUrl(),t="&_t="+Date.now();let r=null;const a=`${e}?action=public_login&phone=${encodeURIComponent(o)}&pin=${encodeURIComponent(n)}${t}`,s=await fetch(a);if(s.ok){const e=await s.json();if(e&&e.success&&e.user)r=e.user;else{const t=String(e&&e.error?e.error:"").toLowerCase();if("login_failed"===t)return showError("Nomor WhatsApp atau PIN salah"),void resetLoginButton();if("account_inactive"===t)return showError("Akun Anda tidak aktif. Hubungi admin."),void resetLoginButton();if("rate_limited"===t)return showError(e&&e.message||"Terlalu banyak percobaan login, coba lagi."),void resetLoginButton();if("invalid sheet"!==t&&"invalid action"!==t)return showError(e&&e.message||"Login gagal. Silakan coba lagi."),void resetLoginButton()}}if(!r){const a=phoneLookupVariants(o),s=await fetch(`${e}?sheet=users${t}`);if(!s.ok)return showError("Gagal menghubungi server. Silakan coba lagi."),void resetLoginButton();const i=await s.json();if(isUnauthorizedApiResponse(i))return showError("Layanan login membutuhkan endpoint public_login. Hubungi admin."),void resetLoginButton();const l=parseSheetResponse(i);for(const e of a){const t=l.find(t=>normalizePhoneTo08(t.whatsapp||t.phone||"")===normalizePhoneTo08(e));if(t){r=t;break}}if(!r)return showError("Nomor WhatsApp tidak terdaftar"),void resetLoginButton();if((r.pin||"").toString()!==n)return showError("PIN salah. Silakan coba lagi."),void resetLoginButton()}if(r.status&&"aktif"!==r.status.toLowerCase())return showError("Akun Anda tidak aktif. Hubungi admin."),void resetLoginButton();r.whatsapp=normalizePhoneTo08(r.whatsapp||r.phone||o),saveLoggedInUser(r),showDashboard(r),document.getElementById("dashboard-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(e){console.error("Login error:",e),showError("Terjadi kesalahan. Silakan coba lagi."),resetLoginButton()}}else showError("PIN harus 6 digit");else showError("Gunakan format 08xxxxxxxxxx")}),document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-name").value.trim(),n=document.getElementById("register-whatsapp").value.trim(),r=document.getElementById("register-pin").value.trim(),a=document.getElementById("register-pin-confirm").value.trim(),o=pendingReferralCodeFromUrl,s=document.getElementById("register-error"),i=document.getElementById("register-error-text"),l=document.getElementById("register-success"),d=document.getElementById("register-btn");s.classList.add("hidden"),l.classList.add("hidden");const c=t.replace(/\s/g,"");if(c.length<4)return i.textContent="Masukkan Nama Lengkap",void s.classList.remove("hidden");const u=c.toLowerCase(),m=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const e of m)if(e.test(u))return i.textContent="Masukkan Nama Lengkap",void s.classList.remove("hidden");const g=normalizePhoneTo08(n);if(!g)return i.textContent="Gunakan format 08xxxxxxxxxx",void s.classList.remove("hidden");const p=g.replace(/[^0-9]/g,"");if(p.length<10||p.length>13)return i.textContent="Nomor WhatsApp tidak valid",void s.classList.remove("hidden");const f=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const e of f)if(e.test(p))return i.textContent="Nomor WhatsApp tidak valid",void s.classList.remove("hidden");if(6!==r.length||!/^\d{6}$/.test(r))return i.textContent="PIN harus 6 digit angka",void s.classList.remove("hidden");if(r!==a)return i.textContent="PIN tidak cocok",void s.classList.remove("hidden");d.disabled=!0,d.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const e=CONFIG.getMainApiUrl(),a=phoneLookupVariants(g);let c=[];const u="&_t="+Date.now();console.log("üîç Checking phone formats:",a);try{const t=await fetch(`${e}?sheet=users${u}`);if(t.ok){const e=await t.json();c=parseSheetResponse(e).filter(e=>{const t=normalizePhoneTo08(e.whatsapp||e.phone||"");return a.some(e=>normalizePhoneTo08(e)===t)}),c&&c.length>0&&console.log("üìä Found existing user:",c)}else console.warn(`API error: ${t.status}`)}catch(e){console.warn("Check failed:",e.message)}if(console.log("üìä Final check result for",n,":",c),c&&c.length>0)return i.textContent="Nomor WhatsApp sudah terdaftar",s.classList.remove("hidden"),d.disabled=!1,void(d.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar');const m=`USR-${Date.now().toString().slice(-6)}`,p=(new Date).toISOString().split("T")[0],f=(new Date).toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),h=await GASActions.create("users",{id:m,nama:t,whatsapp:g,pin:r,tanggal_daftar:p,status:"aktif",total_points:0,created_at:f,referred_by:"",referred_by_phone:"",referral_count:0,referral_points_total:0,kode_referral:""});if(!h.created||h.created<1)throw new Error("Gagal mendaftar");let y="";if(o)try{const e=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:g,ref_code:o}});y=e&&e.success?" Kode referral berhasil diterapkan.":" Akun dibuat, namun kode referral tidak valid."}catch(e){console.warn("Referral attach failed after registration:",e),y=" Akun dibuat, namun kode referral gagal diproses."}l.classList.remove("hidden");const w=l.querySelector("span");w&&(w.textContent="Pendaftaran berhasil! Silakan login."+y),document.getElementById("register-form").reset(),setTimeout(()=>{showLogin()},2e3)}catch(e){console.error("Registration error:",e),i.textContent="Terjadi kesalahan. Silakan coba lagi.",s.classList.remove("hidden")}finally{d.disabled=!1,d.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar'}}),document.getElementById("forgot-pin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("forgot-whatsapp").value.trim(),n=document.getElementById("forgot-error"),r=document.getElementById("forgot-error-text"),a=document.getElementById("forgot-btn"),o=normalizePhoneTo08(t);if(!o)return n.classList.remove("hidden"),void(r.textContent="Gunakan format 08xxxxxxxxxx");n.classList.add("hidden"),a.disabled=!0,a.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=users`),s=parseSheetResponse(await t.json()).filter(e=>normalizePhoneTo08(e.whatsapp||e.phone||"")===o);if(!s||0===s.length)return r.textContent="Nomor WhatsApp tidak terdaftar",n.classList.remove("hidden"),a.disabled=!1,void(a.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi');alert(`Kode verifikasi telah dikirim ke WhatsApp ${o}.\n\nUntuk sementara, hubungi admin untuk reset PIN.`);const i=o.replace(/^0/,"62");window.open(`https://wa.me/628993370200?text=Halo, saya ingin reset PIN akun saya. Nomor WhatsApp: ${i}`,"_blank"),setTimeout(()=>{showLogin()},1e3)}catch(e){console.error("Forgot PIN error:",e),r.textContent="Terjadi kesalahan. Silakan coba lagi.",n.classList.remove("hidden")}finally{a.disabled=!1,a.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi'}}),document.getElementById("edit-profile-form").addEventListener("submit",async e=>{e.preventDefault();const t=getLoggedInUser();if(!t)return;const n=document.getElementById("edit-name").value.trim(),r=document.getElementById("edit-old-pin").value.trim(),a=document.getElementById("edit-new-pin").value.trim(),o=document.getElementById("edit-confirm-pin").value.trim(),s=document.getElementById("edit-error"),i=document.getElementById("edit-error-text"),l=document.getElementById("edit-save-btn");if(s.classList.add("hidden"),n.replace(/\s/g,"").length<4)return i.textContent="Masukkan Nama Lengkap",void s.classList.remove("hidden");if(r||a||o){if(!r||!a||!o)return i.textContent="Lengkapi semua field PIN",void s.classList.remove("hidden");if(6!==a.length||!/^\d{6}$/.test(a))return i.textContent="PIN baru harus 6 digit angka",void s.classList.remove("hidden");if(a!==o)return i.textContent="PIN baru tidak cocok",void s.classList.remove("hidden")}l.disabled=!0,l.textContent="Menyimpan...";try{const e=CONFIG.getMainApiUrl(),o=await fetch(`${e}?sheet=users&id=${t.id}`),d=await o.json();if(!d||0===d.length)throw new Error("User not found");const c=d[0];if(r&&c.pin!==r)return i.textContent="PIN lama salah",s.classList.remove("hidden"),l.disabled=!1,void(l.textContent="Simpan");const u={nama:n};a&&(u.pin=a);const m=await GASActions.update("users",t.id,u);if(!m.affected||m.affected<1)throw new Error("Failed to update");t.nama=n,saveLoggedInUser(t),document.getElementById("user-name").textContent=n,closeEditProfile(),alert("Profil berhasil diperbarui!")}catch(e){console.error("Edit profile error:",e),i.textContent="Terjadi kesalahan. Silakan coba lagi.",s.classList.remove("hidden")}finally{l.disabled=!1,l.textContent="Simpan"}});const originalCreateOrderCard=createOrderCard;function switchRewardTab(e){const t=document.getElementById("tab-exchange"),n=document.getElementById("tab-history"),r=document.getElementById("exchange-content"),a=document.getElementById("history-content");"exchange"===e?(t.classList.add("text-amber-600","border-amber-600"),t.classList.remove("text-gray-400","border-transparent"),n.classList.add("text-gray-400","border-transparent"),n.classList.remove("text-amber-600","border-amber-600"),r.classList.remove("hidden"),a.classList.add("hidden"),fetchRewardItemsForAkun()):"history"===e&&(n.classList.add("text-amber-600","border-amber-600"),n.classList.remove("text-gray-400","border-transparent"),t.classList.add("text-gray-400","border-transparent"),t.classList.remove("text-amber-600","border-amber-600"),a.classList.remove("hidden"),r.classList.add("hidden"),loadClaimsHistory())}async function loadClaimsHistory(){const e=getLoggedInUser();if(!e)return;const t=document.getElementById("claims-loading"),n=document.getElementById("claims-empty"),r=document.getElementById("claims-list");t.classList.remove("hidden"),n.classList.add("hidden"),r.innerHTML="";try{const a=CONFIG.getMainApiUrl(),o=phoneLookupVariants(e.whatsapp).map(e=>`phone=${encodeURIComponent(e)}`).join("&"),s=await fetch(`${a}?sheet=claims&${o}`);if(!s.ok)throw new Error("Failed to fetch claims");const i=parseSheetResponse(await s.json());if(t.classList.add("hidden"),!i||0===i.length)return void n.classList.remove("hidden");i.sort((e,t)=>{const n=new Date(e.tanggal||e.date||0);return new Date(t.tanggal||t.date||0)-n}),i.forEach(e=>{const t=createClaimCard(e);r.appendChild(t)})}catch(e){console.error("Error loading claims history:",e),t.classList.add("hidden"),n.classList.remove("hidden")}}function createClaimCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition";const n=(e.status||"pending").toLowerCase(),r={pending:"bg-yellow-100 text-yellow-700",approved:"bg-green-100 text-green-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-red-100 text-red-700"}[n]||"bg-gray-100 text-gray-700",a={pending:"Menunggu",approved:"Disetujui",completed:"Selesai",rejected:"Ditolak"}[n]||e.status||"Menunggu",o=new Date(e.tanggal||e.date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return t.innerHTML=`\n        <div class="flex justify-between items-start mb-3">\n            <div class="flex-1">\n                <h5 class="font-bold text-gray-800">${escapeHtml(e.hadiah||e.reward||"Reward")}</h5>\n                <p class="text-xs text-gray-500 mt-1">${o}</p>\n            </div>\n            <span class="${r} text-xs font-bold px-3 py-1 rounded-full">${escapeHtml(a)}</span>\n        </div>\n        <div class="flex items-center justify-between pt-3 border-t border-gray-100">\n            <div class="flex items-center gap-2">\n                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <span class="text-sm font-semibold text-gray-700">${e.poin||0} Poin</span>\n            </div>\n            ${e.id?`<span class="text-xs text-gray-400">#${escapeHtml(e.id)}</span>`:""}\n        </div>\n    `,t}function closeLoyaltyModal(){document.getElementById("loyalty-modal").classList.add("hidden"),switchRewardTab("exchange")}async function openRewardModal(){const e=getLoggedInUser();if(!e)return;await loadModalPoints();const t=document.getElementById("loyalty-modal-points"),n=t?parseInt(t.textContent||"0"):0;setRewardContextFromAkun(e.whatsapp,n,e.nama),document.getElementById("loyalty-modal").classList.remove("hidden"),switchRewardTab("exchange"),fetchRewardItemsForAkun()}async function loadModalPoints(){const e=getLoggedInUser();if(!e)return;const t=parseInt(e.total_points||e.points||e.poin||0,10)||0;try{const n=CONFIG.getMainApiUrl(),r=buildSessionQuery(e);if(r){const e=await fetch(`${n}?action=public_user_points${r}&_t=${Date.now()}`);if(e.ok){const t=await e.json();if(t&&t.success)return void(document.getElementById("loyalty-modal-points").textContent=String(parseInt(t.points||0,10)||0))}}if(!hasPublicSession(e))return void(document.getElementById("loyalty-modal-points").textContent=String(t));const a=await fetch(`${n}?sheet=user_points`);if(!a.ok)return void(document.getElementById("loyalty-modal-points").textContent=String(t));const o=await a.json();if(o&&"object"==typeof o&&"unauthorized"===String(o.error||"").toLowerCase())return console.warn("‚ö†Ô∏è Unauthorized access to user_points (modal). Falling back to user profile points."),void(document.getElementById("loyalty-modal-points").textContent=String(t));const s=Array.isArray(o)?o.filter(t=>normalizePhoneTo08(t.phone)===normalizePhoneTo08(e.whatsapp)):[];if(s&&s.length>0){const e=s[0],t=parseInt(e.points||e.poin||0);document.getElementById("loyalty-modal-points").textContent=t}else document.getElementById("loyalty-modal-points").textContent=String(t)}catch(e){console.error("Error loading modal points:",e),document.getElementById("loyalty-modal-points").textContent=String(t)}}createOrderCard=function(e){const t=originalCreateOrderCard(e);return t.style.cursor="pointer",t.addEventListener("click",()=>{showOrderDetailModal(e)}),t};var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});function hideRewardLoaders(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchRewardItemsForAkun(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n.innerHTML="";try{const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=tukar_poin`);if(!t.ok)throw new Error("Failed to fetch reward items");const n=await t.json();renderRewardItemsListAkun(parseSheetResponse(n))}catch(e){console.error("Error fetching reward items:",e),t&&t.classList.add("hidden"),n.innerHTML='\n            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">\n                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>\n            </div>\n        '}finally{hideRewardLoaders()}}}function renderRewardItemsListAkun(e){const t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){if(!e||0===e.length)return t&&t.classList.remove("hidden"),void(n.innerHTML="");t&&t.classList.add("hidden"),n.innerHTML=e.map(e=>{const t=escapeHtml((e.id||"").toString()),n=escapeHtml((e.nama||e.judul||"Hadiah").toString()),r=parseInt(e.poin||e.Poin||0),a=(e.gambar||"https://via.placeholder.com/80?text=Reward").toString();return`\n            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-amber-500 transition">\n                <div class="flex gap-3 mb-3">\n                    \x3c!-- Left: Image --\x3e\n                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">\n                        <img src="${sanitizeUrl(a,"https://via.placeholder.com/80?text=Reward")}" alt="${n}" class="w-full h-full object-cover" data-fallback-src="https://via.placeholder.com/80?text=Reward">\n                    </div>\n                    \n                    \x3c!-- Middle: Title & Description --\x3e\n                    <div class="flex-1 min-w-0">\n                        <p class="font-bold text-gray-800 text-sm mb-1">${n}</p>\n                        <p class="text-xs text-gray-500 line-clamp-2">${escapeHtml((e.deskripsi||"").toString())}</p>\n                    </div>\n                    \n                    \x3c!-- Right: Badge --\x3e\n                    <div class="flex-shrink-0">\n                        <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">${r} Poin</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Full-width Button --\x3e\n                <button class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg transition text-sm" onclick="handleTukarSekarangAkun('${t}')">\n                    Tukar Sekarang\n                </button>\n            </div>\n        `}).join("")}}function setRewardContextFromAkun(e,t,n){e&&(sessionStorage.setItem("reward_phone",e),console.log("‚úÖ Reward context set - phone:",e)),null!=t&&(sessionStorage.setItem("user_points",t.toString()),console.log("‚úÖ Reward context set - points:",t)),n&&(sessionStorage.setItem("reward_customer_name",n),console.log("‚úÖ Reward context set - name:",n))}function handleTukarSekarangAkun(e){const t=getLoggedInUser();if(!t)return void showToast("Mohon login terlebih dahulu.");const n=document.getElementById("loyalty-points"),r=n?parseInt(n.textContent||"0"):0;setRewardContextFromAkun(t.whatsapp,r,t.nama),"function"==typeof showConfirmTukarModal?showConfirmTukarModal(e):"function"==typeof window.claimReward?window.claimReward(e):showToast("Fitur tukar poin akan segera hadir!")}function hideMobileBottomNavOnDashboard(){const e=document.getElementById("mobile-bottom-nav"),t=document.getElementById("dashboard-section");e&&t&&(t.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}ensureImageFallbackHandler(),document.addEventListener("DOMContentLoaded",function(){setTimeout(hideMobileBottomNavOnDashboard,100)});const originalShowDashboard=showDashboard;showDashboard=function(e){"function"==typeof originalShowDashboard&&originalShowDashboard(e),setTimeout(hideMobileBottomNavOnDashboard,100)};const originalShowLogin=showLogin;showLogin=function(){"function"==typeof originalShowLogin&&originalShowLogin();const e=document.getElementById("mobile-bottom-nav");e&&e.classList.remove("hidden")};
