const normalizePhoneTo08=e=>{const n=String(e??"").replace(/[^0-9]/g,"");if(!n)return"";let a=n;return a.startsWith("62")&&(a=a.slice(2)),a.startsWith("0")&&(a=a.slice(1)),a.startsWith("8")?"0"+a:""},phoneLookupVariants=e=>{const t=normalizePhoneTo08(e);if(!t)return[];const n=t.slice(1);return[t,`+62${n}`,`62${n}`,n]},displayPhone=e=>normalizePhoneTo08(e)||e||"",parseSheetResponse=e=>Array.isArray(e)?e:e&&Array.isArray(e.result)?e.result:e&&e.result?Array.isArray(e.result)?e.result:[e.result]:[],isUnauthorizedApiResponse=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)&&String(e.error||"").toLowerCase()==="unauthorized");let referralProfileCache=null;function toReferralCodeValue(e){return String(e||"").trim().toUpperCase()}function setReferralStatus(e,t){const n=document.getElementById("referral-status");n&&(n.textContent=e||"",n.className="text-xs",t==="success"?n.classList.add("text-green-600"):t==="error"?n.classList.add("text-red-600"):t==="warning"?n.classList.add("text-amber-600"):n.classList.add("text-gray-500"))}function generateReferralCode(e,t,n){const a=String(e||"USER").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6)||"USER",s=normalizePhoneTo08(t).replace(/\D/g,"").slice(-4)||Math.floor(1e3+Math.random()*9e3).toString();let r=`${a}${s}`.slice(0,24);if(!n.has(r))return r;for(let d=1;d<=2e3;d+=1){const i=`${a}${s}${d}`.slice(0,24);if(!n.has(i))return i}return`${a}${Date.now().toString().slice(-6)}`.slice(0,24)}async function fetchUsersList(){const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=users&_t=${Date.now()}`);if(!t.ok)throw new Error("Gagal memuat data users");return parseSheetResponse(await t.json())}async function ensureUserReferralCode(e,t){const n=t.find(r=>String(r.id)===String(e.id))||t.find(r=>normalizePhoneTo08(r.whatsapp||r.phone||"")===normalizePhoneTo08(e.whatsapp));if(!n)return{user:{id:e.id||"",nama:e.nama||"User",whatsapp:normalizePhoneTo08(e.whatsapp||e.phone||""),kode_referral:"",referred_by:"",referral_count:0,referral_points_total:0},code:"",missingProfile:!0};const a=toReferralCodeValue(n.kode_referral);if(a)return{user:n,code:a};const o=new Set(t.map(r=>toReferralCodeValue(r.kode_referral)).filter(Boolean)),s=generateReferralCode(n.nama,n.whatsapp||n.phone,o);return await GASActions.update("users",n.id,{kode_referral:s}),n.kode_referral=s,{user:n,code:s}}function applyReferralDataToUI(e){const t=document.getElementById("referral-code-display"),n=document.getElementById("referral-input"),a=document.getElementById("apply-referral-btn"),o=document.getElementById("referral-count"),s=document.getElementById("referral-points-total");t&&(t.value=toReferralCodeValue(e.kode_referral)||"-"),o&&(o.textContent=String(parseInt(e.referral_count||0,10)||0)),s&&(s.textContent=String(parseInt(e.referral_points_total||0,10)||0));const r=toReferralCodeValue(e.referred_by)!=="";n&&(n.value=r?toReferralCodeValue(e.referred_by):"",n.disabled=r),a&&(a.disabled=r),r?setReferralStatus(`Referral aktif dengan kode: ${toReferralCodeValue(e.referred_by)}`,"success"):setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info")}function getReferralStatusBadge(e){const t=String(e||"").toLowerCase();return t==="approved"?'<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold">Approved</span>':t==="rejected"||t==="void"?'<span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold">Rejected</span>':'<span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">Pending</span>'}async function loadReferralHistory(e){const t=document.getElementById("referral-history-list"),n=document.getElementById("referral-history-badge");if(!(!t||!n))try{const a=CONFIG.getMainApiUrl(),o=normalizePhoneTo08(e.whatsapp),s=await fetch(`${a}?sheet=referrals&phone=${encodeURIComponent(o)}&_t=${Date.now()}`);if(!s.ok)throw new Error("Gagal memuat riwayat referral");const d=parseSheetResponse(await s.json()).filter(i=>{const l=normalizePhoneTo08(i.referrer_phone||""),c=normalizePhoneTo08(i.referee_phone||"");return l===o||c===o}).sort((i,l)=>new Date(l.created_at||0).getTime()-new Date(i.created_at||0).getTime()).slice(0,5);if(n.textContent=`${d.length} data`,d.length===0){t.innerHTML='<p class="text-gray-400">Belum ada riwayat referral.</p>';return}t.innerHTML=d.map(i=>{const l=normalizePhoneTo08(i.referrer_phone||"")===o?"Anda mengajak":"Anda diajak",c=normalizePhoneTo08(l==="Anda mengajak"?i.referee_phone||"":i.referrer_phone||""),m=l==="Anda mengajak"?parseInt(i.reward_referrer_points||0,10)||0:parseInt(i.reward_referee_points||0,10)||0;return`
                <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-bold text-gray-700">${escapeHtml(l)}</span>
                        ${getReferralStatusBadge(i.status)}
                    </div>
                    <p class="text-gray-600">No: ${escapeHtml(c||"-")}</p>
                    <p class="text-green-700 font-semibold">Reward: ${escapeHtml(String(m))} poin</p>
                </div>
            `}).join("")}catch(a){console.error("Error loading referral history:",a),n.textContent="error",t.innerHTML='<p class="text-red-500">Gagal memuat riwayat referral.</p>'}}async function loadReferralData(e){try{const t=await fetchUsersList(),n=await ensureUserReferralCode(e,t);if(referralProfileCache=n.user,applyReferralDataToUI(n.user),n.missingProfile){setReferralStatus("Profil referral belum sinkron. Silakan hubungi admin.","warning");return}await loadReferralHistory(e)}catch(t){console.error("Error loading referral data:",t),setReferralStatus("Gagal memuat data referral. Coba refresh halaman.","error")}}document.addEventListener("DOMContentLoaded",()=>{const e=getLoggedInUser(),t=document.getElementById("referral-input");t&&t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),applyReferralCode())}),e?showDashboard(e):showLogin()});function showLogin(){document.getElementById("login-section").classList.remove("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showDashboard(e){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.remove("hidden"),document.getElementById("user-name").textContent=e.nama,document.getElementById("user-whatsapp").textContent=displayPhone(e.whatsapp),loadLoyaltyPoints(e),loadReferralData(e),loadOrderHistory(e)}document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-whatsapp").value.trim(),n=document.getElementById("login-pin").value.trim(),a=document.getElementById("login-btn"),o=document.getElementById("login-error"),s=document.getElementById("login-error-text");if(!t||!n){showError("Mohon lengkapi semua field");return}const r=normalizePhoneTo08(t);if(!r){showError("Gunakan format 08xxxxxxxxxx");return}if(r.length<10||r.length>13){showError("Panjang nomor tidak valid");return}if(n.length!==6){showError("PIN harus 6 digit");return}a.disabled=!0,a.innerHTML=`
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Memproses...</span>
    `,o.classList.add("hidden");try{const d=CONFIG.getMainApiUrl(),i="&_t="+Date.now(),l=phoneLookupVariants(r);let c=null;const m=await fetch(`${d}?sheet=users${i}`);if(!m.ok){showError("Gagal menghubungi server. Silakan coba lagi."),resetLoginButton();return}const u=await m.json();if(isUnauthorizedApiResponse(u)){showError("Layanan login membutuhkan otorisasi API. Hubungi admin."),resetLoginButton();return}const g=parseSheetResponse(u);for(const h of l){const y=g.find(p=>normalizePhoneTo08(p.whatsapp||p.phone||"")===normalizePhoneTo08(h));if(y){c=y;break}}if(!c){showError("Nomor WhatsApp tidak terdaftar"),resetLoginButton();return}if((c.pin||"").toString()!==n){showError("PIN salah. Silakan coba lagi."),resetLoginButton();return}if(c.status&&c.status.toLowerCase()!=="aktif"){showError("Akun Anda tidak aktif. Hubungi admin."),resetLoginButton();return}c.whatsapp=normalizePhoneTo08(c.whatsapp||c.phone||r),saveLoggedInUser(c),showDashboard(c),document.getElementById("dashboard-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(d){console.error("Login error:",d),showError("Terjadi kesalahan. Silakan coba lagi."),resetLoginButton()}});function showError(e){const t=document.getElementById("login-error"),n=document.getElementById("login-error-text");n.textContent=e,t.classList.remove("hidden")}function resetLoginButton(){const e=document.getElementById("login-btn");e.disabled=!1,e.innerHTML=`
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
        </svg>
        Masuk
    `}function saveLoggedInUser(e){const t=normalizePhoneTo08(e.whatsapp||e.phone||"");localStorage.setItem("gosembako_user",JSON.stringify({id:e.id,nama:e.nama,whatsapp:t||e.whatsapp,tanggal_daftar:e.tanggal_daftar}))}function getLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;const t=JSON.parse(e);return t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||"")||t.whatsapp,t}function logout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("gosembako_user"),window.location.reload())}async function copyReferralCode(){const e=document.getElementById("referral-code-display"),t=toReferralCodeValue(e?e.value:"");if(!t||t==="-"){setReferralStatus("Kode referral belum tersedia.","warning");return}try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t);else{const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}setReferralStatus("Kode referral berhasil disalin.","success")}catch(n){console.error("Copy referral failed:",n),setReferralStatus("Gagal menyalin kode referral.","error")}}async function applyReferralCode(){const e=getLoggedInUser();if(!e){setReferralStatus("Silakan login ulang.","error");return}const t=document.getElementById("referral-input"),n=document.getElementById("apply-referral-btn"),a=toReferralCodeValue(t?t.value:"");if(!a){setReferralStatus("Masukkan kode referral terlebih dahulu.","warning");return}const o=toReferralCodeValue(document.getElementById("referral-code-display")?.value);if(o&&a===o){setReferralStatus("Kode referral sendiri tidak bisa dipakai.","error");return}if(t&&t.disabled){setReferralStatus("Kode referral sudah pernah diterapkan.","warning");return}const s=n?n.textContent:"";try{n&&(n.disabled=!0,n.textContent="Memproses...");const r=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:normalizePhoneTo08(e.whatsapp),ref_code:a}});if(!r||r.success===!1){const d=r&&(r.message||r.error||r.error_code)||"Gagal menerapkan referral";setReferralStatus(d,"error"),n&&(n.disabled=!1,n.textContent=s||"Terapkan");return}t&&(t.value=a,t.disabled=!0),n&&(n.disabled=!0,n.textContent="Terapkan"),setReferralStatus("Kode referral berhasil diterapkan.","success"),await loadReferralData(e)}catch(r){console.error("applyReferralCode error:",r),setReferralStatus(r.message||"Gagal menerapkan kode referral.","error"),n&&(n.disabled=!1,n.textContent=s||"Terapkan")}}async function loadLoyaltyPoints(e){try{const t=CONFIG.getMainApiUrl(),n=normalizePhoneTo08(e.whatsapp),a=parseInt(e.total_points||e.points||e.poin||0,10)||0;if(!n){console.warn("\u26A0\uFE0F Invalid phone number for loyalty points lookup"),document.getElementById("loyalty-points").textContent=String(a),setRewardContextFromAkun(e.whatsapp,a,e.nama);return}console.log(`\u{1F50D} Loading loyalty points for phone: ${n}`);const o=await fetch(`${t}?sheet=user_points`);if(!o.ok){console.error("\u274C Failed to fetch loyalty points"),document.getElementById("loyalty-points").textContent="0";return}const s=await o.json();if(console.log("\u{1F4E5} Points data received:",s),s&&typeof s=="object"&&String(s.error||"").toLowerCase()==="unauthorized"){console.warn("\u26A0\uFE0F Unauthorized access to user_points. Falling back to user profile points."),document.getElementById("loyalty-points").textContent=String(a),setRewardContextFromAkun(e.whatsapp,a,e.nama);return}let r=Array.isArray(s)?s:s.result||[];if(!Array.isArray(r)){console.warn("\u26A0\uFE0F Unexpected points data format"),document.getElementById("loyalty-points").textContent="0";return}const d=phoneLookupVariants(n);let i=null;for(const l of d)if(i=r.find(c=>normalizePhoneTo08(c.phone||c.whatsapp||"")===normalizePhoneTo08(l)),i){console.log(`\u2705 Found points record for ${l}:`,i);break}if(i){const l=parseInt(i.points||i.poin||0);console.log(`\u2705 User points: ${l}`),document.getElementById("loyalty-points").textContent=l,setRewardContextFromAkun(e.whatsapp,l,e.nama)}else console.log("\u26A0\uFE0F No points record found for user"),document.getElementById("loyalty-points").textContent=String(a),setRewardContextFromAkun(e.whatsapp,a,e.nama)}catch(t){console.error("\u274C Error loading loyalty points:",t);const n=parseInt(e.total_points||e.points||e.poin||0,10)||0;document.getElementById("loyalty-points").textContent=String(n),setRewardContextFromAkun(e.whatsapp,n,e.nama)}}async function loadOrderHistory(e){const t=document.getElementById("order-loading"),n=document.getElementById("order-empty"),a=document.getElementById("order-list"),o=document.getElementById("total-accepted-spend");t.classList.remove("hidden"),n.classList.add("hidden"),a.innerHTML="",o&&(o.textContent="Rp 0");try{const s=CONFIG.getMainApiUrl();let r=await fetch(`${s}?sheet=orders`);if(!r.ok)throw new Error("Gagal memuat riwayat pesanan");let d=await r.json(),i=Array.isArray(d)?d.filter(l=>normalizePhoneTo08(l.phone)===normalizePhoneTo08(e.whatsapp)):[];if(t.classList.add("hidden"),!i||i.length===0){n.classList.remove("hidden");return}if(i=i.filter(l=>{const c=normalizePhoneTo08(l.phone||l.whatsapp||""),m=normalizePhoneTo08(e.whatsapp);return c===m}),i.length===0){n.classList.remove("hidden");return}if(i.sort((l,c)=>{const m=new Date(l.tanggal_pesanan||l.timestamp||0);return new Date(c.tanggal_pesanan||c.timestamp||0)-m}),window.allOrders=i,window.currentPage=1,window.ordersPerPage=10,o){const l=new Set(["terima","diterima","selesai"]),c=i.reduce((m,u)=>{const g=String(u.status||"").toLowerCase().trim();return l.has(g)?m+parseCurrencyValue(u.total||u.total_bayar||0):m},0);o.textContent=formatCurrency(c)}displayOrderPage(1)}catch(s){console.error("Error loading order history:",s),t.classList.add("hidden"),a.innerHTML=`
            <div class="text-center py-8 text-red-600">
                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm">Gagal memuat riwayat pesanan</p>
                <button onclick="location.reload()" class="mt-3 text-green-600 hover:underline text-sm font-bold">Coba Lagi</button>
            </div>
        `}}function parseCurrencyValue(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),n=parseFloat(t);return Number.isNaN(n)?0:n}function displayOrderPage(e){const t=document.getElementById("order-list"),n=document.getElementById("order-pagination");if(!window.allOrders||window.allOrders.length===0)return;const a=window.allOrders.length,o=Math.ceil(a/window.ordersPerPage),s=(e-1)*window.ordersPerPage,r=Math.min(s+window.ordersPerPage,a);t.innerHTML="";for(let d=s;d<r;d++){const i=createOrderCard(window.allOrders[d]);t.appendChild(i)}o>1?(n.classList.remove("hidden"),n.innerHTML=createPagination(e,o)):n.classList.add("hidden"),window.currentPage=e}function createPagination(e,t){let n='<div class="flex justify-center items-center gap-2 mt-6">';e>1&&(n+=`<button onclick="displayOrderPage(${e-1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">\u2190 Prev</button>`),n+='<div class="flex gap-1">';for(let a=1;a<=t;a++)a===e?n+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm">${a}</button>`:a===1||a===t||a>=e-1&&a<=e+1?n+=`<button onclick="displayOrderPage(${a})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm">${a}</button>`:(a===e-2||a===e+2)&&(n+='<span class="px-2 py-2 text-gray-500">...</span>');return n+="</div>",e<t&&(n+=`<button onclick="displayOrderPage(${e+1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">Next \u2192</button>`),n+="</div>",n}function createOrderCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-3 hover:border-green-300 transition cursor-pointer";const n=formatDate(e.tanggal_pesanan||e.timestamp),a=formatCurrency(e.total||e.total_bayar||0),o=e.status||"Menunggu",s=getStatusBadge(o),r=e.produk||e.items||e.product_name||"N/A",d=truncateText(r,20),i=e.id||"N/A";return t.innerHTML=`
        <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
                <p class="text-[10px] font-bold text-gray-700 mb-1">Order ID: <span class="text-green-600">${escapeHtml(i)}</span></p>
            </div>
            ${s}
        </div>
        
        <div class="border-t border-gray-100 pt-2 space-y-1.5">
            <div class="text-sm">
                <p class="text-gray-600 text-xs mb-0.5">Produk:</p>
                <p class="font-semibold text-gray-800 lg:hidden">${escapeHtml(d)}</p>
                <p class="font-semibold text-gray-800 hidden lg:block">${escapeHtml(r)}</p>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Qty:</span>
                <span class="font-semibold text-gray-800">${e.qty||e.quantity||e.jumlah||"N/A"}</span>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Poin:</span>
                <span class="font-semibold text-amber-600">+${e.poin||e.points||0}</span>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Total Bayar:</span>
                <span class="font-bold text-green-600">${a}</span>
            </div>
        </div>
        
        <div class="mt-3 pt-2 border-t border-gray-100">
            <button onclick="window.location.href='index.html'" class="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-bold py-1.5 rounded-lg transition text-xs">
                Belanja Lagi
            </button>
        </div>
    `,t.addEventListener("click",l=>{l.target.tagName!=="BUTTON"&&l.target.tagName!=="A"&&showOrderDetailModal(e)}),t}function getStatusBadge(e){const t=normalizeStatus(e),n={Menunggu:{bg:"bg-yellow-100",text:"text-yellow-700",label:"Menunggu"},Diproses:{bg:"bg-blue-100",text:"text-blue-700",label:"Diproses"},Dikirim:{bg:"bg-purple-100",text:"text-purple-700",label:"Dikirim"},Diterima:{bg:"bg-green-100",text:"text-green-700",label:"Diterima"},Dibatalkan:{bg:"bg-red-100",text:"text-red-700",label:"Dibatalkan"}},a=n[t]||n.Menunggu;return`<span class="${a.bg} ${a.text} text-xs font-bold px-3 py-1 rounded-full">${a.label}</span>`}function normalizeStatus(e){if(!e)return"Menunggu";const t=e.toLowerCase().trim();return{menunggu:"Menunggu",pending:"Menunggu",diproses:"Diproses",proses:"Diproses",processing:"Diproses",dikirim:"Dikirim",kirim:"Dikirim",shipped:"Dikirim",diterima:"Diterima",terima:"Diterima",selesai:"Diterima",completed:"Diterima",dibatalkan:"Dibatalkan",batal:"Dibatalkan",cancelled:"Dibatalkan",canceled:"Dibatalkan"}[t]||e}function formatDate(e){if(!e||e==="N/A"||e==="")return"N/A";let t;if(typeof e=="number")t=new Date(e);else if(typeof e=="string"){let a=e.split(",")[0].trim();if(t=new Date(e),isNaN(t.getTime())&&a.includes("/")){const o=a.split("/");if(o.length===3){const s=parseInt(o[0]),r=parseInt(o[1]),d=parseInt(o[2]);s<=31&&r<=12&&d>1900&&(t=new Date(d,r-1,s))}}}else t=new Date(e);if(isNaN(t.getTime()))return"N/A";const n={year:"numeric",month:"long",day:"numeric"};return t.toLocaleDateString("id-ID",n)}function truncateText(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":"N/A"}function formatCurrency(e){const t=parseInt(e)||0;return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t)}function showRegisterInfo(){alert(`Untuk mendaftar, silakan hubungi admin GoSembako melalui WhatsApp.

Anda akan diberikan akun dengan nomor WhatsApp dan PIN untuk login.`)}function showRegister(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.remove("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showForgotPIN(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.remove("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-name").value.trim(),n=document.getElementById("register-whatsapp").value.trim(),a=document.getElementById("register-pin").value.trim(),o=document.getElementById("register-pin-confirm").value.trim(),s=toReferralCodeValue(document.getElementById("register-referral-code")?.value||""),r=document.getElementById("register-error"),d=document.getElementById("register-error-text"),i=document.getElementById("register-success"),l=document.getElementById("register-btn");r.classList.add("hidden"),i.classList.add("hidden");const c=t.replace(/\s/g,"");if(c.length<4){d.textContent="Masukkan Nama Lengkap",r.classList.remove("hidden");return}const m=c.toLowerCase(),u=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const p of u)if(p.test(m)){d.textContent="Masukkan Nama Lengkap",r.classList.remove("hidden");return}const g=normalizePhoneTo08(n);if(!g){d.textContent="Gunakan format 08xxxxxxxxxx",r.classList.remove("hidden");return}const h=g.replace(/[^0-9]/g,"");if(h.length<10||h.length>13){d.textContent="Nomor WhatsApp tidak valid",r.classList.remove("hidden");return}const y=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const p of y)if(p.test(h)){d.textContent="Nomor WhatsApp tidak valid",r.classList.remove("hidden");return}if(a.length!==6||!/^\d{6}$/.test(a)){d.textContent="PIN harus 6 digit angka",r.classList.remove("hidden");return}if(a!==o){d.textContent="PIN tidak cocok",r.classList.remove("hidden");return}l.disabled=!0,l.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const p=CONFIG.getMainApiUrl(),b=phoneLookupVariants(g);let w=[];const E="&_t="+Date.now();console.log("\u{1F50D} Checking phone formats:",b);try{const f=await fetch(`${p}?sheet=users${E}`);if(!f.ok)console.warn(`API error: ${f.status}`);else{const D=await f.json();w=parseSheetResponse(D).filter(I=>{const M=normalizePhoneTo08(I.whatsapp||I.phone||"");return b.some($=>normalizePhoneTo08($)===M)}),w&&w.length>0&&console.log("\u{1F4CA} Found existing user:",w)}}catch(f){console.warn("Check failed:",f.message)}if(console.log("\u{1F4CA} Final check result for",n,":",w),w&&w.length>0){d.textContent="Nomor WhatsApp sudah terdaftar",r.classList.remove("hidden"),l.disabled=!1,l.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar';return}const L=`USR-${Date.now().toString().slice(-6)}`,B=new Date().toISOString().split("T")[0],C=new Date().toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),v=await GASActions.create("users",{id:L,nama:t,whatsapp:g,pin:a,tanggal_daftar:B,status:"aktif",total_points:0,created_at:C,referred_by:"",referred_by_phone:"",referral_count:0,referral_points_total:0,kode_referral:""});if(!v.created||v.created<1)throw new Error("Gagal mendaftar");let x="";if(s)try{const f=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:g,ref_code:s}});f&&f.success?x=" Kode referral berhasil diterapkan.":x=" Akun dibuat, namun kode referral tidak valid."}catch(f){console.warn("Referral attach failed after registration:",f),x=" Akun dibuat, namun kode referral gagal diproses."}i.classList.remove("hidden");const k=i.querySelector("span");k&&(k.textContent="Pendaftaran berhasil! Silakan login."+x),document.getElementById("register-form").reset(),setTimeout(()=>{showLogin()},2e3)}catch(p){console.error("Registration error:",p),d.textContent="Terjadi kesalahan. Silakan coba lagi.",r.classList.remove("hidden")}finally{l.disabled=!1,l.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar'}}),document.getElementById("forgot-pin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("forgot-whatsapp").value.trim(),n=document.getElementById("forgot-error"),a=document.getElementById("forgot-error-text"),o=document.getElementById("forgot-btn"),s=normalizePhoneTo08(t);if(!s){n.classList.remove("hidden"),a.textContent="Gunakan format 08xxxxxxxxxx";return}n.classList.add("hidden"),o.disabled=!0,o.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const r=CONFIG.getMainApiUrl(),d=await fetch(`${r}?sheet=users`),l=parseSheetResponse(await d.json()).filter(m=>normalizePhoneTo08(m.whatsapp||m.phone||"")===s);if(!l||l.length===0){a.textContent="Nomor WhatsApp tidak terdaftar",n.classList.remove("hidden"),o.disabled=!1,o.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi';return}alert(`Kode verifikasi telah dikirim ke WhatsApp ${s}.

Untuk sementara, hubungi admin untuk reset PIN.`);const c=s.replace(/^0/,"62");window.open(`https://wa.me/628993370200?text=Halo, saya ingin reset PIN akun saya. Nomor WhatsApp: ${c}`,"_blank"),setTimeout(()=>{showLogin()},1e3)}catch(r){console.error("Forgot PIN error:",r),a.textContent="Terjadi kesalahan. Silakan coba lagi.",n.classList.remove("hidden")}finally{o.disabled=!1,o.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi'}});function openEditProfile(){const e=getLoggedInUser();e&&(document.getElementById("edit-name").value=e.nama,document.getElementById("edit-old-pin").value="",document.getElementById("edit-new-pin").value="",document.getElementById("edit-confirm-pin").value="",document.getElementById("edit-error").classList.add("hidden"),document.getElementById("edit-profile-modal").classList.remove("hidden"))}function closeEditProfile(){document.getElementById("edit-profile-modal").classList.add("hidden")}document.getElementById("edit-profile-form").addEventListener("submit",async e=>{e.preventDefault();const t=getLoggedInUser();if(!t)return;const n=document.getElementById("edit-name").value.trim(),a=document.getElementById("edit-old-pin").value.trim(),o=document.getElementById("edit-new-pin").value.trim(),s=document.getElementById("edit-confirm-pin").value.trim(),r=document.getElementById("edit-error"),d=document.getElementById("edit-error-text"),i=document.getElementById("edit-save-btn");if(r.classList.add("hidden"),n.replace(/\s/g,"").length<4){d.textContent="Masukkan Nama Lengkap",r.classList.remove("hidden");return}if(a||o||s){if(!a||!o||!s){d.textContent="Lengkapi semua field PIN",r.classList.remove("hidden");return}if(o.length!==6||!/^\d{6}$/.test(o)){d.textContent="PIN baru harus 6 digit angka",r.classList.remove("hidden");return}if(o!==s){d.textContent="PIN baru tidak cocok",r.classList.remove("hidden");return}}i.disabled=!0,i.textContent="Menyimpan...";try{const c=CONFIG.getMainApiUrl(),u=await(await fetch(`${c}?sheet=users&id=${t.id}`)).json();if(!u||u.length===0)throw new Error("User not found");const g=u[0];if(a&&g.pin!==a){d.textContent="PIN lama salah",r.classList.remove("hidden"),i.disabled=!1,i.textContent="Simpan";return}const h={nama:n};o&&(h.pin=o);const y=await GASActions.update("users",t.id,h);if(!y.affected||y.affected<1)throw new Error("Failed to update");t.nama=n,saveLoggedInUser(t),document.getElementById("user-name").textContent=n,closeEditProfile(),alert("Profil berhasil diperbarui!")}catch(c){console.error("Edit profile error:",c),d.textContent="Terjadi kesalahan. Silakan coba lagi.",r.classList.remove("hidden")}finally{i.disabled=!1,i.textContent="Simpan"}});function showOrderDetailModal(e){document.getElementById("tracking-order-id").textContent=e.id||"N/A";const t=e.tanggal||e.tanggal_pesanan||e.timestamp||e.date||e.created_at;document.getElementById("tracking-order-date").textContent=formatDate(t);const n=normalizeStatus(e.status||"Menunggu"),a=getStatusBadge(n),o=document.getElementById("tracking-status-badge");o&&(o.innerHTML=a),document.getElementById("tracking-products").textContent=e.produk||e.items||e.product_name||"N/A",document.getElementById("tracking-total").textContent=formatCurrency(e.total||e.total_bayar||0);const s=createAnimatedTimeline(n);document.getElementById("tracking-timeline").innerHTML=s,document.getElementById("order-tracking-modal").classList.remove("hidden")}function createAnimatedTimeline(e){const t=[{name:"Menunggu",gif:"wait.gif",key:"Menunggu"},{name:"Diproses",gif:"grocery-basket.gif",key:"Diproses"},{name:"Dikirim",gif:"grocery.gif",key:"Dikirim"},{name:"Diterima",gif:"shipping.gif",key:"Diterima"}];let n=t.findIndex(a=>a.key===e);return e==="Dibatalkan"?`
            <div class="flex items-center justify-center gap-3 py-4">
                <div class="bg-red-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div>
                    <p class="font-bold text-red-600">Dibatalkan</p>
                    <p class="text-xs text-gray-500">Pesanan telah dibatalkan</p>
                </div>
            </div>
        `:(n===-1&&(n=0),`
        <div class="flex items-center justify-between gap-2 py-2">
            ${t.map((a,o)=>{const s=o<=n,r=o===n,d=o===t.length-1,i=`./assets/images/${a.gif}`,l=sanitizeUrl(i,"./assets/images/wait.gif");return`
                    <div class="flex flex-col items-center flex-1">
                        <div class="${s?"bg-green-50":"bg-gray-100"} w-12 h-12 rounded-full flex items-center justify-center ${r?"ring-2 ring-green-500 ring-offset-2":""}">
                            <img src="${l}" alt="${a.name}" class="w-8 h-8 object-contain ${s?"":"opacity-40"}" data-fallback-src="${i}">
                        </div>
                        <p class="text-[10px] font-semibold mt-2 text-center ${s?"text-gray-800":"text-gray-400"}">${a.name}</p>
                        ${r?'<p class="text-[8px] text-green-600 font-bold mt-0.5">\u25CF Saat ini</p>':'<p class="text-[8px] text-transparent mt-0.5">\u25CF</p>'}
                    </div>
                    ${d?"":`
                        <div class="flex-shrink-0 w-8 h-0.5 ${s&&o<n?"bg-green-500":"bg-gray-300"} transition-all duration-500 mb-6"></div>
                    `}
                `}).join("")}
        </div>
    `)}function closeOrderTracking(){document.getElementById("order-tracking-modal").classList.add("hidden")}const originalCreateOrderCard=createOrderCard;createOrderCard=function(e){const t=originalCreateOrderCard(e);return t.style.cursor="pointer",t.addEventListener("click",()=>{showOrderDetailModal(e)}),t};function switchRewardTab(e){const t=document.getElementById("tab-exchange"),n=document.getElementById("tab-history"),a=document.getElementById("exchange-content"),o=document.getElementById("history-content");e==="exchange"?(t.classList.add("text-amber-600","border-amber-600"),t.classList.remove("text-gray-400","border-transparent"),n.classList.add("text-gray-400","border-transparent"),n.classList.remove("text-amber-600","border-amber-600"),a.classList.remove("hidden"),o.classList.add("hidden"),fetchRewardItemsForAkun()):e==="history"&&(n.classList.add("text-amber-600","border-amber-600"),n.classList.remove("text-gray-400","border-transparent"),t.classList.add("text-gray-400","border-transparent"),t.classList.remove("text-amber-600","border-amber-600"),o.classList.remove("hidden"),a.classList.add("hidden"),loadClaimsHistory())}async function loadClaimsHistory(){const e=getLoggedInUser();if(!e)return;const t=document.getElementById("claims-loading"),n=document.getElementById("claims-empty"),a=document.getElementById("claims-list");t.classList.remove("hidden"),n.classList.add("hidden"),a.innerHTML="";try{const o=CONFIG.getMainApiUrl(),r=phoneLookupVariants(e.whatsapp).map(l=>`phone=${encodeURIComponent(l)}`).join("&"),d=await fetch(`${o}?sheet=claims&${r}`);if(!d.ok)throw new Error("Failed to fetch claims");const i=parseSheetResponse(await d.json());if(t.classList.add("hidden"),!i||i.length===0){n.classList.remove("hidden");return}i.sort((l,c)=>{const m=new Date(l.tanggal||l.date||0);return new Date(c.tanggal||c.date||0)-m}),i.forEach(l=>{const c=createClaimCard(l);a.appendChild(c)})}catch(o){console.error("Error loading claims history:",o),t.classList.add("hidden"),n.classList.remove("hidden")}}function createClaimCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition";const n={pending:"bg-yellow-100 text-yellow-700",approved:"bg-green-100 text-green-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-red-100 text-red-700"},a=(e.status||"pending").toLowerCase(),o=n[a]||"bg-gray-100 text-gray-700",r={pending:"Menunggu",approved:"Disetujui",completed:"Selesai",rejected:"Ditolak"}[a]||e.status||"Menunggu",i=new Date(e.tanggal||e.date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return t.innerHTML=`
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <h5 class="font-bold text-gray-800">${escapeHtml(e.hadiah||e.reward||"Reward")}</h5>
                <p class="text-xs text-gray-500 mt-1">${i}</p>
            </div>
            <span class="${o} text-xs font-bold px-3 py-1 rounded-full">${escapeHtml(r)}</span>
        </div>
        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-gray-700">${e.poin||0} Poin</span>
            </div>
            ${e.id?`<span class="text-xs text-gray-400">#${escapeHtml(e.id)}</span>`:""}
        </div>
    `,t}function closeLoyaltyModal(){document.getElementById("loyalty-modal").classList.add("hidden"),switchRewardTab("exchange")}async function openRewardModal(){const e=getLoggedInUser();if(!e)return;await loadModalPoints();const t=document.getElementById("loyalty-modal-points"),n=t?parseInt(t.textContent||"0"):0;setRewardContextFromAkun(e.whatsapp,n,e.nama),document.getElementById("loyalty-modal").classList.remove("hidden"),switchRewardTab("exchange"),fetchRewardItemsForAkun()}async function loadModalPoints(){const e=getLoggedInUser();if(!e)return;const t=parseInt(e.total_points||e.points||e.poin||0,10)||0;try{const n=CONFIG.getMainApiUrl(),a=await fetch(`${n}?sheet=user_points`);if(!a.ok){document.getElementById("loyalty-modal-points").textContent=String(t);return}const o=await a.json();if(o&&typeof o=="object"&&String(o.error||"").toLowerCase()==="unauthorized"){console.warn("\u26A0\uFE0F Unauthorized access to user_points (modal). Falling back to user profile points."),document.getElementById("loyalty-modal-points").textContent=String(t);return}const s=Array.isArray(o)?o.filter(r=>normalizePhoneTo08(r.phone)===normalizePhoneTo08(e.whatsapp)):[];if(s&&s.length>0){const r=s[0],d=parseInt(r.points||r.poin||0);document.getElementById("loyalty-modal-points").textContent=d}else document.getElementById("loyalty-modal-points").textContent=String(t)}catch(n){console.error("Error loading modal points:",n),document.getElementById("loyalty-modal-points").textContent=String(t)}}var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});ensureImageFallbackHandler();function hideRewardLoaders(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchRewardItemsForAkun(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n.innerHTML="";try{const a=CONFIG.getMainApiUrl(),o=await fetch(`${a}?sheet=tukar_poin`);if(!o.ok)throw new Error("Failed to fetch reward items");const s=await o.json(),r=parseSheetResponse(s);renderRewardItemsListAkun(r)}catch(a){console.error("Error fetching reward items:",a),t&&t.classList.add("hidden"),n.innerHTML=`
            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">
                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>
            </div>
        `}finally{hideRewardLoaders()}}}function renderRewardItemsListAkun(e){const t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){if(!e||e.length===0){t&&t.classList.remove("hidden"),n.innerHTML="";return}t&&t.classList.add("hidden"),n.innerHTML=e.map(a=>{const o=escapeHtml((a.id||"").toString()),s=escapeHtml((a.nama||a.judul||"Hadiah").toString()),r=parseInt(a.poin||a.Poin||0),d=(a.gambar||"https://via.placeholder.com/80?text=Reward").toString(),i=sanitizeUrl(d,"https://via.placeholder.com/80?text=Reward"),l=escapeHtml((a.deskripsi||"").toString());return`
            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-amber-500 transition">
                <div class="flex gap-3 mb-3">
                    <!-- Left: Image -->
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${i}" alt="${s}" class="w-full h-full object-cover" data-fallback-src="https://via.placeholder.com/80?text=Reward">
                    </div>
                    
                    <!-- Middle: Title & Description -->
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 text-sm mb-1">${s}</p>
                        <p class="text-xs text-gray-500 line-clamp-2">${l}</p>
                    </div>
                    
                    <!-- Right: Badge -->
                    <div class="flex-shrink-0">
                        <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">${r} Poin</span>
                    </div>
                </div>
                
                <!-- Full-width Button -->
                <button class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg transition text-sm" onclick="handleTukarSekarangAkun('${o}')">
                    Tukar Sekarang
                </button>
            </div>
        `}).join("")}}function setRewardContextFromAkun(e,t,n){e&&(sessionStorage.setItem("reward_phone",e),console.log("\u2705 Reward context set - phone:",e)),t!=null&&(sessionStorage.setItem("user_points",t.toString()),console.log("\u2705 Reward context set - points:",t)),n&&(sessionStorage.setItem("reward_customer_name",n),console.log("\u2705 Reward context set - name:",n))}function handleTukarSekarangAkun(e){const t=getLoggedInUser();if(!t){showToast("Mohon login terlebih dahulu.");return}const n=document.getElementById("loyalty-points"),a=n?parseInt(n.textContent||"0"):0;setRewardContextFromAkun(t.whatsapp,a,t.nama),typeof showConfirmTukarModal=="function"?showConfirmTukarModal(e):typeof window.claimReward=="function"?window.claimReward(e):showToast("Fitur tukar poin akan segera hadir!")}function hideMobileBottomNavOnDashboard(){const e=document.getElementById("mobile-bottom-nav"),t=document.getElementById("dashboard-section");e&&t&&(t.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}document.addEventListener("DOMContentLoaded",function(){setTimeout(hideMobileBottomNavOnDashboard,100)});const originalShowDashboard=showDashboard;showDashboard=function(e){typeof originalShowDashboard=="function"&&originalShowDashboard(e),setTimeout(hideMobileBottomNavOnDashboard,100)};const originalShowLogin=showLogin;showLogin=function(){typeof originalShowLogin=="function"&&originalShowLogin();const e=document.getElementById("mobile-bottom-nav");e&&e.classList.remove("hidden")};
