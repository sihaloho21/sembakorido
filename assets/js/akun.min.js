const normalizePhoneTo08=e=>{const n=String(e??"").replace(/[^0-9]/g,"");if(!n)return"";let r=n;return r.startsWith("62")&&(r=r.slice(2)),r.startsWith("0")&&(r=r.slice(1)),r.startsWith("8")?"0"+r:""},phoneLookupVariants=e=>{const t=normalizePhoneTo08(e);if(!t)return[];const n=t.slice(1);return[t,`+62${n}`,`62${n}`,n]},displayPhone=e=>normalizePhoneTo08(e)||e||"",parseSheetResponse=e=>Array.isArray(e)?e:e&&Array.isArray(e.result)?e.result:e&&e.result?Array.isArray(e.result)?e.result:[e.result]:[],isUnauthorizedApiResponse=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)&&String(e.error||"").toLowerCase()==="unauthorized"),buildSessionQuery=e=>{const t=String(e&&e.session_token||"").trim();return t?`&session_token=${encodeURIComponent(t)}`:""},hasPublicSession=e=>String(e&&e.session_token||"").trim()!=="";let referralProfileCache=null,pendingReferralCodeFromUrl="",referralConfigCache={rewardReferrerPoints:20,rewardRefereePoints:10,minFirstOrder:5e4};function toReferralCodeValue(e){return String(e||"").trim().toUpperCase()}function getReferralCodeFromUrl(){try{const e=new URLSearchParams(window.location.search||"");return toReferralCodeValue(e.get("ref")||e.get("referral")||e.get("kode_referral")||"")}catch(e){return console.warn("Failed parsing referral code from URL:",e),""}}function buildReferralShareUrl(e){const t=toReferralCodeValue(e);if(!t||t==="-")return"";const n=new URL(`${window.location.origin}${window.location.pathname}`);return n.searchParams.set("ref",t),n.toString()}function updateRegisterReferralInfo(){const e=document.getElementById("register-referral-info"),t=document.getElementById("register-referral-info-text");!e||!t||(pendingReferralCodeFromUrl?(t.textContent=`Referral dari link aktif: ${pendingReferralCodeFromUrl}`,e.classList.remove("hidden")):e.classList.add("hidden"))}function buildReferralShareMessage(e,t){const n=toReferralCodeValue(e);if(!n||n==="-"||!t)return"";const r=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,o=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,s=parseInt(referralConfigCache.minFirstOrder||0,10)||0,a=s>0?formatCurrency(s):"sesuai ketentuan program";return["Halo, yuk daftar GoSembako pakai link referral saya.","",`Link: ${t}`,`Kode Referral: ${n}`,"",`Bonus pengguna baru: ${o} poin`,`Bonus pengajak: ${r} poin`,`Bonus aktif setelah pesanan pertama selesai (minimal ${a}).`,"","Terima kasih."].join(`
`)}function updateReferralShareUI(e){const t=toReferralCodeValue(e&&e.kode_referral||referralProfileCache&&referralProfileCache.kode_referral||getLoggedInUser()&&getLoggedInUser().kode_referral||""),n=buildReferralShareUrl(t),r=document.getElementById("referral-code-display"),o=document.getElementById("referral-share-message"),s=document.getElementById("referral-reward-info");if(r&&(r.value=n||"-",r.dataset.referralCode=t||""),o&&(o.textContent=n?buildReferralShareMessage(t,n):"Link referral akan muncul setelah kode referral tersedia."),s){const a=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,l=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,d=parseInt(referralConfigCache.minFirstOrder||0,10)||0;s.textContent=`Pengajak: ${a} poin, Pengguna baru: ${l} poin (setelah pesanan pertama selesai${d>0?`, minimal ${formatCurrency(d)}`:""}).`}}function getCurrentReferralCode(){const e=document.getElementById("referral-code-display"),t=toReferralCodeValue(e?.dataset?.referralCode||"");return t||toReferralCodeValue(getLoggedInUser()?.kode_referral||"")}async function loadPublicReferralConfig(){try{const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?action=public_referral_config&_t=${Date.now()}`);if(!t.ok)return;const n=await t.json();if(!n||n.success!==!0)return;referralConfigCache={rewardReferrerPoints:parseInt(n.reward_referrer_points||referralConfigCache.rewardReferrerPoints,10)||referralConfigCache.rewardReferrerPoints,rewardRefereePoints:parseInt(n.reward_referee_points||referralConfigCache.rewardRefereePoints,10)||referralConfigCache.rewardRefereePoints,minFirstOrder:parseInt(n.min_first_order||referralConfigCache.minFirstOrder,10)||referralConfigCache.minFirstOrder}}catch(e){console.warn("Failed to load public referral config:",e)}}function setReferralStatus(e,t){const n=document.getElementById("referral-status");n&&(n.textContent=e||"",n.className="text-xs",t==="success"?n.classList.add("text-green-600"):t==="error"?n.classList.add("text-red-600"):t==="warning"?n.classList.add("text-amber-600"):n.classList.add("text-gray-500"))}function generateReferralCode(e,t,n){const r=String(e||"USER").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6)||"USER",s=normalizePhoneTo08(t).replace(/\D/g,"").slice(-4)||Math.floor(1e3+Math.random()*9e3).toString();let a=`${r}${s}`.slice(0,24);if(!n.has(a))return a;for(let l=1;l<=2e3;l+=1){const d=`${r}${s}${l}`.slice(0,24);if(!n.has(d))return d}return`${r}${Date.now().toString().slice(-6)}`.slice(0,24)}async function fetchUsersList(){const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=users&_t=${Date.now()}`);if(!t.ok)throw new Error("Gagal memuat data users");return parseSheetResponse(await t.json())}async function ensureUserReferralCode(e,t){const n=t.find(a=>String(a.id)===String(e.id))||t.find(a=>normalizePhoneTo08(a.whatsapp||a.phone||"")===normalizePhoneTo08(e.whatsapp));if(!n)return{user:{id:e.id||"",nama:e.nama||"User",whatsapp:normalizePhoneTo08(e.whatsapp||e.phone||""),kode_referral:"",referred_by:"",referral_count:0,referral_points_total:0},code:"",missingProfile:!0};const r=toReferralCodeValue(n.kode_referral);if(r)return{user:n,code:r};const o=new Set(t.map(a=>toReferralCodeValue(a.kode_referral)).filter(Boolean)),s=generateReferralCode(n.nama,n.whatsapp||n.phone,o);return await GASActions.update("users",n.id,{kode_referral:s}),n.kode_referral=s,{user:n,code:s}}function applyReferralDataToUI(e){const t=document.getElementById("referral-code-display"),n=document.getElementById("referral-input"),r=document.getElementById("apply-referral-btn"),o=document.getElementById("referral-count"),s=document.getElementById("referral-points-total");t&&(t.value="-"),o&&(o.textContent=String(parseInt(e.referral_count||0,10)||0)),s&&(s.textContent=String(parseInt(e.referral_points_total||0,10)||0));const a=toReferralCodeValue(e.referred_by)!=="";n&&(n.value=a?toReferralCodeValue(e.referred_by):"",n.disabled=a),r&&(r.disabled=a),a?setReferralStatus(`Referral aktif dengan kode: ${toReferralCodeValue(e.referred_by)}`,"success"):setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info"),updateReferralShareUI(e)}function buildReferralProfileFallback(e){return{id:e&&e.id?e.id:"",nama:e&&e.nama?e.nama:"User",whatsapp:normalizePhoneTo08(e&&(e.whatsapp||e.phone)||""),kode_referral:toReferralCodeValue(e&&e.kode_referral?e.kode_referral:""),referred_by:toReferralCodeValue(e&&e.referred_by?e.referred_by:""),referral_count:parseInt(e&&e.referral_count||0,10)||0,referral_points_total:parseInt(e&&e.referral_points_total||0,10)||0}}function getReferralStatusBadge(e){const t=String(e||"").toLowerCase();return t==="approved"?'<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold">Approved</span>':t==="rejected"||t==="void"?'<span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold">Rejected</span>':'<span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">Pending</span>'}async function loadReferralHistory(e){const t=document.getElementById("referral-history-list"),n=document.getElementById("referral-history-badge");if(!(!t||!n))try{const r=CONFIG.getMainApiUrl(),o=normalizePhoneTo08(e.whatsapp);let s=[],a=!1;const l=buildSessionQuery(e);if(l){const i=await fetch(`${r}?action=public_referral_history${l}&_t=${Date.now()}`);if(i.ok){const c=await i.json();c&&c.success&&Array.isArray(c.referrals)&&(s=c.referrals,a=!0)}}if(!s.length&&!a){const i=await fetch(`${r}?sheet=referrals&phone=${encodeURIComponent(o)}&_t=${Date.now()}`);if(!i.ok)throw new Error("Gagal memuat riwayat referral");s=parseSheetResponse(await i.json())}const d=s.filter(i=>{const c=normalizePhoneTo08(i.referrer_phone||""),m=normalizePhoneTo08(i.referee_phone||"");return c===o||m===o}).sort((i,c)=>new Date(c.created_at||0).getTime()-new Date(i.created_at||0).getTime()).slice(0,5);if(n.textContent=`${d.length} data`,d.length===0){t.innerHTML='<p class="text-gray-400">Belum ada riwayat referral.</p>';return}t.innerHTML=d.map(i=>{const c=normalizePhoneTo08(i.referrer_phone||"")===o?"Anda mengajak":"Anda diajak",m=normalizePhoneTo08(c==="Anda mengajak"?i.referee_phone||"":i.referrer_phone||""),u=c==="Anda mengajak"?parseInt(i.reward_referrer_points||0,10)||0:parseInt(i.reward_referee_points||0,10)||0;return`
                <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-bold text-gray-700">${escapeHtml(c)}</span>
                        ${getReferralStatusBadge(i.status)}
                    </div>
                    <p class="text-gray-600">No: ${escapeHtml(m||"-")}</p>
                    <p class="text-green-700 font-semibold">Reward: ${escapeHtml(String(u))} poin</p>
                </div>
            `}).join("")}catch(r){console.error("Error loading referral history:",r),n.textContent="error",t.innerHTML='<p class="text-red-500">Gagal memuat riwayat referral.</p>'}}async function fetchPublicReferralProfile(e){if(!hasPublicSession(e))return null;const t=buildSessionQuery(e);if(!t)return null;try{const n=CONFIG.getMainApiUrl(),r=await fetch(`${n}?action=public_user_profile${t}&_t=${Date.now()}`);if(!r.ok)return null;const o=await r.json();return!o||o.success!==!0||!o.user?null:o.user}catch(n){return console.warn("Failed to load public referral profile:",n),null}}async function loadReferralData(e){try{const t=await fetchPublicReferralProfile(e);if(t){referralProfileCache=t,applyReferralDataToUI(t),await loadReferralHistory({...e,session_token:String(e.session_token||t.session_token||"").trim()});return}const n=await fetchUsersList(),r=await ensureUserReferralCode(e,n);if(referralProfileCache=r.user,applyReferralDataToUI(r.user),r.missingProfile){applyReferralDataToUI(buildReferralProfileFallback(e)),setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info"),await loadReferralHistory(e);return}await loadReferralHistory(e)}catch(t){console.error("Error loading referral data:",t),applyReferralDataToUI(buildReferralProfileFallback(e)),setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info");try{await loadReferralHistory(e)}catch(n){console.warn("Failed loading referral history after fallback:",n)}}}document.addEventListener("DOMContentLoaded",()=>{pendingReferralCodeFromUrl=getReferralCodeFromUrl(),updateRegisterReferralInfo(),loadPublicReferralConfig().then(()=>{referralProfileCache&&updateReferralShareUI(referralProfileCache)});const e=getLoggedInUser(),t=document.getElementById("referral-input");t&&t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),applyReferralCode())}),e?showDashboard(e):showLogin()});function showLogin(){document.getElementById("login-section").classList.remove("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showDashboard(e){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.remove("hidden"),document.getElementById("user-name").textContent=e.nama,document.getElementById("user-whatsapp").textContent=displayPhone(e.whatsapp),loadLoyaltyPoints(e),loadReferralData(e),loadOrderHistory(e)}document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-whatsapp").value.trim(),n=document.getElementById("login-pin").value.trim(),r=document.getElementById("login-btn"),o=document.getElementById("login-error"),s=document.getElementById("login-error-text");if(!t||!n){showError("Mohon lengkapi semua field");return}const a=normalizePhoneTo08(t);if(!a){showError("Gunakan format 08xxxxxxxxxx");return}if(a.length<10||a.length>13){showError("Panjang nomor tidak valid");return}if(n.length!==6){showError("PIN harus 6 digit");return}r.disabled=!0,r.innerHTML=`
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Memproses...</span>
    `,o.classList.add("hidden");try{const l=CONFIG.getMainApiUrl(),d="&_t="+Date.now();let i=null;const c=`${l}?action=public_login&phone=${encodeURIComponent(a)}&pin=${encodeURIComponent(n)}${d}`,m=await fetch(c);if(m.ok){const u=await m.json();if(u&&u.success&&u.user)i=u.user;else{const p=String(u&&u.error?u.error:"").toLowerCase();if(p==="login_failed"){showError("Nomor WhatsApp atau PIN salah"),resetLoginButton();return}if(p==="account_inactive"){showError("Akun Anda tidak aktif. Hubungi admin."),resetLoginButton();return}if(p==="rate_limited"){showError(u&&u.message||"Terlalu banyak percobaan login, coba lagi."),resetLoginButton();return}if(!(p==="invalid sheet"||p==="invalid action")){showError(u&&u.message||"Login gagal. Silakan coba lagi."),resetLoginButton();return}}}if(!i){const u=phoneLookupVariants(a),p=await fetch(`${l}?sheet=users${d}`);if(!p.ok){showError("Gagal menghubungi server. Silakan coba lagi."),resetLoginButton();return}const f=await p.json();if(isUnauthorizedApiResponse(f)){showError("Layanan login membutuhkan endpoint public_login. Hubungi admin."),resetLoginButton();return}const w=parseSheetResponse(f);for(const y of u){const b=w.find(g=>normalizePhoneTo08(g.whatsapp||g.phone||"")===normalizePhoneTo08(y));if(b){i=b;break}}if(!i){showError("Nomor WhatsApp tidak terdaftar"),resetLoginButton();return}if((i.pin||"").toString()!==n){showError("PIN salah. Silakan coba lagi."),resetLoginButton();return}}if(i.status&&i.status.toLowerCase()!=="aktif"){showError("Akun Anda tidak aktif. Hubungi admin."),resetLoginButton();return}i.whatsapp=normalizePhoneTo08(i.whatsapp||i.phone||a),saveLoggedInUser(i),showDashboard(i),document.getElementById("dashboard-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(l){console.error("Login error:",l),showError("Terjadi kesalahan. Silakan coba lagi."),resetLoginButton()}});function showError(e){const t=document.getElementById("login-error"),n=document.getElementById("login-error-text");n.textContent=e,t.classList.remove("hidden")}function resetLoginButton(){const e=document.getElementById("login-btn");e.disabled=!1,e.innerHTML=`
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
        </svg>
        Masuk
    `}function saveLoggedInUser(e){const t=normalizePhoneTo08(e.whatsapp||e.phone||"");localStorage.setItem("gosembako_user",JSON.stringify({id:e.id,nama:e.nama,whatsapp:t||e.whatsapp,tanggal_daftar:e.tanggal_daftar,status:e.status||"",total_points:parseInt(e.total_points||e.points||e.poin||0,10)||0,kode_referral:toReferralCodeValue(e.kode_referral||""),referred_by:toReferralCodeValue(e.referred_by||""),referral_count:parseInt(e.referral_count||0,10)||0,referral_points_total:parseInt(e.referral_points_total||0,10)||0,session_token:String(e.session_token||"").trim()}))}function getLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;const t=JSON.parse(e);return t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||"")||t.whatsapp,t.session_token=String(t.session_token||"").trim(),t}function logout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("gosembako_user"),window.location.reload())}async function copyReferralCode(){const e=getCurrentReferralCode();if(!e||e==="-"){setReferralStatus("Link referral belum tersedia.","warning");return}const t=buildReferralShareUrl(e);if(!t){setReferralStatus("Link referral tidak tersedia.","warning");return}try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t);else{const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}setReferralStatus("Link referral berhasil disalin.","success")}catch(n){console.error("Copy referral failed:",n),setReferralStatus("Gagal menyalin link referral.","error")}}function shareReferralWhatsApp(){const e=getCurrentReferralCode(),t=buildReferralShareUrl(e);if(!t){setReferralStatus("Link referral belum tersedia.","warning");return}const n=buildReferralShareMessage(e,t),r=`https://wa.me/?text=${encodeURIComponent(n)}`;window.open(r,"_blank","noopener"),setReferralStatus("Link referral siap dibagikan ke WhatsApp.","success")}async function applyReferralCode(){const e=getLoggedInUser();if(!e){setReferralStatus("Silakan login ulang.","error");return}const t=document.getElementById("referral-input"),n=document.getElementById("apply-referral-btn"),r=toReferralCodeValue(t?t.value:"");if(!r){setReferralStatus("Masukkan kode referral terlebih dahulu.","warning");return}const o=getCurrentReferralCode();if(o&&r===o){setReferralStatus("Kode referral sendiri tidak bisa dipakai.","error");return}if(t&&t.disabled){setReferralStatus("Kode referral sudah pernah diterapkan.","warning");return}const s=n?n.textContent:"";try{n&&(n.disabled=!0,n.textContent="Memproses...");const a=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:normalizePhoneTo08(e.whatsapp),ref_code:r}});if(!a||a.success===!1){const l=a&&(a.message||a.error||a.error_code)||"Gagal menerapkan referral";setReferralStatus(l,"error"),n&&(n.disabled=!1,n.textContent=s||"Terapkan");return}t&&(t.value=r,t.disabled=!0),n&&(n.disabled=!0,n.textContent="Terapkan"),setReferralStatus("Kode referral berhasil diterapkan.","success"),await loadReferralData(e)}catch(a){console.error("applyReferralCode error:",a),setReferralStatus(a.message||"Gagal menerapkan kode referral.","error"),n&&(n.disabled=!1,n.textContent=s||"Terapkan")}}async function loadLoyaltyPoints(e){try{const t=CONFIG.getMainApiUrl(),n=normalizePhoneTo08(e.whatsapp),r=parseInt(e.total_points||e.points||e.poin||0,10)||0;if(!n){console.warn("\u26A0\uFE0F Invalid phone number for loyalty points lookup"),document.getElementById("loyalty-points").textContent=String(r),setRewardContextFromAkun(e.whatsapp,r,e.nama);return}console.log(`\u{1F50D} Loading loyalty points for phone: ${n}`);let o=null;const s=buildSessionQuery(e);if(s){const m=await fetch(`${t}?action=public_user_points${s}&_t=${Date.now()}`);if(m.ok){const u=await m.json();u&&u.success&&(o=parseInt(u.points||0,10)||0)}}if(o!==null){document.getElementById("loyalty-points").textContent=String(o),setRewardContextFromAkun(e.whatsapp,o,e.nama);return}if(!hasPublicSession(e)){document.getElementById("loyalty-points").textContent=String(r),setRewardContextFromAkun(e.whatsapp,r,e.nama);return}const a=await fetch(`${t}?sheet=user_points`);if(!a.ok){console.error("\u274C Failed to fetch loyalty points"),document.getElementById("loyalty-points").textContent="0";return}const l=await a.json();if(console.log("\u{1F4E5} Points data received:",l),l&&typeof l=="object"&&String(l.error||"").toLowerCase()==="unauthorized"){console.warn("\u26A0\uFE0F Unauthorized access to user_points. Falling back to user profile points."),document.getElementById("loyalty-points").textContent=String(r),setRewardContextFromAkun(e.whatsapp,r,e.nama);return}let d=Array.isArray(l)?l:l.result||[];if(!Array.isArray(d)){console.warn("\u26A0\uFE0F Unexpected points data format"),document.getElementById("loyalty-points").textContent="0";return}const i=phoneLookupVariants(n);let c=null;for(const m of i)if(c=d.find(u=>normalizePhoneTo08(u.phone||u.whatsapp||"")===normalizePhoneTo08(m)),c){console.log(`\u2705 Found points record for ${m}:`,c);break}if(c){const m=parseInt(c.points||c.poin||0);console.log(`\u2705 User points: ${m}`),document.getElementById("loyalty-points").textContent=m,setRewardContextFromAkun(e.whatsapp,m,e.nama)}else console.log("\u26A0\uFE0F No points record found for user"),document.getElementById("loyalty-points").textContent=String(r),setRewardContextFromAkun(e.whatsapp,r,e.nama)}catch(t){console.error("\u274C Error loading loyalty points:",t);const n=parseInt(e.total_points||e.points||e.poin||0,10)||0;document.getElementById("loyalty-points").textContent=String(n),setRewardContextFromAkun(e.whatsapp,n,e.nama)}}async function loadOrderHistory(e){const t=document.getElementById("order-loading"),n=document.getElementById("order-empty"),r=document.getElementById("order-list"),o=document.getElementById("total-accepted-spend");t.classList.remove("hidden"),n.classList.add("hidden"),r.innerHTML="",o&&(o.textContent="Rp 0");try{const s=CONFIG.getMainApiUrl();let a=[];const l=buildSessionQuery(e);if(l){const d=await fetch(`${s}?action=public_user_orders${l}&_t=${Date.now()}`);if(d.ok){const i=await d.json();i&&i.success&&Array.isArray(i.orders)&&(a=i.orders)}}if(!a.length){let d=await fetch(`${s}?sheet=orders`);if(!d.ok)throw new Error("Gagal memuat riwayat pesanan");let i=await d.json();a=Array.isArray(i)?i.filter(c=>normalizePhoneTo08(c.phone)===normalizePhoneTo08(e.whatsapp)):[]}if(t.classList.add("hidden"),!a||a.length===0){n.classList.remove("hidden");return}if(a=a.filter(d=>{const i=normalizePhoneTo08(d.phone||d.whatsapp||""),c=normalizePhoneTo08(e.whatsapp);return i===c}),a.length===0){n.classList.remove("hidden");return}if(a.sort((d,i)=>{const c=new Date(d.tanggal_pesanan||d.timestamp||0);return new Date(i.tanggal_pesanan||i.timestamp||0)-c}),window.allOrders=a,window.currentPage=1,window.ordersPerPage=10,o){const d=new Set(["terima","diterima","selesai"]),i=a.reduce((c,m)=>{const u=String(m.status||"").toLowerCase().trim();return d.has(u)?c+parseCurrencyValue(m.total||m.total_bayar||0):c},0);o.textContent=formatCurrency(i)}displayOrderPage(1)}catch(s){console.error("Error loading order history:",s),t.classList.add("hidden"),r.innerHTML=`
            <div class="text-center py-8 text-red-600">
                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm">Gagal memuat riwayat pesanan</p>
                <button onclick="location.reload()" class="mt-3 text-green-600 hover:underline text-sm font-bold">Coba Lagi</button>
            </div>
        `}}function parseCurrencyValue(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),n=parseFloat(t);return Number.isNaN(n)?0:n}function displayOrderPage(e){const t=document.getElementById("order-list"),n=document.getElementById("order-pagination");if(!window.allOrders||window.allOrders.length===0)return;const r=window.allOrders.length,o=Math.ceil(r/window.ordersPerPage),s=(e-1)*window.ordersPerPage,a=Math.min(s+window.ordersPerPage,r);t.innerHTML="";for(let l=s;l<a;l++){const d=createOrderCard(window.allOrders[l]);t.appendChild(d)}o>1?(n.classList.remove("hidden"),n.innerHTML=createPagination(e,o)):n.classList.add("hidden"),window.currentPage=e}function createPagination(e,t){let n='<div class="flex justify-center items-center gap-2 mt-6">';e>1&&(n+=`<button onclick="displayOrderPage(${e-1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">\u2190 Prev</button>`),n+='<div class="flex gap-1">';for(let r=1;r<=t;r++)r===e?n+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm">${r}</button>`:r===1||r===t||r>=e-1&&r<=e+1?n+=`<button onclick="displayOrderPage(${r})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm">${r}</button>`:(r===e-2||r===e+2)&&(n+='<span class="px-2 py-2 text-gray-500">...</span>');return n+="</div>",e<t&&(n+=`<button onclick="displayOrderPage(${e+1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">Next \u2192</button>`),n+="</div>",n}function createOrderCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-3 hover:border-green-300 transition cursor-pointer";const n=formatDate(e.tanggal_pesanan||e.timestamp),r=formatCurrency(e.total||e.total_bayar||0),o=e.status||"Menunggu",s=getStatusBadge(o),a=e.produk||e.items||e.product_name||"N/A",l=truncateText(a,20),d=e.id||"N/A";return t.innerHTML=`
        <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
                <p class="text-[10px] font-bold text-gray-700 mb-1">Order ID: <span class="text-green-600">${escapeHtml(d)}</span></p>
            </div>
            ${s}
        </div>
        
        <div class="border-t border-gray-100 pt-2 space-y-1.5">
            <div class="text-sm">
                <p class="text-gray-600 text-xs mb-0.5">Produk:</p>
                <p class="font-semibold text-gray-800 lg:hidden">${escapeHtml(l)}</p>
                <p class="font-semibold text-gray-800 hidden lg:block">${escapeHtml(a)}</p>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Qty:</span>
                <span class="font-semibold text-gray-800">${e.qty||e.quantity||e.jumlah||"N/A"}</span>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Poin:</span>
                <span class="font-semibold text-amber-600">+${e.poin||e.points||0}</span>
            </div>
            <div class="flex justify-between text-xs">
                <span class="text-gray-600">Total Bayar:</span>
                <span class="font-bold text-green-600">${r}</span>
            </div>
        </div>
        
        <div class="mt-3 pt-2 border-t border-gray-100">
            <button onclick="window.location.href='index.html'" class="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-bold py-1.5 rounded-lg transition text-xs">
                Belanja Lagi
            </button>
        </div>
    `,t.addEventListener("click",i=>{i.target.tagName!=="BUTTON"&&i.target.tagName!=="A"&&showOrderDetailModal(e)}),t}function getStatusBadge(e){const t=normalizeStatus(e),n={Menunggu:{bg:"bg-yellow-100",text:"text-yellow-700",label:"Menunggu"},Diproses:{bg:"bg-blue-100",text:"text-blue-700",label:"Diproses"},Dikirim:{bg:"bg-purple-100",text:"text-purple-700",label:"Dikirim"},Diterima:{bg:"bg-green-100",text:"text-green-700",label:"Diterima"},Dibatalkan:{bg:"bg-red-100",text:"text-red-700",label:"Dibatalkan"}},r=n[t]||n.Menunggu;return`<span class="${r.bg} ${r.text} text-xs font-bold px-3 py-1 rounded-full">${r.label}</span>`}function normalizeStatus(e){if(!e)return"Menunggu";const t=e.toLowerCase().trim();return{menunggu:"Menunggu",pending:"Menunggu",diproses:"Diproses",proses:"Diproses",processing:"Diproses",dikirim:"Dikirim",kirim:"Dikirim",shipped:"Dikirim",diterima:"Diterima",terima:"Diterima",selesai:"Diterima",completed:"Diterima",dibatalkan:"Dibatalkan",batal:"Dibatalkan",cancelled:"Dibatalkan",canceled:"Dibatalkan"}[t]||e}function formatDate(e){if(!e||e==="N/A"||e==="")return"N/A";let t;if(typeof e=="number")t=new Date(e);else if(typeof e=="string"){let r=e.split(",")[0].trim();if(t=new Date(e),isNaN(t.getTime())&&r.includes("/")){const o=r.split("/");if(o.length===3){const s=parseInt(o[0]),a=parseInt(o[1]),l=parseInt(o[2]);s<=31&&a<=12&&l>1900&&(t=new Date(l,a-1,s))}}}else t=new Date(e);if(isNaN(t.getTime()))return"N/A";const n={year:"numeric",month:"long",day:"numeric"};return t.toLocaleDateString("id-ID",n)}function truncateText(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":"N/A"}function formatCurrency(e){const t=parseInt(e)||0;return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t)}function showRegisterInfo(){alert(`Untuk mendaftar, silakan hubungi admin GoSembako melalui WhatsApp.

Anda akan diberikan akun dengan nomor WhatsApp dan PIN untuk login.`)}function showRegister(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.remove("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden"),updateRegisterReferralInfo()}function showForgotPIN(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.remove("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-name").value.trim(),n=document.getElementById("register-whatsapp").value.trim(),r=document.getElementById("register-pin").value.trim(),o=document.getElementById("register-pin-confirm").value.trim(),s=pendingReferralCodeFromUrl,a=document.getElementById("register-error"),l=document.getElementById("register-error-text"),d=document.getElementById("register-success"),i=document.getElementById("register-btn");a.classList.add("hidden"),d.classList.add("hidden");const c=t.replace(/\s/g,"");if(c.length<4){l.textContent="Masukkan Nama Lengkap",a.classList.remove("hidden");return}const m=c.toLowerCase(),u=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const y of u)if(y.test(m)){l.textContent="Masukkan Nama Lengkap",a.classList.remove("hidden");return}const p=normalizePhoneTo08(n);if(!p){l.textContent="Gunakan format 08xxxxxxxxxx",a.classList.remove("hidden");return}const f=p.replace(/[^0-9]/g,"");if(f.length<10||f.length>13){l.textContent="Nomor WhatsApp tidak valid",a.classList.remove("hidden");return}const w=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const y of w)if(y.test(f)){l.textContent="Nomor WhatsApp tidak valid",a.classList.remove("hidden");return}if(r.length!==6||!/^\d{6}$/.test(r)){l.textContent="PIN harus 6 digit angka",a.classList.remove("hidden");return}if(r!==o){l.textContent="PIN tidak cocok",a.classList.remove("hidden");return}i.disabled=!0,i.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const y=CONFIG.getMainApiUrl(),b=phoneLookupVariants(p);let g=[];const E="&_t="+Date.now();console.log("\u{1F50D} Checking phone formats:",b);try{const h=await fetch(`${y}?sheet=users${E}`);if(!h.ok)console.warn(`API error: ${h.status}`);else{const _=await h.json();g=parseSheetResponse(_).filter(I=>{const $=normalizePhoneTo08(I.whatsapp||I.phone||"");return b.some(D=>normalizePhoneTo08(D)===$)}),g&&g.length>0&&console.log("\u{1F4CA} Found existing user:",g)}}catch(h){console.warn("Check failed:",h.message)}if(console.log("\u{1F4CA} Final check result for",n,":",g),g&&g.length>0){l.textContent="Nomor WhatsApp sudah terdaftar",a.classList.remove("hidden"),i.disabled=!1,i.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar';return}const L=`USR-${Date.now().toString().slice(-6)}`,B=new Date().toISOString().split("T")[0],C=new Date().toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),k=await GASActions.create("users",{id:L,nama:t,whatsapp:p,pin:r,tanggal_daftar:B,status:"aktif",total_points:0,created_at:C,referred_by:"",referred_by_phone:"",referral_count:0,referral_points_total:0,kode_referral:""});if(!k.created||k.created<1)throw new Error("Gagal mendaftar");let x="";if(s)try{const h=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:p,ref_code:s}});h&&h.success?x=" Kode referral berhasil diterapkan.":x=" Akun dibuat, namun kode referral tidak valid."}catch(h){console.warn("Referral attach failed after registration:",h),x=" Akun dibuat, namun kode referral gagal diproses."}d.classList.remove("hidden");const v=d.querySelector("span");v&&(v.textContent="Pendaftaran berhasil! Silakan login."+x),document.getElementById("register-form").reset(),setTimeout(()=>{showLogin()},2e3)}catch(y){console.error("Registration error:",y),l.textContent="Terjadi kesalahan. Silakan coba lagi.",a.classList.remove("hidden")}finally{i.disabled=!1,i.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar'}}),document.getElementById("forgot-pin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("forgot-whatsapp").value.trim(),n=document.getElementById("forgot-error"),r=document.getElementById("forgot-error-text"),o=document.getElementById("forgot-btn"),s=normalizePhoneTo08(t);if(!s){n.classList.remove("hidden"),r.textContent="Gunakan format 08xxxxxxxxxx";return}n.classList.add("hidden"),o.disabled=!0,o.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const a=CONFIG.getMainApiUrl(),l=await fetch(`${a}?sheet=users`),i=parseSheetResponse(await l.json()).filter(m=>normalizePhoneTo08(m.whatsapp||m.phone||"")===s);if(!i||i.length===0){r.textContent="Nomor WhatsApp tidak terdaftar",n.classList.remove("hidden"),o.disabled=!1,o.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi';return}alert(`Kode verifikasi telah dikirim ke WhatsApp ${s}.

Untuk sementara, hubungi admin untuk reset PIN.`);const c=s.replace(/^0/,"62");window.open(`https://wa.me/628993370200?text=Halo, saya ingin reset PIN akun saya. Nomor WhatsApp: ${c}`,"_blank"),setTimeout(()=>{showLogin()},1e3)}catch(a){console.error("Forgot PIN error:",a),r.textContent="Terjadi kesalahan. Silakan coba lagi.",n.classList.remove("hidden")}finally{o.disabled=!1,o.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi'}});function openEditProfile(){const e=getLoggedInUser();e&&(document.getElementById("edit-name").value=e.nama,document.getElementById("edit-old-pin").value="",document.getElementById("edit-new-pin").value="",document.getElementById("edit-confirm-pin").value="",document.getElementById("edit-error").classList.add("hidden"),document.getElementById("edit-profile-modal").classList.remove("hidden"))}function closeEditProfile(){document.getElementById("edit-profile-modal").classList.add("hidden")}document.getElementById("edit-profile-form").addEventListener("submit",async e=>{e.preventDefault();const t=getLoggedInUser();if(!t)return;const n=document.getElementById("edit-name").value.trim(),r=document.getElementById("edit-old-pin").value.trim(),o=document.getElementById("edit-new-pin").value.trim(),s=document.getElementById("edit-confirm-pin").value.trim(),a=document.getElementById("edit-error"),l=document.getElementById("edit-error-text"),d=document.getElementById("edit-save-btn");if(a.classList.add("hidden"),n.replace(/\s/g,"").length<4){l.textContent="Masukkan Nama Lengkap",a.classList.remove("hidden");return}if(r||o||s){if(!r||!o||!s){l.textContent="Lengkapi semua field PIN",a.classList.remove("hidden");return}if(o.length!==6||!/^\d{6}$/.test(o)){l.textContent="PIN baru harus 6 digit angka",a.classList.remove("hidden");return}if(o!==s){l.textContent="PIN baru tidak cocok",a.classList.remove("hidden");return}}d.disabled=!0,d.textContent="Menyimpan...";try{const c=CONFIG.getMainApiUrl(),u=await(await fetch(`${c}?sheet=users&id=${t.id}`)).json();if(!u||u.length===0)throw new Error("User not found");const p=u[0];if(r&&p.pin!==r){l.textContent="PIN lama salah",a.classList.remove("hidden"),d.disabled=!1,d.textContent="Simpan";return}const f={nama:n};o&&(f.pin=o);const w=await GASActions.update("users",t.id,f);if(!w.affected||w.affected<1)throw new Error("Failed to update");t.nama=n,saveLoggedInUser(t),document.getElementById("user-name").textContent=n,closeEditProfile(),alert("Profil berhasil diperbarui!")}catch(c){console.error("Edit profile error:",c),l.textContent="Terjadi kesalahan. Silakan coba lagi.",a.classList.remove("hidden")}finally{d.disabled=!1,d.textContent="Simpan"}});function showOrderDetailModal(e){document.getElementById("tracking-order-id").textContent=e.id||"N/A";const t=e.tanggal||e.tanggal_pesanan||e.timestamp||e.date||e.created_at;document.getElementById("tracking-order-date").textContent=formatDate(t);const n=normalizeStatus(e.status||"Menunggu"),r=getStatusBadge(n),o=document.getElementById("tracking-status-badge");o&&(o.innerHTML=r),document.getElementById("tracking-products").textContent=e.produk||e.items||e.product_name||"N/A",document.getElementById("tracking-total").textContent=formatCurrency(e.total||e.total_bayar||0);const s=createAnimatedTimeline(n);document.getElementById("tracking-timeline").innerHTML=s,document.getElementById("order-tracking-modal").classList.remove("hidden")}function createAnimatedTimeline(e){const t=[{name:"Menunggu",gif:"wait.gif",key:"Menunggu"},{name:"Diproses",gif:"grocery-basket.gif",key:"Diproses"},{name:"Dikirim",gif:"grocery.gif",key:"Dikirim"},{name:"Diterima",gif:"shipping.gif",key:"Diterima"}];let n=t.findIndex(r=>r.key===e);return e==="Dibatalkan"?`
            <div class="flex items-center justify-center gap-3 py-4">
                <div class="bg-red-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div>
                    <p class="font-bold text-red-600">Dibatalkan</p>
                    <p class="text-xs text-gray-500">Pesanan telah dibatalkan</p>
                </div>
            </div>
        `:(n===-1&&(n=0),`
        <div class="flex items-center justify-between gap-2 py-2">
            ${t.map((r,o)=>{const s=o<=n,a=o===n,l=o===t.length-1,d=`./assets/images/${r.gif}`,i=sanitizeUrl(d,"./assets/images/wait.gif");return`
                    <div class="flex flex-col items-center flex-1">
                        <div class="${s?"bg-green-50":"bg-gray-100"} w-12 h-12 rounded-full flex items-center justify-center ${a?"ring-2 ring-green-500 ring-offset-2":""}">
                            <img src="${i}" alt="${r.name}" class="w-8 h-8 object-contain ${s?"":"opacity-40"}" data-fallback-src="${d}">
                        </div>
                        <p class="text-[10px] font-semibold mt-2 text-center ${s?"text-gray-800":"text-gray-400"}">${r.name}</p>
                        ${a?'<p class="text-[8px] text-green-600 font-bold mt-0.5">\u25CF Saat ini</p>':'<p class="text-[8px] text-transparent mt-0.5">\u25CF</p>'}
                    </div>
                    ${l?"":`
                        <div class="flex-shrink-0 w-8 h-0.5 ${s&&o<n?"bg-green-500":"bg-gray-300"} transition-all duration-500 mb-6"></div>
                    `}
                `}).join("")}
        </div>
    `)}function closeOrderTracking(){document.getElementById("order-tracking-modal").classList.add("hidden")}const originalCreateOrderCard=createOrderCard;createOrderCard=function(e){const t=originalCreateOrderCard(e);return t.style.cursor="pointer",t.addEventListener("click",()=>{showOrderDetailModal(e)}),t};function switchRewardTab(e){const t=document.getElementById("tab-exchange"),n=document.getElementById("tab-history"),r=document.getElementById("exchange-content"),o=document.getElementById("history-content");e==="exchange"?(t.classList.add("text-amber-600","border-amber-600"),t.classList.remove("text-gray-400","border-transparent"),n.classList.add("text-gray-400","border-transparent"),n.classList.remove("text-amber-600","border-amber-600"),r.classList.remove("hidden"),o.classList.add("hidden"),fetchRewardItemsForAkun()):e==="history"&&(n.classList.add("text-amber-600","border-amber-600"),n.classList.remove("text-gray-400","border-transparent"),t.classList.add("text-gray-400","border-transparent"),t.classList.remove("text-amber-600","border-amber-600"),o.classList.remove("hidden"),r.classList.add("hidden"),loadClaimsHistory())}async function loadClaimsHistory(){const e=getLoggedInUser();if(!e)return;const t=document.getElementById("claims-loading"),n=document.getElementById("claims-empty"),r=document.getElementById("claims-list");t.classList.remove("hidden"),n.classList.add("hidden"),r.innerHTML="";try{const o=CONFIG.getMainApiUrl(),a=phoneLookupVariants(e.whatsapp).map(i=>`phone=${encodeURIComponent(i)}`).join("&"),l=await fetch(`${o}?sheet=claims&${a}`);if(!l.ok)throw new Error("Failed to fetch claims");const d=parseSheetResponse(await l.json());if(t.classList.add("hidden"),!d||d.length===0){n.classList.remove("hidden");return}d.sort((i,c)=>{const m=new Date(i.tanggal||i.date||0);return new Date(c.tanggal||c.date||0)-m}),d.forEach(i=>{const c=createClaimCard(i);r.appendChild(c)})}catch(o){console.error("Error loading claims history:",o),t.classList.add("hidden"),n.classList.remove("hidden")}}function createClaimCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition";const n={pending:"bg-yellow-100 text-yellow-700",approved:"bg-green-100 text-green-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-red-100 text-red-700"},r=(e.status||"pending").toLowerCase(),o=n[r]||"bg-gray-100 text-gray-700",a={pending:"Menunggu",approved:"Disetujui",completed:"Selesai",rejected:"Ditolak"}[r]||e.status||"Menunggu",d=new Date(e.tanggal||e.date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return t.innerHTML=`
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <h5 class="font-bold text-gray-800">${escapeHtml(e.hadiah||e.reward||"Reward")}</h5>
                <p class="text-xs text-gray-500 mt-1">${d}</p>
            </div>
            <span class="${o} text-xs font-bold px-3 py-1 rounded-full">${escapeHtml(a)}</span>
        </div>
        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-gray-700">${e.poin||0} Poin</span>
            </div>
            ${e.id?`<span class="text-xs text-gray-400">#${escapeHtml(e.id)}</span>`:""}
        </div>
    `,t}function closeLoyaltyModal(){document.getElementById("loyalty-modal").classList.add("hidden"),switchRewardTab("exchange")}async function openRewardModal(){const e=getLoggedInUser();if(!e)return;await loadModalPoints();const t=document.getElementById("loyalty-modal-points"),n=t?parseInt(t.textContent||"0"):0;setRewardContextFromAkun(e.whatsapp,n,e.nama),document.getElementById("loyalty-modal").classList.remove("hidden"),switchRewardTab("exchange"),fetchRewardItemsForAkun()}async function loadModalPoints(){const e=getLoggedInUser();if(!e)return;const t=parseInt(e.total_points||e.points||e.poin||0,10)||0;try{const n=CONFIG.getMainApiUrl(),r=buildSessionQuery(e);if(r){const l=await fetch(`${n}?action=public_user_points${r}&_t=${Date.now()}`);if(l.ok){const d=await l.json();if(d&&d.success){document.getElementById("loyalty-modal-points").textContent=String(parseInt(d.points||0,10)||0);return}}}if(!hasPublicSession(e)){document.getElementById("loyalty-modal-points").textContent=String(t);return}const o=await fetch(`${n}?sheet=user_points`);if(!o.ok){document.getElementById("loyalty-modal-points").textContent=String(t);return}const s=await o.json();if(s&&typeof s=="object"&&String(s.error||"").toLowerCase()==="unauthorized"){console.warn("\u26A0\uFE0F Unauthorized access to user_points (modal). Falling back to user profile points."),document.getElementById("loyalty-modal-points").textContent=String(t);return}const a=Array.isArray(s)?s.filter(l=>normalizePhoneTo08(l.phone)===normalizePhoneTo08(e.whatsapp)):[];if(a&&a.length>0){const l=a[0],d=parseInt(l.points||l.poin||0);document.getElementById("loyalty-modal-points").textContent=d}else document.getElementById("loyalty-modal-points").textContent=String(t)}catch(n){console.error("Error loading modal points:",n),document.getElementById("loyalty-modal-points").textContent=String(t)}}var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});ensureImageFallbackHandler();function hideRewardLoaders(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchRewardItemsForAkun(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n.innerHTML="";try{const r=CONFIG.getMainApiUrl(),o=await fetch(`${r}?sheet=tukar_poin`);if(!o.ok)throw new Error("Failed to fetch reward items");const s=await o.json(),a=parseSheetResponse(s);renderRewardItemsListAkun(a)}catch(r){console.error("Error fetching reward items:",r),t&&t.classList.add("hidden"),n.innerHTML=`
            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">
                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>
            </div>
        `}finally{hideRewardLoaders()}}}function renderRewardItemsListAkun(e){const t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){if(!e||e.length===0){t&&t.classList.remove("hidden"),n.innerHTML="";return}t&&t.classList.add("hidden"),n.innerHTML=e.map(r=>{const o=escapeHtml((r.id||"").toString()),s=escapeHtml((r.nama||r.judul||"Hadiah").toString()),a=parseInt(r.poin||r.Poin||0),l=(r.gambar||"https://via.placeholder.com/80?text=Reward").toString(),d=sanitizeUrl(l,"https://via.placeholder.com/80?text=Reward"),i=escapeHtml((r.deskripsi||"").toString());return`
            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-amber-500 transition">
                <div class="flex gap-3 mb-3">
                    <!-- Left: Image -->
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${d}" alt="${s}" class="w-full h-full object-cover" data-fallback-src="https://via.placeholder.com/80?text=Reward">
                    </div>
                    
                    <!-- Middle: Title & Description -->
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 text-sm mb-1">${s}</p>
                        <p class="text-xs text-gray-500 line-clamp-2">${i}</p>
                    </div>
                    
                    <!-- Right: Badge -->
                    <div class="flex-shrink-0">
                        <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">${a} Poin</span>
                    </div>
                </div>
                
                <!-- Full-width Button -->
                <button class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg transition text-sm" onclick="handleTukarSekarangAkun('${o}')">
                    Tukar Sekarang
                </button>
            </div>
        `}).join("")}}function setRewardContextFromAkun(e,t,n){e&&(sessionStorage.setItem("reward_phone",e),console.log("\u2705 Reward context set - phone:",e)),t!=null&&(sessionStorage.setItem("user_points",t.toString()),console.log("\u2705 Reward context set - points:",t)),n&&(sessionStorage.setItem("reward_customer_name",n),console.log("\u2705 Reward context set - name:",n))}function handleTukarSekarangAkun(e){const t=getLoggedInUser();if(!t){showToast("Mohon login terlebih dahulu.");return}const n=document.getElementById("loyalty-points"),r=n?parseInt(n.textContent||"0"):0;setRewardContextFromAkun(t.whatsapp,r,t.nama),typeof showConfirmTukarModal=="function"?showConfirmTukarModal(e):typeof window.claimReward=="function"?window.claimReward(e):showToast("Fitur tukar poin akan segera hadir!")}function hideMobileBottomNavOnDashboard(){const e=document.getElementById("mobile-bottom-nav"),t=document.getElementById("dashboard-section");e&&t&&(t.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}document.addEventListener("DOMContentLoaded",function(){setTimeout(hideMobileBottomNavOnDashboard,100)});const originalShowDashboard=showDashboard;showDashboard=function(e){typeof originalShowDashboard=="function"&&originalShowDashboard(e),setTimeout(hideMobileBottomNavOnDashboard,100)};const originalShowLogin=showLogin;showLogin=function(){typeof originalShowLogin=="function"&&originalShowLogin();const e=document.getElementById("mobile-bottom-nav");e&&e.classList.remove("hidden")};
