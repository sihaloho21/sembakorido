const normalizePhoneTo08=e=>{const t=String(null==e?"":e).replace(/[^0-9]/g,"");if(!t)return"";let r=t;return r.startsWith("62")&&(r=r.slice(2)),r.startsWith("0")&&(r=r.slice(1)),r.startsWith("8")?"0"+r:""},phoneLookupVariants=e=>{const t=normalizePhoneTo08(e);if(!t)return[];const r=t.slice(1);return[t,`+62${r}`,`62${r}`,r]},displayPhone=e=>normalizePhoneTo08(e)||e||"",parseSheetResponse=e=>Array.isArray(e)?e:e&&Array.isArray(e.result)?e.result:e&&e.result?Array.isArray(e.result)?e.result:[e.result]:[],buildSessionQuery=e=>{const t=String(e&&e.session_token||"").trim();return t?`&session_token=${encodeURIComponent(t)}`:""},hasPublicSession=e=>""!==String(e&&e.session_token||"").trim(),SESSION_INVALID_MESSAGE="Session login tidak valid. Silakan login ulang.",NETWORK_ERROR_MESSAGE="Gagal memuat data. Periksa koneksi lalu coba lagi.",SECTION_UI_MAP={referral:{loadingId:"referral-loading",errorId:"referral-error",errorTextId:"referral-error-text",loginCtaId:"referral-login-cta",retryAction:"retry-referral"},paylater:{loadingId:"paylater-loading",errorId:"paylater-error",errorTextId:"paylater-error-text",loginCtaId:"paylater-login-cta",retryAction:"retry-paylater"},orders:{loadingId:"order-loading",errorId:"order-error",errorTextId:"order-error-text",loginCtaId:"orders-login-cta",retryAction:"retry-orders"},points:{loadingId:"points-loading",errorId:"points-error",errorTextId:"points-error-text",loginCtaId:"points-login-cta",retryAction:"retry-points"}};let lastPaylaterDetailInvoiceId="";function createAkunError(e,t){const r=new Error(e||"Unknown error");return r.code=String(t||"").toUpperCase(),r.isSessionError="UNAUTHORIZED_SESSION"===r.code,r}function setPointsStaleNotice(e){const t=document.getElementById("points-stale-note");t&&t.classList.toggle("hidden",!e)}function setSectionLoading(e,t){const r=SECTION_UI_MAP[e];if(!r||!r.loadingId)return;const n=document.getElementById(r.loadingId);n&&n.classList.toggle("hidden",!t)}function clearSectionError(e){const t=SECTION_UI_MAP[e];if(!t)return;const r=t.errorId?document.getElementById(t.errorId):null,n=t.errorTextId?document.getElementById(t.errorTextId):null,a=t.loginCtaId?document.getElementById(t.loginCtaId):null;r&&r.classList.add("hidden"),n&&(n.textContent=""),a&&a.classList.add("hidden")}function setSectionError(e,t,r){const n=SECTION_UI_MAP[e];if(!n)return;const a=n.errorId?document.getElementById(n.errorId):null,o=n.errorTextId?document.getElementById(n.errorTextId):null,i=n.loginCtaId?document.getElementById(n.loginCtaId):null,s=a?a.querySelector('[data-action^="retry-"]'):null,d=String(t||NETWORK_ERROR_MESSAGE);if(o&&(o.textContent=d),s&&s.setAttribute("data-action",r||n.retryAction),i){const e=-1!==d.indexOf(SESSION_INVALID_MESSAGE);i.classList.toggle("hidden",!e)}a&&a.classList.remove("hidden")}function isSessionError(e){if(!e||"object"!=typeof e)return!1;const t=String(e.error||e.error_code||"").toLowerCase(),r=String(e.message||"").toLowerCase();return"unauthorized_session"===t||"session_unavailable"===t||-1!==r.indexOf("session login tidak valid")}function parsePublicSuccess(e,t){if(e&&!0===e.success)return e;if(isSessionError(e))throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");throw createAkunError(String(e&&(e.message||e.error||e.error_code)||t||NETWORK_ERROR_MESSAGE).trim(),String(e&&(e.error||e.error_code)||"").toUpperCase())}function resolvePublicErrorMessage(e,t){if(!e)return t||NETWORK_ERROR_MESSAGE;const r=String(e.code||"").toUpperCase(),n=String(e.message||"").trim(),a=n.toLowerCase();return e.isSessionError||"UNAUTHORIZED_SESSION"===r||-1!==a.indexOf("session")?SESSION_INVALID_MESSAGE:-1!==a.indexOf("failed to fetch")||-1!==a.indexOf("network")||-1!==a.indexOf("rate limit")||-1!==a.indexOf("http ")||-1!==a.indexOf("timeout")?NETWORK_ERROR_MESSAGE:n||t||NETWORK_ERROR_MESSAGE}async function akunApiGet(e,t={}){if("undefined"==typeof ApiService||"function"!=typeof ApiService.get)throw createAkunError("ApiService belum tersedia.","API_SERVICE_UNAVAILABLE");return ApiService.get(e,{cache:!1,maxRetries:3,...t})}async function akunApiPost(e,t={}){if("undefined"==typeof ApiService||"function"!=typeof ApiService.post)throw createAkunError("ApiService belum tersedia.","API_SERVICE_UNAVAILABLE");return ApiService.post("",e,{cache:!1,maxRetries:2,...t})}let referralProfileCache=null,pendingReferralCodeFromUrl="",referralConfigCache={rewardReferrerPoints:20,rewardRefereePoints:10,minFirstOrder:5e4};function toReferralCodeValue(e){return String(e||"").trim().toUpperCase()}function getReferralCodeFromUrl(){try{const e=new URLSearchParams(window.location.search||"");return toReferralCodeValue(e.get("ref")||e.get("referral")||e.get("kode_referral")||"")}catch(e){return console.warn("Failed parsing referral code from URL:",e),""}}function buildReferralShareUrl(e){const t=toReferralCodeValue(e);if(!t||"-"===t)return"";const r=new URL(`${window.location.origin}${window.location.pathname}`);return r.searchParams.set("ref",t),r.toString()}function updateRegisterReferralInfo(){const e=document.getElementById("register-referral-info"),t=document.getElementById("register-referral-info-text");e&&t&&(pendingReferralCodeFromUrl?(t.textContent=`Referral dari link aktif: ${pendingReferralCodeFromUrl}`,e.classList.remove("hidden")):e.classList.add("hidden"))}function buildReferralShareMessage(e,t){const r=toReferralCodeValue(e);if(!r||"-"===r||!t)return"";const n=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,a=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,o=parseInt(referralConfigCache.minFirstOrder||0,10)||0;return["Halo, yuk daftar GoSembako pakai link referral saya.","",`Link: ${t}`,`Kode Referral: ${r}`,"",`Bonus pengguna baru: ${a} poin`,`Bonus pengajak: ${n} poin`,`Bonus aktif setelah pesanan pertama selesai (minimal ${o>0?formatCurrency(o):"sesuai ketentuan program"}).`,"","Terima kasih."].join("\n")}function updateReferralShareUI(e){const t=toReferralCodeValue(e&&e.kode_referral||referralProfileCache&&referralProfileCache.kode_referral||getLoggedInUser()&&getLoggedInUser().kode_referral||""),r=buildReferralShareUrl(t),n=document.getElementById("referral-code-display"),a=document.getElementById("referral-share-message"),o=document.getElementById("referral-reward-info");if(n&&(n.value=r||"-",n.dataset.referralCode=t||""),a&&(a.textContent=r?buildReferralShareMessage(t,r):"Link referral akan muncul setelah kode referral tersedia."),o){const e=parseInt(referralConfigCache.rewardReferrerPoints||0,10)||0,t=parseInt(referralConfigCache.rewardRefereePoints||0,10)||0,r=parseInt(referralConfigCache.minFirstOrder||0,10)||0;o.textContent=`Pengajak: ${e} poin, Pengguna baru: ${t} poin (setelah pesanan pertama selesai${r>0?`, minimal ${formatCurrency(r)}`:""}).`}}function getCurrentReferralCode(){const e=document.getElementById("referral-code-display"),t=toReferralCodeValue(e?.dataset?.referralCode||"");if(t)return t;return toReferralCodeValue(getLoggedInUser()?.kode_referral||"")}async function loadPublicReferralConfig(){try{const e=parsePublicSuccess(await akunApiGet("?action=public_referral_config",{cache:!0,cacheDuration:3e5}),"Gagal memuat konfigurasi referral.");referralConfigCache={rewardReferrerPoints:parseInt(e.reward_referrer_points||referralConfigCache.rewardReferrerPoints,10)||referralConfigCache.rewardReferrerPoints,rewardRefereePoints:parseInt(e.reward_referee_points||referralConfigCache.rewardRefereePoints,10)||referralConfigCache.rewardRefereePoints,minFirstOrder:parseInt(e.min_first_order||referralConfigCache.minFirstOrder,10)||referralConfigCache.minFirstOrder}}catch(e){console.warn("Failed to load public referral config:",e)}}function setReferralStatus(e,t){const r=document.getElementById("referral-status");r&&(r.textContent=e||"",r.className="text-xs","success"===t?r.classList.add("text-green-600"):"error"===t?r.classList.add("text-red-600"):"warning"===t?r.classList.add("text-amber-600"):r.classList.add("text-gray-500"))}function applyReferralDataToUI(e){const t=document.getElementById("referral-code-display"),r=document.getElementById("referral-input"),n=document.getElementById("apply-referral-btn"),a=document.getElementById("referral-count"),o=document.getElementById("referral-points-total");t&&(t.value="-"),a&&(a.textContent=String(parseInt(e.referral_count||0,10)||0)),o&&(o.textContent=String(parseInt(e.referral_points_total||0,10)||0));const i=""!==toReferralCodeValue(e.referred_by);r&&(r.value=i?toReferralCodeValue(e.referred_by):"",r.disabled=i),n&&(n.disabled=i),i?setReferralStatus(`Referral aktif dengan kode: ${toReferralCodeValue(e.referred_by)}`,"success"):setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info"),updateReferralShareUI(e)}function buildReferralProfileFallback(e){return{id:e&&e.id?e.id:"",nama:e&&e.nama?e.nama:"User",whatsapp:normalizePhoneTo08(e&&(e.whatsapp||e.phone)||""),kode_referral:toReferralCodeValue(e&&e.kode_referral?e.kode_referral:""),referred_by:toReferralCodeValue(e&&e.referred_by?e.referred_by:""),referral_count:parseInt(e&&e.referral_count||0,10)||0,referral_points_total:parseInt(e&&e.referral_points_total||0,10)||0}}function getReferralStatusBadge(e){const t=String(e||"").toLowerCase();return"approved"===t?'<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold">Approved</span>':"rejected"===t||"void"===t?'<span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold">Rejected</span>':'<span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">Pending</span>'}async function loadReferralHistory(e){const t=document.getElementById("referral-history-list"),r=document.getElementById("referral-history-badge");if(!t||!r)return;const n=buildSessionQuery(e);if(!n)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const a=parsePublicSuccess(await akunApiGet(`?action=public_referral_history${n}`),"Gagal memuat riwayat referral."),o=normalizePhoneTo08(e.whatsapp),i=(Array.isArray(a.referrals)?a.referrals:[]).filter(e=>{const t=normalizePhoneTo08(e.referrer_phone||""),r=normalizePhoneTo08(e.referee_phone||"");return t===o||r===o}).sort((e,t)=>new Date(t.created_at||0).getTime()-new Date(e.created_at||0).getTime()).slice(0,10);r.textContent=`${i.length} data`,0!==i.length?t.innerHTML=i.map(e=>{const t=normalizePhoneTo08(e.referrer_phone||"")===o?"Anda mengajak":"Anda diajak",r=normalizePhoneTo08("Anda mengajak"===t?e.referee_phone||"":e.referrer_phone||""),n="Anda mengajak"===t?parseInt(e.reward_referrer_points||0,10)||0:parseInt(e.reward_referee_points||0,10)||0;return`\n            <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">\n                <div class="flex items-center justify-between mb-1">\n                    <span class="font-bold text-gray-700">${escapeHtml(t)}</span>\n                    ${getReferralStatusBadge(e.status)}\n                </div>\n                <p class="text-gray-600">No: ${escapeHtml(r||"-")}</p>\n                <p class="text-green-700 font-semibold">Reward: ${escapeHtml(String(n))} poin</p>\n            </div>\n        `}).join(""):t.innerHTML='<p class="text-gray-400">Belum ada riwayat referral.</p>'}async function fetchPublicReferralProfile(e){const t=buildSessionQuery(e);if(!t)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");return parsePublicSuccess(await akunApiGet(`?action=public_user_profile${t}`),"Gagal memuat profil referral.").user||null}async function loadReferralData(e){clearSectionError("referral"),setSectionLoading("referral",!0);try{const t=await fetchPublicReferralProfile(e);if(!t)throw createAkunError("Profil referral tidak tersedia","REFERRAL_PROFILE_NOT_FOUND");referralProfileCache=t,applyReferralDataToUI(t),await loadReferralHistory({...e,session_token:String(e.session_token||t.session_token||"").trim()})}catch(t){console.error("Error loading referral data:",t),applyReferralDataToUI(buildReferralProfileFallback(e)),setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info");const r=document.getElementById("referral-history-list"),n=document.getElementById("referral-history-badge");n&&(n.textContent="error"),r&&(r.innerHTML='<p class="text-red-500">Gagal memuat riwayat referral.</p>'),setSectionError("referral",resolvePublicErrorMessage(t),"retry-referral")}finally{setSectionLoading("referral",!1)}}function showLogin(){document.getElementById("login-section").classList.remove("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showDashboard(e){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.remove("hidden"),document.getElementById("user-name").textContent=e.nama,document.getElementById("user-whatsapp").textContent=displayPhone(e.whatsapp),loadLoyaltyPoints(e),loadReferralData(e),loadPaylaterData(e),loadOrderHistory(e)}function retryReferralSection(){const e=getLoggedInUser();e?loadReferralData(e):showLogin()}function retryPaylaterSection(){const e=getLoggedInUser();e?loadPaylaterData(e):showLogin()}function retryOrdersSection(){const e=getLoggedInUser();e?loadOrderHistory(e):showLogin()}function retryPointsSection(){const e=getLoggedInUser();e?loadLoyaltyPoints(e):showLogin()}function mapPublicLoginError(e){const t=String(e&&(e.error||e.error_code)||"").toUpperCase();return"LOGIN_FAILED"===t?"Nomor WhatsApp atau PIN salah":"ACCOUNT_INACTIVE"===t?"Akun Anda tidak aktif. Hubungi admin.":"RATE_LIMITED"===t?String(e.message||"Terlalu banyak percobaan login, coba lagi."):"UNAUTHORIZED_SESSION"===t?SESSION_INVALID_MESSAGE:String(e&&e.message||"Login gagal. Silakan coba lagi.")}function showError(e){const t=document.getElementById("login-error");document.getElementById("login-error-text").textContent=e,t.classList.remove("hidden")}function resetLoginButton(){const e=document.getElementById("login-btn");e.disabled=!1,e.innerHTML='\n        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>\n        </svg>\n        Masuk\n    '}function saveLoggedInUser(e){const t=normalizePhoneTo08(e.whatsapp||e.phone||"");localStorage.setItem("gosembako_user",JSON.stringify({id:e.id,nama:e.nama,whatsapp:t||e.whatsapp,tanggal_daftar:e.tanggal_daftar,status:e.status||"",total_points:parseInt(e.total_points||e.points||e.poin||0,10)||0,kode_referral:toReferralCodeValue(e.kode_referral||""),referred_by:toReferralCodeValue(e.referred_by||""),referral_count:parseInt(e.referral_count||0,10)||0,referral_points_total:parseInt(e.referral_points_total||0,10)||0,session_token:String(e.session_token||"").trim()}))}function getLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;try{const t=JSON.parse(e);return t&&"object"==typeof t?(t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||"")||t.whatsapp||"",t.session_token=String(t.session_token||t.sessionToken||t.st||"").trim(),t):null}catch(e){return console.warn("Invalid gosembako_user payload:",e),null}}function logout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("gosembako_user"),window.location.reload())}async function copyReferralCode(){const e=getCurrentReferralCode();if(!e||"-"===e)return void setReferralStatus("Link referral belum tersedia.","warning");const t=buildReferralShareUrl(e);if(t)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t);else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}setReferralStatus("Link referral berhasil disalin.","success")}catch(e){console.error("Copy referral failed:",e),setReferralStatus("Gagal menyalin link referral.","error")}else setReferralStatus("Link referral tidak tersedia.","warning")}function shareReferralWhatsApp(){const e=getCurrentReferralCode(),t=buildReferralShareUrl(e);if(!t)return void setReferralStatus("Link referral belum tersedia.","warning");const r=buildReferralShareMessage(e,t),n=`https://wa.me/?text=${encodeURIComponent(r)}`;window.open(n,"_blank","noopener"),setReferralStatus("Link referral siap dibagikan ke WhatsApp.","success")}async function applyReferralCode(){const e=getLoggedInUser();if(!e)return void setReferralStatus("Silakan login ulang.","error");const t=document.getElementById("referral-input"),r=document.getElementById("apply-referral-btn"),n=toReferralCodeValue(t?t.value:"");if(!n)return void setReferralStatus("Masukkan kode referral terlebih dahulu.","warning");const a=getCurrentReferralCode();if(a&&n===a)return void setReferralStatus("Kode referral sendiri tidak bisa dipakai.","error");if(t&&t.disabled)return void setReferralStatus("Kode referral sudah pernah diterapkan.","warning");const o=r?r.textContent:"";try{r&&(r.disabled=!0,r.textContent="Memproses...");const a=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:normalizePhoneTo08(e.whatsapp),ref_code:n}});if(!a||!1===a.success){return setReferralStatus(a&&(a.message||a.error||a.error_code)||"Gagal menerapkan referral","error"),void(r&&(r.disabled=!1,r.textContent=o||"Terapkan"))}t&&(t.value=n,t.disabled=!0),r&&(r.disabled=!0,r.textContent="Terapkan"),setReferralStatus("Kode referral berhasil diterapkan.","success"),await loadReferralData(e)}catch(e){console.error("applyReferralCode error:",e),setReferralStatus(e.message||"Gagal menerapkan kode referral.","error"),r&&(r.disabled=!1,r.textContent=o||"Terapkan")}}async function loadLoyaltyPoints(e){const t=document.getElementById("loyalty-points");if(!t)return;const r=parseInt(e.total_points||e.points||e.poin||0,10)||0;clearSectionError("points"),setSectionLoading("points",!0),setPointsStaleNotice(!1);try{const r=buildSessionQuery(e);if(!r)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const n=parsePublicSuccess(await akunApiGet(`?action=public_user_points${r}`),"Gagal memuat poin loyalitas."),a=parseInt(n.points||0,10)||0;t.textContent=String(a),setRewardContextFromAkun(e.whatsapp,a,e.nama)}catch(n){console.error("Error loading loyalty points:",n),t.textContent=String(r),setRewardContextFromAkun(e.whatsapp,r,e.nama),setPointsStaleNotice(!0);setSectionError("points",`${resolvePublicErrorMessage(n)} data bisa tidak terbaru`,"retry-points")}finally{setSectionLoading("points",!1)}}function getPaylaterStatusBadgeClass(e){const t=String(e||"").toLowerCase().trim();return"active"===t?"bg-green-100 text-green-700":"frozen"===t?"bg-amber-100 text-amber-700":"locked"===t||"overdue"===t?"bg-red-100 text-red-700":"paid"===t?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}function renderPaylaterSummary(e){const t=e&&e.account||{},r=e&&e.summary||{},n=String(t.status||"inactive").toLowerCase().trim(),a=document.getElementById("paylater-account-status"),o=document.getElementById("paylater-credit-limit"),i=document.getElementById("paylater-available-limit"),s=document.getElementById("paylater-used-limit"),d=document.getElementById("paylater-invoice-total"),l=document.getElementById("paylater-invoice-active"),c=document.getElementById("paylater-invoice-overdue"),u=document.getElementById("paylater-remaining-open");a&&(a.textContent=n||"inactive",a.className=`text-xs font-bold px-2 py-1 rounded-full ${getPaylaterStatusBadgeClass(n)}`),o&&(o.textContent=formatCurrency(t.credit_limit||0)),i&&(i.textContent=formatCurrency(t.available_limit||0)),s&&(s.textContent=formatCurrency(t.used_limit||0)),d&&(d.textContent=String(parseInt(r.invoice_count_total||0,10)||0)),l&&(l.textContent=String(parseInt(r.invoice_count_active||0,10)||0)),c&&(c.textContent=String(parseInt(r.invoice_count_overdue||0,10)||0)),u&&(u.textContent=formatCurrency(r.remaining_open||0))}function renderPaylaterInvoices(e){const t=document.getElementById("paylater-invoice-list"),r=document.getElementById("paylater-history-badge");if(!t)return;const n=Array.isArray(e)?e:[];r&&(r.textContent=`${n.length} data`),n.length?t.innerHTML=n.slice(0,10).map(e=>{const t=String(e.invoice_id||e.id||"-"),r=String(e.status||"active").toLowerCase(),n=parseCurrencyValue(e.total_due||0),a=parseCurrencyValue(e.paid_amount||0),o=Math.max(0,n-a),i=formatDate(e.due_date||e.created_at||"");return`\n            <div class="rounded-xl border border-gray-200 p-3 bg-white">\n                <div class="flex items-center justify-between gap-2 mb-2">\n                    <p class="font-bold text-gray-800">${escapeHtml(t)}</p>\n                    <span class="text-[10px] font-bold px-2 py-1 rounded-full ${getPaylaterStatusBadgeClass(r)}">${escapeHtml(r)}</span>\n                </div>\n                <div class="grid grid-cols-2 gap-2 text-[11px] text-gray-600">\n                    <p>Total Due: <span class="font-bold text-gray-800">${escapeHtml(formatCurrency(n))}</span></p>\n                    <p>Sisa: <span class="font-bold text-red-600">${escapeHtml(formatCurrency(o))}</span></p>\n                    <p>Paid: <span class="font-bold text-green-700">${escapeHtml(formatCurrency(a))}</span></p>\n                    <p>Jatuh Tempo: <span class="font-bold text-gray-800">${escapeHtml(i)}</span></p>\n                </div>\n                <div class="mt-2">\n                    <button type="button" data-action="view-paylater-invoice" data-invoice-id="${escapeHtml(t)}" class="text-xs font-bold px-3 py-1.5 rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-700 transition">Lihat Detail</button>\n                </div>\n            </div>\n        `}).join(""):t.innerHTML='<p class="text-gray-400">Belum ada riwayat invoice.</p>'}function closePaylaterDetailModal(){const e=document.getElementById("paylater-detail-modal");e&&e.classList.add("hidden")}async function openPaylaterDetailModal(e){const t=getLoggedInUser();if(!t||!e)return;const r=document.getElementById("paylater-detail-modal"),n=document.getElementById("paylater-detail-content");if(r&&n){lastPaylaterDetailInvoiceId=String(e||"").trim(),r.classList.remove("hidden"),n.innerHTML='<p class="text-gray-500">Memuat detail tagihan...</p>';try{const r=buildSessionQuery(t);if(!r)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const a=parsePublicSuccess(await akunApiGet(`?action=public_paylater_invoice_detail&invoice_id=${encodeURIComponent(e)}${r}`),"Gagal memuat detail tagihan."),o=a.invoice||{},i=Array.isArray(a.ledger)?a.ledger:[],s=parseCurrencyValue(o.total_due||0),d=parseCurrencyValue(o.paid_amount||0),l=Math.max(0,s-d),c=String(o.status||"").toLowerCase().trim(),u=l>0&&!["paid","cancelled","defaulted"].includes(c),g=String(o.invoice_id||o.id||e||"-"),m=`https://wa.me/628993370200?text=${`KONFIRMASI PEMBAYARAN PAYLATER%0A%0AInvoice: ${encodeURIComponent(g)}%0ATotal Due: ${encodeURIComponent(formatCurrency(s))}%0ASudah Dibayar: ${encodeURIComponent(formatCurrency(d))}%0ASisa Tagihan: ${encodeURIComponent(formatCurrency(l))}%0AMohon verifikasi pembayaran saya.`}`,p=i.length?i.map(e=>`\n                    <div class="rounded-lg border border-gray-200 p-2">\n                        <p class="text-xs font-bold text-gray-700">${escapeHtml(String(e.type||"-"))}</p>\n                        <p class="text-xs text-gray-600">${escapeHtml(formatDate(e.created_at||""))}</p>\n                        <p class="text-xs text-gray-700">Amount: <span class="font-bold">${escapeHtml(formatCurrency(e.amount||0))}</span></p>\n                        <p class="text-xs text-gray-500">${escapeHtml(String(e.note||"-"))}</p>\n                    </div>\n                `).join(""):'<p class="text-xs text-gray-500">Belum ada ledger untuk invoice ini.</p>',f=u?`\n                <div class="pt-3 border-t border-gray-100">\n                    <button type="button" data-action="confirm-paylater-payment" data-wa-link="${escapeHtml(m)}" class="w-full bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 rounded-lg transition">\n                        Konfirmasi Bayar via WhatsApp\n                    </button>\n                </div>\n              `:"";n.innerHTML=`\n            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">\n                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">\n                    <p class="text-xs text-gray-500">Invoice ID</p>\n                    <p class="font-bold text-gray-800">${escapeHtml(String(o.invoice_id||o.id||"-"))}</p>\n                </div>\n                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">\n                    <p class="text-xs text-gray-500">Status</p>\n                    <p class="font-bold text-gray-800">${escapeHtml(String(o.status||"-"))}</p>\n                </div>\n                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">\n                    <p class="text-xs text-gray-500">Total Due</p>\n                    <p class="font-bold text-gray-800">${escapeHtml(formatCurrency(s))}</p>\n                </div>\n                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">\n                    <p class="text-xs text-gray-500">Sisa Tagihan</p>\n                    <p class="font-bold text-red-700">${escapeHtml(formatCurrency(l))}</p>\n                </div>\n                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">\n                    <p class="text-xs text-gray-500">Jatuh Tempo</p>\n                    <p class="font-bold text-gray-800">${escapeHtml(formatDate(o.due_date||"-"))}</p>\n                </div>\n                <div class="rounded-xl bg-gray-50 border border-gray-200 p-3">\n                    <p class="text-xs text-gray-500">Tenor</p>\n                    <p class="font-bold text-gray-800">${escapeHtml(String(o.tenor_weeks||"-"))} minggu</p>\n                </div>\n            </div>\n            <div class="pt-3 border-t border-gray-100">\n                <p class="text-sm font-bold text-gray-800 mb-2">Riwayat Ledger</p>\n                <div class="space-y-2">${p}</div>\n            </div>\n            ${f}\n        `}catch(e){console.error("Error load paylater detail:",e);const t=resolvePublicErrorMessage(e,"Gagal memuat detail tagihan."),r=t===SESSION_INVALID_MESSAGE;n.innerHTML=`\n            <div class="rounded-xl border border-red-200 bg-red-50 p-3">\n                <p class="text-red-700 text-sm font-semibold">${escapeHtml(t)}</p>\n                <div class="flex items-center gap-2 mt-3">\n                    <button type="button" data-action="retry-paylater-detail" class="px-3 py-1.5 rounded-lg bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition">\n                        Coba Lagi\n                    </button>\n                    ${r?'<button type="button" data-action="show-login" class="px-3 py-1.5 rounded-lg bg-white text-red-700 text-xs font-bold border border-red-200 hover:bg-red-100 transition">Login Ulang</button>':""}\n                </div>\n            </div>\n        `}}}async function loadPaylaterData(e){clearSectionError("paylater"),setSectionLoading("paylater",!0);try{const t=buildSessionQuery(e);if(!t)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const[r,n]=await Promise.all([akunApiGet(`?action=public_paylater_summary${t}`),akunApiGet(`?action=public_paylater_invoices${t}`)]),a=parsePublicSuccess(r,"Gagal memuat ringkasan PayLater."),o=parsePublicSuccess(n,"Gagal memuat daftar invoice PayLater.");renderPaylaterSummary(a),renderPaylaterInvoices(o.invoices||[])}catch(e){console.error("Error loading paylater data:",e),setSectionError("paylater",resolvePublicErrorMessage(e),"retry-paylater")}finally{setSectionLoading("paylater",!1)}}async function loadOrderHistory(e){document.getElementById("order-loading");const t=document.getElementById("order-empty"),r=document.getElementById("order-list"),n=document.getElementById("order-error"),a=document.getElementById("order-pagination"),o=document.getElementById("total-accepted-spend");clearSectionError("orders"),setSectionLoading("orders",!0),t&&t.classList.add("hidden"),n&&n.classList.add("hidden"),r&&(r.innerHTML=""),a&&(a.classList.add("hidden"),a.innerHTML=""),o&&(o.textContent="Rp 0");try{const r=buildSessionQuery(e);if(!r)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const n=parsePublicSuccess(await akunApiGet(`?action=public_user_orders${r}`),"Gagal memuat riwayat pesanan.");let a=Array.isArray(n.orders)?n.orders:[];if(setSectionLoading("orders",!1),!a||0===a.length)return void(t&&t.classList.remove("hidden"));if(a=a.filter(t=>normalizePhoneTo08(t.phone||t.whatsapp||"")===normalizePhoneTo08(e.whatsapp)),0===a.length)return void(t&&t.classList.remove("hidden"));if(a.sort((e,t)=>{const r=new Date(e.tanggal_pesanan||e.timestamp||0);return new Date(t.tanggal_pesanan||t.timestamp||0)-r}),window.allOrders=a,window.currentPage=1,window.ordersPerPage=10,o){const e=new Set(["terima","diterima","selesai"]),t=a.reduce((t,r)=>{const n=String(r.status||"").toLowerCase().trim();return e.has(n)?t+parseCurrencyValue(r.total||r.total_bayar||0):t},0);o.textContent=formatCurrency(t)}displayOrderPage(1)}catch(e){console.error("Error loading order history:",e),setSectionLoading("orders",!1),t&&t.classList.add("hidden"),r&&(r.innerHTML=""),a&&a.classList.add("hidden"),setSectionError("orders",resolvePublicErrorMessage(e),"retry-orders")}}function parseCurrencyValue(e){if("number"==typeof e)return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),r=parseFloat(t);return Number.isNaN(r)?0:r}function displayOrderPage(e){const t=document.getElementById("order-list"),r=document.getElementById("order-pagination");if(!window.allOrders||0===window.allOrders.length)return;const n=window.allOrders.length,a=Math.ceil(n/window.ordersPerPage),o=(e-1)*window.ordersPerPage,i=Math.min(o+window.ordersPerPage,n);t.innerHTML="";for(let e=o;e<i;e++){const r=createOrderCard(window.allOrders[e]);t.appendChild(r)}a>1?(r.classList.remove("hidden"),r.innerHTML=createPagination(e,a)):r.classList.add("hidden"),window.currentPage=e}function createPagination(e,t){let r='<div class="flex justify-center items-center gap-2 mt-6">';e>1&&(r+=`<button onclick="displayOrderPage(${e-1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">← Prev</button>`),r+='<div class="flex gap-1">';for(let n=1;n<=t;n++)n===e?r+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm">${n}</button>`:1===n||n===t||n>=e-1&&n<=e+1?r+=`<button onclick="displayOrderPage(${n})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm">${n}</button>`:n!==e-2&&n!==e+2||(r+='<span class="px-2 py-2 text-gray-500">...</span>');return r+="</div>",e<t&&(r+=`<button onclick="displayOrderPage(${e+1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">Next →</button>`),r+="</div>",r}function createOrderCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-3 hover:border-green-300 transition cursor-pointer";formatDate(e.tanggal_pesanan||e.timestamp);const r=formatCurrency(e.total||e.total_bayar||0),n=getStatusBadge(e.status||"Menunggu"),a=e.produk||e.items||e.product_name||"N/A",o=truncateText(a,20),i=e.id||"N/A";return t.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n            <div class="flex-1">\n                <p class="text-[10px] font-bold text-gray-700 mb-1">Order ID: <span class="text-green-600">${escapeHtml(i)}</span></p>\n            </div>\n            ${n}\n        </div>\n        \n        <div class="border-t border-gray-100 pt-2 space-y-1.5">\n            <div class="text-sm">\n                <p class="text-gray-600 text-xs mb-0.5">Produk:</p>\n                <p class="font-semibold text-gray-800 lg:hidden">${escapeHtml(o)}</p>\n                <p class="font-semibold text-gray-800 hidden lg:block">${escapeHtml(a)}</p>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Qty:</span>\n                <span class="font-semibold text-gray-800">${e.qty||e.quantity||e.jumlah||"N/A"}</span>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Poin:</span>\n                <span class="font-semibold text-amber-600">+${e.poin||e.points||0}</span>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Total Bayar:</span>\n                <span class="font-bold text-green-600">${r}</span>\n            </div>\n        </div>\n        \n        <div class="mt-3 pt-2 border-t border-gray-100">\n            <button onclick="window.location.href='index.html'" class="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-bold py-1.5 rounded-lg transition text-xs">\n                Belanja Lagi\n            </button>\n        </div>\n    `,t.addEventListener("click",t=>{"BUTTON"!==t.target.tagName&&"A"!==t.target.tagName&&showOrderDetailModal(e)}),t}function getStatusBadge(e){const t={Menunggu:{bg:"bg-yellow-100",text:"text-yellow-700",label:"Menunggu"},Diproses:{bg:"bg-blue-100",text:"text-blue-700",label:"Diproses"},Dikirim:{bg:"bg-purple-100",text:"text-purple-700",label:"Dikirim"},Diterima:{bg:"bg-green-100",text:"text-green-700",label:"Diterima"},Dibatalkan:{bg:"bg-red-100",text:"text-red-700",label:"Dibatalkan"}},r=t[normalizeStatus(e)]||t.Menunggu;return`<span class="${r.bg} ${r.text} text-xs font-bold px-3 py-1 rounded-full">${r.label}</span>`}function normalizeStatus(e){if(!e)return"Menunggu";return{menunggu:"Menunggu",pending:"Menunggu",diproses:"Diproses",proses:"Diproses",processing:"Diproses",dikirim:"Dikirim",kirim:"Dikirim",shipped:"Dikirim",diterima:"Diterima",terima:"Diterima",selesai:"Diterima",completed:"Diterima",dibatalkan:"Dibatalkan",batal:"Dibatalkan",cancelled:"Dibatalkan",canceled:"Dibatalkan"}[e.toLowerCase().trim()]||e}function formatDate(e){if(!e||"N/A"===e||""===e)return"N/A";let t;if("number"==typeof e)t=new Date(e);else if("string"==typeof e){let r=e.split(",")[0].trim();if(t=new Date(e),isNaN(t.getTime())&&r.includes("/")){const e=r.split("/");if(3===e.length){const r=parseInt(e[0]),n=parseInt(e[1]),a=parseInt(e[2]);r<=31&&n<=12&&a>1900&&(t=new Date(a,n-1,r))}}}else t=new Date(e);if(isNaN(t.getTime()))return"N/A";return t.toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"})}function truncateText(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":"N/A"}function formatCurrency(e){const t=parseInt(e)||0;return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t)}function showRegisterInfo(){alert("Untuk mendaftar, silakan hubungi admin GoSembako melalui WhatsApp.\n\nAnda akan diberikan akun dengan nomor WhatsApp dan PIN untuk login.")}function showRegister(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.remove("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden"),updateRegisterReferralInfo()}function showForgotPIN(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.remove("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function openEditProfile(){const e=getLoggedInUser();e&&(document.getElementById("edit-name").value=e.nama,document.getElementById("edit-old-pin").value="",document.getElementById("edit-new-pin").value="",document.getElementById("edit-confirm-pin").value="",document.getElementById("edit-error").classList.add("hidden"),document.getElementById("edit-profile-modal").classList.remove("hidden"))}function closeEditProfile(){document.getElementById("edit-profile-modal").classList.add("hidden")}function showOrderDetailModal(e){document.getElementById("tracking-order-id").textContent=e.id||"N/A";const t=e.tanggal||e.tanggal_pesanan||e.timestamp||e.date||e.created_at;document.getElementById("tracking-order-date").textContent=formatDate(t);const r=normalizeStatus(e.status||"Menunggu"),n=getStatusBadge(r),a=document.getElementById("tracking-status-badge");a&&(a.innerHTML=n),document.getElementById("tracking-products").textContent=e.produk||e.items||e.product_name||"N/A",document.getElementById("tracking-total").textContent=formatCurrency(e.total||e.total_bayar||0);const o=createAnimatedTimeline(r);document.getElementById("tracking-timeline").innerHTML=o,document.getElementById("order-tracking-modal").classList.remove("hidden")}function createAnimatedTimeline(e){const t=[{name:"Menunggu",gif:"wait.gif",key:"Menunggu"},{name:"Diproses",gif:"grocery-basket.gif",key:"Diproses"},{name:"Dikirim",gif:"grocery.gif",key:"Dikirim"},{name:"Diterima",gif:"shipping.gif",key:"Diterima"}];let r=t.findIndex(t=>t.key===e);return"Dibatalkan"===e?'\n            <div class="flex items-center justify-center gap-3 py-4">\n                <div class="bg-red-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">\n                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </div>\n                <div>\n                    <p class="font-bold text-red-600">Dibatalkan</p>\n                    <p class="text-xs text-gray-500">Pesanan telah dibatalkan</p>\n                </div>\n            </div>\n        ':(-1===r&&(r=0),`\n        <div class="flex items-center justify-between gap-2 py-2">\n            ${t.map((e,n)=>{const a=n<=r,o=n===r,i=n===t.length-1,s=`./assets/images/${e.gif}`;return`\n                    <div class="flex flex-col items-center flex-1">\n                        <div class="${a?"bg-green-50":"bg-gray-100"} w-12 h-12 rounded-full flex items-center justify-center ${o?"ring-2 ring-green-500 ring-offset-2":""}">\n                            <img src="${sanitizeUrl(s,"./assets/images/wait.gif")}" alt="${e.name}" class="w-8 h-8 object-contain ${a?"":"opacity-40"}" data-fallback-src="${s}">\n                        </div>\n                        <p class="text-[10px] font-semibold mt-2 text-center ${a?"text-gray-800":"text-gray-400"}">${e.name}</p>\n                        ${o?'<p class="text-[8px] text-green-600 font-bold mt-0.5">● Saat ini</p>':'<p class="text-[8px] text-transparent mt-0.5">●</p>'}\n                    </div>\n                    ${i?"":`\n                        <div class="flex-shrink-0 w-8 h-0.5 ${a&&n<r?"bg-green-500":"bg-gray-300"} transition-all duration-500 mb-6"></div>\n                    `}\n                `}).join("")}\n        </div>\n    `)}function closeOrderTracking(){document.getElementById("order-tracking-modal").classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{pendingReferralCodeFromUrl=getReferralCodeFromUrl(),updateRegisterReferralInfo(),loadPublicReferralConfig().then(()=>{referralProfileCache&&updateReferralShareUI(referralProfileCache)});const e=getLoggedInUser(),t=document.getElementById("referral-input");t&&t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),applyReferralCode())}),document.addEventListener("click",e=>{if(e.target.closest('[data-action="show-login"]'))return void showLogin();if(e.target.closest('[data-action="retry-paylater-detail"]'))return void(lastPaylaterDetailInvoiceId&&openPaylaterDetailModal(lastPaylaterDetailInvoiceId));const t=e.target.closest('[data-action="view-paylater-invoice"]');if(t)return void openPaylaterDetailModal(t.getAttribute("data-invoice-id"));const r=e.target.closest('[data-action="confirm-paylater-payment"]');if(r){const e=String(r.getAttribute("data-wa-link")||"").trim();e&&window.open(e,"_blank")}}),e?showDashboard(e):showLogin()}),document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-whatsapp").value.trim(),r=document.getElementById("login-pin").value.trim(),n=document.getElementById("login-btn"),a=document.getElementById("login-error");document.getElementById("login-error-text");if(!t||!r)return void showError("Mohon lengkapi semua field");const o=normalizePhoneTo08(t);if(o)if(o.length<10||o.length>13)showError("Panjang nomor tidak valid");else if(6===r.length){n.disabled=!0,n.innerHTML='\n        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n        </svg>\n        <span>Memproses...</span>\n    ',a.classList.add("hidden");try{const e=await akunApiGet(`?action=public_login&phone=${encodeURIComponent(o)}&pin=${encodeURIComponent(r)}`);if(!e||!0!==e.success||!e.user)return showError(mapPublicLoginError(e)),void resetLoginButton();const t=e.user;if(t.status&&"aktif"!==t.status.toLowerCase())return showError("Akun Anda tidak aktif. Hubungi admin."),void resetLoginButton();t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||o),saveLoggedInUser(t),showDashboard(t),document.getElementById("dashboard-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(e){console.error("Login error:",e),showError(resolvePublicErrorMessage(e,NETWORK_ERROR_MESSAGE)),resetLoginButton()}}else showError("PIN harus 6 digit");else showError("Gunakan format 08xxxxxxxxxx")}),document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-name").value.trim(),r=document.getElementById("register-whatsapp").value.trim(),n=document.getElementById("register-pin").value.trim(),a=document.getElementById("register-pin-confirm").value.trim(),o=pendingReferralCodeFromUrl,i=document.getElementById("register-error"),s=document.getElementById("register-error-text"),d=document.getElementById("register-success"),l=document.getElementById("register-btn");i.classList.add("hidden"),d.classList.add("hidden");const c=t.replace(/\s/g,"");if(c.length<4)return s.textContent="Masukkan Nama Lengkap",void i.classList.remove("hidden");const u=c.toLowerCase(),g=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const e of g)if(e.test(u))return s.textContent="Masukkan Nama Lengkap",void i.classList.remove("hidden");const m=normalizePhoneTo08(r);if(!m)return s.textContent="Gunakan format 08xxxxxxxxxx",void i.classList.remove("hidden");const p=m.replace(/[^0-9]/g,"");if(p.length<10||p.length>13)return s.textContent="Nomor WhatsApp tidak valid",void i.classList.remove("hidden");const f=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const e of f)if(e.test(p))return s.textContent="Nomor WhatsApp tidak valid",void i.classList.remove("hidden");if(6!==n.length||!/^\d{6}$/.test(n))return s.textContent="PIN harus 6 digit angka",void i.classList.remove("hidden");if(n!==a)return s.textContent="PIN tidak cocok",void i.classList.remove("hidden");l.disabled=!0,l.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const e=`USR-${Date.now().toString().slice(-6)}`,r=(new Date).toISOString().split("T")[0],a=(new Date).toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=await akunApiPost({action:"create",sheet:"users",data:{id:e,nama:t,whatsapp:m,pin:n,tanggal_daftar:r,status:"aktif",total_points:0,created_at:a,referred_by:"",referred_by_phone:"",referral_count:0,referral_points_total:0,kode_referral:""}});if(i&&i.error)throw createAkunError(String(i.message||i.error||"Gagal mendaftar"),String(i.error||""));if(!i||!0!==i.success||!i.created||i.created<1)throw new Error(String(i&&(i.message||i.error||i.error_code)||"Gagal mendaftar"));let s="";if(o)try{const e=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:m,ref_code:o}});s=e&&e.success?" Kode referral berhasil diterapkan.":" Akun dibuat, namun kode referral tidak valid."}catch(e){console.warn("Referral attach failed after registration:",e),s=" Akun dibuat, namun kode referral gagal diproses."}d.classList.remove("hidden");const l=d.querySelector("span");l&&(l.textContent="Pendaftaran berhasil! Silakan login."+s),document.getElementById("register-form").reset(),setTimeout(()=>{showLogin()},2e3)}catch(e){console.error("Registration error:",e);const t=String(e.code||e.message||"").toUpperCase();-1!==t.indexOf("DUPLICATE_PHONE")?s.textContent="Nomor WhatsApp sudah terdaftar":-1!==t.indexOf("RATE_LIMITED")?s.textContent="Terlalu banyak percobaan pendaftaran. Coba lagi sebentar.":s.textContent="Terjadi kesalahan. Silakan coba lagi.",i.classList.remove("hidden")}finally{l.disabled=!1,l.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar'}}),document.getElementById("forgot-pin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("forgot-whatsapp").value.trim(),r=document.getElementById("forgot-error"),n=document.getElementById("forgot-error-text"),a=document.getElementById("forgot-btn"),o=normalizePhoneTo08(t);if(!o)return r.classList.remove("hidden"),void(n.textContent="Gunakan format 08xxxxxxxxxx");r.classList.add("hidden"),a.disabled=!0,a.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{alert(`Untuk reset PIN, hubungi admin melalui WhatsApp terdaftar: ${o}.`);const e=o.replace(/^0/,"62");window.open(`https://wa.me/628993370200?text=Halo, saya ingin reset PIN akun saya. Nomor WhatsApp: ${e}`,"_blank"),setTimeout(()=>{showLogin()},1e3)}catch(e){console.error("Forgot PIN error:",e),n.textContent="Terjadi kesalahan. Silakan coba lagi.",r.classList.remove("hidden")}finally{a.disabled=!1,a.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi'}}),document.getElementById("edit-profile-form").addEventListener("submit",async e=>{e.preventDefault();const t=getLoggedInUser();if(!t)return;const r=document.getElementById("edit-name").value.trim(),n=document.getElementById("edit-old-pin").value.trim(),a=document.getElementById("edit-new-pin").value.trim(),o=document.getElementById("edit-confirm-pin").value.trim(),i=document.getElementById("edit-error"),s=document.getElementById("edit-error-text"),d=document.getElementById("edit-save-btn");i.classList.add("hidden");if(r.replace(/\s/g,"").length<4)return s.textContent="Masukkan Nama Lengkap",void i.classList.remove("hidden");if(n||a||o){if(!n||!a||!o)return s.textContent="Lengkapi semua field PIN",void i.classList.remove("hidden");if(6!==a.length||!/^\d{6}$/.test(a))return s.textContent="PIN baru harus 6 digit angka",void i.classList.remove("hidden");if(a!==o)return s.textContent="PIN baru tidak cocok",void i.classList.remove("hidden")}d.disabled=!0,d.textContent="Menyimpan...";try{const e=String(t.session_token||"").trim();if(!e)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const i=parsePublicSuccess(await akunApiPost({action:"public_update_profile",data:{session_token:e,nama:r,old_pin:n,new_pin:a,confirm_pin:o}}),"Gagal memperbarui profil."),s=i&&i.user?i.user:t;saveLoggedInUser(s),document.getElementById("user-name").textContent=s.nama||r,closeEditProfile(),alert("Profil berhasil diperbarui!")}catch(e){console.error("Edit profile error:",e);const t=String(e.code||e.message||"").toUpperCase();-1!==t.indexOf("OLD_PIN_INVALID")?s.textContent="PIN lama salah":-1!==t.indexOf("UNAUTHORIZED_SESSION")?s.textContent=SESSION_INVALID_MESSAGE:s.textContent="Terjadi kesalahan. Silakan coba lagi.",i.classList.remove("hidden")}finally{d.disabled=!1,d.textContent="Simpan"}});const originalCreateOrderCard=createOrderCard;function switchRewardTab(e){const t=document.getElementById("tab-exchange"),r=document.getElementById("tab-history"),n=document.getElementById("exchange-content"),a=document.getElementById("history-content");"exchange"===e?(t.classList.add("text-amber-600","border-amber-600"),t.classList.remove("text-gray-400","border-transparent"),r.classList.add("text-gray-400","border-transparent"),r.classList.remove("text-amber-600","border-amber-600"),n.classList.remove("hidden"),a.classList.add("hidden"),fetchRewardItemsForAkun()):"history"===e&&(r.classList.add("text-amber-600","border-amber-600"),r.classList.remove("text-gray-400","border-transparent"),t.classList.add("text-gray-400","border-transparent"),t.classList.remove("text-amber-600","border-amber-600"),a.classList.remove("hidden"),n.classList.add("hidden"),loadClaimsHistory())}async function loadClaimsHistory(){const e=getLoggedInUser();if(!e)return;const t=document.getElementById("claims-loading"),r=document.getElementById("claims-empty"),n=document.getElementById("claims-list");t.classList.remove("hidden"),r.classList.add("hidden"),n.innerHTML="";try{const a=buildSessionQuery(e);if(!a)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const o=parsePublicSuccess(await akunApiGet(`?action=public_claim_history${a}`),"Gagal memuat riwayat klaim."),i=Array.isArray(o.claims)?o.claims:[];if(t.classList.add("hidden"),!i||0===i.length)return void r.classList.remove("hidden");i.sort((e,t)=>{const r=new Date(e.tanggal||e.date||0);return new Date(t.tanggal||t.date||0)-r}),i.forEach(e=>{const t=createClaimCard(e);n.appendChild(t)})}catch(e){console.error("Error loading claims history:",e),t.classList.add("hidden"),r.classList.remove("hidden")}}function createClaimCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition";const r=(e.status||"pending").toLowerCase(),n={pending:"bg-yellow-100 text-yellow-700",approved:"bg-green-100 text-green-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-red-100 text-red-700"}[r]||"bg-gray-100 text-gray-700",a={pending:"Menunggu",approved:"Disetujui",completed:"Selesai",rejected:"Ditolak"}[r]||e.status||"Menunggu",o=new Date(e.tanggal||e.date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return t.innerHTML=`\n        <div class="flex justify-between items-start mb-3">\n            <div class="flex-1">\n                <h5 class="font-bold text-gray-800">${escapeHtml(e.hadiah||e.reward||"Reward")}</h5>\n                <p class="text-xs text-gray-500 mt-1">${o}</p>\n            </div>\n            <span class="${n} text-xs font-bold px-3 py-1 rounded-full">${escapeHtml(a)}</span>\n        </div>\n        <div class="flex items-center justify-between pt-3 border-t border-gray-100">\n            <div class="flex items-center gap-2">\n                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <span class="text-sm font-semibold text-gray-700">${e.poin||0} Poin</span>\n            </div>\n            ${e.id?`<span class="text-xs text-gray-400">#${escapeHtml(e.id)}</span>`:""}\n        </div>\n    `,t}function closeLoyaltyModal(){document.getElementById("loyalty-modal").classList.add("hidden"),switchRewardTab("exchange")}async function openRewardModal(){const e=getLoggedInUser();if(!e)return;await loadModalPoints();const t=document.getElementById("loyalty-modal-points"),r=t?parseInt(t.textContent||"0"):0;setRewardContextFromAkun(e.whatsapp,r,e.nama),document.getElementById("loyalty-modal").classList.remove("hidden"),switchRewardTab("exchange"),fetchRewardItemsForAkun()}async function loadModalPoints(){const e=getLoggedInUser();if(!e)return;const t=parseInt(e.total_points||e.points||e.poin||0,10)||0,r=document.getElementById("loyalty-modal-points");if(r)try{const n=buildSessionQuery(e);if(!n)return void(r.textContent=String(t));const a=parsePublicSuccess(await akunApiGet(`?action=public_user_points${n}`),"Gagal memuat poin.");r.textContent=String(parseInt(a.points||0,10)||0)}catch(e){console.error("Error loading modal points:",e),r.textContent=String(t)}}createOrderCard=function(e){const t=originalCreateOrderCard(e);return t.style.cursor="pointer",t.addEventListener("click",()=>{showOrderDetailModal(e)}),t};var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});function hideRewardLoaders(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchRewardItemsForAkun(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("reward-items-empty"),r=document.getElementById("reward-items-list");if(r){e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),r.innerHTML="";try{const e=getLoggedInUser(),t=buildSessionQuery(e);if(!t)throw createAkunError(SESSION_INVALID_MESSAGE,"UNAUTHORIZED_SESSION");const r=parsePublicSuccess(await akunApiGet(`?action=public_rewards_catalog${t}`),"Gagal memuat daftar hadiah.");renderRewardItemsListAkun(Array.isArray(r.rewards)?r.rewards:[])}catch(e){console.error("Error fetching reward items:",e),t&&t.classList.add("hidden"),r.innerHTML='\n            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">\n                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>\n            </div>\n        '}finally{hideRewardLoaders()}}}function renderRewardItemsListAkun(e){const t=document.getElementById("reward-items-empty"),r=document.getElementById("reward-items-list");if(r){if(!e||0===e.length)return t&&t.classList.remove("hidden"),void(r.innerHTML="");t&&t.classList.add("hidden"),r.innerHTML=e.map(e=>{const t=escapeHtml((e.id||"").toString()),r=escapeHtml((e.nama||e.judul||"Hadiah").toString()),n=parseInt(e.poin||e.Poin||0),a=(e.gambar||"https://via.placeholder.com/80?text=Reward").toString();return`\n            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-amber-500 transition">\n                <div class="flex gap-3 mb-3">\n                    \x3c!-- Left: Image --\x3e\n                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">\n                        <img src="${sanitizeUrl(a,"https://via.placeholder.com/80?text=Reward")}" alt="${r}" class="w-full h-full object-cover" data-fallback-src="https://via.placeholder.com/80?text=Reward">\n                    </div>\n                    \n                    \x3c!-- Middle: Title & Description --\x3e\n                    <div class="flex-1 min-w-0">\n                        <p class="font-bold text-gray-800 text-sm mb-1">${r}</p>\n                        <p class="text-xs text-gray-500 line-clamp-2">${escapeHtml((e.deskripsi||"").toString())}</p>\n                    </div>\n                    \n                    \x3c!-- Right: Badge --\x3e\n                    <div class="flex-shrink-0">\n                        <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">${n} Poin</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Full-width Button --\x3e\n                <button class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg transition text-sm" onclick="handleTukarSekarangAkun('${t}')">\n                    Tukar Sekarang\n                </button>\n            </div>\n        `}).join("")}}function setRewardContextFromAkun(e,t,r){e&&(sessionStorage.setItem("reward_phone",e),console.log("✅ Reward context set - phone:",e)),null!=t&&(sessionStorage.setItem("user_points",t.toString()),console.log("✅ Reward context set - points:",t)),r&&(sessionStorage.setItem("reward_customer_name",r),console.log("✅ Reward context set - name:",r))}function handleTukarSekarangAkun(e){const t=getLoggedInUser();if(!t)return void showToast("Mohon login terlebih dahulu.");const r=document.getElementById("loyalty-points"),n=r?parseInt(r.textContent||"0"):0;setRewardContextFromAkun(t.whatsapp,n,t.nama),"function"==typeof showConfirmTukarModal?showConfirmTukarModal(e):"function"==typeof window.claimReward?window.claimReward(e):showToast("Fitur tukar poin akan segera hadir!")}function hideMobileBottomNavOnDashboard(){const e=document.getElementById("mobile-bottom-nav"),t=document.getElementById("dashboard-section");e&&t&&(t.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}ensureImageFallbackHandler(),document.addEventListener("DOMContentLoaded",function(){setTimeout(hideMobileBottomNavOnDashboard,100)});const originalShowDashboard=showDashboard;showDashboard=function(e){"function"==typeof originalShowDashboard&&originalShowDashboard(e),setTimeout(hideMobileBottomNavOnDashboard,100)};const originalShowLogin=showLogin;showLogin=function(){"function"==typeof originalShowLogin&&originalShowLogin();const e=document.getElementById("mobile-bottom-nav");e&&e.classList.remove("hidden")};