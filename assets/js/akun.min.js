const normalizePhoneTo08=e=>{const t=String(null==e?"":e).replace(/[^0-9]/g,"");if(!t)return"";let n=t;return n.startsWith("62")&&(n=n.slice(2)),n.startsWith("0")&&(n=n.slice(1)),n.startsWith("8")?"0"+n:""},phoneLookupVariants=e=>{const t=normalizePhoneTo08(e);if(!t)return[];const n=t.slice(1);return[t,`+62${n}`,`62${n}`,n]},displayPhone=e=>normalizePhoneTo08(e)||e||"",parseSheetResponse=e=>Array.isArray(e)?e:e&&Array.isArray(e.result)?e.result:e&&e.result?Array.isArray(e.result)?e.result:[e.result]:[];let referralProfileCache=null;function toReferralCodeValue(e){return String(e||"").trim().toUpperCase()}function setReferralStatus(e,t){const n=document.getElementById("referral-status");n&&(n.textContent=e||"",n.className="text-xs","success"===t?n.classList.add("text-green-600"):"error"===t?n.classList.add("text-red-600"):"warning"===t?n.classList.add("text-amber-600"):n.classList.add("text-gray-500"))}function generateReferralCode(e,t,n){const a=String(e||"USER").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6)||"USER",r=normalizePhoneTo08(t).replace(/\D/g,"").slice(-4)||Math.floor(1e3+9e3*Math.random()).toString();let o=`${a}${r}`.slice(0,24);if(!n.has(o))return o;for(let e=1;e<=2e3;e+=1){const t=`${a}${r}${e}`.slice(0,24);if(!n.has(t))return t}return`${a}${Date.now().toString().slice(-6)}`.slice(0,24)}async function fetchUsersList(){const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=users&_t=${Date.now()}`);if(!t.ok)throw new Error("Gagal memuat data users");return parseSheetResponse(await t.json())}async function ensureUserReferralCode(e,t){const n=t.find(t=>String(t.id)===String(e.id))||t.find(t=>normalizePhoneTo08(t.whatsapp||t.phone||"")===normalizePhoneTo08(e.whatsapp));if(!n)throw new Error("User profil tidak ditemukan");const a=toReferralCodeValue(n.kode_referral);if(a)return{user:n,code:a};const r=new Set(t.map(e=>toReferralCodeValue(e.kode_referral)).filter(Boolean)),o=generateReferralCode(n.nama,n.whatsapp||n.phone,r);return await GASActions.update("users",n.id,{kode_referral:o}),n.kode_referral=o,{user:n,code:o}}function applyReferralDataToUI(e){const t=document.getElementById("referral-code-display"),n=document.getElementById("referral-input"),a=document.getElementById("apply-referral-btn"),r=document.getElementById("referral-count"),o=document.getElementById("referral-points-total");t&&(t.value=toReferralCodeValue(e.kode_referral)||"-"),r&&(r.textContent=String(parseInt(e.referral_count||0,10)||0)),o&&(o.textContent=String(parseInt(e.referral_points_total||0,10)||0));const s=""!==toReferralCodeValue(e.referred_by);n&&(n.value=s?toReferralCodeValue(e.referred_by):"",n.disabled=s),a&&(a.disabled=s),s?setReferralStatus(`Referral aktif dengan kode: ${toReferralCodeValue(e.referred_by)}`,"success"):setReferralStatus("Kode referral hanya bisa dipakai satu kali.","info")}async function loadReferralData(e){try{const t=await fetchUsersList(),n=await ensureUserReferralCode(e,t);referralProfileCache=n.user,applyReferralDataToUI(n.user)}catch(e){console.error("Error loading referral data:",e),setReferralStatus("Gagal memuat data referral. Coba refresh halaman.","error")}}function showLogin(){document.getElementById("login-section").classList.remove("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showDashboard(e){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.remove("hidden"),document.getElementById("user-name").textContent=e.nama,document.getElementById("user-whatsapp").textContent=displayPhone(e.whatsapp),loadLoyaltyPoints(e),loadReferralData(e),loadOrderHistory(e)}function showError(e){const t=document.getElementById("login-error");document.getElementById("login-error-text").textContent=e,t.classList.remove("hidden")}function resetLoginButton(){const e=document.getElementById("login-btn");e.disabled=!1,e.innerHTML='\n        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>\n        </svg>\n        Masuk\n    '}function saveLoggedInUser(e){const t=normalizePhoneTo08(e.whatsapp||e.phone||"");localStorage.setItem("gosembako_user",JSON.stringify({id:e.id,nama:e.nama,whatsapp:t||e.whatsapp,tanggal_daftar:e.tanggal_daftar}))}function getLoggedInUser(){const e=localStorage.getItem("gosembako_user");if(!e)return null;const t=JSON.parse(e);return t.whatsapp=normalizePhoneTo08(t.whatsapp||t.phone||"")||t.whatsapp,t}function logout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("gosembako_user"),window.location.reload())}async function copyReferralCode(){const e=document.getElementById("referral-code-display"),t=toReferralCodeValue(e?e.value:"");if(t&&"-"!==t)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t);else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}setReferralStatus("Kode referral berhasil disalin.","success")}catch(e){console.error("Copy referral failed:",e),setReferralStatus("Gagal menyalin kode referral.","error")}else setReferralStatus("Kode referral belum tersedia.","warning")}async function applyReferralCode(){const e=getLoggedInUser();if(!e)return void setReferralStatus("Silakan login ulang.","error");const t=document.getElementById("referral-input"),n=document.getElementById("apply-referral-btn"),a=toReferralCodeValue(t?t.value:"");if(!a)return void setReferralStatus("Masukkan kode referral terlebih dahulu.","warning");const r=toReferralCodeValue(document.getElementById("referral-code-display")?.value);if(r&&a===r)return void setReferralStatus("Kode referral sendiri tidak bisa dipakai.","error");if(t&&t.disabled)return void setReferralStatus("Kode referral sudah pernah diterapkan.","warning");const o=n?n.textContent:"";try{n&&(n.disabled=!0,n.textContent="Memproses...");const r=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:normalizePhoneTo08(e.whatsapp),ref_code:a}});if(!r||!1===r.success){return setReferralStatus(r&&(r.message||r.error||r.error_code)||"Gagal menerapkan referral","error"),void(n&&(n.disabled=!1,n.textContent=o||"Terapkan"))}t&&(t.value=a,t.disabled=!0),n&&(n.disabled=!0,n.textContent="Terapkan"),setReferralStatus("Kode referral berhasil diterapkan.","success"),await loadReferralData(e)}catch(e){console.error("applyReferralCode error:",e),setReferralStatus(e.message||"Gagal menerapkan kode referral.","error"),n&&(n.disabled=!1,n.textContent=o||"Terapkan")}}async function loadLoyaltyPoints(e){try{const t=CONFIG.getMainApiUrl(),n=normalizePhoneTo08(e.whatsapp);if(!n)return console.warn("‚ö†Ô∏è Invalid phone number for loyalty points lookup"),void(document.getElementById("loyalty-points").textContent="0");console.log(`üîç Loading loyalty points for phone: ${n}`);const a=await fetch(`${t}?sheet=user_points`);if(!a.ok)return console.error("‚ùå Failed to fetch loyalty points"),void(document.getElementById("loyalty-points").textContent="0");const r=await a.json();console.log("üì• Points data received:",r);let o=Array.isArray(r)?r:r.result||[];if(!Array.isArray(o))return console.warn("‚ö†Ô∏è Unexpected points data format"),void(document.getElementById("loyalty-points").textContent="0");const s=phoneLookupVariants(n);let i=null;for(const e of s)if(i=o.find(t=>normalizePhoneTo08(t.phone||t.whatsapp||"")===normalizePhoneTo08(e)),i){console.log(`‚úÖ Found points record for ${e}:`,i);break}if(i){const t=parseInt(i.points||i.poin||0);console.log(`‚úÖ User points: ${t}`),document.getElementById("loyalty-points").textContent=t,setRewardContextFromAkun(e.whatsapp,t,e.nama)}else console.log("‚ö†Ô∏è No points record found for user"),document.getElementById("loyalty-points").textContent="0",setRewardContextFromAkun(e.whatsapp,0,e.nama)}catch(e){console.error("‚ùå Error loading loyalty points:",e),document.getElementById("loyalty-points").textContent="0"}}async function loadOrderHistory(e){const t=document.getElementById("order-loading"),n=document.getElementById("order-empty"),a=document.getElementById("order-list"),r=document.getElementById("total-accepted-spend");t.classList.remove("hidden"),n.classList.add("hidden"),a.innerHTML="",r&&(r.textContent="Rp 0");try{const a=CONFIG.getMainApiUrl();let o=await fetch(`${a}?sheet=orders`);if(!o.ok)throw new Error("Gagal memuat riwayat pesanan");let s=await o.json(),i=Array.isArray(s)?s.filter(t=>normalizePhoneTo08(t.phone)===normalizePhoneTo08(e.whatsapp)):[];if(t.classList.add("hidden"),!i||0===i.length)return void n.classList.remove("hidden");if(i=i.filter(t=>normalizePhoneTo08(t.phone||t.whatsapp||"")===normalizePhoneTo08(e.whatsapp)),0===i.length)return void n.classList.remove("hidden");if(i.sort((e,t)=>{const n=new Date(e.tanggal_pesanan||e.timestamp||0);return new Date(t.tanggal_pesanan||t.timestamp||0)-n}),window.allOrders=i,window.currentPage=1,window.ordersPerPage=10,r){const e=new Set(["terima","diterima","selesai"]),t=i.reduce((t,n)=>{const a=String(n.status||"").toLowerCase().trim();return e.has(a)?t+parseCurrencyValue(n.total||n.total_bayar||0):t},0);r.textContent=formatCurrency(t)}displayOrderPage(1)}catch(e){console.error("Error loading order history:",e),t.classList.add("hidden"),a.innerHTML='\n            <div class="text-center py-8 text-red-600">\n                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <p class="text-sm">Gagal memuat riwayat pesanan</p>\n                <button onclick="location.reload()" class="mt-3 text-green-600 hover:underline text-sm font-bold">Coba Lagi</button>\n            </div>\n        '}}function parseCurrencyValue(e){if("number"==typeof e)return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),n=parseFloat(t);return Number.isNaN(n)?0:n}function displayOrderPage(e){const t=document.getElementById("order-list"),n=document.getElementById("order-pagination");if(!window.allOrders||0===window.allOrders.length)return;const a=window.allOrders.length,r=Math.ceil(a/window.ordersPerPage),o=(e-1)*window.ordersPerPage,s=Math.min(o+window.ordersPerPage,a);t.innerHTML="";for(let e=o;e<s;e++){const n=createOrderCard(window.allOrders[e]);t.appendChild(n)}r>1?(n.classList.remove("hidden"),n.innerHTML=createPagination(e,r)):n.classList.add("hidden"),window.currentPage=e}function createPagination(e,t){let n='<div class="flex justify-center items-center gap-2 mt-6">';e>1&&(n+=`<button onclick="displayOrderPage(${e-1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">‚Üê Prev</button>`),n+='<div class="flex gap-1">';for(let a=1;a<=t;a++)a===e?n+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm">${a}</button>`:1===a||a===t||a>=e-1&&a<=e+1?n+=`<button onclick="displayOrderPage(${a})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm">${a}</button>`:a!==e-2&&a!==e+2||(n+='<span class="px-2 py-2 text-gray-500">...</span>');return n+="</div>",e<t&&(n+=`<button onclick="displayOrderPage(${e+1})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-sm">Next ‚Üí</button>`),n+="</div>",n}function createOrderCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-3 hover:border-green-300 transition cursor-pointer";formatDate(e.tanggal_pesanan||e.timestamp);const n=formatCurrency(e.total||e.total_bayar||0),a=getStatusBadge(e.status||"Menunggu"),r=e.produk||e.items||e.product_name||"N/A",o=truncateText(r,20),s=e.id||"N/A";return t.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n            <div class="flex-1">\n                <p class="text-[10px] font-bold text-gray-700 mb-1">Order ID: <span class="text-green-600">${escapeHtml(s)}</span></p>\n            </div>\n            ${a}\n        </div>\n        \n        <div class="border-t border-gray-100 pt-2 space-y-1.5">\n            <div class="text-sm">\n                <p class="text-gray-600 text-xs mb-0.5">Produk:</p>\n                <p class="font-semibold text-gray-800 lg:hidden">${escapeHtml(o)}</p>\n                <p class="font-semibold text-gray-800 hidden lg:block">${escapeHtml(r)}</p>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Qty:</span>\n                <span class="font-semibold text-gray-800">${e.qty||e.quantity||e.jumlah||"N/A"}</span>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Poin:</span>\n                <span class="font-semibold text-amber-600">+${e.poin||e.points||0}</span>\n            </div>\n            <div class="flex justify-between text-xs">\n                <span class="text-gray-600">Total Bayar:</span>\n                <span class="font-bold text-green-600">${n}</span>\n            </div>\n        </div>\n        \n        <div class="mt-3 pt-2 border-t border-gray-100">\n            <button onclick="window.location.href='index.html'" class="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-bold py-1.5 rounded-lg transition text-xs">\n                Belanja Lagi\n            </button>\n        </div>\n    `,t.addEventListener("click",t=>{"BUTTON"!==t.target.tagName&&"A"!==t.target.tagName&&showOrderDetailModal(e)}),t}function getStatusBadge(e){const t={Menunggu:{bg:"bg-yellow-100",text:"text-yellow-700",label:"Menunggu"},Diproses:{bg:"bg-blue-100",text:"text-blue-700",label:"Diproses"},Dikirim:{bg:"bg-purple-100",text:"text-purple-700",label:"Dikirim"},Diterima:{bg:"bg-green-100",text:"text-green-700",label:"Diterima"},Dibatalkan:{bg:"bg-red-100",text:"text-red-700",label:"Dibatalkan"}},n=t[normalizeStatus(e)]||t.Menunggu;return`<span class="${n.bg} ${n.text} text-xs font-bold px-3 py-1 rounded-full">${n.label}</span>`}function normalizeStatus(e){if(!e)return"Menunggu";return{menunggu:"Menunggu",pending:"Menunggu",diproses:"Diproses",proses:"Diproses",processing:"Diproses",dikirim:"Dikirim",kirim:"Dikirim",shipped:"Dikirim",diterima:"Diterima",terima:"Diterima",selesai:"Diterima",completed:"Diterima",dibatalkan:"Dibatalkan",batal:"Dibatalkan",cancelled:"Dibatalkan",canceled:"Dibatalkan"}[e.toLowerCase().trim()]||e}function formatDate(e){if(!e||"N/A"===e||""===e)return"N/A";let t;if("number"==typeof e)t=new Date(e);else if("string"==typeof e){let n=e.split(",")[0].trim();if(t=new Date(e),isNaN(t.getTime())&&n.includes("/")){const e=n.split("/");if(3===e.length){const n=parseInt(e[0]),a=parseInt(e[1]),r=parseInt(e[2]);n<=31&&a<=12&&r>1900&&(t=new Date(r,a-1,n))}}}else t=new Date(e);if(isNaN(t.getTime()))return"N/A";return t.toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"})}function truncateText(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":"N/A"}function formatCurrency(e){const t=parseInt(e)||0;return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t)}function showRegisterInfo(){alert("Untuk mendaftar, silakan hubungi admin GoSembako melalui WhatsApp.\n\nAnda akan diberikan akun dengan nomor WhatsApp dan PIN untuk login.")}function showRegister(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.remove("hidden"),document.getElementById("forgot-pin-section").classList.add("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function showForgotPIN(){document.getElementById("login-section").classList.add("hidden"),document.getElementById("register-section").classList.add("hidden"),document.getElementById("forgot-pin-section").classList.remove("hidden"),document.getElementById("dashboard-section").classList.add("hidden")}function openEditProfile(){const e=getLoggedInUser();e&&(document.getElementById("edit-name").value=e.nama,document.getElementById("edit-old-pin").value="",document.getElementById("edit-new-pin").value="",document.getElementById("edit-confirm-pin").value="",document.getElementById("edit-error").classList.add("hidden"),document.getElementById("edit-profile-modal").classList.remove("hidden"))}function closeEditProfile(){document.getElementById("edit-profile-modal").classList.add("hidden")}function showOrderDetailModal(e){document.getElementById("tracking-order-id").textContent=e.id||"N/A";const t=e.tanggal||e.tanggal_pesanan||e.timestamp||e.date||e.created_at;document.getElementById("tracking-order-date").textContent=formatDate(t);const n=normalizeStatus(e.status||"Menunggu"),a=getStatusBadge(n),r=document.getElementById("tracking-status-badge");r&&(r.innerHTML=a),document.getElementById("tracking-products").textContent=e.produk||e.items||e.product_name||"N/A",document.getElementById("tracking-total").textContent=formatCurrency(e.total||e.total_bayar||0);const o=createAnimatedTimeline(n);document.getElementById("tracking-timeline").innerHTML=o,document.getElementById("order-tracking-modal").classList.remove("hidden")}function createAnimatedTimeline(e){const t=[{name:"Menunggu",gif:"wait.gif",key:"Menunggu"},{name:"Diproses",gif:"grocery-basket.gif",key:"Diproses"},{name:"Dikirim",gif:"grocery.gif",key:"Dikirim"},{name:"Diterima",gif:"shipping.gif",key:"Diterima"}];let n=t.findIndex(t=>t.key===e);return"Dibatalkan"===e?'\n            <div class="flex items-center justify-center gap-3 py-4">\n                <div class="bg-red-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">\n                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </div>\n                <div>\n                    <p class="font-bold text-red-600">Dibatalkan</p>\n                    <p class="text-xs text-gray-500">Pesanan telah dibatalkan</p>\n                </div>\n            </div>\n        ':(-1===n&&(n=0),`\n        <div class="flex items-center justify-between gap-2 py-2">\n            ${t.map((e,a)=>{const r=a<=n,o=a===n,s=a===t.length-1,i=`./assets/images/${e.gif}`;return`\n                    <div class="flex flex-col items-center flex-1">\n                        <div class="${r?"bg-green-50":"bg-gray-100"} w-12 h-12 rounded-full flex items-center justify-center ${o?"ring-2 ring-green-500 ring-offset-2":""}">\n                            <img src="${sanitizeUrl(i,"./assets/images/wait.gif")}" alt="${e.name}" class="w-8 h-8 object-contain ${r?"":"opacity-40"}" data-fallback-src="${i}">\n                        </div>\n                        <p class="text-[10px] font-semibold mt-2 text-center ${r?"text-gray-800":"text-gray-400"}">${e.name}</p>\n                        ${o?'<p class="text-[8px] text-green-600 font-bold mt-0.5">‚óè Saat ini</p>':'<p class="text-[8px] text-transparent mt-0.5">‚óè</p>'}\n                    </div>\n                    ${s?"":`\n                        <div class="flex-shrink-0 w-8 h-0.5 ${r&&a<n?"bg-green-500":"bg-gray-300"} transition-all duration-500 mb-6"></div>\n                    `}\n                `}).join("")}\n        </div>\n    `)}function closeOrderTracking(){document.getElementById("order-tracking-modal").classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{const e=getLoggedInUser(),t=document.getElementById("referral-input");t&&t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),applyReferralCode())}),e?showDashboard(e):showLogin()}),document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-whatsapp").value.trim(),n=document.getElementById("login-pin").value.trim(),a=document.getElementById("login-btn"),r=document.getElementById("login-error");document.getElementById("login-error-text");if(!t||!n)return void showError("Mohon lengkapi semua field");const o=normalizePhoneTo08(t);if(o)if(o.length<10||o.length>13)showError("Panjang nomor tidak valid");else if(6===n.length){a.disabled=!0,a.innerHTML='\n        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n        </svg>\n        <span>Memproses...</span>\n    ',r.classList.add("hidden");try{const e=CONFIG.getMainApiUrl(),t="&_t="+Date.now(),a=phoneLookupVariants(o);let r=null;const s=await fetch(`${e}?sheet=users${t}`);if(!s.ok)return showError("Gagal menghubungi server. Silakan coba lagi."),void resetLoginButton();const i=await s.json(),d=parseSheetResponse(i);for(const e of a){const t=d.find(t=>normalizePhoneTo08(t.whatsapp||t.phone||"")===normalizePhoneTo08(e));if(t){r=t;break}}if(!r)return showError("Nomor WhatsApp tidak terdaftar"),void resetLoginButton();if((r.pin||"").toString()!==n)return showError("PIN salah. Silakan coba lagi."),void resetLoginButton();if(r.status&&"aktif"!==r.status.toLowerCase())return showError("Akun Anda tidak aktif. Hubungi admin."),void resetLoginButton();r.whatsapp=normalizePhoneTo08(r.whatsapp||r.phone||o),saveLoggedInUser(r),showDashboard(r),document.getElementById("dashboard-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(e){console.error("Login error:",e),showError("Terjadi kesalahan. Silakan coba lagi."),resetLoginButton()}}else showError("PIN harus 6 digit");else showError("Gunakan format 08xxxxxxxxxx")}),document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-name").value.trim(),n=document.getElementById("register-whatsapp").value.trim(),a=document.getElementById("register-pin").value.trim(),r=document.getElementById("register-pin-confirm").value.trim(),o=toReferralCodeValue(document.getElementById("register-referral-code")?.value||""),s=document.getElementById("register-error"),i=document.getElementById("register-error-text"),d=document.getElementById("register-success"),l=document.getElementById("register-btn");s.classList.add("hidden"),d.classList.add("hidden");const c=t.replace(/\s/g,"");if(c.length<4)return i.textContent="Masukkan Nama Lengkap",void s.classList.remove("hidden");const m=c.toLowerCase(),u=[/^(.)\1{3,}$/,/^(.{2})\1{2,}$/,/^(.{3})\1{2,}$/,/^([a-z])([a-z])\1\2{2,}$/];for(const e of u)if(e.test(m))return i.textContent="Masukkan Nama Lengkap",void s.classList.remove("hidden");const g=normalizePhoneTo08(n);if(!g)return i.textContent="Gunakan format 08xxxxxxxxxx",void s.classList.remove("hidden");const p=g.replace(/[^0-9]/g,"");if(p.length<10||p.length>13)return i.textContent="Nomor WhatsApp tidak valid",void s.classList.remove("hidden");const h=[/^(\d)\1{9,}$/,/^08(\d)\1{8,}$/,/^(\d{2})\1{4,}$/,/^(\d{3})\1{3,}$/];for(const e of h)if(e.test(p))return i.textContent="Nomor WhatsApp tidak valid",void s.classList.remove("hidden");if(6!==a.length||!/^\d{6}$/.test(a))return i.textContent="PIN harus 6 digit angka",void s.classList.remove("hidden");if(a!==r)return i.textContent="PIN tidak cocok",void s.classList.remove("hidden");l.disabled=!0,l.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const e=CONFIG.getMainApiUrl(),r=phoneLookupVariants(g);let c=[];const m="&_t="+Date.now();console.log("üîç Checking phone formats:",r);try{const t=await fetch(`${e}?sheet=users${m}`);if(t.ok){const e=await t.json();c=parseSheetResponse(e).filter(e=>{const t=normalizePhoneTo08(e.whatsapp||e.phone||"");return r.some(e=>normalizePhoneTo08(e)===t)}),c&&c.length>0&&console.log("üìä Found existing user:",c)}else console.warn(`API error: ${t.status}`)}catch(e){console.warn("Check failed:",e.message)}if(console.log("üìä Final check result for",n,":",c),c&&c.length>0)return i.textContent="Nomor WhatsApp sudah terdaftar",s.classList.remove("hidden"),l.disabled=!1,void(l.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar');const u=`USR-${Date.now().toString().slice(-6)}`,p=(new Date).toISOString().split("T")[0],h=(new Date).toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),f=await GASActions.create("users",{id:u,nama:t,whatsapp:g,pin:a,tanggal_daftar:p,status:"aktif",total_points:0,created_at:h,referred_by:"",referred_by_phone:"",referral_count:0,referral_points_total:0,kode_referral:""});if(!f.created||f.created<1)throw new Error("Gagal mendaftar");let y="";if(o)try{const e=await GASActions.post({action:"attach_referral",sheet:"users",data:{referee_phone:g,ref_code:o}});y=e&&e.success?" Kode referral berhasil diterapkan.":" Akun dibuat, namun kode referral tidak valid."}catch(e){console.warn("Referral attach failed after registration:",e),y=" Akun dibuat, namun kode referral gagal diproses."}d.classList.remove("hidden");const w=d.querySelector("span");w&&(w.textContent="Pendaftaran berhasil! Silakan login."+y),document.getElementById("register-form").reset(),setTimeout(()=>{showLogin()},2e3)}catch(e){console.error("Registration error:",e),i.textContent="Terjadi kesalahan. Silakan coba lagi.",s.classList.remove("hidden")}finally{l.disabled=!1,l.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Daftar'}}),document.getElementById("forgot-pin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("forgot-whatsapp").value.trim(),n=document.getElementById("forgot-error"),a=document.getElementById("forgot-error-text"),r=document.getElementById("forgot-btn"),o=normalizePhoneTo08(t);if(!o)return n.classList.remove("hidden"),void(a.textContent="Gunakan format 08xxxxxxxxxx");n.classList.add("hidden"),r.disabled=!0,r.innerHTML='<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=users`),s=parseSheetResponse(await t.json()).filter(e=>normalizePhoneTo08(e.whatsapp||e.phone||"")===o);if(!s||0===s.length)return a.textContent="Nomor WhatsApp tidak terdaftar",n.classList.remove("hidden"),r.disabled=!1,void(r.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi');alert(`Kode verifikasi telah dikirim ke WhatsApp ${o}.\n\nUntuk sementara, hubungi admin untuk reset PIN.`);const i=o.replace(/^0/,"62");window.open(`https://wa.me/628993370200?text=Halo, saya ingin reset PIN akun saya. Nomor WhatsApp: ${i}`,"_blank"),setTimeout(()=>{showLogin()},1e3)}catch(e){console.error("Forgot PIN error:",e),a.textContent="Terjadi kesalahan. Silakan coba lagi.",n.classList.remove("hidden")}finally{r.disabled=!1,r.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Kirim Kode Verifikasi'}}),document.getElementById("edit-profile-form").addEventListener("submit",async e=>{e.preventDefault();const t=getLoggedInUser();if(!t)return;const n=document.getElementById("edit-name").value.trim(),a=document.getElementById("edit-old-pin").value.trim(),r=document.getElementById("edit-new-pin").value.trim(),o=document.getElementById("edit-confirm-pin").value.trim(),s=document.getElementById("edit-error"),i=document.getElementById("edit-error-text"),d=document.getElementById("edit-save-btn");s.classList.add("hidden");if(n.replace(/\s/g,"").length<4)return i.textContent="Masukkan Nama Lengkap",void s.classList.remove("hidden");if(a||r||o){if(!a||!r||!o)return i.textContent="Lengkapi semua field PIN",void s.classList.remove("hidden");if(6!==r.length||!/^\d{6}$/.test(r))return i.textContent="PIN baru harus 6 digit angka",void s.classList.remove("hidden");if(r!==o)return i.textContent="PIN baru tidak cocok",void s.classList.remove("hidden")}d.disabled=!0,d.textContent="Menyimpan...";try{const e=CONFIG.getMainApiUrl(),o=await fetch(`${e}?sheet=users&id=${t.id}`),l=await o.json();if(!l||0===l.length)throw new Error("User not found");const c=l[0];if(a&&c.pin!==a)return i.textContent="PIN lama salah",s.classList.remove("hidden"),d.disabled=!1,void(d.textContent="Simpan");const m={nama:n};r&&(m.pin=r);const u=await GASActions.update("users",t.id,m);if(!u.affected||u.affected<1)throw new Error("Failed to update");t.nama=n,saveLoggedInUser(t),document.getElementById("user-name").textContent=n,closeEditProfile(),alert("Profil berhasil diperbarui!")}catch(e){console.error("Edit profile error:",e),i.textContent="Terjadi kesalahan. Silakan coba lagi.",s.classList.remove("hidden")}finally{d.disabled=!1,d.textContent="Simpan"}});const originalCreateOrderCard=createOrderCard;function switchRewardTab(e){const t=document.getElementById("tab-exchange"),n=document.getElementById("tab-history"),a=document.getElementById("exchange-content"),r=document.getElementById("history-content");"exchange"===e?(t.classList.add("text-amber-600","border-amber-600"),t.classList.remove("text-gray-400","border-transparent"),n.classList.add("text-gray-400","border-transparent"),n.classList.remove("text-amber-600","border-amber-600"),a.classList.remove("hidden"),r.classList.add("hidden"),fetchRewardItemsForAkun()):"history"===e&&(n.classList.add("text-amber-600","border-amber-600"),n.classList.remove("text-gray-400","border-transparent"),t.classList.add("text-gray-400","border-transparent"),t.classList.remove("text-amber-600","border-amber-600"),r.classList.remove("hidden"),a.classList.add("hidden"),loadClaimsHistory())}async function loadClaimsHistory(){const e=getLoggedInUser();if(!e)return;const t=document.getElementById("claims-loading"),n=document.getElementById("claims-empty"),a=document.getElementById("claims-list");t.classList.remove("hidden"),n.classList.add("hidden"),a.innerHTML="";try{const r=CONFIG.getMainApiUrl(),o=phoneLookupVariants(e.whatsapp).map(e=>`phone=${encodeURIComponent(e)}`).join("&"),s=await fetch(`${r}?sheet=claims&${o}`);if(!s.ok)throw new Error("Failed to fetch claims");const i=parseSheetResponse(await s.json());if(t.classList.add("hidden"),!i||0===i.length)return void n.classList.remove("hidden");i.sort((e,t)=>{const n=new Date(e.tanggal||e.date||0);return new Date(t.tanggal||t.date||0)-n}),i.forEach(e=>{const t=createClaimCard(e);a.appendChild(t)})}catch(e){console.error("Error loading claims history:",e),t.classList.add("hidden"),n.classList.remove("hidden")}}function createClaimCard(e){const t=document.createElement("div");t.className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition";const n=(e.status||"pending").toLowerCase(),a={pending:"bg-yellow-100 text-yellow-700",approved:"bg-green-100 text-green-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-red-100 text-red-700"}[n]||"bg-gray-100 text-gray-700",r={pending:"Menunggu",approved:"Disetujui",completed:"Selesai",rejected:"Ditolak"}[n]||e.status||"Menunggu",o=new Date(e.tanggal||e.date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return t.innerHTML=`\n        <div class="flex justify-between items-start mb-3">\n            <div class="flex-1">\n                <h5 class="font-bold text-gray-800">${escapeHtml(e.hadiah||e.reward||"Reward")}</h5>\n                <p class="text-xs text-gray-500 mt-1">${o}</p>\n            </div>\n            <span class="${a} text-xs font-bold px-3 py-1 rounded-full">${escapeHtml(r)}</span>\n        </div>\n        <div class="flex items-center justify-between pt-3 border-t border-gray-100">\n            <div class="flex items-center gap-2">\n                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <span class="text-sm font-semibold text-gray-700">${e.poin||0} Poin</span>\n            </div>\n            ${e.id?`<span class="text-xs text-gray-400">#${escapeHtml(e.id)}</span>`:""}\n        </div>\n    `,t}function closeLoyaltyModal(){document.getElementById("loyalty-modal").classList.add("hidden"),switchRewardTab("exchange")}async function openRewardModal(){const e=getLoggedInUser();if(!e)return;await loadModalPoints();const t=document.getElementById("loyalty-modal-points"),n=t?parseInt(t.textContent||"0"):0;setRewardContextFromAkun(e.whatsapp,n,e.nama),document.getElementById("loyalty-modal").classList.remove("hidden"),switchRewardTab("exchange"),fetchRewardItemsForAkun()}async function loadModalPoints(){const e=getLoggedInUser();if(e)try{const t=CONFIG.getMainApiUrl(),n=await fetch(`${t}?sheet=user_points`);if(!n.ok)return void(document.getElementById("loyalty-modal-points").textContent="0");const a=await n.json(),r=Array.isArray(a)?a.filter(t=>normalizePhoneTo08(t.phone)===normalizePhoneTo08(e.whatsapp)):[];if(r&&r.length>0){const e=r[0],t=parseInt(e.points||e.poin||0);document.getElementById("loyalty-modal-points").textContent=t}else document.getElementById("loyalty-modal-points").textContent="0"}catch(e){console.error("Error loading modal points:",e),document.getElementById("loyalty-modal-points").textContent="0"}}createOrderCard=function(e){const t=originalCreateOrderCard(e);return t.style.cursor="pointer",t.addEventListener("click",()=>{showOrderDetailModal(e)}),t};var escapeHtml=window.FrontendSanitize&&window.FrontendSanitize.escapeHtml||(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}),sanitizeUrl=window.FrontendSanitize&&window.FrontendSanitize.sanitizeUrl||(e=>String(e||"")),ensureImageFallbackHandler=window.FrontendSanitize&&window.FrontendSanitize.ensureImageFallbackHandler||(()=>{});function hideRewardLoaders(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("rewards-loading");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}async function fetchRewardItemsForAkun(){const e=document.getElementById("reward-items-loading"),t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n.innerHTML="";try{const e=CONFIG.getMainApiUrl(),t=await fetch(`${e}?sheet=tukar_poin`);if(!t.ok)throw new Error("Failed to fetch reward items");const n=await t.json();renderRewardItemsListAkun(parseSheetResponse(n))}catch(e){console.error("Error fetching reward items:",e),t&&t.classList.add("hidden"),n.innerHTML='\n            <div class="text-center py-6 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">\n                <p class="text-xs text-red-600 font-semibold">Gagal memuat hadiah. Silakan coba lagi nanti.</p>\n            </div>\n        '}finally{hideRewardLoaders()}}}function renderRewardItemsListAkun(e){const t=document.getElementById("reward-items-empty"),n=document.getElementById("reward-items-list");if(n){if(!e||0===e.length)return t&&t.classList.remove("hidden"),void(n.innerHTML="");t&&t.classList.add("hidden"),n.innerHTML=e.map(e=>{const t=escapeHtml((e.id||"").toString()),n=escapeHtml((e.nama||e.judul||"Hadiah").toString()),a=parseInt(e.poin||e.Poin||0),r=(e.gambar||"https://via.placeholder.com/80?text=Reward").toString();return`\n            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-amber-500 transition">\n                <div class="flex gap-3 mb-3">\n                    \x3c!-- Left: Image --\x3e\n                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">\n                        <img src="${sanitizeUrl(r,"https://via.placeholder.com/80?text=Reward")}" alt="${n}" class="w-full h-full object-cover" data-fallback-src="https://via.placeholder.com/80?text=Reward">\n                    </div>\n                    \n                    \x3c!-- Middle: Title & Description --\x3e\n                    <div class="flex-1 min-w-0">\n                        <p class="font-bold text-gray-800 text-sm mb-1">${n}</p>\n                        <p class="text-xs text-gray-500 line-clamp-2">${escapeHtml((e.deskripsi||"").toString())}</p>\n                    </div>\n                    \n                    \x3c!-- Right: Badge --\x3e\n                    <div class="flex-shrink-0">\n                        <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">${a} Poin</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Full-width Button --\x3e\n                <button class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg transition text-sm" onclick="handleTukarSekarangAkun('${t}')">\n                    Tukar Sekarang\n                </button>\n            </div>\n        `}).join("")}}function setRewardContextFromAkun(e,t,n){e&&(sessionStorage.setItem("reward_phone",e),console.log("‚úÖ Reward context set - phone:",e)),null!=t&&(sessionStorage.setItem("user_points",t.toString()),console.log("‚úÖ Reward context set - points:",t)),n&&(sessionStorage.setItem("reward_customer_name",n),console.log("‚úÖ Reward context set - name:",n))}function handleTukarSekarangAkun(e){const t=getLoggedInUser();if(!t)return void showToast("Mohon login terlebih dahulu.");const n=document.getElementById("loyalty-points"),a=n?parseInt(n.textContent||"0"):0;setRewardContextFromAkun(t.whatsapp,a,t.nama),"function"==typeof showConfirmTukarModal?showConfirmTukarModal(e):"function"==typeof window.claimReward?window.claimReward(e):showToast("Fitur tukar poin akan segera hadir!")}function hideMobileBottomNavOnDashboard(){const e=document.getElementById("mobile-bottom-nav"),t=document.getElementById("dashboard-section");e&&t&&(t.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}ensureImageFallbackHandler(),document.addEventListener("DOMContentLoaded",function(){setTimeout(hideMobileBottomNavOnDashboard,100)});const originalShowDashboard=showDashboard;showDashboard=function(e){"function"==typeof originalShowDashboard&&originalShowDashboard(e),setTimeout(hideMobileBottomNavOnDashboard,100)};const originalShowLoginSection=showLoginSection;showLoginSection=function(){"function"==typeof originalShowLoginSection&&originalShowLoginSection();const e=document.getElementById("mobile-bottom-nav");e&&e.classList.remove("hidden")};