const ApiService={cache:new Map,pendingRequests:new Map,DEFAULT_CACHE_DURATION:3e5,MAX_RETRIES:3,INITIAL_RETRY_DELAY:1e3,clearCache(){this.cache.clear(),this.pendingRequests.clear(),console.log("üßπ [ApiService] Cache cleared successfully")},clearCacheForEndpoint(e){const t=`${CONFIG.getMainApiUrl()}${e}`,s=this._generateCacheKey(t,{});this.cache.delete(s),console.log("üßπ [ApiService] Cache cleared for endpoint:",e)},async fetch(e,t={}){const s=`${CONFIG.getMainApiUrl()}${e}`,i=this._generateCacheKey(s,t),c=!1!==t.cache;if(c&&this.cache.has(i)){const s=this.cache.get(i),c=t.cacheDuration||this.DEFAULT_CACHE_DURATION;if(Date.now()-s.timestamp<c)return console.log("üì¶ [ApiService] Using cached data:",e),s.data;console.log("‚è∞ [ApiService] Cache expired:",e),this.cache.delete(i)}if(this.pendingRequests.has(i))return console.log("‚è≥ [ApiService] Waiting for pending request:",e),this.pendingRequests.get(i);const a=this._fetchWithRetry(s,t);this.pendingRequests.set(i,a);try{const t=await a;return c&&(this.cache.set(i,{data:t,timestamp:Date.now()}),console.log("üíæ [ApiService] Data cached:",e)),t}catch(t){throw console.error("‚ùå [ApiService] Request failed:",e,t),t}finally{this.pendingRequests.delete(i)}},async _fetchWithRetry(e,t){const s=t.maxRetries||this.MAX_RETRIES;let i;for(let c=0;c<s;c++)try{console.log(`üåê [ApiService] Request attempt ${c+1}/${s}:`,e);const i=await fetch(e,{method:t.method||"GET",mode:"cors",headers:t.headers||{},body:t.body});if(429===i.status){if(c<s-1){const e=this._calculateBackoff(c);console.warn(`‚è±Ô∏è [ApiService] Rate limited (429), retrying in ${e}ms...`),await this._sleep(e);continue}throw new Error("Rate limit exceeded. Please try again later.")}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const a=await i.json();return console.log("‚úÖ [ApiService] Request successful:",e),a}catch(e){if(i=e,c<s-1&&this._isRetryableError(e)){const t=this._calculateBackoff(c);console.warn(`üîÑ [ApiService] Retry ${c+1}/${s} after ${t}ms:`,e.message),await this._sleep(t);continue}break}throw i},_calculateBackoff(e){return this.INITIAL_RETRY_DELAY*Math.pow(2,e)},_isRetryableError:e=>e.message.includes("fetch")||e.message.includes("network")||e.message.includes("timeout"),_sleep:e=>new Promise(t=>setTimeout(t,e)),_generateCacheKey:(e,t)=>`${t.method||"GET"}:${e}:${t.body||""}`,getCacheStats(){const e={totalEntries:this.cache.size,pendingRequests:this.pendingRequests.size,entries:[]};for(const[t,s]of this.cache.entries()){const i=Date.now()-s.timestamp;e.entries.push({key:t,age:Math.round(i/1e3),size:JSON.stringify(s.data).length})}return e},async post(e,t,s={}){const i=new FormData;return i.append("json",JSON.stringify(t)),this.fetch(e,{...s,method:"POST",body:i,cache:!1})},async patch(e,t,s={}){return console.warn("‚ö†Ô∏è ApiService.patch() is deprecated. Use GASActions.update() instead."),this.fetch(e,{...s,method:"PATCH",headers:{"Content-Type":"application/json",...s.headers},body:JSON.stringify(t),cache:!1})},async get(e,t={}){return this.fetch(e,{...t,method:"GET"})}};window.ApiService=ApiService;