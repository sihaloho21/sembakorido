class BundleCarousel{constructor(){this.bundles=[],this.currentIndex=0,this.autoRotateInterval=null,this.isTransitioning=!1,this.init()}async init(){await this.fetchBundles(),this.bundles.length>0&&(this.render(),this.setupEventListeners(),this.startAutoRotate())}async fetchBundles(){try{const t=await fetch(CONFIG.getMainApiUrl()),e=await t.json();this.bundles=e.filter(t=>t.kategori&&t.kategori.toLowerCase().includes("paket")).map(t=>{const e=parseInt(t.harga_cash||t.harga||0),n=parseInt(t.harga_gajian||t.hargaGajian||0),s=n>0?n:"function"==typeof calculateGajianPrice?calculateGajianPrice(e).price:e;return{...t,harga:e,hargaGajian:s,hargaCoret:parseInt(t.harga_coret||t.hargaCoret||0),stok:parseInt(t.stok_tersedia||t.stok||0),gambar:t.gambar||"https://placehold.co/300x200?text=Produk"}}),console.log(`✅ Loaded ${this.bundles.length} bundle packages`)}catch(t){console.error("❌ Error fetching bundles:",t),this.bundles=[]}}render(){const t=document.getElementById("bundle-carousel-container");t&&0!==this.bundles.length?(t.style.display="block",t.innerHTML=`\n            <div class="bundle-carousel-wrapper">\n                <button class="carousel-nav carousel-prev" id="carousel-prev" aria-label="Previous">\n                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>\n                    </svg>\n                </button>\n                \n                <div class="carousel-track-container">\n                    <div class="carousel-track" id="carousel-track">\n                        ${this.bundles.map((t,e)=>this.renderProductCard(t,e)).join("")}\n                    </div>\n                </div>\n                \n                <button class="carousel-nav carousel-next" id="carousel-next" aria-label="Next">\n                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>\n                    </svg>\n                </button>\n            </div>\n            \n            <div class="carousel-dots" id="carousel-dots">\n                ${this.bundles.map((t,e)=>`\n                    <button class="carousel-dot ${0===e?"active":""}" data-index="${e}" aria-label="Go to slide ${e+1}"></button>\n                `).join("")}\n            </div>\n        `,this.updateCarousel()):t&&(t.style.display="none")}renderProductCard(t,e){let n="";n=t.stok>5?'<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Tersedia</span>':t.stok>0?`<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Terbatas (${t.stok})</span>`:'<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Stok Habis</span>',JSON.stringify(t).replace(/'/g,"\\'").replace(/"/g,"&quot;");const s=(t.gambar?t.gambar.split(","):[])[0]||"https://placehold.co/300x200?text=Produk",a="function"==typeof calculateRewardPoints?calculateRewardPoints(t.harga,t.nama):0;let o="";if(t.hargaCoret>t.harga){const e=Math.round((t.hargaCoret-t.harga)/t.hargaCoret*100);o=`\n                <div class="flex items-center gap-1 mb-0.5">\n                    <span class="text-[10px] text-gray-400 line-through">Rp ${t.hargaCoret.toLocaleString("id-ID")}</span>\n                    <span class="bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded font-bold">-${e}%</span>\n                </div>\n            `}const r=t.variations&&t.variations.length>0;return`\n            <div class="carousel-slide" data-index="${e}">\n                <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300 relative h-full">\n                    <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">\n                        <div class="bg-amber-400 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1">\n                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>\n                            +${a} Poin\n                        </div>\n                    </div>\n                    <img src="${s}" alt="${t.nama}" onclick='bundleCarousel.openProductDetail(${e})' class="w-full h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity ${0===t.stok?"grayscale opacity-60":""}" onerror="this.src='https://placehold.co/300x200?text=Produk'">\n                    <div class="p-6">\n                        <div class="flex justify-between items-start mb-2">\n                            <h4 class="text-lg font-bold text-gray-800">${t.nama}</h4>\n                            ${n}\n                        </div>\n                        <div class="flex justify-between items-center mb-4">\n                            <button onclick="shareProduct('${t.nama}')" class="text-green-600 hover:text-green-700 flex items-center gap-1 text-xs font-medium">\n                                <span>Share</span>\n                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n                            </button>\n                        </div>\n                        <div class="grid grid-cols-2 gap-4 mb-6">\n                            <div class="bg-green-50 p-3 rounded-lg">\n                                <p class="text-[10px] text-green-600 font-bold uppercase">Harga Cash</p>\n                                <div class="flex flex-col">\n                                    ${o}\n                                    <p class="text-lg font-bold text-green-700">Rp ${t.harga.toLocaleString("id-ID")}</p>\n                                </div>\n                            </div>\n                            <div class="bg-blue-50 p-3 rounded-lg">\n                                <p class="text-[10px] text-blue-600 font-bold uppercase">Bayar Gajian</p>\n                                <div class="flex flex-col">\n                                    <p class="text-[8px] text-blue-400 mb-0.5">Harga Per Tgl ${(new Date).toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}</p>\n                                    <p class="text-lg font-bold text-blue-700">Rp ${t.hargaGajian.toLocaleString("id-ID")}</p>\n                                </div>\n                            </div>\n                        </div>\n                        ${r?`\n                        <button onclick='bundleCarousel.openProductDetail(${e}); event.stopPropagation();' class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 mb-3">\n                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>\n                            Pilih Variasi\n                        </button>\n                        `:`\n                        <button onclick='bundleCarousel.addProductToCart(${e}, event)' ${0===t.stok?"disabled":""} class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 mb-3">\n                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>\n                            Tambah ke Keranjang\n                        </button>\n                        `}\n                        <div class="grid grid-cols-2 gap-2">\n                            <button onclick='bundleCarousel.openProductDetail(${e}); event.stopPropagation();' class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 rounded-lg text-sm transition">Rincian</button>\n                            <button onclick='bundleCarousel.directOrderProduct(${e}); event.stopPropagation();' ${0===t.stok?"disabled":""} class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 rounded-lg text-sm transition">Beli Sekarang</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}setupEventListeners(){const t=document.getElementById("carousel-prev"),e=document.getElementById("carousel-next"),n=document.querySelectorAll(".carousel-dot");t&&t.addEventListener("click",()=>this.prev()),e&&e.addEventListener("click",()=>this.next()),n.forEach(t=>{t.addEventListener("click",t=>{const e=parseInt(t.target.dataset.index);this.goToSlide(e)})});const s=document.getElementById("carousel-track");if(s){let t=0,e=0,n=!1;s.addEventListener("touchstart",e=>{t=e.touches[0].clientX,n=!0,this.stopAutoRotate()}),s.addEventListener("touchmove",t=>{n&&(e=t.touches[0].clientX)}),s.addEventListener("touchend",()=>{if(!n)return;n=!1;const s=t-e;Math.abs(s)>50&&(s>0?this.next():this.prev()),this.startAutoRotate()})}}updateCarousel(){const t=document.getElementById("carousel-track"),e=document.querySelectorAll(".carousel-dot"),n=document.getElementById("carousel-prev"),s=document.getElementById("carousel-next");if(!t)return;const a=window.innerWidth<768,o=a?1:2,r=a?90:45,i=-this.currentIndex*r+5;t.style.transform=`translateX(${i}%)`,e.forEach((t,e)=>{t.classList.toggle("active",e===this.currentIndex)}),n&&s&&(n.style.opacity=0===this.currentIndex?"0.5":"1",s.style.opacity=this.currentIndex>=this.bundles.length-o?"0.5":"1")}next(){if(this.isTransitioning)return;const t=window.innerWidth<768?1:2,e=this.bundles.length-t;this.currentIndex>=e?this.currentIndex=0:this.currentIndex++,this.isTransitioning=!0,this.updateCarousel(),setTimeout(()=>{this.isTransitioning=!1},500)}prev(){if(this.isTransitioning)return;const t=window.innerWidth<768?1:2,e=this.bundles.length-t;this.currentIndex<=0?this.currentIndex=e:this.currentIndex--,this.isTransitioning=!0,this.updateCarousel(),setTimeout(()=>{this.isTransitioning=!1},500)}goToSlide(t){this.isTransitioning||(this.currentIndex=t,this.isTransitioning=!0,this.updateCarousel(),setTimeout(()=>{this.isTransitioning=!1},500),this.stopAutoRotate(),this.startAutoRotate())}startAutoRotate(){this.stopAutoRotate(),this.autoRotateInterval=setInterval(()=>{this.next()},3e3)}stopAutoRotate(){this.autoRotateInterval&&(clearInterval(this.autoRotateInterval),this.autoRotateInterval=null)}openProductDetail(t){const e=this.bundles[t];if(!e)return;this.stopAutoRotate(),"function"==typeof showDetail?showDetail(e):console.error("showDetail function not found");const n=document.getElementById("detail-modal");if(n){const t=new MutationObserver(e=>{e.forEach(e=>{"class"===e.attributeName&&n.classList.contains("hidden")&&(this.startAutoRotate(),t.disconnect())})});t.observe(n,{attributes:!0})}}addProductToCart(t,e){const n=this.bundles[t];n&&("function"==typeof addToCart?addToCart(n,e):console.error("addToCart function not found"))}directOrderProduct(t){const e=this.bundles[t];e&&(this.stopAutoRotate(),"function"==typeof directOrder?directOrder(e):console.error("directOrder function not found"))}async refresh(){await this.fetchBundles(),this.currentIndex=0,this.render(),this.setupEventListeners(),this.startAutoRotate()}}let bundleCarousel,bundleResizeTimeout;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{bundleCarousel=new BundleCarousel}):bundleCarousel=new BundleCarousel,window.addEventListener("resize",()=>{clearTimeout(bundleResizeTimeout),bundleResizeTimeout=setTimeout(()=>{bundleCarousel&&bundleCarousel.updateCarousel()},250)});