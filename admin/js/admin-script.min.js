var escapeHtml=window.AdminSanitize&&window.AdminSanitize.escapeHtml||(e=>String(e||"")),escapeAttr=window.AdminSanitize&&window.AdminSanitize.escapeAttr||(e=>String(e||"")),sanitizeUrl=window.AdminSanitize&&window.AdminSanitize.sanitizeUrl||(e=>String(e||""));function logout(){localStorage.removeItem("admin_logged_in"),window.location.href="login.html"}"true"!==localStorage.getItem("admin_logged_in")&&(window.location.href="login.html");let API_URL=CONFIG.getAdminApiUrl();const CATEGORIES_SHEET="categories",PRODUCTS_SHEET="products",ORDERS_SHEET="orders",TUKAR_POIN_SHEET="tukar_poin",PURCHASES_SHEET="pembelian",SUPPLIERS_SHEET="suppliers",MONTHLY_COST_SHEET="biaya_bulanan",REFERRALS_SHEET="referrals";let allProducts=[],allCategories=[],allOrders=[],allTukarPoin=[],allPurchases=[],allSuppliers=[],allMonthlyCosts=[],allReferrals=[],currentOrderFilter="semua",currentOrderPage=1;const ordersPerPage=10;let referralFilterStatus="all",referralSearch="";function showSection(e){document.querySelectorAll("main > section").forEach(e=>e.classList.add("hidden")),document.getElementById(`section-${e}`).classList.remove("hidden"),document.querySelectorAll(".sidebar-item").forEach(e=>e.classList.remove("active")),document.getElementById(`nav-${e}`).classList.add("active"),closeSidebarOnMobile();document.getElementById("section-title").innerText={dashboard:"Dashboard",produk:"Produk",bundle:"Bundle Builder",pembelian:"Pembelian",suppliers:"Supplier",biaya:"Biaya Operasional",kategori:"Kategori",pesanan:"Pesanan",referrals:"Referral","tukar-poin":"Tukar Poin",banners:"Banner Promosi","user-points":"Poin Pengguna","tiered-pricing":"Harga Grosir Bertingkat",pengaturan:"Pengaturan"}[e],"kategori"===e&&fetchCategories(),"produk"===e&&fetchAdminProducts(),"bundle"===e&&(0!==allProducts.length&&0!==allCategories.length||(fetchAdminProducts(),fetchCategories()),ensureBundleBuilderReady()),"pembelian"===e&&(0===allProducts.length&&fetchAdminProducts(),fetchPurchases()),"suppliers"===e&&fetchSuppliers(),"biaya"===e&&fetchMonthlyCosts(),"pesanan"===e&&fetchOrders(),"referrals"===e&&fetchReferrals(),"tukar-poin"===e&&fetchTukarPoin(),"banners"===e&&fetchBanners(),"user-points"===e&&fetchUserPoints(),"tiered-pricing"===e&&fetchTieredPricingProducts(),"dashboard"===e&&(updateDashboardStats(),loadStoreStatus()),"pengaturan"===e&&loadSettings()}function closeSidebarOnMobile(){if(window.innerWidth>768)return;const e=document.querySelector("aside"),t=document.querySelector(".sidebar-overlay"),a=document.querySelector(".hamburger-menu");if(e&&e.classList.remove("active"),t&&t.classList.remove("active"),a){a.setAttribute("aria-expanded","false");const e=a.querySelector(".hamburger-icon"),t=a.querySelector(".close-icon");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden")}document.body.style.overflow=""}function loadStoreStatus(){const e=CONFIG.isStoreClosed(),t=document.getElementById("store-closed-toggle"),a=document.getElementById("store-status-label");t&&a&&(t.checked=e,e?(a.innerText="TOKO TUTUP",a.className="text-sm font-bold px-3 py-1 rounded-full bg-red-100 text-red-700"):(a.innerText="TOKO BUKA",a.className="text-sm font-bold px-3 py-1 rounded-full bg-green-100 text-green-700"))}function toggleStoreStatus(){const e=document.getElementById("store-closed-toggle").checked;CONFIG.setStoreClosed(e),loadStoreStatus(),showAdminToast(e?"Toko sekarang TUTUP":"Toko sekarang BUKA",e?"warning":"success")}async function updateDashboardStats(){try{const[e,t,a,n,r]=await Promise.all([fetch(`${API_URL}?sheet=products`),fetch(`${API_URL}?sheet=orders`),fetch(`${API_URL}?sheet=pembelian`),fetch(`${API_URL}?sheet=biaya_bulanan`),fetch(`${API_URL}?sheet=referrals`)]),o=await e.json(),s=await t.json(),i=a.ok?await a.json():[],d=n.ok?await n.json():[],l=r.ok?await r.json():[];allProducts=Array.isArray(o)?o:[],allPurchases=Array.isArray(i)?i:[],allMonthlyCosts=Array.isArray(d)?d:[],document.getElementById("stat-total-produk").innerText=o.length||0,document.getElementById("stat-total-pesanan").innerText=s.length||0;const c=o.filter(e=>parseInt(e.stok)<=5).length;document.getElementById("stat-stok-menipis").innerText=c;const u=Array.isArray(s)?s:[];allOrders=u,updateRevenueStats(u),renderRecentOrders(u),updateReferralStats(Array.isArray(l)?l:[]),renderRecentReferrals(Array.isArray(l)?l:[])}catch(e){console.error(e)}}function updateReferralStats(e){const t=document.getElementById("stat-referral-pending"),a=document.getElementById("stat-referral-approved"),n=document.getElementById("stat-referral-points");if(!t||!a||!n)return;const r=Array.isArray(e)?e:[],o=r.filter(e=>"pending"===String(e.status||"").toLowerCase()).length,s=r.filter(e=>"approved"===String(e.status||"").toLowerCase()),i=s.length,d=s.reduce((e,t)=>e+parseCurrencyValue(t.reward_referrer_points||0)+parseCurrencyValue(t.reward_referee_points||0),0);t.innerText=o,a.innerText=i,n.innerText=d.toLocaleString("id-ID")}function renderRecentReferrals(e){const t=document.getElementById("recent-referrals-list");if(!t)return;if(!Array.isArray(e)||0===e.length)return void(t.innerHTML='<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">Belum ada data referral.</td></tr>');const a=[...e].sort((e,t)=>{const a=new Date(e.created_at||0).getTime();return new Date(t.created_at||0).getTime()-a}).slice(0,6);t.innerHTML=a.map(e=>{const t=String(e.status||"pending").toLowerCase(),a="approved"===t?"bg-green-100 text-green-700":"pending"===t?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700",n=parseCurrencyValue(e.reward_referrer_points||0)+parseCurrencyValue(e.reward_referee_points||0);return`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-4 py-3 text-xs font-semibold text-gray-700">${escapeHtml(normalizePhone(e.referrer_phone||"-"))}</td>\n                <td class="px-4 py-3 text-xs text-gray-700">${escapeHtml(normalizePhone(e.referee_phone||"-"))}</td>\n                <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded-full font-bold ${a}">${escapeHtml(t)}</span></td>\n                <td class="px-4 py-3 text-xs font-bold text-blue-700">${n.toLocaleString("id-ID")}</td>\n            </tr>\n        `}).join("")}async function fetchReferrals(){const e=document.getElementById("referral-list-body");e&&(e.innerHTML='<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Memuat data referral...</td></tr>');try{const e=await fetch(`${API_URL}?sheet=referrals`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();allReferrals=Array.isArray(t)?t:[],renderReferralTable()}catch(t){console.error(t),e&&(e.innerHTML='<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">Gagal memuat referral.</td></tr>')}}function getFilteredReferrals(){const e=normalizePhone(referralSearch||"");return allReferrals.filter(t=>{const a=String(t.status||"").toLowerCase(),n=normalizePhone(t.referrer_phone||""),r=normalizePhone(t.referee_phone||""),o="all"===referralFilterStatus||a===referralFilterStatus,s=!e||n.includes(e)||r.includes(e);return o&&s})}function renderReferralTable(){const e=document.getElementById("referral-list-body"),t=document.getElementById("referral-filter-summary");if(!e)return;const a=getFilteredReferrals();t&&(t.textContent=`${a.length} data`),0!==a.length?e.innerHTML=a.map(e=>{const t=String(e.status||"pending").toLowerCase(),a="approved"===t?"bg-green-100 text-green-700":"pending"===t?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700",n=parseCurrencyValue(e.reward_referrer_points||0),r=parseCurrencyValue(e.reward_referee_points||0),o=`${n.toLocaleString("id-ID")} / ${r.toLocaleString("id-ID")}`,s=escapeHtml(e.id||"-"),i=escapeHtml(e.trigger_order_id||"-"),d="approved"!==t,l="rejected"!==t&&"void"!==t;return`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-6 py-4 text-xs font-bold text-blue-600">${s}</td>\n                <td class="px-6 py-4 text-sm text-gray-700">${escapeHtml(normalizePhone(e.referrer_phone||"-"))}</td>\n                <td class="px-6 py-4 text-sm text-gray-700">${escapeHtml(normalizePhone(e.referee_phone||"-"))}</td>\n                <td class="px-6 py-4"><span class="text-xs px-2 py-1 rounded-full font-bold ${a}">${escapeHtml(t)}</span></td>\n                <td class="px-6 py-4 text-sm font-semibold text-gray-700">${o}</td>\n                <td class="px-6 py-4 text-sm text-gray-600">${i}</td>\n                <td class="px-6 py-4 text-right">\n                    <div class="inline-flex gap-2">\n                        <button data-action="approve-referral" data-id="${escapeAttr(e.id)}" class="px-3 py-1.5 rounded-lg bg-green-100 hover:bg-green-200 text-green-700 text-xs font-bold transition" ${d?"":"disabled"}>\n                            Approve\n                        </button>\n                        <button data-action="reject-referral" data-id="${escapeAttr(e.id)}" class="px-3 py-1.5 rounded-lg bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold transition" ${l?"":"disabled"}>\n                            Reject\n                        </button>\n                    </div>\n                </td>\n            </tr>\n        `}).join(""):e.innerHTML='<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Tidak ada data referral sesuai filter.</td></tr>'}async function runReferralLedgerReconciliation(){const e=document.getElementById("referral-reconcile-body"),t=document.getElementById("reconcile-total-count"),a=document.getElementById("reconcile-match-count"),n=document.getElementById("reconcile-mismatch-count");e&&(e.innerHTML='<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Memproses rekonsiliasi...</td></tr>');try{const[r,o]=await Promise.all([fetch(`${API_URL}?sheet=user_points`),fetch(`${API_URL}?sheet=point_transactions`)]),s=r.ok?await r.json():[],i=o.ok?await o.json():[],d=Array.isArray(s)?s:[],l=Array.isArray(i)?i:[],c=new Map;d.forEach(e=>{const t=normalizePhone(e.phone||e.whatsapp||"");t&&c.set(t,parseCurrencyValue(e.points||e.poin||0))});const u=new Map;l.forEach(e=>{const t=normalizePhone(e.phone||"");if(!t)return;const a=u.get(t)||0,n=parseCurrencyValue(e.points_delta||0);u.set(t,a+n)});const p=new Set([...c.keys(),...u.keys()]),m=Array.from(p).map(e=>{const t=c.get(e)||0,a=u.get(e)||0,n=t-a;return{phone:e,userPoints:t,ledgerSum:a,diff:n,match:Math.abs(n)<1e-4}}).sort((e,t)=>Math.abs(t.diff)-Math.abs(e.diff)),g=m.length,h=m.filter(e=>!e.match).length,y=g-h;if(t&&(t.innerText=String(g)),a&&(a.innerText=String(y)),n&&(n.innerText=String(h)),!e)return;if(0===m.length)return void(e.innerHTML='<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Tidak ada data untuk direkonsiliasi.</td></tr>');e.innerHTML=m.map(e=>{const t=e.match?"bg-green-100 text-green-700":"bg-red-100 text-red-700",a=e.match?"match":"mismatch";return`\n                <tr class="hover:bg-gray-50 transition">\n                    <td class="px-4 py-3 text-xs font-semibold text-gray-700">${escapeHtml(e.phone)}</td>\n                    <td class="px-4 py-3 text-xs text-gray-700">${e.userPoints.toLocaleString("id-ID")}</td>\n                    <td class="px-4 py-3 text-xs text-gray-700">${e.ledgerSum.toLocaleString("id-ID")}</td>\n                    <td class="px-4 py-3 text-xs font-bold ${e.match?"text-green-700":"text-red-700"}">${e.diff.toLocaleString("id-ID")}</td>\n                    <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded-full font-bold ${t}">${a}</span></td>\n                </tr>\n            `}).join(""),showAdminToast(`Rekonsiliasi selesai: ${h} mismatch`,h>0?"warning":"success")}catch(t){console.error(t),e&&(e.innerHTML='<tr><td colspan="5" class="px-4 py-4 text-center text-red-500">Gagal menjalankan rekonsiliasi.</td></tr>'),showAdminToast("Gagal menjalankan rekonsiliasi ledger.","error")}}async function fetchSettingsRowsFromSheet(){try{const e=await fetch(`${API_URL}?sheet=settings&_t=${Date.now()}`);if(!e.ok)return[];const t=await e.json();return Array.isArray(t)?t:[]}catch(e){return console.warn("Failed to fetch settings from sheet:",e),[]}}function getLatestSettingValue(e,t,a){if(!Array.isArray(e))return a;for(let n=e.length-1;n>=0;n-=1)if(String(e[n].key||"").trim()===t){const t=e[n].value;return null!=t&&""!==String(t)?t:a}return a}async function handleApproveReferral(e){const t=allReferrals.find(t=>String(t.id)===String(e));if(t){try{const e=await GASActions.post({action:"evaluate_referral",sheet:"referrals",data:{order_id:t.trigger_order_id||`MANUAL-${Date.now()}`,order_status:"Selesai",order_total:parseCurrencyValue(t.trigger_order_total||999999),buyer_phone:normalizePhone(t.referee_phone||"")}});if(e&&e.success)return showAdminToast("Referral approved & reward diproses.","success"),fetchReferrals(),void updateDashboardStats()}catch(e){console.warn("evaluate_referral failed, fallback to manual status update:",e)}try{(await GASActions.update("referrals",e,{status:"approved",approved_at:(new Date).toISOString(),notes:"Manual approved from admin panel"})).affected>0?(showAdminToast("Referral di-approve manual (tanpa auto reward).","warning"),fetchReferrals(),updateDashboardStats()):showAdminToast("Gagal approve referral.","error")}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat approve referral.","error")}}else showAdminToast("Referral tidak ditemukan.","error")}async function handleRejectReferral(e){try{(await GASActions.update("referrals",e,{status:"rejected",notes:"Manual rejected from admin panel"})).affected>0?(showAdminToast("Referral di-reject.","success"),fetchReferrals(),updateDashboardStats()):showAdminToast("Gagal reject referral.","error")}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat reject referral.","error")}}function renderRecentOrders(e){const t=document.getElementById("recent-orders-list");if(!t)return;if(!Array.isArray(e)||0===e.length)return void(t.innerHTML='<tr><td colspan="4" class="px-6 py-6 text-center text-gray-500">Belum ada pesanan.</td></tr>');const a=[...e].sort((e,t)=>{const a=parseOrderDate(e.tanggal_pesanan||e.timestamp||e.tanggal||e.date)||new Date(0);return(parseOrderDate(t.tanggal_pesanan||t.timestamp||t.tanggal||t.date)||new Date(0))-a}).slice(0,5);t.innerHTML=a.map(e=>{const t=escapeHtml(e.id||"-"),a=escapeHtml(e.pelanggan||e.customer||e.nama||"-"),n=escapeHtml(e.status||"Menunggu");return`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-6 py-4 text-xs font-bold text-blue-600" data-label="ID">${t}</td>\n                <td class="px-6 py-4 text-sm text-gray-800" data-label="Pelanggan">${a}</td>\n                <td class="px-6 py-4" data-label="Status">\n                    <span class="status-badge status-${String(e.status||"").toLowerCase().replace(/[^a-z0-9_-]/g,"")}">${n}</span>\n                </td>\n                <td class="px-6 py-4 text-right font-bold text-gray-800" data-label="Total">${`Rp ${parseCurrencyValue(e.total||e.total_bayar||0).toLocaleString("id-ID")}`}</td>\n            </tr>\n        `}).join("")}function updateRevenueStats(e){const t=document.getElementById("stat-omzet-harian"),a=document.getElementById("stat-hpp-harian"),n=document.getElementById("stat-profit-harian"),r=document.getElementById("summary-omzet-30d"),o=document.getElementById("summary-hpp-30d"),s=document.getElementById("summary-profit-30d"),i=document.getElementById("summary-margin-30d"),d=document.getElementById("summary-cost-30d"),l=document.getElementById("summary-net-30d");if(!(t||a||r||o))return;const c=new Date,u=new Date(c.getFullYear(),c.getMonth(),c.getDate()),p=new Date(u);p.setDate(p.getDate()-29);let m=0,g=0,h=0,y=0;e.forEach(e=>{const t=parseOrderDate(e.tanggal_pesanan||e.timestamp||e.tanggal||e.date);if(!t)return;const a=parseCurrencyValue(e.total||e.total_bayar||e.totalBayar||0),n=calculateOrderHpp(e);t>=u&&(m+=a,g+=n),t>=p&&(h+=a,y+=n)}),t&&(t.innerText=`Rp ${m.toLocaleString("id-ID")}`),a&&(a.innerText=`Rp ${Math.round(g).toLocaleString("id-ID")}`),n&&(n.innerText=`Rp ${Math.round(m-g).toLocaleString("id-ID")}`);const f=calculateMonthlyCostTotal();if(r&&(r.innerText=`Rp ${h.toLocaleString("id-ID")}`),o&&(o.innerText=`Rp ${Math.round(y).toLocaleString("id-ID")}`),s&&(s.innerText=`Rp ${Math.round(h-y).toLocaleString("id-ID")}`),d&&(d.innerText=`Rp ${Math.round(f).toLocaleString("id-ID")}`),l&&(l.innerText=`Rp ${Math.round(h-y-f).toLocaleString("id-ID")}`),i){const e=h>0?(h-y)/h*100:0;i.innerText=`${e.toFixed(1)}%`}}function parseOrderDate(e){if(!e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return e;if("number"==typeof e){const t=new Date(e);return Number.isNaN(t.getTime())?null:t}const t=String(e).trim();if(!t)return null;const a=new Date(t);if(!Number.isNaN(a.getTime()))return a;if(t.includes("/")){const e=t.split("/").map(e=>e.trim());if(e.length>=3){const t=parseInt(e[0],10),a=parseInt(e[1],10),n=parseInt(e[2],10);if(!Number.isNaN(t)&&!Number.isNaN(a)&&!Number.isNaN(n))return new Date(n,a-1,t)}}return null}function parseCurrencyValue(e){if("number"==typeof e)return e;if(!e)return 0;const t=String(e).replace(/[^0-9.-]/g,""),a=parseFloat(t);return Number.isNaN(a)?0:a}function calculateMonthlyCostTotal(){return Array.isArray(allMonthlyCosts)?allMonthlyCosts.reduce((e,t)=>{const a=String(t.aktif||t.status||"Ya").toLowerCase();if("ya"!==a&&"aktif"!==a)return e;return e+parseCurrencyValue(t.nominal||t.amount||0)},0):0}function getBundleRules(){return CONFIG.getBundleDiscountConfig?CONFIG.getBundleDiscountConfig():{rule34:5,rule56:8,rule7plus:10}}function recommendBundleDiscount(e){const t=getBundleRules();return e>=7?t.rule7plus:e>=5?t.rule56:e>=3?t.rule34:0}function ensureBundleBuilderReady(){const e=document.getElementById("bundle-items");e&&(0===e.children.length&&(addBundleItemRow(),addBundleItemRow()),updateBundleCategoryDropdown(),updateBundleTotals())}function addBundleItemRow(){const e=document.getElementById("bundle-items");if(!e)return;const t=document.createElement("div");t.className="grid grid-cols-1 md:grid-cols-3 gap-3 items-center bundle-item-row",t.innerHTML=`\n        <div>\n            <select class="bundle-item-product w-full p-3 border border-gray-300 rounded-xl outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100">\n                <option value="">-- Pilih Produk --</option>\n                ${allProducts.map(e=>`<option value="${escapeAttr(e.id)}">${escapeHtml(e.nama)}</option>`).join("")}\n            </select>\n        </div>\n        <div>\n            <input type="number" min="1" step="1" value="1" class="bundle-item-qty w-full p-3 border border-gray-300 rounded-xl outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100">\n        </div>\n        <div class="flex items-center gap-2">\n            <span class="bundle-item-subtotal text-sm text-gray-600 flex-1">Rp 0</span>\n            <button type="button" data-action="remove-bundle-item" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-bold transition">\n                Hapus\n            </button>\n        </div>\n    `,e.appendChild(t)}function refreshBundleItemOptions(){const e=document.querySelectorAll(".bundle-item-product");if(!e.length)return;const t='<option value="">-- Pilih Produk --</option>'+allProducts.map(e=>`<option value="${escapeAttr(e.id)}">${escapeHtml(e.nama)}</option>`).join("");e.forEach(e=>{const a=e.value;e.innerHTML=t,e.value=a})}function removeBundleItemRow(e){const t=e.closest(".bundle-item-row");t&&t.remove(),updateBundleTotals()}function updateBundleTotals(){const e=Array.from(document.querySelectorAll(".bundle-item-row"));let t=0,a=0;const n=[];e.forEach(e=>{const r=e.querySelector(".bundle-item-product")?.value,o=parseInt(e.querySelector(".bundle-item-qty")?.value||"0",10),s=allProducts.find(e=>String(e.id)===String(r)),i=(s?parseCurrencyValue(s.harga):0)*(Number.isFinite(o)?o:0);t+=i,s&&o>0&&(a+=1,n.push(`- ${s.nama} x${o}`));const d=e.querySelector(".bundle-item-subtotal");d&&(d.textContent=`Rp ${Math.round(i).toLocaleString("id-ID")}`)});const r=document.getElementById("bundle-total");r&&(r.value=`Rp ${Math.round(t).toLocaleString("id-ID")}`);const o=document.getElementById("bundle-discount");if(o&&(""===o.value||"true"===o.dataset.auto)){const e=recommendBundleDiscount(a);o.value=e,o.dataset.auto="true"}const s=parseFloat(o?.value||"0")||0,i=Math.max(0,t-t*s/100),d=document.getElementById("bundle-final");d&&(d.value=`Rp ${Math.round(i).toLocaleString("id-ID")}`);const l=document.getElementById("bundle-description");l&&!l.dataset.touched&&(l.value=`Isi paket:\n${n.join("\n")}`)}function applyBundleRecommendation(){const e=Array.from(document.querySelectorAll(".bundle-item-row")).reduce((e,t)=>{const a=t.querySelector(".bundle-item-product")?.value,n=parseInt(t.querySelector(".bundle-item-qty")?.value||"0",10);return a&&n>0?e+1:e},0),t=document.getElementById("bundle-discount");t&&(t.value=recommendBundleDiscount(e),t.dataset.auto="true"),updateBundleTotals()}function parseOrderItems(e){return e?String(e).split("|").map(e=>e.trim()).filter(Boolean).map(e=>{const t=e.match(/(.+)\(x\s*([0-9]+)\)/i);let a=t?t[1].trim():e;const n=t?parseInt(t[2],10):1;return a=a.replace(/\s*\([^)]*\)\s*$/,"").trim(),{name:a,qty:Number.isFinite(n)?n:1}}):[]}function calculateOrderHpp(e){const t=parseOrderItems(e.produk||"");if(0===t.length)return 0;let a=0;return t.forEach(e=>{const t=allProducts.find(t=>String(t.nama).trim().toLowerCase()===String(e.name).trim().toLowerCase());if(!t)return;const n=getPurchaseStats(t.id);n.avgCost>0&&(a+=n.avgCost*e.qty)}),a}async function fetchSuppliers(){const e=document.getElementById("supplier-list-body");e&&(e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data supplier...</td></tr>');try{const e=await fetch(`${API_URL}?sheet=suppliers`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();allSuppliers=Array.isArray(t)?t:[],renderSuppliersTable(),updateSupplierDatalist()}catch(t){console.error(t),e&&(e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat data supplier. Pastikan sheet "suppliers" sudah ada.</td></tr>')}}function renderSuppliersTable(){const e=document.getElementById("supplier-list-body");e&&(Array.isArray(allSuppliers)&&0!==allSuppliers.length?e.innerHTML=allSuppliers.map(e=>`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">${escapeHtml(e.nama||e.name||"")}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(e.phone||e.kontak||"")}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(e.alamat||e.address||"")}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(e.catatan||e.notes||"")}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button data-action="edit-supplier" data-id="${escapeAttr(e.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-supplier" data-id="${escapeAttr(e.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n        `).join(""):e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada supplier.</td></tr>')}function resetSupplierForm(){const e=document.getElementById("supplier-form");e&&e.reset();const t=document.getElementById("form-supplier-id");t&&(t.value="")}function openEditSupplier(e){const t=allSuppliers.find(t=>String(t.id)===String(e));t&&(document.getElementById("form-supplier-id").value=t.id,document.getElementById("form-supplier-name").value=t.nama||t.name||"",document.getElementById("form-supplier-phone").value=t.phone||t.kontak||"",document.getElementById("form-supplier-address").value=t.alamat||t.address||"",document.getElementById("form-supplier-notes").value=t.catatan||t.notes||"")}async function handleDeleteSupplier(e){if(confirm("Hapus supplier ini?"))try{(await GASActions.delete("suppliers",e)).deleted>0&&(showAdminToast("Supplier berhasil dihapus!","success"),fetchSuppliers())}catch(e){console.error(e),showAdminToast("Gagal menghapus supplier.","error")}}const supplierForm=document.getElementById("supplier-form");async function fetchMonthlyCosts(){const e=document.getElementById("monthly-cost-list-body");e&&(e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data biaya...</td></tr>');try{const e=await fetch(`${API_URL}?sheet=biaya_bulanan`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();allMonthlyCosts=Array.isArray(t)?t:[],renderMonthlyCostsTable(),updateRevenueStats(allOrders||[])}catch(t){console.error(t),e&&(e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat biaya. Pastikan sheet "biaya_bulanan" sudah ada.</td></tr>')}}function renderMonthlyCostsTable(){const e=document.getElementById("monthly-cost-list-body");e&&(Array.isArray(allMonthlyCosts)&&0!==allMonthlyCosts.length?e.innerHTML=allMonthlyCosts.map(e=>{const t=escapeHtml(e.nama||e.name||""),a=parseCurrencyValue(e.nominal||e.amount||0),n=escapeHtml(e.aktif||e.status||"Ya"),r=escapeHtml(e.catatan||e.notes||"");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">${t}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">Rp ${Math.round(a).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${n}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${r}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button data-action="edit-cost" data-id="${escapeAttr(e.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-cost" data-id="${escapeAttr(e.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n        `}).join(""):e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada biaya.</td></tr>')}function resetMonthlyCostForm(){const e=document.getElementById("monthly-cost-form");e&&e.reset();const t=document.getElementById("form-cost-id");t&&(t.value="")}function openEditMonthlyCost(e){const t=allMonthlyCosts.find(t=>String(t.id)===String(e));t&&(document.getElementById("form-cost-id").value=t.id,document.getElementById("form-cost-name").value=t.nama||t.name||"",document.getElementById("form-cost-amount").value=parseCurrencyValue(t.nominal||t.amount||0),document.getElementById("form-cost-active").value=t.aktif||t.status||"Ya",document.getElementById("form-cost-notes").value=t.catatan||t.notes||"")}async function handleDeleteMonthlyCost(e){if(confirm("Hapus biaya ini?"))try{(await GASActions.delete("biaya_bulanan",e)).deleted>0&&(showAdminToast("Biaya berhasil dihapus!","success"),fetchMonthlyCosts())}catch(e){console.error(e),showAdminToast("Gagal menghapus biaya.","error")}}supplierForm&&supplierForm.addEventListener("submit",async e=>{e.preventDefault();const t=supplierForm.querySelector('button[type="submit"]'),a=t.innerText;t.disabled=!0,t.innerText="Menyimpan...";const n=document.getElementById("form-supplier-id").value||Date.now().toString(),r={id:n,nama:document.getElementById("form-supplier-name").value,phone:document.getElementById("form-supplier-phone").value,alamat:document.getElementById("form-supplier-address").value,catatan:document.getElementById("form-supplier-notes").value};try{const e=document.getElementById("form-supplier-id").value?await GASActions.update("suppliers",n,r):await GASActions.create("suppliers",r);(e.affected>0||e.created>0)&&(showAdminToast("Supplier berhasil disimpan!","success"),resetSupplierForm(),fetchSuppliers())}catch(e){console.error(e),showAdminToast("Gagal menyimpan supplier.","error")}finally{t.disabled=!1,t.innerText=a}});const monthlyCostForm=document.getElementById("monthly-cost-form");monthlyCostForm&&monthlyCostForm.addEventListener("submit",async e=>{e.preventDefault();const t=monthlyCostForm.querySelector('button[type="submit"]'),a=t.innerText;t.disabled=!0,t.innerText="Menyimpan...";const n=document.getElementById("form-cost-id").value||Date.now().toString(),r={id:n,nama:document.getElementById("form-cost-name").value,nominal:document.getElementById("form-cost-amount").value,aktif:document.getElementById("form-cost-active").value,catatan:document.getElementById("form-cost-notes").value};try{const e=document.getElementById("form-cost-id").value?await GASActions.update("biaya_bulanan",n,r):await GASActions.create("biaya_bulanan",r);(e.affected>0||e.created>0)&&(showAdminToast("Biaya berhasil disimpan!","success"),resetMonthlyCostForm(),fetchMonthlyCosts())}catch(e){console.error(e),showAdminToast("Gagal menyimpan biaya.","error")}finally{t.disabled=!1,t.innerText=a}});const bundleForm=document.getElementById("bundle-form");async function fetchOrders(){const e=document.getElementById("order-list-body");e.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Memuat data pesanan...</td></tr>';try{const e=await fetch(`${API_URL}?sheet=orders`);allOrders=await e.json(),Array.isArray(allOrders)||(allOrders=[]),renderOrderTable(),updateOrderStats()}catch(t){console.error("Error:",t),e.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-red-500">Gagal memuat data pesanan.</td></tr>'}}function updateOrderStats(){const e=allOrders.length,t=allOrders.filter(e=>"menunggu"===e.status.toLowerCase()).length,a=allOrders.reduce((e,t)=>e+(parseInt(t.total)||0),0),n=e>0?Math.round(a/e):0;document.getElementById("order-stat-total").innerText=e,document.getElementById("order-stat-pending").innerText=t,document.getElementById("order-stat-revenue").innerText=`Rp ${a.toLocaleString("id-ID")}`,document.getElementById("order-stat-avg").innerText=`Rp ${n.toLocaleString("id-ID")}`,document.getElementById("order-count-display").innerText=`(${e})`}function filterOrders(e,t){currentOrderFilter=e,currentOrderPage=1,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active","bg-green-600","text-white"),e.classList.add("bg-gray-100","text-gray-600")}),t&&(t.classList.add("active","bg-green-600","text-white"),t.classList.remove("bg-gray-100","text-gray-600")),renderOrderTable()}function renderOrderTable(){const e=document.getElementById("order-list-body"),t=document.getElementById("order-pagination-admin"),a=("semua"===currentOrderFilter?allOrders:allOrders.filter(e=>String(e.status||"").toLowerCase()===currentOrderFilter.toLowerCase())).slice().sort((e,t)=>{const a=parseOrderDate(e.tanggal_pesanan||e.timestamp||e.tanggal||e.date)||new Date(0);return(parseOrderDate(t.tanggal_pesanan||t.timestamp||t.tanggal||t.date)||new Date(0))-a});if(0===a.length)return e.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Tidak ada pesanan.</td></tr>',void(t&&(t.innerHTML=""));const n=Math.ceil(a.length/10),r=10*(currentOrderPage-1),o=Math.min(r+10,a.length),s=a.slice(r,o);e.innerHTML=s.map(e=>{const t=escapeHtml(e.id),a=escapeHtml(e.pelanggan),n=escapeHtml(e.produk),r=escapeHtml(e.qty),o=escapeHtml(e.status),s=String(e.status||"").toLowerCase().replace(/[^a-z0-9_-]/g,""),i=escapeHtml(e.tanggal||"");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 font-bold text-blue-600 text-xs" data-label="ID Pesanan">${t}</td>\n            <td class="px-6 py-4 text-sm text-gray-800 font-medium" data-label="Pelanggan">${a}</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Produk">${n}</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Qty">${r}</td>\n            <td class="px-6 py-4 text-sm font-bold text-gray-800" data-label="Total">Rp ${parseInt(e.total).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4" data-label="Status">\n                <span class="status-badge status-${s}">${o}</span>\n            </td>\n            <td class="px-6 py-4 text-xs text-gray-500" data-label="Tanggal">${i}</td>\n            <td class="px-6 py-4 text-right" data-label="Aksi">\n                <select data-action="update-order-status" data-id="${escapeAttr(e.id)}" class="text-xs border rounded-lg p-1 outline-none focus:ring-1 focus:ring-green-500">\n                    <option value="">Ubah Status</option>\n                    <option value="Menunggu">Menunggu</option>\n                    <option value="Diproses">Diproses</option>\n                    <option value="Dikirim">Dikirim</option>\n                    <option value="Terima">Terima</option>\n                    <option value="Dibatalkan">Dibatalkan</option>\n                </select>\n            </td>\n        </tr>\n    `}).join(""),t&&(t.innerHTML=renderOrderPagination(n))}function renderOrderPagination(e){if(e<=1)return"";let t='<div class="flex flex-wrap justify-center items-center gap-2">';currentOrderPage>1&&(t+=`<button data-action="order-page" data-page="${currentOrderPage-1}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-xs">← Prev</button>`);let a=Math.max(1,currentOrderPage-2),n=Math.min(e,a+5-1);n-a<4&&(a=Math.max(1,n-5+1));for(let e=a;e<=n;e++)t+=e===currentOrderPage?`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-xs">${e}</button>`:`<button data-action="order-page" data-page="${e}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-xs">${e}</button>`;return currentOrderPage<e&&(t+=`<button data-action="order-page" data-page="${currentOrderPage+1}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-xs">Next →</button>`),t+="</div>",t}function normalizePhone(e){if(!e)return"";let t=e.toString().replace(/[^0-9]/g,"");return t.startsWith("62")?t="0"+t.slice(2):t.startsWith("8")?t="0"+t:t.startsWith("0")||(t="0"+t),t}async function updateOrderStatus(e,t,a){if(t&&a){a.disabled=!0;try{const n=allOrders.find(t=>t.id===e);if(!n)return showAdminToast("Pesanan tidak ditemukan!","error"),void(a.disabled=!1);if((await GASActions.update("orders",e,{status:t})).affected>0){if(["terima","diterima","selesai","paid"].includes(String(t||"").toLowerCase())&&n.phone)try{const e=await GASActions.post({action:"evaluate_referral",sheet:"referrals",data:{order_id:n.id,order_status:t,order_total:parseCurrencyValue(n.total||n.total_bayar||0),buyer_phone:normalizePhone(n.phone||"")}});e&&e.success&&e.referral_id&&showAdminToast(`Referral diproses: ${e.referral_id}`,"success")}catch(e){console.warn("Referral evaluation failed:",e)}if("Terima"===t&&"Yes"!==n.point_processed){if(n.phone&&n.poin){const t=parseFloat(n.poin)||0,a=normalizePhone(n.phone),r=await fetch(`${API_URL}?sheet=user_points`),o=await r.json(),s=Array.isArray(o)?o.filter(e=>normalizePhone(e.phone)===a):[];let i=!1;if(Array.isArray(s)&&s.length>0){const e=parseFloat(s[0].points)||0;(await GASActions.update("user_points",s[0].id,{points:e+t,last_updated:(new Date).toLocaleString("id-ID")})).affected>0&&(i=!0)}else{(await GASActions.create("user_points",{id:Date.now().toString(),phone:a,points:t,last_updated:(new Date).toLocaleString("id-ID")})).created>0&&(i=!0)}i?(await GASActions.update("orders",e,{point_processed:"Yes"}),showAdminToast(`Status diperbarui & +${t} poin diberikan ke ${a}`,"success")):showAdminToast("Status diperbarui, tapi gagal update poin.","warning")}}else showAdminToast("Status pesanan diperbarui!","success");const a=allOrders.findIndex(t=>t.id===e);-1!==a&&(allOrders[a].status=t,"Terima"===t&&(allOrders[a].point_processed="Yes"),renderOrderTable(),updateOrderStats())}else showAdminToast("Gagal memperbarui status di database.","error")}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat memperbarui status.","error")}finally{a.disabled=!1}}}async function fetchCategories(){try{const e=await fetch(`${API_URL}?sheet=categories`);allCategories=await e.json(),renderCategoryTable(),updateCategoryDropdown();const t=document.getElementById("section-bundle");t&&!t.classList.contains("hidden")&&ensureBundleBuilderReady()}catch(e){console.error(e)}}function renderCategoryTable(){const e=document.getElementById("category-list-body");0!==allCategories.length?(e.innerHTML=allCategories.map(e=>`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 font-bold text-gray-800 text-sm" data-label="Nama Kategori">${escapeHtml(e.nama)}</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Deskripsi">${escapeHtml(e.deskripsi||"-")}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2" data-label="Aksi">\n                <button data-action="edit-category" data-id="${escapeAttr(e.id)}" data-name="${escapeAttr(e.nama)}" data-description="${escapeAttr(e.deskripsi||"")}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-category" data-id="${escapeAttr(e.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `).join(""),document.getElementById("category-count").innerText=`(${allCategories.length})`):e.innerHTML='<tr><td colspan="3" class="px-6 py-10 text-center text-gray-500">Belum ada kategori.</td></tr>'}function openEditCategory(e,t,a){const n=prompt("Nama Kategori:",t);if(null===n)return;const r=prompt("Deskripsi:",a);null!==r&&handleEditCategory(e,n,r)}async function handleEditCategory(e,t,a){try{(await GASActions.update("categories",e,{nama:t,deskripsi:a})).affected>0&&(showAdminToast("Kategori berhasil diperbarui!","success"),fetchCategories())}catch(e){console.error(e),showAdminToast("Gagal memperbarui kategori.","error")}}async function handleDeleteCategory(e){if(confirm("Apakah Anda yakin ingin menghapus kategori ini?"))try{(await GASActions.delete("categories",e)).deleted>0&&(showAdminToast("Kategori berhasil dihapus!","success"),fetchCategories())}catch(e){console.error(e),showAdminToast("Gagal menghapus kategori.","error")}}function updateCategoryDropdown(){const e=document.getElementById("form-category");if(!e)return;const t=e.value;e.innerHTML='<option value="">-- Pilih Kategori --</option>'+allCategories.map(e=>{const t=escapeHtml(e.nama);return`<option value="${t}">${t}</option>`}).join(""),e.value=t,updateBundleCategoryDropdown()}function updateBundleCategoryDropdown(){const e=document.getElementById("bundle-category");if(!e)return;const t=e.value;e.innerHTML='<option value="">-- Pilih Kategori --</option>'+allCategories.map(e=>{const t=escapeHtml(e.nama);return`<option value="${t}">${t}</option>`}).join(""),e.value=t}function updatePurchaseProductDropdown(){const e=document.getElementById("form-purchase-product");if(!e)return;const t=e.value;e.innerHTML='<option value="">-- Pilih Produk --</option>'+allProducts.map(e=>{const t=escapeHtml(e.nama);return`<option value="${escapeAttr(e.id)}">${t}</option>`}).join(""),e.value=t}function updateSupplierDatalist(){const e=document.getElementById("supplier-list");e&&(e.innerHTML=allSuppliers.map(e=>`<option value="${escapeHtml(e.nama||e.name||"")}"></option>`).join(""))}function getPurchaseStats(e){if(!e)return{avgCost:0,lastCost:0,totalQty:0};const t=String(e),a=allPurchases.filter(e=>String(e.product_id||e.productId||e.id_produk||"")===t);let n=0,r=0,o=0,s=new Date(0);a.forEach(e=>{const t=parseFloat(e.qty||e.jumlah||e.quantity||0),a=parseCurrencyValue(e.harga_modal||e.modal||e.cost||e.harga||0);if(!Number.isFinite(t)||t<=0||!Number.isFinite(a)||a<=0)return;n+=t,r+=t*a;const i=parseOrderDate(e.tanggal||e.date||e.created_at||e.timestamp)||new Date(0);i>s&&(s=i,o=a)});return{avgCost:n>0?r/n:0,lastCost:o,totalQty:n}}async function fetchAdminProducts(){document.getElementById("admin-product-list").innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data...</td></tr>';try{const[e,t,a]=await Promise.all([fetch(`${API_URL}?sheet=products`),fetch(`${API_URL}?sheet=pembelian`),fetch(`${API_URL}?sheet=suppliers`)]);if(allProducts=await e.json(),t.ok){const e=await t.json();allPurchases=Array.isArray(e)?e:[]}else allPurchases=[];if(a.ok){const e=await a.json();allSuppliers=Array.isArray(e)?e:[]}else allSuppliers=[];renderAdminTable(),updatePurchaseProductDropdown(),updateSupplierDatalist(),refreshBundleItemOptions(),document.getElementById("section-pembelian")&&!document.getElementById("section-pembelian").classList.contains("hidden")&&renderPurchaseTable();const n=document.getElementById("section-bundle");n&&!n.classList.contains("hidden")&&ensureBundleBuilderReady(),updateDashboardStats()}catch(e){console.error(e)}}function renderAdminTable(){const e=document.getElementById("admin-product-list");0!==allProducts.length?e.innerHTML=allProducts.map(e=>{const t=escapeHtml(e.nama),a=escapeHtml(e.kategori||"-"),n=escapeHtml(e.stok),r=e.gambar?e.gambar.split(",")[0]:"https://via.placeholder.com/50",o=sanitizeUrl(r,"https://via.placeholder.com/50"),s=parseCurrencyValue(e.harga),i=getPurchaseStats(e.id),d=i.avgCost,l=i.lastCost,c=d>0?s-d:0,u=d>0?c/d*100:0,p=CONFIG.getMarginAlertThreshold?CONFIG.getMarginAlertThreshold():10,m=d>0&&u<p;return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4" data-label="Produk">\n                <div class="flex items-center gap-3">\n                    <img src="${o}" class="w-10 h-10 object-cover rounded-lg bg-gray-100" alt="${t}">\n                    <span class="font-bold text-gray-800 text-sm">${t}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4" data-label="Kategori">\n                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-md text-[10px] font-bold uppercase">${a}</span>\n            </td>\n            <td class="px-6 py-4" data-label="Harga">\n                <div class="flex flex-col">\n                    ${e.harga_coret?`<span class="text-[10px] text-gray-400 line-through">Rp ${parseInt(e.harga_coret).toLocaleString("id-ID")}</span>`:""}\n                    <span class="font-bold text-green-700 text-sm">Rp ${parseInt(e.harga).toLocaleString("id-ID")}</span>\n                    ${d>0?`<span class="text-[10px] text-gray-500">Modal avg: Rp ${Math.round(d).toLocaleString("id-ID")}</span>`:'<span class="text-[10px] text-gray-400">Modal avg: -</span>'}\n                    ${l>0?`<span class="text-[10px] text-gray-500">Modal last: Rp ${Math.round(l).toLocaleString("id-ID")}</span>`:'<span class="text-[10px] text-gray-400">Modal last: -</span>'}\n                    ${d>0?`<span class="text-[10px] ${m?"text-red-600 font-bold":"text-green-600"}">Margin: Rp ${Math.round(c).toLocaleString("id-ID")} (${u.toFixed(1)}%)</span>`:""}\n                    ${m?'<span class="text-[10px] text-red-500 font-bold">Margin Rendah</span>':""}\n                </div>\n            </td>\n            <td class="px-6 py-4" data-label="Stok">\n                <span class="text-sm ${parseInt(e.stok)<=5?"text-red-600 font-bold":"text-gray-600"}">${n}</span>\n            </td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2" data-label="Aksi">\n                <button data-action="edit-product" data-id="${escapeAttr(e.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-product" data-id="${escapeAttr(e.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `}).join(""):e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada produk.</td></tr>'}function openAddModal(){document.getElementById("modal-title").innerText="Tambah Produk",document.getElementById("product-id").value="",document.getElementById("product-form").reset(),document.getElementById("variants-container").innerHTML="",document.getElementById("product-modal").classList.remove("hidden")}function openEditModal(e){const t=allProducts.find(t=>t.id==e);if(!t)return;document.getElementById("modal-title").innerText="Edit Produk",document.getElementById("product-id").value=t.id,document.getElementById("form-nama").value=t.nama,document.getElementById("form-harga").value=t.harga,document.getElementById("form-harga-coret").value=t.harga_coret||"",document.getElementById("form-stok").value=t.stok,document.getElementById("form-category").value=t.kategori||"",document.getElementById("form-deskripsi").value=t.deskripsi||"";const a=t.gambar?t.gambar.split(","):[];document.getElementById("form-gambar-1").value=a[0]||"",document.getElementById("form-gambar-2").value=a[1]||"",document.getElementById("form-gambar-3").value=a[2]||"",loadVariants(t.variasi),document.getElementById("product-modal").classList.remove("hidden")}function closeModal(){document.getElementById("product-modal").classList.add("hidden")}async function handleDelete(e){if(confirm("Apakah Anda yakin ingin menghapus produk ini?"))try{(await GASActions.delete("products",e)).deleted>0&&(showAdminToast("Produk berhasil dihapus!","success"),fetchAdminProducts())}catch(e){console.error(e),showAdminToast("Gagal menghapus produk.","error")}}async function fetchPurchases(){const e=document.getElementById("purchase-list-body");e&&(e.innerHTML='<tr><td colspan="7" class="px-6 py-10 text-center text-gray-500">Memuat data pembelian...</td></tr>');try{const e=await fetch(`${API_URL}?sheet=pembelian`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();allPurchases=Array.isArray(t)?t:[],renderPurchaseTable(),renderAdminTable()}catch(t){console.error(t),e&&(e.innerHTML='<tr><td colspan="7" class="px-6 py-10 text-center text-red-500">Gagal memuat data pembelian. Pastikan sheet "pembelian" sudah ada dan GAS mengizinkan sheet tersebut.</td></tr>')}}function renderPurchaseTable(){const e=document.getElementById("purchase-list-body");if(!e)return;if(!Array.isArray(allPurchases)||0===allPurchases.length)return void(e.innerHTML='<tr><td colspan="7" class="px-6 py-10 text-center text-gray-500">Belum ada data pembelian.</td></tr>');const t=[...allPurchases].sort((e,t)=>{const a=parseOrderDate(e.tanggal||e.date||e.created_at||e.timestamp)||new Date(0);return(parseOrderDate(t.tanggal||t.date||t.created_at||t.timestamp)||new Date(0))-a});e.innerHTML=t.map(e=>{const t=e.product_id||e.productId||e.id_produk||"",a=allProducts.find(e=>String(e.id)===String(t)),n=escapeHtml(e.product_nama||a&&a.nama||"-"),r=escapeHtml(e.supplier||"-"),o=parseFloat(e.qty||e.jumlah||e.quantity||0),s=parseCurrencyValue(e.harga_modal||e.modal||e.cost||0),i=o*s,d=parseOrderDate(e.tanggal||e.date||e.created_at||e.timestamp),l=d?d.toLocaleDateString("id-ID"):"-";return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(l)}</td>\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">${n}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${r}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${Number.isFinite(o)?o:"-"}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">Rp ${Math.round(s||0).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4 text-sm text-gray-700 font-bold">Rp ${Math.round(i||0).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4 text-right">\n                <button data-action="delete-purchase" data-id="${escapeAttr(e.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n        `}).join("")}async function handleDeletePurchase(e){if(confirm("Hapus data pembelian ini?"))try{(await GASActions.delete("pembelian",e)).deleted>0&&(showAdminToast("Pembelian berhasil dihapus!","success"),fetchPurchases())}catch(e){console.error(e),showAdminToast("Gagal menghapus pembelian.","error")}}bundleForm&&bundleForm.addEventListener("submit",async e=>{e.preventDefault();const t=bundleForm.querySelector('button[type="submit"]'),a=t.innerText;t.disabled=!0,t.innerText="Menyimpan...";const n=Array.from(document.querySelectorAll(".bundle-item-row")).map(e=>{const t=e.querySelector(".bundle-item-product")?.value,a=parseInt(e.querySelector(".bundle-item-qty")?.value||"0",10),n=allProducts.find(e=>String(e.id)===String(t));return n&&a?{id:n.id,nama:n.nama,qty:a}:null}).filter(Boolean);if(0===n.length)return showAdminToast("Tambahkan minimal 1 item paket.","warning"),t.disabled=!1,void(t.innerText=a);const r=parseFloat(document.getElementById("bundle-discount")?.value||"0")||0,o=n.reduce((e,t)=>{const a=allProducts.find(e=>String(e.id)===String(t.id));return e+(a?parseCurrencyValue(a.harga):0)*t.qty},0),s=Math.max(0,o-o*r/100),i=document.getElementById("bundle-description"),d=i?.value||`Isi paket:\n${n.map(e=>`- ${e.nama} x${e.qty}`).join("\n")}`,l={id:Date.now().toString(),nama:document.getElementById("bundle-name").value,harga:Math.round(s),harga_coret:Math.round(o),gambar:document.getElementById("bundle-image").value,stok:document.getElementById("bundle-stock").value,kategori:document.getElementById("bundle-category").value,deskripsi:d,variasi:"",grosir:""};try{(await GASActions.create("products",l)).created>0&&(showAdminToast("Paket berhasil dibuat!","success"),bundleForm.reset(),document.getElementById("bundle-description").dataset.touched="",document.getElementById("bundle-items").innerHTML="",ensureBundleBuilderReady(),fetchAdminProducts())}catch(e){console.error(e),showAdminToast("Gagal membuat paket.","error")}finally{t.disabled=!1,t.innerText=a}}),document.getElementById("product-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("product-id").value,a=document.getElementById("submit-btn"),n=a.innerText;a.disabled=!0,a.innerText="Menyimpan...";const r=[document.getElementById("form-gambar-1").value,document.getElementById("form-gambar-2").value,document.getElementById("form-gambar-3").value].filter(e=>""!==e.trim()).join(","),o=collectVariants(),s=o.length>0?JSON.stringify(o):"",i={nama:document.getElementById("form-nama").value,harga:document.getElementById("form-harga").value,harga_coret:document.getElementById("form-harga-coret").value,stok:document.getElementById("form-stok").value,kategori:document.getElementById("form-category").value,deskripsi:document.getElementById("form-deskripsi").value,gambar:r,variasi:s};try{const e=t||Date.now().toString();let a;a=t?await GASActions.update("products",e,i):await GASActions.create("products",{...i,id:e}),(a.affected>0||a.created>0)&&(showAdminToast(t?"Produk berhasil diperbarui!":"Produk berhasil ditambahkan!","success"),closeModal(),fetchAdminProducts())}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat menyimpan data.","error")}finally{a.disabled=!1,a.innerText=n}});const purchaseForm=document.getElementById("purchase-form");async function fetchTukarPoin(){const e=document.getElementById("tukar-poin-list");e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data tukar poin...</td></tr>';try{const e=await fetch(`${API_URL}?sheet=tukar_poin`);if(!e.ok)throw new Error(`HTTP ${e.status}`);allTukarPoin=await e.json(),Array.isArray(allTukarPoin)||(allTukarPoin=[]),renderTukarPoinTable()}catch(t){console.error("Error:",t),e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat data tukar poin. Pastikan sheet "tukar_poin" sudah ada.</td></tr>'}}function renderTukarPoinTable(){const e=document.getElementById("tukar-poin-list");0!==allTukarPoin.length?e.innerHTML=allTukarPoin.map(e=>{const t=escapeHtml(e.judul||e.nama||""),a=escapeHtml(e.deskripsi||"-"),n=escapeHtml(e.poin);return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4" data-label="Produk">\n                <div class="flex items-center gap-3">\n                    <img src="${sanitizeUrl(e.gambar,"https://via.placeholder.com/50")}" class="w-10 h-10 object-cover rounded-lg bg-gray-100" alt="${t}">\n                    <span class="font-bold text-gray-800 text-sm">${t}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4 font-bold text-amber-600 text-sm" data-label="Poin">${n} Poin</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Deskripsi">${a}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2" data-label="Aksi">\n                <button data-action="edit-tukar-poin" data-id="${escapeAttr(e.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Edit">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-tukar-poin" data-id="${escapeAttr(e.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Hapus">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `}).join(""):e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada produk tukar poin.</td></tr>'}function openAddTukarPoinModal(){document.getElementById("tukar-poin-id").value="",document.getElementById("tukar-poin-form").reset(),document.getElementById("tukar-poin-modal-title").innerText="Tambah Produk Tukar Poin",document.getElementById("tukar-poin-submit-btn").innerText="Simpan",document.getElementById("tukar-poin-modal").classList.remove("hidden")}function openEditTukarPoinModal(e){const t=allTukarPoin.find(t=>t.id===e);t?(document.getElementById("tukar-poin-id").value=t.id,document.getElementById("form-tukar-judul").value=t.judul||"",document.getElementById("form-tukar-poin").value=t.poin||"",document.getElementById("form-tukar-gambar").value=t.gambar||"",document.getElementById("form-tukar-deskripsi").value=t.deskripsi||"",document.getElementById("tukar-poin-modal-title").innerText="Edit Produk Tukar Poin",document.getElementById("tukar-poin-submit-btn").innerText="Perbarui",document.getElementById("tukar-poin-modal").classList.remove("hidden")):showAdminToast("Produk tidak ditemukan!","error")}function closeTukarPoinModal(){document.getElementById("tukar-poin-modal").classList.add("hidden"),document.getElementById("tukar-poin-form").reset()}async function handleDeleteTukarPoin(e){if(confirm("Apakah Anda yakin ingin menghapus produk tukar poin ini?"))try{(await GASActions.delete("tukar_poin",e)).deleted>0?(showAdminToast("Produk tukar poin berhasil dihapus!","success"),fetchTukarPoin()):showAdminToast("Gagal menghapus produk.","error")}catch(e){console.error(e),showAdminToast("Gagal menghapus produk.","error")}}async function fetchUserPoints(){const e=document.getElementById("user-points-list");e.innerHTML='<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">Memuat data...</td></tr>';try{const t=await fetch(`${API_URL}?sheet=user_points`),a=await t.json();if(0===a.length)return void(e.innerHTML='<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">Belum ada data poin pengguna.</td></tr>');e.innerHTML=a.map(e=>{const t=escapeHtml(e.phone),a=escapeHtml(e.last_updated||"-");return`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-6 py-4 font-bold text-gray-800 text-sm" data-label="Telepon">${t}</td>\n                <td class="px-6 py-4 font-bold text-green-600 text-sm" data-label="Poin">${parseFloat(e.points).toFixed(1)} Poin</td>\n                <td class="px-6 py-4 text-xs text-gray-500" data-label="Terakhir Update">${a}</td>\n                <td class="px-6 py-4 text-right" data-label="Aksi">\n                    <button data-action="edit-user-points" data-phone="${escapeAttr(e.phone)}" data-points="${escapeAttr(e.points)}" class="text-blue-600 hover:underline text-sm font-bold">Edit Poin</button>\n                </td>\n            </tr>\n        `}).join("")}catch(e){console.error(e)}}async function editUserPoints(e,t){const a=prompt(`Masukkan saldo poin baru untuk ${e}:`,t);if(null!==a&&""!==a)try{const t=await fetch(`${API_URL}?sheet=user_points`),n=(await t.json()).find(t=>t.phone===e);if(!n||!n.id)return void showAdminToast("User tidak ditemukan!","error");(await GASActions.update("user_points",n.id,{points:parseFloat(a),last_updated:(new Date).toLocaleString("id-ID")})).affected>0&&(showAdminToast("Saldo poin diperbarui!","success"),fetchUserPoints())}catch(e){console.error(e),showAdminToast("Gagal memperbarui poin.","error")}}async function loadSettings(){const e=CONFIG.getAllConfig();document.getElementById("settings-main-api").value=e.mainApi,document.getElementById("settings-admin-api").value=e.adminApi,document.getElementById("gajian-target-day").value=e.gajian.targetDay,document.getElementById("gajian-default-markup").value=100*e.gajian.defaultMarkup,renderGajianMarkups(e.gajian.markups),document.getElementById("reward-point-value").value=e.reward.pointValue,document.getElementById("reward-min-point").value=e.reward.minPoint,renderRewardOverrides(e.reward.manualOverrides);const t=document.getElementById("margin-alert-threshold");if(t&&(t.value=e.marginAlert||CONFIG.getMarginAlertThreshold()),e.bundleDiscount){const t=document.getElementById("bundle-rule-34"),a=document.getElementById("bundle-rule-56"),n=document.getElementById("bundle-rule-7");t&&(t.value=e.bundleDiscount.rule34??5),a&&(a.value=e.bundleDiscount.rule56??8),n&&(n.value=e.bundleDiscount.rule7plus??10)}const a=await fetchSettingsRowsFromSheet(),n=getLatestSettingValue(a,"referral_enabled","true"),r=getLatestSettingValue(a,"referral_reward_referrer","20"),o=getLatestSettingValue(a,"referral_reward_referee","10"),s=getLatestSettingValue(a,"referral_min_first_order","50000"),i=document.getElementById("referral-enabled"),d=document.getElementById("referral-reward-referrer"),l=document.getElementById("referral-reward-referee"),c=document.getElementById("referral-min-first-order");i&&(i.value="false"===String(n).toLowerCase()?"false":"true"),d&&(d.value=parseInt(r,10)||20),l&&(l.value=parseInt(o,10)||10),c&&(c.value=parseInt(s,10)||5e4)}function renderGajianMarkups(e){document.getElementById("gajian-markups-table").innerHTML=e.map((e,t)=>`\n        <tr class="border-b border-gray-50">\n            <td class="py-2 px-2">${escapeHtml(e.minDays)} Hari</td>\n            <td class="py-2 px-2 font-bold text-green-600">${escapeHtml((100*e.rate).toFixed(1))}%</td>\n            <td class="py-2 px-2">\n                <button data-action="edit-markup" data-index="${t}" class="text-blue-600 hover:underline">Edit</button>\n            </td>\n        </tr>\n    `).join("")}function renderRewardOverrides(e){document.getElementById("reward-overrides-table").innerHTML=Object.entries(e).map(([e,t])=>`\n        <tr class="border-b border-gray-50">\n            <td class="py-2 px-2">${escapeHtml(e)}</td>\n            <td class="py-2 px-2 font-bold text-amber-600">${escapeHtml(t)} Poin</td>\n            <td class="py-2 px-2">\n                <button data-action="delete-reward-override" data-name="${escapeAttr(e)}" class="text-red-600 hover:underline">Hapus</button>\n            </td>\n        </tr>\n    `).join("")}async function saveSettings(){const e=document.getElementById("settings-main-api").value.trim(),t=document.getElementById("settings-admin-api").value.trim();if(!e||!t)return void showAdminToast("URL API tidak boleh kosong!","error");CONFIG.setMainApiUrl(e),CONFIG.setAdminApiUrl(t),API_URL=t,"undefined"!=typeof ApiService&&(ApiService.clearCache(),console.log("✅ Cache cleared after API URL change"));const a=parseInt(document.getElementById("gajian-target-day").value),n=parseFloat(document.getElementById("gajian-default-markup").value)/100,r=CONFIG.getGajianConfig();CONFIG.setGajianConfig({...r,targetDay:a,defaultMarkup:n});const o=parseInt(document.getElementById("reward-point-value").value),s=parseFloat(document.getElementById("reward-min-point").value),i=CONFIG.getRewardConfig();CONFIG.setRewardConfig({...i,pointValue:o,minPoint:s});const d=document.getElementById("margin-alert-threshold");d&&CONFIG.setMarginAlertThreshold(parseFloat(d.value));const l=document.getElementById("bundle-rule-34"),c=document.getElementById("bundle-rule-56"),u=document.getElementById("bundle-rule-7");l&&c&&u&&CONFIG.setBundleDiscountConfig&&CONFIG.setBundleDiscountConfig({rule34:parseFloat(l.value)||0,rule56:parseFloat(c.value)||0,rule7plus:parseFloat(u.value)||0});const p=document.getElementById("referral-enabled"),m=document.getElementById("referral-reward-referrer"),g=document.getElementById("referral-reward-referee"),h=document.getElementById("referral-min-first-order"),y=p?p.value:"true",f=m?parseInt(m.value||"20",10):20,b=g?parseInt(g.value||"10",10):10,v=h?parseInt(h.value||"50000",10):5e4;try{await Promise.all([GASActions.upsertSetting("referral_enabled",String(y)),GASActions.upsertSetting("referral_reward_referrer",String(f)),GASActions.upsertSetting("referral_reward_referee",String(b)),GASActions.upsertSetting("referral_min_first_order",String(v))])}catch(e){console.warn("upsert_setting not available, fallback to append create:",e);try{await Promise.all([GASActions.create("settings",{key:"referral_enabled",value:String(y)}),GASActions.create("settings",{key:"referral_reward_referrer",value:String(f)}),GASActions.create("settings",{key:"referral_reward_referee",value:String(b)}),GASActions.create("settings",{key:"referral_min_first_order",value:String(v)})]),showAdminToast("Fallback aktif: settings masih disimpan dengan metode append.","warning")}catch(e){console.warn("Fallback create settings failed:",e),showAdminToast("Pengaturan lokal tersimpan, tapi gagal simpan setting referral ke sheet.","warning")}}window.dispatchEvent(new Event("api-config-changed")),console.log("🔔 [ADMIN] Dispatched api-config-changed event to all listeners");const x=`✅ Pengaturan Berhasil Disimpan!\n\n📡 Main API: ${e.substring(0,40)}...\n🔧 Admin API: ${t.substring(0,40)}...\n🗑️ Cache cleared\n\n⏳ Reloading...`;alert(x),showAdminToast("Pengaturan berhasil disimpan! Halaman akan reload...","success"),setTimeout(()=>location.reload(),1500)}function openEditMarkupModal(e){const t=CONFIG.getGajianConfig().markups[e];t&&(document.getElementById("edit-markup-index").value=e,document.getElementById("edit-markup-min-days").value=t.minDays,document.getElementById("edit-markup-rate").value=(100*t.rate).toFixed(1),document.getElementById("edit-markup-modal").classList.remove("hidden"))}function closeEditMarkupModal(){document.getElementById("edit-markup-modal").classList.add("hidden")}function openAddOverrideModal(){document.getElementById("override-modal-title").innerText="Tambah Override Poin",document.getElementById("reward-override-form").reset();document.getElementById("override-product-name").innerHTML='<option value="">-- Pilih Produk --</option>'+allProducts.map(e=>{const t=escapeHtml(e.nama);return`<option value="${t}">${t}</option>`}).join(""),document.getElementById("reward-override-modal").classList.remove("hidden")}function closeRewardOverrideModal(){document.getElementById("reward-override-modal").classList.add("hidden")}function deleteRewardOverride(e){if(!confirm(`Hapus override untuk ${e}?`))return;const t=CONFIG.getRewardConfig();delete t.manualOverrides[e],CONFIG.setRewardConfig(t),renderRewardOverrides(t.manualOverrides),showAdminToast("Override poin dihapus!","success")}function showAdminToast(e,t="info"){let a=document.getElementById("admin-toast-container");a||(a=document.createElement("div"),a.id="admin-toast-container",a.className="fixed bottom-8 right-8 z-[100] flex flex-col gap-3",document.body.appendChild(a));const n=document.createElement("div");n.className=`${{success:"bg-green-600",error:"bg-red-600",warning:"bg-amber-500",info:"bg-blue-600"}[t]||"bg-gray-800"} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in-right min-w-[300px]`;const r={success:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',error:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',warning:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',info:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'};n.dataset.toast="admin",n.innerHTML=`\n        <div class="flex-shrink-0">${r[t]||r.info}</div>\n        <div class="flex-1 font-medium text-sm">${escapeHtml(e)}</div>\n        <button data-action="dismiss-admin-toast" class="flex-shrink-0 hover:bg-white/20 p-1 rounded-lg transition">\n            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>\n        </button>\n    `,a.appendChild(n),setTimeout(()=>{n.parentElement&&(n.classList.add("animate-fade-out"),setTimeout(()=>n.remove(),500))},4e3)}function bindAdminActions(){document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const a=t.dataset.action;if("show-section"!==a)if("logout"!==a)if("open-add-modal"!==a)if("filter-orders"!==a){if("order-page"===a){const e=parseInt(t.dataset.page,10);return void(Number.isNaN(e)||(currentOrderPage=e,renderOrderTable()))}if("open-add-tukar-poin"!==a)if("open-add-banner"!==a)if("refresh-user-points"!==a)if("open-add-override"!==a)if("test-main-api"!==a)if("test-admin-api"!==a)if("view-cache-stats"!==a)if("clear-api-cache"!==a)if("save-settings"!==a)if("close-edit-markup-modal"!==a)if("close-reward-override-modal"!==a)if("close-tukar-poin-modal"!==a)if("close-banner-modal"!==a)if("add-variant-row"!==a)if("close-product-modal"!==a)if("edit-category"!==a)if("delete-category"!==a)if("edit-product"!==a)if("delete-product"!==a)if("edit-tukar-poin"!==a)if("delete-tukar-poin"!==a)if("delete-purchase"!==a)if("edit-supplier"!==a)if("delete-supplier"!==a)if("reset-supplier-form"!==a)if("edit-cost"!==a)if("delete-cost"!==a)if("refresh-referrals"!==a)if("reconcile-referral-ledger"!==a)if("approve-referral"!==a)if("reject-referral"!==a)if("reset-cost-form"!==a){if("add-bundle-item"===a)return addBundleItemRow(),void updateBundleTotals();if("remove-bundle-item"!==a)if("apply-bundle-recommendation"!==a)if("edit-user-points"!==a){if("edit-markup"===a){const e=parseInt(t.dataset.index,10);return void(Number.isNaN(e)||openEditMarkupModal(e))}if("delete-reward-override"!==a){if("dismiss-admin-toast"===a){const e=t.closest('[data-toast="admin"]');return void(e&&e.remove())}"remove-variant-row"!==a||removeVariantRow(t)}else deleteRewardOverride(t.dataset.name)}else editUserPoints(t.dataset.phone,t.dataset.points);else applyBundleRecommendation();else removeBundleItemRow(t)}else resetMonthlyCostForm();else handleRejectReferral(t.dataset.id);else handleApproveReferral(t.dataset.id);else runReferralLedgerReconciliation();else fetchReferrals();else handleDeleteMonthlyCost(t.dataset.id);else openEditMonthlyCost(t.dataset.id);else resetSupplierForm();else handleDeleteSupplier(t.dataset.id);else openEditSupplier(t.dataset.id);else handleDeletePurchase(t.dataset.id);else handleDeleteTukarPoin(t.dataset.id);else openEditTukarPoinModal(t.dataset.id);else handleDelete(t.dataset.id);else openEditModal(t.dataset.id);else handleDeleteCategory(t.dataset.id);else openEditCategory(t.dataset.id,t.dataset.name,t.dataset.description);else closeModal();else addVariantRow();else"function"==typeof closeBannerModal&&closeBannerModal();else closeTukarPoinModal();else closeRewardOverrideModal();else closeEditMarkupModal();else saveSettings();else clearApiCache();else viewCacheStats();else testAdminApi();else testMainApi();else openAddOverrideModal();else fetchUserPoints();else"function"==typeof openAddBannerModal&&openAddBannerModal();else openAddTukarPoinModal()}else filterOrders(t.dataset.filter||"semua",t);else openAddModal();else logout();else showSection(t.dataset.section)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-action]");if(!t)return;const a=t.dataset.action;if("toggle-store-status"!==a){if("update-order-status"===a){updateOrderStatus(t.dataset.id,t.value,t)}}else toggleStoreStatus()}),document.addEventListener("input",e=>{const t=e.target.closest('[data-action="preview-variant-image"]');if(t)previewVariantImage(t);else{if(e.target.classList.contains("bundle-item-product")||e.target.classList.contains("bundle-item-qty")||"bundle-discount"===e.target.id){const t=document.getElementById("bundle-discount");t&&"bundle-discount"===e.target.id&&(t.dataset.auto="false"),updateBundleTotals()}"bundle-description"===e.target.id&&(e.target.dataset.touched="true")}})}function bindAdminImageFallbackHandler(){window.__adminImageFallbackHandlerAdded||(window.__adminImageFallbackHandlerAdded=!0,document.addEventListener("error",e=>{const t=e.target;if(!t||"IMG"!==t.tagName)return;const a=t.getAttribute("data-fallback-src"),n=t.getAttribute("data-fallback-action");a&&t.src!==a?t.src=a:"hide"===n&&(t.style.display="none")},!0))}function loadVariants(e){if(document.getElementById("variants-container").innerHTML="",e)try{const t=JSON.parse(e);Array.isArray(t)&&t.length>0&&t.forEach((e,t)=>{renderVariantRow(e,t)})}catch(e){console.error("Error parsing variants:",e)}}function renderVariantRow(e,t){const a=document.getElementById("variants-container"),n=document.createElement("div");n.className="bg-white p-4 rounded-lg border border-gray-200 variant-row",n.dataset.index=t;const r=e.harga_coret||"",o=e.gambar||"",s=e.grosir||"",i=escapeAttr(e.sku||""),d=escapeAttr(e.nama||""),l=escapeAttr(e.harga||""),c=escapeAttr(r),u=escapeAttr(e.stok||""),p=(escapeHtml(s),sanitizeUrl(o,""));n.innerHTML=`\n        <div class="grid grid-cols-2 gap-3 mb-3">\n            <div>\n                <label class="text-xs font-bold text-gray-600">SKU</label>\n                <input type="text" class="variant-sku w-full p-2 border rounded text-sm" value="${i}" placeholder="MG-1L" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Nama Varian</label>\n                <input type="text" class="variant-nama w-full p-2 border rounded text-sm" value="${d}" placeholder="1 Liter" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Harga (Rp)</label>\n                <input type="number" class="variant-harga w-full p-2 border rounded text-sm" value="${l}" placeholder="15000" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Harga Coret (Rp)</label>\n                <input type="number" class="variant-harga-coret w-full p-2 border rounded text-sm" value="${c}" placeholder="16000">\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Stok</label>\n                <input type="number" class="variant-stok w-full p-2 border rounded text-sm" value="${u}" placeholder="10" required>\n            </div>\n            <div class="col-span-2">\n                <label class="text-xs font-bold text-gray-600">URL Gambar Varian (Opsional)</label>\n                <input type="text" class="variant-gambar w-full p-2 border rounded text-sm mb-2" value="${escapeAttr(o)}" placeholder="https://example.com/variant-image.jpg" data-action="preview-variant-image">\n                <p class="text-[10px] text-gray-500 mb-2">Jika diisi, gambar ini akan tampil saat varian dipilih. Jika kosong, akan gunakan gambar produk utama.</p>\n                ${p?`<img src="${p}" class="variant-image-preview w-24 h-24 object-cover rounded border" data-fallback-src="https://placehold.co/96x96?text=Img" data-fallback-action="hide">`:""}\n            </div>\n        </div>\n        <div class="mb-3">\n            <label class="text-xs font-bold text-gray-600">Harga Grosir (JSON)</label>\n            <textarea class="variant-grosir w-full p-2 border rounded text-xs" rows="2" placeholder='[{"min_qty":5,"price":14000}]'>${escapeHtml(s)}</textarea>\n        </div>\n        <div class="flex justify-end">\n            <button type="button" data-action="remove-variant-row" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm font-bold transition">\n                Hapus Varian\n            </button>\n        </div>\n    `,a.appendChild(n)}function addVariantRow(){renderVariantRow({},document.getElementById("variants-container").children.length)}function removeVariantRow(e){e.closest(".variant-row").remove()}function collectVariants(){const e=document.querySelectorAll(".variant-row"),t=[];return e.forEach(e=>{const a=e.querySelector(".variant-sku").value.trim(),n=e.querySelector(".variant-nama").value.trim(),r=e.querySelector(".variant-harga").value.trim(),o=e.querySelector(".variant-harga-coret").value.trim(),s=e.querySelector(".variant-stok").value.trim(),i=e.querySelector(".variant-gambar").value.trim(),d=e.querySelector(".variant-grosir").value.trim();if(a&&n&&r&&s){const e={sku:a,nama:n,harga:parseInt(r),stok:parseInt(s)};o&&(e.harga_coret=parseInt(o)),i&&(e.gambar=i),d&&(e.grosir=d),t.push(e)}}),t}function previewVariantImage(e){const t=e.value.trim(),a=e.closest(".variant-row").querySelector(".variant-image-preview");if(a&&a.remove(),t){const a=sanitizeUrl(t,"");if(!a)return void showAdminToast("URL gambar tidak valid.","warning");const n=document.createElement("img");n.src=a,n.className="variant-image-preview w-24 h-24 object-cover rounded border mt-2",n.onerror=function(){this.style.display="none",showToast("Gagal memuat gambar. Periksa URL gambar.","error")},e.parentElement.appendChild(n)}}function updateCacheCount(){if("undefined"!=typeof ApiService){const e=ApiService.getCacheStats(),t=document.getElementById("cache-count");t&&(t.textContent=e.totalEntries)}}function clearApiCache(){if("undefined"==typeof ApiService)return void alert("ApiService tidak tersedia.");if(!confirm("Hapus semua cache API? Data akan di-fetch ulang dari server."))return;const e=ApiService.clearCache();alert(`✅ Cache berhasil dihapus!\n\n${e} entries dihapus.`),updateCacheCount()}function viewCacheStats(){if("undefined"==typeof ApiService)return void alert("ApiService tidak tersedia.");const e=ApiService.getCacheStats();let t="📊 STATISTIK CACHE API\n\n";t+=`Total Entries: ${e.totalEntries}\n`,t+=`Pending Requests: ${e.pendingRequests}\n\n`,e.entries.length>0?(t+="DETAIL CACHE:\n",t+=`${"=".repeat(40)}\n\n`,e.entries.forEach((e,a)=>{const n=e.key.split(":")[1]?.split("?")[1]||"unknown";t+=`${a+1}. ${n}\n`,t+=`   Age: ${e.age}s\n`,t+=`   Size: ${(e.size/1024).toFixed(2)} KB\n\n`})):t+="Tidak ada cache tersimpan.",alert(t)}async function testMainApi(){const e=document.getElementById("settings-main-api").value.trim(),t=document.getElementById("main-api-status");if(e)if(e.startsWith("http://")||e.startsWith("https://")){showApiStatus(t,"loading","⏳ Testing API...");try{const a=`${e}?sheet=products`,n=await fetch(a);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(!Array.isArray(r))throw new Error('Response bukan array. Pastikan sheet "products" ada di spreadsheet.');showApiStatus(t,"success",`✅ API Valid! Ditemukan ${r.length} produk.`)}catch(e){console.error("API Test Error:",e),showApiStatus(t,"error",`❌ API Error: ${e.message}`)}}else showApiStatus(t,"error","❌ API URL harus dimulai dengan http:// atau https://");else showApiStatus(t,"error","❌ API URL tidak boleh kosong!")}async function testAdminApi(){const e=document.getElementById("settings-admin-api").value.trim(),t=document.getElementById("admin-api-status");if(e)if(e.startsWith("http://")||e.startsWith("https://")){showApiStatus(t,"loading","⏳ Testing API...");try{const a=`${e}?sheet=products`,n=await fetch(a);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(!Array.isArray(r))throw new Error('Response bukan array. Pastikan sheet "products" ada di spreadsheet.');showApiStatus(t,"success",`✅ API Valid! Ditemukan ${r.length} produk.`)}catch(e){console.error("API Test Error:",e),showApiStatus(t,"error",`❌ API Error: ${e.message}`)}}else showApiStatus(t,"error","❌ API URL harus dimulai dengan http:// atau https://");else showApiStatus(t,"error","❌ API URL tidak boleh kosong!")}function showApiStatus(e,t,a){e.classList.remove("hidden","bg-green-100","text-green-700","bg-red-100","text-red-700","bg-yellow-100","text-yellow-700"),"success"===t?e.classList.add("bg-green-100","text-green-700"):"error"===t?e.classList.add("bg-red-100","text-red-700"):"loading"===t&&e.classList.add("bg-yellow-100","text-yellow-700"),e.textContent=a}purchaseForm&&purchaseForm.addEventListener("submit",async e=>{e.preventDefault();const t=purchaseForm.querySelector('button[type="submit"]'),a=t.innerText;t.disabled=!0,t.innerText="Menyimpan...";const n=document.getElementById("form-purchase-product").value,r=allProducts.find(e=>String(e.id)===String(n)),o={id:Date.now().toString(),product_id:n,product_nama:r?r.nama:"",supplier:document.getElementById("form-purchase-supplier").value,qty:document.getElementById("form-purchase-qty").value,harga_modal:document.getElementById("form-purchase-cost").value,tanggal:document.getElementById("form-purchase-date").value||(new Date).toISOString().slice(0,10)};try{(await GASActions.create("pembelian",o)).created>0&&(showAdminToast("Pembelian berhasil disimpan!","success"),purchaseForm.reset(),fetchPurchases())}catch(e){console.error(e);String(e&&e.message?e.message:e).includes("Invalid sheet")?showAdminToast('Sheet "pembelian" belum diizinkan di GAS. Tambahkan "pembelian" ke daftar sheet yang diizinkan.',"warning"):showAdminToast("Gagal menyimpan pembelian.","error")}finally{t.disabled=!1,t.innerText=a}}),document.getElementById("category-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("form-category-nama").value,a=document.getElementById("form-category-deskripsi").value,n=e.target.querySelector('button[type="submit"]'),r=n.innerHTML;n.disabled=!0,n.innerHTML="Menyimpan...";try{(await GASActions.create("categories",{id:Date.now().toString(),nama:t,deskripsi:a})).created>0&&(showAdminToast("Kategori berhasil ditambahkan!","success"),e.target.reset(),fetchCategories())}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat menyimpan data.","error")}finally{n.disabled=!1,n.innerHTML=r}}),document.getElementById("tukar-poin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("tukar-poin-id").value,a=document.getElementById("form-tukar-judul").value.trim(),n=document.getElementById("form-tukar-poin").value.trim(),r=document.getElementById("form-tukar-gambar").value.trim(),o=document.getElementById("form-tukar-deskripsi").value.trim();if(!a||!n||!r)return void showAdminToast("Semua field yang ditandai wajib diisi!","error");const s=e.target.querySelector('button[type="submit"]'),i=s.innerHTML;s.disabled=!0,s.innerHTML="Menyimpan...";try{const e={judul:a,poin:parseInt(n),gambar:r,deskripsi:o},s=t||Date.now().toString();let i;i=t?await GASActions.update("tukar_poin",s,e):await GASActions.create("tukar_poin",{...e,id:s}),i.created>0||i.affected>0?(showAdminToast(t?"Produk tukar poin berhasil diperbarui!":"Produk tukar poin berhasil ditambahkan!","success"),closeTukarPoinModal(),fetchTukarPoin()):showAdminToast("Gagal menyimpan data.","error")}catch(e){console.error(e),showAdminToast("Gagal menyimpan data.","error")}finally{s.disabled=!1,s.innerHTML=i}}),document.getElementById("edit-markup-form").addEventListener("submit",e=>{e.preventDefault();const t=parseInt(document.getElementById("edit-markup-index").value),a=parseInt(document.getElementById("edit-markup-min-days").value),n=parseFloat(document.getElementById("edit-markup-rate").value)/100,r=CONFIG.getGajianConfig();r.markups[t]={minDays:a,rate:n},r.markups.sort((e,t)=>t.minDays-e.minDays),CONFIG.setGajianConfig(r),renderGajianMarkups(r.markups),closeEditMarkupModal(),showAdminToast("Skema markup diperbarui!","success")}),document.getElementById("reward-override-form").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("override-product-name").value,a=parseFloat(document.getElementById("override-point-value").value),n=CONFIG.getRewardConfig();n.manualOverrides[t]=a,CONFIG.setRewardConfig(n),renderRewardOverrides(n.manualOverrides),closeRewardOverrideModal(),showAdminToast("Override poin disimpan!","success")}),document.addEventListener("DOMContentLoaded",()=>{showSection("dashboard"),bindAdminActions(),bindAdminImageFallbackHandler();const e=document.getElementById("referral-search");e&&e.addEventListener("input",e=>{referralSearch=e.target.value||"",renderReferralTable()});const t=document.getElementById("referral-filter-status");t&&t.addEventListener("change",e=>{referralFilterStatus=e.target.value||"all",renderReferralTable()})}),document.addEventListener("DOMContentLoaded",()=>{setInterval(updateCacheCount,5e3),updateCacheCount()});