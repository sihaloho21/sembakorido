var escapeHtml=window.AdminSanitize&&window.AdminSanitize.escapeHtml||(value=>String(value||""));var escapeAttr=window.AdminSanitize&&window.AdminSanitize.escapeAttr||(value=>String(value||""));var sanitizeUrl=window.AdminSanitize&&window.AdminSanitize.sanitizeUrl||(url=>String(url||""));if(localStorage.getItem("admin_logged_in")!=="true"){window.location.href="login.html"}function logout(){localStorage.removeItem("admin_logged_in");window.location.href="login.html"}let API_URL=CONFIG.getAdminApiUrl();const CATEGORIES_SHEET="categories";const PRODUCTS_SHEET="products";const ORDERS_SHEET="orders";const TUKAR_POIN_SHEET="tukar_poin";const PURCHASES_SHEET="pembelian";const SUPPLIERS_SHEET="suppliers";const MONTHLY_COST_SHEET="biaya_bulanan";let allProducts=[];let allCategories=[];let allOrders=[];let allTukarPoin=[];let allPurchases=[];let allSuppliers=[];let allMonthlyCosts=[];let currentOrderFilter="semua";let currentOrderPage=1;const ordersPerPage=10;function showSection(sectionId){document.querySelectorAll("main > section").forEach(s=>s.classList.add("hidden"));document.getElementById(`section-${sectionId}`).classList.remove("hidden");document.querySelectorAll(".sidebar-item").forEach(item=>item.classList.remove("active"));document.getElementById(`nav-${sectionId}`).classList.add("active");closeSidebarOnMobile();const titles={dashboard:"Dashboard",produk:"Produk",bundle:"Bundle Builder",pembelian:"Pembelian",suppliers:"Supplier",biaya:"Biaya Operasional",kategori:"Kategori",pesanan:"Pesanan","tukar-poin":"Tukar Poin",banners:"Banner Promosi","user-points":"Poin Pengguna","tiered-pricing":"Harga Grosir Bertingkat",pengaturan:"Pengaturan"};document.getElementById("section-title").innerText=titles[sectionId];if(sectionId==="kategori")fetchCategories();if(sectionId==="produk")fetchAdminProducts();if(sectionId==="bundle"){if(allProducts.length===0||allCategories.length===0){fetchAdminProducts();fetchCategories()}ensureBundleBuilderReady()}if(sectionId==="pembelian"){if(allProducts.length===0)fetchAdminProducts();fetchPurchases()}if(sectionId==="suppliers")fetchSuppliers();if(sectionId==="biaya")fetchMonthlyCosts();if(sectionId==="pesanan")fetchOrders();if(sectionId==="tukar-poin")fetchTukarPoin();if(sectionId==="banners")fetchBanners();if(sectionId==="user-points")fetchUserPoints();if(sectionId==="tiered-pricing")fetchTieredPricingProducts();if(sectionId==="dashboard"){updateDashboardStats();loadStoreStatus()}if(sectionId==="pengaturan")loadSettings()}function closeSidebarOnMobile(){if(window.innerWidth>768)return;const sidebar=document.querySelector("aside");const overlay=document.querySelector(".sidebar-overlay");const hamburger=document.querySelector(".hamburger-menu");if(sidebar)sidebar.classList.remove("active");if(overlay)overlay.classList.remove("active");if(hamburger){hamburger.setAttribute("aria-expanded","false");const openIcon=hamburger.querySelector(".hamburger-icon");const closeIcon=hamburger.querySelector(".close-icon");if(openIcon)openIcon.classList.remove("hidden");if(closeIcon)closeIcon.classList.add("hidden")}document.body.style.overflow=""}function loadStoreStatus(){const isClosed=CONFIG.isStoreClosed();const toggle=document.getElementById("store-closed-toggle");const label=document.getElementById("store-status-label");if(toggle&&label){toggle.checked=isClosed;if(isClosed){label.innerText="TOKO TUTUP";label.className="text-sm font-bold px-3 py-1 rounded-full bg-red-100 text-red-700"}else{label.innerText="TOKO BUKA";label.className="text-sm font-bold px-3 py-1 rounded-full bg-green-100 text-green-700"}}}function toggleStoreStatus(){const toggle=document.getElementById("store-closed-toggle");const isClosed=toggle.checked;CONFIG.setStoreClosed(isClosed);loadStoreStatus();showAdminToast(isClosed?"Toko sekarang TUTUP":"Toko sekarang BUKA",isClosed?"warning":"success")}async function updateDashboardStats(){try{const[prodRes,orderRes,purchaseRes,costRes]=await Promise.all([fetch(`${API_URL}?sheet=${PRODUCTS_SHEET}`),fetch(`${API_URL}?sheet=${ORDERS_SHEET}`),fetch(`${API_URL}?sheet=${PURCHASES_SHEET}`),fetch(`${API_URL}?sheet=${MONTHLY_COST_SHEET}`)]);const prods=await prodRes.json();const orders=await orderRes.json();const purchases=purchaseRes.ok?await purchaseRes.json():[];const costs=costRes.ok?await costRes.json():[];allProducts=Array.isArray(prods)?prods:[];allPurchases=Array.isArray(purchases)?purchases:[];allMonthlyCosts=Array.isArray(costs)?costs:[];document.getElementById("stat-total-produk").innerText=prods.length||0;document.getElementById("stat-total-pesanan").innerText=orders.length||0;const lowStock=prods.filter(p=>parseInt(p.stok)<=5).length;document.getElementById("stat-stok-menipis").innerText=lowStock;const normalizedOrders=Array.isArray(orders)?orders:[];allOrders=normalizedOrders;updateRevenueStats(normalizedOrders);renderRecentOrders(normalizedOrders)}catch(e){console.error(e)}}function renderRecentOrders(orders){const tableBody=document.getElementById("recent-orders-list");if(!tableBody)return;if(!Array.isArray(orders)||orders.length===0){tableBody.innerHTML='<tr><td colspan="4" class="px-6 py-6 text-center text-gray-500">Belum ada pesanan.</td></tr>';return}const sorted=[...orders].sort((a,b)=>{const dateA=parseOrderDate(a.tanggal_pesanan||a.timestamp||a.tanggal||a.date)||new Date(0);const dateB=parseOrderDate(b.tanggal_pesanan||b.timestamp||b.tanggal||b.date)||new Date(0);return dateB-dateA}).slice(0,5);tableBody.innerHTML=sorted.map(order=>{const safeId=escapeHtml(order.id||"-");const safeCustomer=escapeHtml(order.pelanggan||order.customer||order.nama||"-");const statusText=escapeHtml(order.status||"Menunggu");const statusClass=String(order.status||"").toLowerCase().replace(/[^a-z0-9_-]/g,"");const totalText=`Rp ${parseCurrencyValue(order.total||order.total_bayar||0).toLocaleString("id-ID")}`;return`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-6 py-4 text-xs font-bold text-blue-600" data-label="ID">${safeId}</td>\n                <td class="px-6 py-4 text-sm text-gray-800" data-label="Pelanggan">${safeCustomer}</td>\n                <td class="px-6 py-4" data-label="Status">\n                    <span class="status-badge status-${statusClass}">${statusText}</span>\n                </td>\n                <td class="px-6 py-4 text-right font-bold text-gray-800" data-label="Total">${totalText}</td>\n            </tr>\n        `}).join("")}function updateRevenueStats(orders){const dailyEl=document.getElementById("stat-omzet-harian");const dailyHppEl=document.getElementById("stat-hpp-harian");const dailyProfitEl=document.getElementById("stat-profit-harian");const summaryOmzetEl=document.getElementById("summary-omzet-30d");const summaryHppEl=document.getElementById("summary-hpp-30d");const summaryProfitEl=document.getElementById("summary-profit-30d");const summaryMarginEl=document.getElementById("summary-margin-30d");const summaryCostEl=document.getElementById("summary-cost-30d");const summaryNetEl=document.getElementById("summary-net-30d");if(!dailyEl&&!dailyHppEl&&!summaryOmzetEl&&!summaryHppEl)return;const now=new Date;const startOfToday=new Date(now.getFullYear(),now.getMonth(),now.getDate());const startOf30Days=new Date(startOfToday);startOf30Days.setDate(startOf30Days.getDate()-29);let dailyTotal=0;let dailyHpp=0;let total30=0;let hpp30=0;orders.forEach(order=>{const orderDate=parseOrderDate(order.tanggal_pesanan||order.timestamp||order.tanggal||order.date);if(!orderDate)return;const amount=parseCurrencyValue(order.total||order.total_bayar||order.totalBayar||0);const orderHpp=calculateOrderHpp(order);if(orderDate>=startOfToday){dailyTotal+=amount;dailyHpp+=orderHpp}if(orderDate>=startOf30Days){total30+=amount;hpp30+=orderHpp}});if(dailyEl)dailyEl.innerText=`Rp ${dailyTotal.toLocaleString("id-ID")}`;if(dailyHppEl)dailyHppEl.innerText=`Rp ${Math.round(dailyHpp).toLocaleString("id-ID")}`;if(dailyProfitEl)dailyProfitEl.innerText=`Rp ${Math.round(dailyTotal-dailyHpp).toLocaleString("id-ID")}`;const monthlyCost=calculateMonthlyCostTotal();if(summaryOmzetEl)summaryOmzetEl.innerText=`Rp ${total30.toLocaleString("id-ID")}`;if(summaryHppEl)summaryHppEl.innerText=`Rp ${Math.round(hpp30).toLocaleString("id-ID")}`;if(summaryProfitEl)summaryProfitEl.innerText=`Rp ${Math.round(total30-hpp30).toLocaleString("id-ID")}`;if(summaryCostEl)summaryCostEl.innerText=`Rp ${Math.round(monthlyCost).toLocaleString("id-ID")}`;if(summaryNetEl)summaryNetEl.innerText=`Rp ${Math.round(total30-hpp30-monthlyCost).toLocaleString("id-ID")}`;if(summaryMarginEl){const margin=total30>0?(total30-hpp30)/total30*100:0;summaryMarginEl.innerText=`${margin.toFixed(1)}%`}}function parseOrderDate(value){if(!value)return null;if(value instanceof Date&&!Number.isNaN(value.getTime()))return value;if(typeof value==="number"){const date=new Date(value);return Number.isNaN(date.getTime())?null:date}const str=String(value).trim();if(!str)return null;const byDate=new Date(str);if(!Number.isNaN(byDate.getTime()))return byDate;if(str.includes("/")){const parts=str.split("/").map(p=>p.trim());if(parts.length>=3){const day=parseInt(parts[0],10);const month=parseInt(parts[1],10);const year=parseInt(parts[2],10);if(!Number.isNaN(day)&&!Number.isNaN(month)&&!Number.isNaN(year)){return new Date(year,month-1,day)}}}return null}function parseCurrencyValue(value){if(typeof value==="number")return value;if(!value)return 0;const cleaned=String(value).replace(/[^0-9.-]/g,"");const parsed=parseFloat(cleaned);return Number.isNaN(parsed)?0:parsed}function calculateMonthlyCostTotal(){if(!Array.isArray(allMonthlyCosts))return 0;return allMonthlyCosts.reduce((sum,cost)=>{const active=String(cost.aktif||cost.status||"Ya").toLowerCase();if(active!=="ya"&&active!=="aktif")return sum;const amount=parseCurrencyValue(cost.nominal||cost.amount||0);return sum+amount},0)}function getBundleRules(){if(CONFIG.getBundleDiscountConfig){return CONFIG.getBundleDiscountConfig()}return{rule34:5,rule56:8,rule7plus:10}}function recommendBundleDiscount(itemCount){const rules=getBundleRules();if(itemCount>=7)return rules.rule7plus;if(itemCount>=5)return rules.rule56;if(itemCount>=3)return rules.rule34;return 0}function ensureBundleBuilderReady(){const itemsContainer=document.getElementById("bundle-items");if(!itemsContainer)return;if(itemsContainer.children.length===0){addBundleItemRow();addBundleItemRow()}updateBundleCategoryDropdown();updateBundleTotals()}function addBundleItemRow(){const container=document.getElementById("bundle-items");if(!container)return;const row=document.createElement("div");row.className="grid grid-cols-1 md:grid-cols-3 gap-3 items-center bundle-item-row";row.innerHTML=`\n        <div>\n            <select class="bundle-item-product w-full p-3 border border-gray-300 rounded-xl outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100">\n                <option value="">-- Pilih Produk --</option>\n                ${allProducts.map(p=>`<option value="${escapeAttr(p.id)}">${escapeHtml(p.nama)}</option>`).join("")}\n            </select>\n        </div>\n        <div>\n            <input type="number" min="1" step="1" value="1" class="bundle-item-qty w-full p-3 border border-gray-300 rounded-xl outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100">\n        </div>\n        <div class="flex items-center gap-2">\n            <span class="bundle-item-subtotal text-sm text-gray-600 flex-1">Rp 0</span>\n            <button type="button" data-action="remove-bundle-item" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-bold transition">\n                Hapus\n            </button>\n        </div>\n    `;container.appendChild(row)}function refreshBundleItemOptions(){const selects=document.querySelectorAll(".bundle-item-product");if(!selects.length)return;const optionsHtml='<option value="">-- Pilih Produk --</option>'+allProducts.map(p=>`<option value="${escapeAttr(p.id)}">${escapeHtml(p.nama)}</option>`).join("");selects.forEach(select=>{const currentVal=select.value;select.innerHTML=optionsHtml;select.value=currentVal})}function removeBundleItemRow(button){const row=button.closest(".bundle-item-row");if(row)row.remove();updateBundleTotals()}function updateBundleTotals(){const rows=Array.from(document.querySelectorAll(".bundle-item-row"));let total=0;let itemCount=0;const itemsDesc=[];rows.forEach(row=>{const productId=row.querySelector(".bundle-item-product")?.value;const qty=parseInt(row.querySelector(".bundle-item-qty")?.value||"0",10);const product=allProducts.find(p=>String(p.id)===String(productId));const price=product?parseCurrencyValue(product.harga):0;const itemTotal=price*(Number.isFinite(qty)?qty:0);total+=itemTotal;if(product&&qty>0){itemCount+=1;itemsDesc.push(`- ${product.nama} x${qty}`)}const subtotalEl=row.querySelector(".bundle-item-subtotal");if(subtotalEl)subtotalEl.textContent=`Rp ${Math.round(itemTotal).toLocaleString("id-ID")}`});const totalEl=document.getElementById("bundle-total");if(totalEl)totalEl.value=`Rp ${Math.round(total).toLocaleString("id-ID")}`;const discountEl=document.getElementById("bundle-discount");if(discountEl&&(discountEl.value===""||discountEl.dataset.auto==="true")){const rec=recommendBundleDiscount(itemCount);discountEl.value=rec;discountEl.dataset.auto="true"}const discount=parseFloat(discountEl?.value||"0")||0;const finalPrice=Math.max(0,total-total*discount/100);const finalEl=document.getElementById("bundle-final");if(finalEl)finalEl.value=`Rp ${Math.round(finalPrice).toLocaleString("id-ID")}`;const descEl=document.getElementById("bundle-description");if(descEl&&!descEl.dataset.touched){descEl.value=`Isi paket:\\n${itemsDesc.join("\\n")}`}}function applyBundleRecommendation(){const rows=Array.from(document.querySelectorAll(".bundle-item-row"));const itemCount=rows.reduce((count,row)=>{const productId=row.querySelector(".bundle-item-product")?.value;const qty=parseInt(row.querySelector(".bundle-item-qty")?.value||"0",10);if(productId&&qty>0)return count+1;return count},0);const discountEl=document.getElementById("bundle-discount");if(discountEl){discountEl.value=recommendBundleDiscount(itemCount);discountEl.dataset.auto="true"}updateBundleTotals()}function parseOrderItems(itemsText){if(!itemsText)return[];return String(itemsText).split("|").map(part=>part.trim()).filter(Boolean).map(part=>{const match=part.match(/(.+)\(x\s*([0-9]+)\)/i);let name=match?match[1].trim():part;const qty=match?parseInt(match[2],10):1;name=name.replace(/\s*\([^)]*\)\s*$/,"").trim();return{name:name,qty:Number.isFinite(qty)?qty:1}})}function calculateOrderHpp(order){const items=parseOrderItems(order.produk||"");if(items.length===0)return 0;let totalHpp=0;items.forEach(item=>{const product=allProducts.find(p=>String(p.nama).trim().toLowerCase()===String(item.name).trim().toLowerCase());if(!product)return;const stats=getPurchaseStats(product.id);if(stats.avgCost>0){totalHpp+=stats.avgCost*item.qty}});return totalHpp}async function fetchSuppliers(){const tbody=document.getElementById("supplier-list-body");if(tbody){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data supplier...</td></tr>'}try{const response=await fetch(`${API_URL}?sheet=${SUPPLIERS_SHEET}`);if(!response.ok)throw new Error(`HTTP ${response.status}`);const data=await response.json();allSuppliers=Array.isArray(data)?data:[];renderSuppliersTable();updateSupplierDatalist()}catch(error){console.error(error);if(tbody){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat data supplier. Pastikan sheet "suppliers" sudah ada.</td></tr>'}}}function renderSuppliersTable(){const tbody=document.getElementById("supplier-list-body");if(!tbody)return;if(!Array.isArray(allSuppliers)||allSuppliers.length===0){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada supplier.</td></tr>';return}tbody.innerHTML=allSuppliers.map(s=>{const safeName=escapeHtml(s.nama||s.name||"");const safePhone=escapeHtml(s.phone||s.kontak||"");const safeAddress=escapeHtml(s.alamat||s.address||"");const safeNotes=escapeHtml(s.catatan||s.notes||"");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">${safeName}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${safePhone}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${safeAddress}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${safeNotes}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button data-action="edit-supplier" data-id="${escapeAttr(s.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-supplier" data-id="${escapeAttr(s.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n        `}).join("")}function resetSupplierForm(){const form=document.getElementById("supplier-form");if(form)form.reset();const idField=document.getElementById("form-supplier-id");if(idField)idField.value=""}function openEditSupplier(id){const supplier=allSuppliers.find(s=>String(s.id)===String(id));if(!supplier)return;document.getElementById("form-supplier-id").value=supplier.id;document.getElementById("form-supplier-name").value=supplier.nama||supplier.name||"";document.getElementById("form-supplier-phone").value=supplier.phone||supplier.kontak||"";document.getElementById("form-supplier-address").value=supplier.alamat||supplier.address||"";document.getElementById("form-supplier-notes").value=supplier.catatan||supplier.notes||""}async function handleDeleteSupplier(id){if(!confirm("Hapus supplier ini?"))return;try{const result=await GASActions.delete(SUPPLIERS_SHEET,id);if(result.deleted>0){showAdminToast("Supplier berhasil dihapus!","success");fetchSuppliers()}}catch(error){console.error(error);showAdminToast("Gagal menghapus supplier.","error")}}const supplierForm=document.getElementById("supplier-form");if(supplierForm){supplierForm.addEventListener("submit",async e=>{e.preventDefault();const submitBtn=supplierForm.querySelector('button[type="submit"]');const originalText=submitBtn.innerText;submitBtn.disabled=true;submitBtn.innerText="Menyimpan...";const id=document.getElementById("form-supplier-id").value||Date.now().toString();const data={id:id,nama:document.getElementById("form-supplier-name").value,phone:document.getElementById("form-supplier-phone").value,alamat:document.getElementById("form-supplier-address").value,catatan:document.getElementById("form-supplier-notes").value};try{const result=document.getElementById("form-supplier-id").value?await GASActions.update(SUPPLIERS_SHEET,id,data):await GASActions.create(SUPPLIERS_SHEET,data);if(result.affected>0||result.created>0){showAdminToast("Supplier berhasil disimpan!","success");resetSupplierForm();fetchSuppliers()}}catch(error){console.error(error);showAdminToast("Gagal menyimpan supplier.","error")}finally{submitBtn.disabled=false;submitBtn.innerText=originalText}})}async function fetchMonthlyCosts(){const tbody=document.getElementById("monthly-cost-list-body");if(tbody){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data biaya...</td></tr>'}try{const response=await fetch(`${API_URL}?sheet=${MONTHLY_COST_SHEET}`);if(!response.ok)throw new Error(`HTTP ${response.status}`);const data=await response.json();allMonthlyCosts=Array.isArray(data)?data:[];renderMonthlyCostsTable();updateRevenueStats(allOrders||[])}catch(error){console.error(error);if(tbody){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat biaya. Pastikan sheet "biaya_bulanan" sudah ada.</td></tr>'}}}function renderMonthlyCostsTable(){const tbody=document.getElementById("monthly-cost-list-body");if(!tbody)return;if(!Array.isArray(allMonthlyCosts)||allMonthlyCosts.length===0){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada biaya.</td></tr>';return}tbody.innerHTML=allMonthlyCosts.map(c=>{const safeName=escapeHtml(c.nama||c.name||"");const amount=parseCurrencyValue(c.nominal||c.amount||0);const status=escapeHtml(c.aktif||c.status||"Ya");const notes=escapeHtml(c.catatan||c.notes||"");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">${safeName}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">Rp ${Math.round(amount).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${status}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${notes}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button data-action="edit-cost" data-id="${escapeAttr(c.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-cost" data-id="${escapeAttr(c.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n        `}).join("")}function resetMonthlyCostForm(){const form=document.getElementById("monthly-cost-form");if(form)form.reset();const idField=document.getElementById("form-cost-id");if(idField)idField.value=""}function openEditMonthlyCost(id){const cost=allMonthlyCosts.find(c=>String(c.id)===String(id));if(!cost)return;document.getElementById("form-cost-id").value=cost.id;document.getElementById("form-cost-name").value=cost.nama||cost.name||"";document.getElementById("form-cost-amount").value=parseCurrencyValue(cost.nominal||cost.amount||0);document.getElementById("form-cost-active").value=cost.aktif||cost.status||"Ya";document.getElementById("form-cost-notes").value=cost.catatan||cost.notes||""}async function handleDeleteMonthlyCost(id){if(!confirm("Hapus biaya ini?"))return;try{const result=await GASActions.delete(MONTHLY_COST_SHEET,id);if(result.deleted>0){showAdminToast("Biaya berhasil dihapus!","success");fetchMonthlyCosts()}}catch(error){console.error(error);showAdminToast("Gagal menghapus biaya.","error")}}const monthlyCostForm=document.getElementById("monthly-cost-form");if(monthlyCostForm){monthlyCostForm.addEventListener("submit",async e=>{e.preventDefault();const submitBtn=monthlyCostForm.querySelector('button[type="submit"]');const originalText=submitBtn.innerText;submitBtn.disabled=true;submitBtn.innerText="Menyimpan...";const id=document.getElementById("form-cost-id").value||Date.now().toString();const data={id:id,nama:document.getElementById("form-cost-name").value,nominal:document.getElementById("form-cost-amount").value,aktif:document.getElementById("form-cost-active").value,catatan:document.getElementById("form-cost-notes").value};try{const result=document.getElementById("form-cost-id").value?await GASActions.update(MONTHLY_COST_SHEET,id,data):await GASActions.create(MONTHLY_COST_SHEET,data);if(result.affected>0||result.created>0){showAdminToast("Biaya berhasil disimpan!","success");resetMonthlyCostForm();fetchMonthlyCosts()}}catch(error){console.error(error);showAdminToast("Gagal menyimpan biaya.","error")}finally{submitBtn.disabled=false;submitBtn.innerText=originalText}})}const bundleForm=document.getElementById("bundle-form");if(bundleForm){bundleForm.addEventListener("submit",async e=>{e.preventDefault();const submitBtn=bundleForm.querySelector('button[type="submit"]');const originalText=submitBtn.innerText;submitBtn.disabled=true;submitBtn.innerText="Menyimpan...";const rows=Array.from(document.querySelectorAll(".bundle-item-row"));const items=rows.map(row=>{const productId=row.querySelector(".bundle-item-product")?.value;const qty=parseInt(row.querySelector(".bundle-item-qty")?.value||"0",10);const product=allProducts.find(p=>String(p.id)===String(productId));if(!product||!qty)return null;return{id:product.id,nama:product.nama,qty:qty}}).filter(Boolean);if(items.length===0){showAdminToast("Tambahkan minimal 1 item paket.","warning");submitBtn.disabled=false;submitBtn.innerText=originalText;return}const totalText=document.getElementById("bundle-total")?.value||"0";const finalText=document.getElementById("bundle-final")?.value||"0";const totalValue=parseCurrencyValue(totalText);const finalValue=parseCurrencyValue(finalText);const descriptionEl=document.getElementById("bundle-description");const description=descriptionEl?.value||`Isi paket:\\n${items.map(i=>`- ${i.nama} x${i.qty}`).join("\\n")}`;const data={id:Date.now().toString(),nama:document.getElementById("bundle-name").value,harga:Math.round(finalValue),harga_coret:Math.round(totalValue),gambar:document.getElementById("bundle-image").value,stok:document.getElementById("bundle-stock").value,kategori:document.getElementById("bundle-category").value,deskripsi:description,variasi:"",grosir:""};try{const result=await GASActions.create(PRODUCTS_SHEET,data);if(result.created>0){showAdminToast("Paket berhasil dibuat!","success");bundleForm.reset();document.getElementById("bundle-description").dataset.touched="";document.getElementById("bundle-items").innerHTML="";ensureBundleBuilderReady();fetchAdminProducts()}}catch(error){console.error(error);showAdminToast("Gagal membuat paket.","error")}finally{submitBtn.disabled=false;submitBtn.innerText=originalText}})}async function fetchOrders(){const tbody=document.getElementById("order-list-body");tbody.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Memuat data pesanan...</td></tr>';try{const response=await fetch(`${API_URL}?sheet=${ORDERS_SHEET}`);allOrders=await response.json();if(!Array.isArray(allOrders))allOrders=[];renderOrderTable();updateOrderStats()}catch(error){console.error("Error:",error);tbody.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-red-500">Gagal memuat data pesanan.</td></tr>'}}function updateOrderStats(){const total=allOrders.length;const pending=allOrders.filter(o=>o.status.toLowerCase()==="menunggu").length;const revenue=allOrders.reduce((acc,o)=>acc+(parseInt(o.total)||0),0);const avg=total>0?Math.round(revenue/total):0;document.getElementById("order-stat-total").innerText=total;document.getElementById("order-stat-pending").innerText=pending;document.getElementById("order-stat-revenue").innerText=`Rp ${revenue.toLocaleString("id-ID")}`;document.getElementById("order-stat-avg").innerText=`Rp ${avg.toLocaleString("id-ID")}`;document.getElementById("order-count-display").innerText=`(${total})`}function filterOrders(status,target){currentOrderFilter=status;currentOrderPage=1;document.querySelectorAll(".filter-btn").forEach(btn=>{btn.classList.remove("active","bg-green-600","text-white");btn.classList.add("bg-gray-100","text-gray-600")});if(target){target.classList.add("active","bg-green-600","text-white");target.classList.remove("bg-gray-100","text-gray-600")}renderOrderTable()}function renderOrderTable(){const tbody=document.getElementById("order-list-body");const pagination=document.getElementById("order-pagination-admin");const filtered=(currentOrderFilter==="semua"?allOrders:allOrders.filter(o=>String(o.status||"").toLowerCase()===currentOrderFilter.toLowerCase())).slice().sort((a,b)=>{const dateA=parseOrderDate(a.tanggal_pesanan||a.timestamp||a.tanggal||a.date)||new Date(0);const dateB=parseOrderDate(b.tanggal_pesanan||b.timestamp||b.tanggal||b.date)||new Date(0);return dateB-dateA});if(filtered.length===0){tbody.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Tidak ada pesanan.</td></tr>';if(pagination)pagination.innerHTML="";return}const totalPages=Math.ceil(filtered.length/ordersPerPage);const startIndex=(currentOrderPage-1)*ordersPerPage;const endIndex=Math.min(startIndex+ordersPerPage,filtered.length);const visibleOrders=filtered.slice(startIndex,endIndex);tbody.innerHTML=visibleOrders.map(o=>{const safeId=escapeHtml(o.id);const safeCustomer=escapeHtml(o.pelanggan);const safeProduct=escapeHtml(o.produk);const safeQty=escapeHtml(o.qty);const safeStatusText=escapeHtml(o.status);const safeStatusClass=String(o.status||"").toLowerCase().replace(/[^a-z0-9_-]/g,"");const safeDate=escapeHtml(o.tanggal||"");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 font-bold text-blue-600 text-xs" data-label="ID Pesanan">${safeId}</td>\n            <td class="px-6 py-4 text-sm text-gray-800 font-medium" data-label="Pelanggan">${safeCustomer}</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Produk">${safeProduct}</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Qty">${safeQty}</td>\n            <td class="px-6 py-4 text-sm font-bold text-gray-800" data-label="Total">Rp ${parseInt(o.total).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4" data-label="Status">\n                <span class="status-badge status-${safeStatusClass}">${safeStatusText}</span>\n            </td>\n            <td class="px-6 py-4 text-xs text-gray-500" data-label="Tanggal">${safeDate}</td>\n            <td class="px-6 py-4 text-right" data-label="Aksi">\n                <select data-action="update-order-status" data-id="${escapeAttr(o.id)}" class="text-xs border rounded-lg p-1 outline-none focus:ring-1 focus:ring-green-500">\n                    <option value="">Ubah Status</option>\n                    <option value="Menunggu">Menunggu</option>\n                    <option value="Diproses">Diproses</option>\n                    <option value="Dikirim">Dikirim</option>\n                    <option value="Terima">Terima</option>\n                    <option value="Dibatalkan">Dibatalkan</option>\n                </select>\n            </td>\n        </tr>\n    `}).join("");if(pagination){pagination.innerHTML=renderOrderPagination(totalPages)}}function renderOrderPagination(totalPages){if(totalPages<=1)return"";let html='<div class="flex flex-wrap justify-center items-center gap-2">';if(currentOrderPage>1){html+=`<button data-action="order-page" data-page="${currentOrderPage-1}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-xs">← Prev</button>`}const maxButtons=5;let start=Math.max(1,currentOrderPage-2);let end=Math.min(totalPages,start+maxButtons-1);if(end-start<maxButtons-1){start=Math.max(1,end-maxButtons+1)}for(let i=start;i<=end;i++){if(i===currentOrderPage){html+=`<button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-xs">${i}</button>`}else{html+=`<button data-action="order-page" data-page="${i}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-xs">${i}</button>`}}if(currentOrderPage<totalPages){html+=`<button data-action="order-page" data-page="${currentOrderPage+1}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-xs">Next →</button>`}html+="</div>";return html}function normalizePhone(phone){if(!phone)return"";let p=phone.toString().replace(/[^0-9]/g,"");if(p.startsWith("62"))p="0"+p.slice(2);else if(p.startsWith("8"))p="0"+p;else if(!p.startsWith("0"))p="0"+p;return p}async function updateOrderStatus(id,newStatus,selectElement){if(!newStatus)return;if(!selectElement)return;selectElement.disabled=true;try{const order=allOrders.find(o=>o.id===id);if(!order){showAdminToast("Pesanan tidak ditemukan!","error");selectElement.disabled=false;return}const result=await GASActions.update(ORDERS_SHEET,id,{status:newStatus});if(result.affected>0){if(newStatus==="Terima"&&order.point_processed!=="Yes"){if(order.phone&&order.poin){const pointsToAdd=parseFloat(order.poin)||0;const phone=normalizePhone(order.phone);const userRes=await fetch(`${API_URL}?sheet=user_points`);const allUsers=await userRes.json();const userData=Array.isArray(allUsers)?allUsers.filter(u=>normalizePhone(u.phone)===phone):[];let pointUpdateSuccess=false;if(Array.isArray(userData)&&userData.length>0){const currentPoints=parseFloat(userData[0].points)||0;const updateRes=await GASActions.update("user_points",userData[0].id,{points:currentPoints+pointsToAdd,last_updated:(new Date).toLocaleString("id-ID")});if(updateRes.affected>0)pointUpdateSuccess=true}else{const createRes=await GASActions.create("user_points",{id:Date.now().toString(),phone:phone,points:pointsToAdd,last_updated:(new Date).toLocaleString("id-ID")});if(createRes.created>0)pointUpdateSuccess=true}if(pointUpdateSuccess){await GASActions.update(ORDERS_SHEET,id,{point_processed:"Yes"});showAdminToast(`Status diperbarui & +${pointsToAdd} poin diberikan ke ${phone}`,"success")}else{showAdminToast("Status diperbarui, tapi gagal update poin.","warning")}}}else{showAdminToast("Status pesanan diperbarui!","success")}const orderIndex=allOrders.findIndex(o=>o.id===id);if(orderIndex!==-1){allOrders[orderIndex].status=newStatus;if(newStatus==="Terima")allOrders[orderIndex].point_processed="Yes";renderOrderTable();updateOrderStats()}}else{showAdminToast("Gagal memperbarui status di database.","error")}}catch(e){console.error(e);showAdminToast("Terjadi kesalahan saat memperbarui status.","error")}finally{selectElement.disabled=false}}async function fetchCategories(){try{const response=await fetch(`${API_URL}?sheet=${CATEGORIES_SHEET}`);allCategories=await response.json();renderCategoryTable();updateCategoryDropdown();const bundleSection=document.getElementById("section-bundle");if(bundleSection&&!bundleSection.classList.contains("hidden")){ensureBundleBuilderReady()}}catch(error){console.error(error)}}function renderCategoryTable(){const tbody=document.getElementById("category-list-body");if(allCategories.length===0){tbody.innerHTML='<tr><td colspan="3" class="px-6 py-10 text-center text-gray-500">Belum ada kategori.</td></tr>';return}tbody.innerHTML=allCategories.map(c=>{const safeName=escapeHtml(c.nama);const safeDesc=escapeHtml(c.deskripsi||"-");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 font-bold text-gray-800 text-sm" data-label="Nama Kategori">${safeName}</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Deskripsi">${safeDesc}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2" data-label="Aksi">\n                <button data-action="edit-category" data-id="${escapeAttr(c.id)}" data-name="${escapeAttr(c.nama)}" data-description="${escapeAttr(c.deskripsi||"")}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-category" data-id="${escapeAttr(c.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `}).join("");document.getElementById("category-count").innerText=`(${allCategories.length})`}function openEditCategory(id,nama,deskripsi){const newNama=prompt("Nama Kategori:",nama);if(newNama===null)return;const newDeskripsi=prompt("Deskripsi:",deskripsi);if(newDeskripsi===null)return;handleEditCategory(id,newNama,newDeskripsi)}async function handleEditCategory(id,nama,deskripsi){try{const result=await GASActions.update(CATEGORIES_SHEET,id,{nama:nama,deskripsi:deskripsi});if(result.affected>0){showAdminToast("Kategori berhasil diperbarui!","success");fetchCategories()}}catch(error){console.error(error);showAdminToast("Gagal memperbarui kategori.","error")}}async function handleDeleteCategory(id){if(!confirm("Apakah Anda yakin ingin menghapus kategori ini?"))return;try{const result=await GASActions.delete(CATEGORIES_SHEET,id);if(result.deleted>0){showAdminToast("Kategori berhasil dihapus!","success");fetchCategories()}}catch(error){console.error(error);showAdminToast("Gagal menghapus kategori.","error")}}function updateCategoryDropdown(){const select=document.getElementById("form-category");if(!select)return;const currentVal=select.value;select.innerHTML='<option value="">-- Pilih Kategori --</option>'+allCategories.map(c=>{const safeName=escapeHtml(c.nama);return`<option value="${safeName}">${safeName}</option>`}).join("");select.value=currentVal;updateBundleCategoryDropdown()}function updateBundleCategoryDropdown(){const select=document.getElementById("bundle-category");if(!select)return;const currentVal=select.value;select.innerHTML='<option value="">-- Pilih Kategori --</option>'+allCategories.map(c=>{const safeName=escapeHtml(c.nama);return`<option value="${safeName}">${safeName}</option>`}).join("");select.value=currentVal}function updatePurchaseProductDropdown(){const select=document.getElementById("form-purchase-product");if(!select)return;const currentVal=select.value;select.innerHTML='<option value="">-- Pilih Produk --</option>'+allProducts.map(p=>{const safeName=escapeHtml(p.nama);return`<option value="${escapeAttr(p.id)}">${safeName}</option>`}).join("");select.value=currentVal}function updateSupplierDatalist(){const list=document.getElementById("supplier-list");if(!list)return;list.innerHTML=allSuppliers.map(s=>{const safeName=escapeHtml(s.nama||s.name||"");return`<option value="${safeName}"></option>`}).join("")}function getPurchaseStats(productId){if(!productId)return{avgCost:0,lastCost:0,totalQty:0};const idStr=String(productId);const purchases=allPurchases.filter(p=>String(p.product_id||p.productId||p.id_produk||"")===idStr);let totalQty=0;let totalCost=0;let lastCost=0;let lastDate=new Date(0);purchases.forEach(p=>{const qty=parseFloat(p.qty||p.jumlah||p.quantity||0);const cost=parseCurrencyValue(p.harga_modal||p.modal||p.cost||p.harga||0);if(!Number.isFinite(qty)||qty<=0||!Number.isFinite(cost)||cost<=0)return;totalQty+=qty;totalCost+=qty*cost;const dt=parseOrderDate(p.tanggal||p.date||p.created_at||p.timestamp)||new Date(0);if(dt>lastDate){lastDate=dt;lastCost=cost}});const avgCost=totalQty>0?totalCost/totalQty:0;return{avgCost:avgCost,lastCost:lastCost,totalQty:totalQty}}async function fetchAdminProducts(){const tbody=document.getElementById("admin-product-list");tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data...</td></tr>';try{const[productsRes,purchasesRes,suppliersRes]=await Promise.all([fetch(`${API_URL}?sheet=${PRODUCTS_SHEET}`),fetch(`${API_URL}?sheet=${PURCHASES_SHEET}`),fetch(`${API_URL}?sheet=${SUPPLIERS_SHEET}`)]);allProducts=await productsRes.json();if(purchasesRes.ok){const purchasesData=await purchasesRes.json();allPurchases=Array.isArray(purchasesData)?purchasesData:[]}else{allPurchases=[]}if(suppliersRes.ok){const suppliersData=await suppliersRes.json();allSuppliers=Array.isArray(suppliersData)?suppliersData:[]}else{allSuppliers=[]}renderAdminTable();updatePurchaseProductDropdown();updateSupplierDatalist();refreshBundleItemOptions();if(document.getElementById("section-pembelian")&&!document.getElementById("section-pembelian").classList.contains("hidden")){renderPurchaseTable()}const bundleSection=document.getElementById("section-bundle");if(bundleSection&&!bundleSection.classList.contains("hidden")){ensureBundleBuilderReady()}updateDashboardStats()}catch(error){console.error(error)}}function renderAdminTable(){const tbody=document.getElementById("admin-product-list");if(allProducts.length===0){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada produk.</td></tr>';return}tbody.innerHTML=allProducts.map(p=>{const safeName=escapeHtml(p.nama);const safeCategory=escapeHtml(p.kategori||"-");const safeStock=escapeHtml(p.stok);const imageUrl=p.gambar?p.gambar.split(",")[0]:"https://via.placeholder.com/50";const safeImage=sanitizeUrl(imageUrl,"https://via.placeholder.com/50");const priceValue=parseCurrencyValue(p.harga);const costStats=getPurchaseStats(p.id);const avgCost=costStats.avgCost;const lastCost=costStats.lastCost;const marginValue=avgCost>0?priceValue-avgCost:0;const marginPercent=avgCost>0?marginValue/avgCost*100:0;const marginThreshold=CONFIG.getMarginAlertThreshold?CONFIG.getMarginAlertThreshold():10;const isLowMargin=avgCost>0&&marginPercent<marginThreshold;return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4" data-label="Produk">\n                <div class="flex items-center gap-3">\n                    <img src="${safeImage}" class="w-10 h-10 object-cover rounded-lg bg-gray-100" alt="${safeName}">\n                    <span class="font-bold text-gray-800 text-sm">${safeName}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4" data-label="Kategori">\n                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-md text-[10px] font-bold uppercase">${safeCategory}</span>\n            </td>\n            <td class="px-6 py-4" data-label="Harga">\n                <div class="flex flex-col">\n                    ${p.harga_coret?`<span class="text-[10px] text-gray-400 line-through">Rp ${parseInt(p.harga_coret).toLocaleString("id-ID")}</span>`:""}\n                    <span class="font-bold text-green-700 text-sm">Rp ${parseInt(p.harga).toLocaleString("id-ID")}</span>\n                    ${avgCost>0?`<span class="text-[10px] text-gray-500">Modal avg: Rp ${Math.round(avgCost).toLocaleString("id-ID")}</span>`:'<span class="text-[10px] text-gray-400">Modal avg: -</span>'}\n                    ${lastCost>0?`<span class="text-[10px] text-gray-500">Modal last: Rp ${Math.round(lastCost).toLocaleString("id-ID")}</span>`:'<span class="text-[10px] text-gray-400">Modal last: -</span>'}\n                    ${avgCost>0?`<span class="text-[10px] ${isLowMargin?"text-red-600 font-bold":"text-green-600"}">Margin: Rp ${Math.round(marginValue).toLocaleString("id-ID")} (${marginPercent.toFixed(1)}%)</span>`:""}\n                    ${isLowMargin?`<span class="text-[10px] text-red-500 font-bold">Margin Rendah</span>`:""}\n                </div>\n            </td>\n            <td class="px-6 py-4" data-label="Stok">\n                <span class="text-sm ${parseInt(p.stok)<=5?"text-red-600 font-bold":"text-gray-600"}">${safeStock}</span>\n            </td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2" data-label="Aksi">\n                <button data-action="edit-product" data-id="${escapeAttr(p.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-product" data-id="${escapeAttr(p.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `}).join("")}function openAddModal(){document.getElementById("modal-title").innerText="Tambah Produk";document.getElementById("product-id").value="";document.getElementById("product-form").reset();document.getElementById("variants-container").innerHTML="";document.getElementById("product-modal").classList.remove("hidden")}function openEditModal(id){const p=allProducts.find(prod=>prod.id==id);if(!p)return;document.getElementById("modal-title").innerText="Edit Produk";document.getElementById("product-id").value=p.id;document.getElementById("form-nama").value=p.nama;document.getElementById("form-harga").value=p.harga;document.getElementById("form-harga-coret").value=p.harga_coret||"";document.getElementById("form-stok").value=p.stok;document.getElementById("form-category").value=p.kategori||"";document.getElementById("form-deskripsi").value=p.deskripsi||"";const images=p.gambar?p.gambar.split(","):[];document.getElementById("form-gambar-1").value=images[0]||"";document.getElementById("form-gambar-2").value=images[1]||"";document.getElementById("form-gambar-3").value=images[2]||"";loadVariants(p.variasi);document.getElementById("product-modal").classList.remove("hidden")}function closeModal(){document.getElementById("product-modal").classList.add("hidden")}document.getElementById("product-form").addEventListener("submit",async e=>{e.preventDefault();const id=document.getElementById("product-id").value;const submitBtn=document.getElementById("submit-btn");const originalText=submitBtn.innerText;submitBtn.disabled=true;submitBtn.innerText="Menyimpan...";const images=[document.getElementById("form-gambar-1").value,document.getElementById("form-gambar-2").value,document.getElementById("form-gambar-3").value].filter(url=>url.trim()!=="").join(",");const variantsData=collectVariants();const variantsJson=variantsData.length>0?JSON.stringify(variantsData):"";const data={nama:document.getElementById("form-nama").value,harga:document.getElementById("form-harga").value,harga_coret:document.getElementById("form-harga-coret").value,stok:document.getElementById("form-stok").value,kategori:document.getElementById("form-category").value,deskripsi:document.getElementById("form-deskripsi").value,gambar:images,variasi:variantsJson};try{const action=id?"update":"create";const productId=id||Date.now().toString();let result;if(id){result=await GASActions.update(PRODUCTS_SHEET,productId,data)}else{result=await GASActions.create(PRODUCTS_SHEET,{...data,id:productId})}if(result.affected>0||result.created>0){showAdminToast(id?"Produk berhasil diperbarui!":"Produk berhasil ditambahkan!","success");closeModal();fetchAdminProducts()}}catch(error){console.error(error);showAdminToast("Terjadi kesalahan saat menyimpan data.","error")}finally{submitBtn.disabled=false;submitBtn.innerText=originalText}});async function handleDelete(id){if(!confirm("Apakah Anda yakin ingin menghapus produk ini?"))return;try{const result=await GASActions.delete(PRODUCTS_SHEET,id);if(result.deleted>0){showAdminToast("Produk berhasil dihapus!","success");fetchAdminProducts()}}catch(error){console.error(error);showAdminToast("Gagal menghapus produk.","error")}}async function fetchPurchases(){const tbody=document.getElementById("purchase-list-body");if(tbody){tbody.innerHTML='<tr><td colspan="7" class="px-6 py-10 text-center text-gray-500">Memuat data pembelian...</td></tr>'}try{const response=await fetch(`${API_URL}?sheet=${PURCHASES_SHEET}`);if(!response.ok)throw new Error(`HTTP ${response.status}`);const data=await response.json();allPurchases=Array.isArray(data)?data:[];renderPurchaseTable();renderAdminTable()}catch(error){console.error(error);if(tbody){tbody.innerHTML='<tr><td colspan="7" class="px-6 py-10 text-center text-red-500">Gagal memuat data pembelian. Pastikan sheet "pembelian" sudah ada dan GAS mengizinkan sheet tersebut.</td></tr>'}}}function renderPurchaseTable(){const tbody=document.getElementById("purchase-list-body");if(!tbody)return;if(!Array.isArray(allPurchases)||allPurchases.length===0){tbody.innerHTML='<tr><td colspan="7" class="px-6 py-10 text-center text-gray-500">Belum ada data pembelian.</td></tr>';return}const sorted=[...allPurchases].sort((a,b)=>{const dateA=parseOrderDate(a.tanggal||a.date||a.created_at||a.timestamp)||new Date(0);const dateB=parseOrderDate(b.tanggal||b.date||b.created_at||b.timestamp)||new Date(0);return dateB-dateA});tbody.innerHTML=sorted.map(p=>{const productId=p.product_id||p.productId||p.id_produk||"";const product=allProducts.find(prod=>String(prod.id)===String(productId));const productName=escapeHtml(p.product_nama||product&&product.nama||"-");const supplier=escapeHtml(p.supplier||"-");const qty=parseFloat(p.qty||p.jumlah||p.quantity||0);const cost=parseCurrencyValue(p.harga_modal||p.modal||p.cost||0);const total=qty*cost;const date=parseOrderDate(p.tanggal||p.date||p.created_at||p.timestamp);const dateLabel=date?date.toLocaleDateString("id-ID"):"-";return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(dateLabel)}</td>\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">${productName}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${supplier}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${Number.isFinite(qty)?qty:"-"}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">Rp ${Math.round(cost||0).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4 text-sm text-gray-700 font-bold">Rp ${Math.round(total||0).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4 text-right">\n                <button data-action="delete-purchase" data-id="${escapeAttr(p.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n        `}).join("")}async function handleDeletePurchase(id){if(!confirm("Hapus data pembelian ini?"))return;try{const result=await GASActions.delete(PURCHASES_SHEET,id);if(result.deleted>0){showAdminToast("Pembelian berhasil dihapus!","success");fetchPurchases()}}catch(error){console.error(error);showAdminToast("Gagal menghapus pembelian.","error")}}const purchaseForm=document.getElementById("purchase-form");if(purchaseForm){purchaseForm.addEventListener("submit",async e=>{e.preventDefault();const submitBtn=purchaseForm.querySelector('button[type="submit"]');const originalText=submitBtn.innerText;submitBtn.disabled=true;submitBtn.innerText="Menyimpan...";const productId=document.getElementById("form-purchase-product").value;const product=allProducts.find(p=>String(p.id)===String(productId));const data={id:Date.now().toString(),product_id:productId,product_nama:product?product.nama:"",supplier:document.getElementById("form-purchase-supplier").value,qty:document.getElementById("form-purchase-qty").value,harga_modal:document.getElementById("form-purchase-cost").value,tanggal:document.getElementById("form-purchase-date").value||(new Date).toISOString().slice(0,10)};try{const result=await GASActions.create(PURCHASES_SHEET,data);if(result.created>0){showAdminToast("Pembelian berhasil disimpan!","success");purchaseForm.reset();fetchPurchases()}}catch(error){console.error(error);const msg=String(error&&error.message?error.message:error);if(msg.includes("Invalid sheet")){showAdminToast('Sheet "pembelian" belum diizinkan di GAS. Tambahkan "pembelian" ke daftar sheet yang diizinkan.',"warning")}else{showAdminToast("Gagal menyimpan pembelian.","error")}}finally{submitBtn.disabled=false;submitBtn.innerText=originalText}})}document.getElementById("category-form").addEventListener("submit",async e=>{e.preventDefault();const nama=document.getElementById("form-category-nama").value;const deskripsi=document.getElementById("form-category-deskripsi").value;const submitBtn=e.target.querySelector('button[type="submit"]');const originalText=submitBtn.innerHTML;submitBtn.disabled=true;submitBtn.innerHTML="Menyimpan...";try{const result=await GASActions.create(CATEGORIES_SHEET,{id:Date.now().toString(),nama:nama,deskripsi:deskripsi});if(result.created>0){showAdminToast("Kategori berhasil ditambahkan!","success");e.target.reset();fetchCategories()}}catch(error){console.error(error);showAdminToast("Terjadi kesalahan saat menyimpan data.","error")}finally{submitBtn.disabled=false;submitBtn.innerHTML=originalText}});async function fetchTukarPoin(){const tbody=document.getElementById("tukar-poin-list");tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data tukar poin...</td></tr>';try{const response=await fetch(`${API_URL}?sheet=${TUKAR_POIN_SHEET}`);if(!response.ok)throw new Error(`HTTP ${response.status}`);allTukarPoin=await response.json();if(!Array.isArray(allTukarPoin))allTukarPoin=[];renderTukarPoinTable()}catch(error){console.error("Error:",error);tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat data tukar poin. Pastikan sheet "tukar_poin" sudah ada.</td></tr>'}}function renderTukarPoinTable(){const tbody=document.getElementById("tukar-poin-list");if(allTukarPoin.length===0){tbody.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada produk tukar poin.</td></tr>';return}tbody.innerHTML=allTukarPoin.map(p=>{const safeTitle=escapeHtml(p.judul||p.nama||"");const safeDesc=escapeHtml(p.deskripsi||"-");const safePoints=escapeHtml(p.poin);const safeImage=sanitizeUrl(p.gambar,"https://via.placeholder.com/50");return`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4" data-label="Produk">\n                <div class="flex items-center gap-3">\n                    <img src="${safeImage}" class="w-10 h-10 object-cover rounded-lg bg-gray-100" alt="${safeTitle}">\n                    <span class="font-bold text-gray-800 text-sm">${safeTitle}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4 font-bold text-amber-600 text-sm" data-label="Poin">${safePoints} Poin</td>\n            <td class="px-6 py-4 text-sm text-gray-600" data-label="Deskripsi">${safeDesc}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2" data-label="Aksi">\n                <button data-action="edit-tukar-poin" data-id="${escapeAttr(p.id)}" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Edit">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button data-action="delete-tukar-poin" data-id="${escapeAttr(p.id)}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Hapus">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `}).join("")}function openAddTukarPoinModal(){document.getElementById("tukar-poin-id").value="";document.getElementById("tukar-poin-form").reset();document.getElementById("tukar-poin-modal-title").innerText="Tambah Produk Tukar Poin";document.getElementById("tukar-poin-submit-btn").innerText="Simpan";document.getElementById("tukar-poin-modal").classList.remove("hidden")}function openEditTukarPoinModal(id){const product=allTukarPoin.find(p=>p.id===id);if(!product){showAdminToast("Produk tidak ditemukan!","error");return}document.getElementById("tukar-poin-id").value=product.id;document.getElementById("form-tukar-judul").value=product.judul||"";document.getElementById("form-tukar-poin").value=product.poin||"";document.getElementById("form-tukar-gambar").value=product.gambar||"";document.getElementById("form-tukar-deskripsi").value=product.deskripsi||"";document.getElementById("tukar-poin-modal-title").innerText="Edit Produk Tukar Poin";document.getElementById("tukar-poin-submit-btn").innerText="Perbarui";document.getElementById("tukar-poin-modal").classList.remove("hidden")}function closeTukarPoinModal(){document.getElementById("tukar-poin-modal").classList.add("hidden");document.getElementById("tukar-poin-form").reset()}async function handleDeleteTukarPoin(id){if(!confirm("Apakah Anda yakin ingin menghapus produk tukar poin ini?"))return;try{const result=await GASActions.delete(TUKAR_POIN_SHEET,id);if(result.deleted>0){showAdminToast("Produk tukar poin berhasil dihapus!","success");fetchTukarPoin()}else{showAdminToast("Gagal menghapus produk.","error")}}catch(e){console.error(e);showAdminToast("Gagal menghapus produk.","error")}}document.getElementById("tukar-poin-form").addEventListener("submit",async e=>{e.preventDefault();const id=document.getElementById("tukar-poin-id").value;const judul=document.getElementById("form-tukar-judul").value.trim();const poin=document.getElementById("form-tukar-poin").value.trim();const gambar=document.getElementById("form-tukar-gambar").value.trim();const deskripsi=document.getElementById("form-tukar-deskripsi").value.trim();if(!judul||!poin||!gambar){showAdminToast("Semua field yang ditandai wajib diisi!","error");return}const submitBtn=e.target.querySelector('button[type="submit"]');const originalText=submitBtn.innerHTML;submitBtn.disabled=true;submitBtn.innerHTML="Menyimpan...";try{const data={judul:judul,poin:parseInt(poin),gambar:gambar,deskripsi:deskripsi};const action=id?"update":"create";const productId=id||Date.now().toString();let result;if(id){result=await GASActions.update(TUKAR_POIN_SHEET,productId,data)}else{result=await GASActions.create(TUKAR_POIN_SHEET,{...data,id:productId})}if(result.created>0||result.affected>0){showAdminToast(id?"Produk tukar poin berhasil diperbarui!":"Produk tukar poin berhasil ditambahkan!","success");closeTukarPoinModal();fetchTukarPoin()}else{showAdminToast("Gagal menyimpan data.","error")}}catch(error){console.error(error);showAdminToast("Gagal menyimpan data.","error")}finally{submitBtn.disabled=false;submitBtn.innerHTML=originalText}});async function fetchUserPoints(){const tbody=document.getElementById("user-points-list");tbody.innerHTML='<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">Memuat data...</td></tr>';try{const response=await fetch(`${API_URL}?sheet=user_points`);const data=await response.json();if(data.length===0){tbody.innerHTML='<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">Belum ada data poin pengguna.</td></tr>';return}tbody.innerHTML=data.map(u=>{const safePhone=escapeHtml(u.phone);const safeUpdated=escapeHtml(u.last_updated||"-");return`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-6 py-4 font-bold text-gray-800 text-sm" data-label="Telepon">${safePhone}</td>\n                <td class="px-6 py-4 font-bold text-green-600 text-sm" data-label="Poin">${parseFloat(u.points).toFixed(1)} Poin</td>\n                <td class="px-6 py-4 text-xs text-gray-500" data-label="Terakhir Update">${safeUpdated}</td>\n                <td class="px-6 py-4 text-right" data-label="Aksi">\n                    <button data-action="edit-user-points" data-phone="${escapeAttr(u.phone)}" data-points="${escapeAttr(u.points)}" class="text-blue-600 hover:underline text-sm font-bold">Edit Poin</button>\n                </td>\n            </tr>\n        `}).join("")}catch(error){console.error(error)}}async function editUserPoints(phone,currentPoints){const newPoints=prompt(`Masukkan saldo poin baru untuk ${phone}:`,currentPoints);if(newPoints===null||newPoints==="")return;try{const searchRes=await fetch(`${API_URL}?sheet=user_points`);const allUsers=await searchRes.json();const user=allUsers.find(u=>u.phone===phone);if(!user||!user.id){showAdminToast("User tidak ditemukan!","error");return}const result=await GASActions.update("user_points",user.id,{points:parseFloat(newPoints),last_updated:(new Date).toLocaleString("id-ID")});if(result.affected>0){showAdminToast("Saldo poin diperbarui!","success");fetchUserPoints()}}catch(error){console.error(error);showAdminToast("Gagal memperbarui poin.","error")}}function loadSettings(){const config=CONFIG.getAllConfig();document.getElementById("settings-main-api").value=config.mainApi;document.getElementById("settings-admin-api").value=config.adminApi;document.getElementById("gajian-target-day").value=config.gajian.targetDay;document.getElementById("gajian-default-markup").value=config.gajian.defaultMarkup*100;renderGajianMarkups(config.gajian.markups);document.getElementById("reward-point-value").value=config.reward.pointValue;document.getElementById("reward-min-point").value=config.reward.minPoint;renderRewardOverrides(config.reward.manualOverrides);const marginEl=document.getElementById("margin-alert-threshold");if(marginEl)marginEl.value=config.marginAlert||CONFIG.getMarginAlertThreshold();if(config.bundleDiscount){const r34=document.getElementById("bundle-rule-34");const r56=document.getElementById("bundle-rule-56");const r7=document.getElementById("bundle-rule-7");if(r34)r34.value=config.bundleDiscount.rule34??5;if(r56)r56.value=config.bundleDiscount.rule56??8;if(r7)r7.value=config.bundleDiscount.rule7plus??10}}function renderGajianMarkups(markups){const tbody=document.getElementById("gajian-markups-table");tbody.innerHTML=markups.map((m,index)=>{const safeMinDays=escapeHtml(m.minDays);const safeRate=escapeHtml((m.rate*100).toFixed(1));return`\n        <tr class="border-b border-gray-50">\n            <td class="py-2 px-2">${safeMinDays} Hari</td>\n            <td class="py-2 px-2 font-bold text-green-600">${safeRate}%</td>\n            <td class="py-2 px-2">\n                <button data-action="edit-markup" data-index="${index}" class="text-blue-600 hover:underline">Edit</button>\n            </td>\n        </tr>\n    `}).join("")}function renderRewardOverrides(overrides){const tbody=document.getElementById("reward-overrides-table");tbody.innerHTML=Object.entries(overrides).map(([name,points])=>{const safeName=escapeHtml(name);const safePoints=escapeHtml(points);return`\n        <tr class="border-b border-gray-50">\n            <td class="py-2 px-2">${safeName}</td>\n            <td class="py-2 px-2 font-bold text-amber-600">${safePoints} Poin</td>\n            <td class="py-2 px-2">\n                <button data-action="delete-reward-override" data-name="${escapeAttr(name)}" class="text-red-600 hover:underline">Hapus</button>\n            </td>\n        </tr>\n    `}).join("")}async function saveSettings(){const mainApi=document.getElementById("settings-main-api").value.trim();const adminApi=document.getElementById("settings-admin-api").value.trim();if(!mainApi||!adminApi){showAdminToast("URL API tidak boleh kosong!","error");return}CONFIG.setMainApiUrl(mainApi);CONFIG.setAdminApiUrl(adminApi);API_URL=adminApi;if(typeof ApiService!=="undefined"){ApiService.clearCache();console.log("✅ Cache cleared after API URL change")}const targetDay=parseInt(document.getElementById("gajian-target-day").value);const defaultMarkup=parseFloat(document.getElementById("gajian-default-markup").value)/100;const currentGajian=CONFIG.getGajianConfig();CONFIG.setGajianConfig({...currentGajian,targetDay:targetDay,defaultMarkup:defaultMarkup});const pointValue=parseInt(document.getElementById("reward-point-value").value);const minPoint=parseFloat(document.getElementById("reward-min-point").value);const currentReward=CONFIG.getRewardConfig();CONFIG.setRewardConfig({...currentReward,pointValue:pointValue,minPoint:minPoint});const marginEl=document.getElementById("margin-alert-threshold");if(marginEl){CONFIG.setMarginAlertThreshold(parseFloat(marginEl.value))}const rule34=document.getElementById("bundle-rule-34");const rule56=document.getElementById("bundle-rule-56");const rule7=document.getElementById("bundle-rule-7");if(rule34&&rule56&&rule7&&CONFIG.setBundleDiscountConfig){CONFIG.setBundleDiscountConfig({rule34:parseFloat(rule34.value)||0,rule56:parseFloat(rule56.value)||0,rule7plus:parseFloat(rule7.value)||0})}window.dispatchEvent(new Event("api-config-changed"));console.log("🔔 [ADMIN] Dispatched api-config-changed event to all listeners");const successMsg=`✅ Pengaturan Berhasil Disimpan!\n\n📡 Main API: ${mainApi.substring(0,40)}...\n🔧 Admin API: ${adminApi.substring(0,40)}...\n🗑️ Cache cleared\n\n⏳ Reloading...`;alert(successMsg);showAdminToast("Pengaturan berhasil disimpan! Halaman akan reload...","success");setTimeout(()=>location.reload(),1500)}function openEditMarkupModal(index){const config=CONFIG.getGajianConfig();const markup=config.markups[index];if(!markup)return;document.getElementById("edit-markup-index").value=index;document.getElementById("edit-markup-min-days").value=markup.minDays;document.getElementById("edit-markup-rate").value=(markup.rate*100).toFixed(1);document.getElementById("edit-markup-modal").classList.remove("hidden")}function closeEditMarkupModal(){document.getElementById("edit-markup-modal").classList.add("hidden")}document.getElementById("edit-markup-form").addEventListener("submit",e=>{e.preventDefault();const index=parseInt(document.getElementById("edit-markup-index").value);const minDays=parseInt(document.getElementById("edit-markup-min-days").value);const rate=parseFloat(document.getElementById("edit-markup-rate").value)/100;const config=CONFIG.getGajianConfig();config.markups[index]={minDays:minDays,rate:rate};config.markups.sort((a,b)=>b.minDays-a.minDays);CONFIG.setGajianConfig(config);renderGajianMarkups(config.markups);closeEditMarkupModal();showAdminToast("Skema markup diperbarui!","success")});function openAddOverrideModal(){document.getElementById("override-modal-title").innerText="Tambah Override Poin";document.getElementById("reward-override-form").reset();const select=document.getElementById("override-product-name");select.innerHTML='<option value="">-- Pilih Produk --</option>'+allProducts.map(p=>{const safeName=escapeHtml(p.nama);return`<option value="${safeName}">${safeName}</option>`}).join("");document.getElementById("reward-override-modal").classList.remove("hidden")}function closeRewardOverrideModal(){document.getElementById("reward-override-modal").classList.add("hidden")}document.getElementById("reward-override-form").addEventListener("submit",e=>{e.preventDefault();const productName=document.getElementById("override-product-name").value;const points=parseFloat(document.getElementById("override-point-value").value);const config=CONFIG.getRewardConfig();config.manualOverrides[productName]=points;CONFIG.setRewardConfig(config);renderRewardOverrides(config.manualOverrides);closeRewardOverrideModal();showAdminToast("Override poin disimpan!","success")});function deleteRewardOverride(name){if(!confirm(`Hapus override untuk ${name}?`))return;const config=CONFIG.getRewardConfig();delete config.manualOverrides[name];CONFIG.setRewardConfig(config);renderRewardOverrides(config.manualOverrides);showAdminToast("Override poin dihapus!","success")}function showAdminToast(message,type="info"){let container=document.getElementById("admin-toast-container");if(!container){container=document.createElement("div");container.id="admin-toast-container";container.className="fixed bottom-8 right-8 z-[100] flex flex-col gap-3";document.body.appendChild(container)}const toast=document.createElement("div");const bgColors={success:"bg-green-600",error:"bg-red-600",warning:"bg-amber-500",info:"bg-blue-600"};toast.className=`${bgColors[type]||"bg-gray-800"} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in-right min-w-[300px]`;const icons={success:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',error:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',warning:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',info:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'};toast.dataset.toast="admin";toast.innerHTML=`\n        <div class="flex-shrink-0">${icons[type]||icons.info}</div>\n        <div class="flex-1 font-medium text-sm">${escapeHtml(message)}</div>\n        <button data-action="dismiss-admin-toast" class="flex-shrink-0 hover:bg-white/20 p-1 rounded-lg transition">\n            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>\n        </button>\n    `;container.appendChild(toast);setTimeout(()=>{if(toast.parentElement){toast.classList.add("animate-fade-out");setTimeout(()=>toast.remove(),500)}},4e3)}function bindAdminActions(){document.addEventListener("click",e=>{const trigger=e.target.closest("[data-action]");if(!trigger)return;const action=trigger.dataset.action;if(action==="show-section"){showSection(trigger.dataset.section);return}if(action==="logout"){logout();return}if(action==="open-add-modal"){openAddModal();return}if(action==="filter-orders"){filterOrders(trigger.dataset.filter||"semua",trigger);return}if(action==="order-page"){const page=parseInt(trigger.dataset.page,10);if(!Number.isNaN(page)){currentOrderPage=page;renderOrderTable()}return}if(action==="open-add-tukar-poin"){openAddTukarPoinModal();return}if(action==="open-add-banner"){if(typeof openAddBannerModal==="function"){openAddBannerModal()}return}if(action==="refresh-user-points"){fetchUserPoints();return}if(action==="open-add-override"){openAddOverrideModal();return}if(action==="test-main-api"){testMainApi();return}if(action==="test-admin-api"){testAdminApi();return}if(action==="view-cache-stats"){viewCacheStats();return}if(action==="clear-api-cache"){clearApiCache();return}if(action==="save-settings"){saveSettings();return}if(action==="close-edit-markup-modal"){closeEditMarkupModal();return}if(action==="close-reward-override-modal"){closeRewardOverrideModal();return}if(action==="close-tukar-poin-modal"){closeTukarPoinModal();return}if(action==="close-banner-modal"){if(typeof closeBannerModal==="function"){closeBannerModal()}return}if(action==="add-variant-row"){addVariantRow();return}if(action==="close-product-modal"){closeModal();return}if(action==="edit-category"){openEditCategory(trigger.dataset.id,trigger.dataset.name,trigger.dataset.description);return}if(action==="delete-category"){handleDeleteCategory(trigger.dataset.id);return}if(action==="edit-product"){openEditModal(trigger.dataset.id);return}if(action==="delete-product"){handleDelete(trigger.dataset.id);return}if(action==="edit-tukar-poin"){openEditTukarPoinModal(trigger.dataset.id);return}if(action==="delete-tukar-poin"){handleDeleteTukarPoin(trigger.dataset.id);return}if(action==="delete-purchase"){handleDeletePurchase(trigger.dataset.id);return}if(action==="edit-supplier"){openEditSupplier(trigger.dataset.id);return}if(action==="delete-supplier"){handleDeleteSupplier(trigger.dataset.id);return}if(action==="reset-supplier-form"){resetSupplierForm();return}if(action==="edit-cost"){openEditMonthlyCost(trigger.dataset.id);return}if(action==="delete-cost"){handleDeleteMonthlyCost(trigger.dataset.id);return}if(action==="reset-cost-form"){resetMonthlyCostForm();return}if(action==="add-bundle-item"){addBundleItemRow();updateBundleTotals();return}if(action==="remove-bundle-item"){removeBundleItemRow(trigger);return}if(action==="apply-bundle-recommendation"){applyBundleRecommendation();return}if(action==="edit-user-points"){editUserPoints(trigger.dataset.phone,trigger.dataset.points);return}if(action==="edit-markup"){const index=parseInt(trigger.dataset.index,10);if(!Number.isNaN(index)){openEditMarkupModal(index)}return}if(action==="delete-reward-override"){deleteRewardOverride(trigger.dataset.name);return}if(action==="dismiss-admin-toast"){const toast=trigger.closest('[data-toast="admin"]');if(toast)toast.remove();return}if(action==="remove-variant-row"){removeVariantRow(trigger);return}});document.addEventListener("change",e=>{const trigger=e.target.closest("[data-action]");if(!trigger)return;const action=trigger.dataset.action;if(action==="toggle-store-status"){toggleStoreStatus();return}if(action==="update-order-status"){const id=trigger.dataset.id;updateOrderStatus(id,trigger.value,trigger)}});document.addEventListener("input",e=>{const trigger=e.target.closest('[data-action="preview-variant-image"]');if(trigger){previewVariantImage(trigger);return}if(e.target.classList.contains("bundle-item-product")||e.target.classList.contains("bundle-item-qty")||e.target.id==="bundle-discount"){const discountEl=document.getElementById("bundle-discount");if(discountEl&&e.target.id==="bundle-discount"){discountEl.dataset.auto="false"}updateBundleTotals()}if(e.target.id==="bundle-description"){e.target.dataset.touched="true"}})}function bindAdminImageFallbackHandler(){if(window.__adminImageFallbackHandlerAdded)return;window.__adminImageFallbackHandlerAdded=true;document.addEventListener("error",event=>{const target=event.target;if(!target||target.tagName!=="IMG")return;const fallback=target.getAttribute("data-fallback-src");const action=target.getAttribute("data-fallback-action");if(fallback&&target.src!==fallback){target.src=fallback;return}if(action==="hide"){target.style.display="none"}},true)}document.addEventListener("DOMContentLoaded",()=>{showSection("dashboard");bindAdminActions();bindAdminImageFallbackHandler()});function loadVariants(variantsJson){const container=document.getElementById("variants-container");container.innerHTML="";if(!variantsJson)return;try{const variants=JSON.parse(variantsJson);if(Array.isArray(variants)&&variants.length>0){variants.forEach((variant,index)=>{renderVariantRow(variant,index)})}}catch(e){console.error("Error parsing variants:",e)}}function renderVariantRow(variant,index){const container=document.getElementById("variants-container");const row=document.createElement("div");row.className="bg-white p-4 rounded-lg border border-gray-200 variant-row";row.dataset.index=index;const hargaCoret=variant.harga_coret||"";const gambar=variant.gambar||"";const grosir=variant.grosir||"";const safeSku=escapeAttr(variant.sku||"");const safeNama=escapeAttr(variant.nama||"");const safeHarga=escapeAttr(variant.harga||"");const safeHargaCoret=escapeAttr(hargaCoret);const safeStok=escapeAttr(variant.stok||"");const safeGrosir=escapeHtml(grosir);const safeImage=sanitizeUrl(gambar,"");row.innerHTML=`\n        <div class="grid grid-cols-2 gap-3 mb-3">\n            <div>\n                <label class="text-xs font-bold text-gray-600">SKU</label>\n                <input type="text" class="variant-sku w-full p-2 border rounded text-sm" value="${safeSku}" placeholder="MG-1L" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Nama Varian</label>\n                <input type="text" class="variant-nama w-full p-2 border rounded text-sm" value="${safeNama}" placeholder="1 Liter" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Harga (Rp)</label>\n                <input type="number" class="variant-harga w-full p-2 border rounded text-sm" value="${safeHarga}" placeholder="15000" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Harga Coret (Rp)</label>\n                <input type="number" class="variant-harga-coret w-full p-2 border rounded text-sm" value="${safeHargaCoret}" placeholder="16000">\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Stok</label>\n                <input type="number" class="variant-stok w-full p-2 border rounded text-sm" value="${safeStok}" placeholder="10" required>\n            </div>\n            <div class="col-span-2">\n                <label class="text-xs font-bold text-gray-600">URL Gambar Varian (Opsional)</label>\n                <input type="text" class="variant-gambar w-full p-2 border rounded text-sm mb-2" value="${escapeAttr(gambar)}" placeholder="https://example.com/variant-image.jpg" data-action="preview-variant-image">\n                <p class="text-[10px] text-gray-500 mb-2">Jika diisi, gambar ini akan tampil saat varian dipilih. Jika kosong, akan gunakan gambar produk utama.</p>\n                ${safeImage?`<img src="${safeImage}" class="variant-image-preview w-24 h-24 object-cover rounded border" data-fallback-src="https://placehold.co/96x96?text=Img" data-fallback-action="hide">`:""}\n            </div>\n        </div>\n        <div class="mb-3">\n            <label class="text-xs font-bold text-gray-600">Harga Grosir (JSON)</label>\n            <textarea class="variant-grosir w-full p-2 border rounded text-xs" rows="2" placeholder='[{"min_qty":5,"price":14000}]'>${escapeHtml(grosir)}</textarea>\n        </div>\n        <div class="flex justify-end">\n            <button type="button" data-action="remove-variant-row" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm font-bold transition">\n                Hapus Varian\n            </button>\n        </div>\n    `;container.appendChild(row)}function addVariantRow(){const container=document.getElementById("variants-container");const index=container.children.length;renderVariantRow({},index)}function removeVariantRow(button){button.closest(".variant-row").remove()}function collectVariants(){const rows=document.querySelectorAll(".variant-row");const variants=[];rows.forEach(row=>{const sku=row.querySelector(".variant-sku").value.trim();const nama=row.querySelector(".variant-nama").value.trim();const harga=row.querySelector(".variant-harga").value.trim();const hargaCoret=row.querySelector(".variant-harga-coret").value.trim();const stok=row.querySelector(".variant-stok").value.trim();const gambar=row.querySelector(".variant-gambar").value.trim();const grosir=row.querySelector(".variant-grosir").value.trim();if(sku&&nama&&harga&&stok){const variant={sku:sku,nama:nama,harga:parseInt(harga),stok:parseInt(stok)};if(hargaCoret)variant.harga_coret=parseInt(hargaCoret);if(gambar)variant.gambar=gambar;if(grosir)variant.grosir=grosir;variants.push(variant)}});return variants}function previewVariantImage(input){const url=input.value.trim();const row=input.closest(".variant-row");const existingPreview=row.querySelector(".variant-image-preview");if(existingPreview){existingPreview.remove()}if(url){const safeUrl=sanitizeUrl(url,"");if(!safeUrl){showAdminToast("URL gambar tidak valid.","warning");return}const preview=document.createElement("img");preview.src=safeUrl;preview.className="variant-image-preview w-24 h-24 object-cover rounded border mt-2";preview.onerror=function(){this.style.display="none";showToast("Gagal memuat gambar. Periksa URL gambar.","error")};input.parentElement.appendChild(preview)}}function updateCacheCount(){if(typeof ApiService!=="undefined"){const stats=ApiService.getCacheStats();const countEl=document.getElementById("cache-count");if(countEl){countEl.textContent=stats.totalEntries}}}function clearApiCache(){if(typeof ApiService==="undefined"){alert("ApiService tidak tersedia.");return}if(!confirm("Hapus semua cache API? Data akan di-fetch ulang dari server.")){return}const cleared=ApiService.clearCache();alert(`✅ Cache berhasil dihapus!\n\n${cleared} entries dihapus.`);updateCacheCount()}function viewCacheStats(){if(typeof ApiService==="undefined"){alert("ApiService tidak tersedia.");return}const stats=ApiService.getCacheStats();let message=`📊 STATISTIK CACHE API\n\n`;message+=`Total Entries: ${stats.totalEntries}\n`;message+=`Pending Requests: ${stats.pendingRequests}\n\n`;if(stats.entries.length>0){message+=`DETAIL CACHE:\n`;message+=`${"=".repeat(40)}\n\n`;stats.entries.forEach((entry,idx)=>{const endpoint=entry.key.split(":")[1]?.split("?")[1]||"unknown";message+=`${idx+1}. ${endpoint}\n`;message+=`   Age: ${entry.age}s\n`;message+=`   Size: ${(entry.size/1024).toFixed(2)} KB\n\n`})}else{message+=`Tidak ada cache tersimpan.`}alert(message)}document.addEventListener("DOMContentLoaded",()=>{setInterval(updateCacheCount,5e3);updateCacheCount()});async function testMainApi(){const apiUrl=document.getElementById("settings-main-api").value.trim();const statusEl=document.getElementById("main-api-status");if(!apiUrl){showApiStatus(statusEl,"error","❌ API URL tidak boleh kosong!");return}if(!apiUrl.startsWith("http://")&&!apiUrl.startsWith("https://")){showApiStatus(statusEl,"error","❌ API URL harus dimulai dengan http:// atau https://");return}showApiStatus(statusEl,"loading","⏳ Testing API...");try{const testUrl=`${apiUrl}?sheet=products`;const response=await fetch(testUrl);if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}const data=await response.json();if(!Array.isArray(data)){throw new Error('Response bukan array. Pastikan sheet "products" ada di spreadsheet.')}showApiStatus(statusEl,"success",`✅ API Valid! Ditemukan ${data.length} produk.`)}catch(error){console.error("API Test Error:",error);showApiStatus(statusEl,"error",`❌ API Error: ${error.message}`)}}async function testAdminApi(){const apiUrl=document.getElementById("settings-admin-api").value.trim();const statusEl=document.getElementById("admin-api-status");if(!apiUrl){showApiStatus(statusEl,"error","❌ API URL tidak boleh kosong!");return}if(!apiUrl.startsWith("http://")&&!apiUrl.startsWith("https://")){showApiStatus(statusEl,"error","❌ API URL harus dimulai dengan http:// atau https://");return}showApiStatus(statusEl,"loading","⏳ Testing API...");try{const testUrl=`${apiUrl}?sheet=products`;const response=await fetch(testUrl);if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}const data=await response.json();if(!Array.isArray(data)){throw new Error('Response bukan array. Pastikan sheet "products" ada di spreadsheet.')}showApiStatus(statusEl,"success",`✅ API Valid! Ditemukan ${data.length} produk.`)}catch(error){console.error("API Test Error:",error);showApiStatus(statusEl,"error",`❌ API Error: ${error.message}`)}}function showApiStatus(element,type,message){element.classList.remove("hidden","bg-green-100","text-green-700","bg-red-100","text-red-700","bg-yellow-100","text-yellow-700");if(type==="success"){element.classList.add("bg-green-100","text-green-700")}else if(type==="error"){element.classList.add("bg-red-100","text-red-700")}else if(type==="loading"){element.classList.add("bg-yellow-100","text-yellow-700")}element.textContent=message}