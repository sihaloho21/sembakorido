let tieredPricingProducts=[],currentEditingProductId=null;async function fetchTieredPricingProducts(){const t=document.getElementById("tiered-pricing-list");if(t){t.innerHTML='<div class="text-center py-10 text-gray-500">Memuat data produk...</div>';try{const t=await fetch(`${API_URL}?sheet=${PRODUCTS_SHEET}`);tieredPricingProducts=await t.json(),renderTieredPricingList()}catch(e){console.error("Error fetching products:",e),t.innerHTML='<div class="text-center py-10 text-red-500">Gagal memuat data produk.</div>'}}}function renderTieredPricingList(){const t=document.getElementById("tiered-pricing-list");t&&(0!==tieredPricingProducts.length?t.innerHTML=tieredPricingProducts.map(t=>{const e=parseGrosirData(t.grosir),r=e&&e.length>0;return`\n            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">\n                <div class="flex items-start justify-between">\n                    <div class="flex-1">\n                        <div class="flex items-center gap-3 mb-3">\n                            <img src="${t.gambar?t.gambar.split(",")[0]:"https://via.placeholder.com/50"}" \n                                 class="w-12 h-12 object-cover rounded-lg bg-gray-100">\n                            <div>\n                                <h4 class="font-bold text-gray-800">${t.nama}</h4>\n                                <p class="text-xs text-gray-500">Harga Satuan: Rp ${parseInt(t.harga).toLocaleString("id-ID")}</p>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="flex items-center gap-3">\n                        <label class="relative inline-flex items-center cursor-pointer">\n                            <input type="checkbox" \n                                   ${r?"checked":""} \n                                   onchange="toggleTieredPricing('${t.id}')" \n                                   class="sr-only peer">\n                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>\n                        </label>\n                        <span class="text-xs font-bold ${r?"text-green-600":"text-gray-500"}">\n                            ${r?"Aktif":"Nonaktif"}\n                        </span>\n                    </div>\n                </div>\n                \n                ${r?`\n                    <div class="mt-6 pt-6 border-t border-gray-100">\n                        <div id="tiered-form-${t.id}" class="space-y-4">\n                            <h5 class="font-bold text-gray-800 text-sm mb-4">Tingkatan Harga Grosir</h5>\n                            \n                            <div id="tiers-container-${t.id}" class="space-y-3">\n                                ${e.map((e,r)=>renderTierInput(t.id,e,r)).join("")}\n                            </div>\n                            \n                            <button type="button" \n                                    onclick="addTierInput('${t.id}')" \n                                    class="w-full mt-4 py-2 px-4 border-2 border-dashed border-green-300 text-green-600 rounded-lg font-bold hover:bg-green-50 transition text-sm">\n                                + Tambah Tingkatan\n                            </button>\n                            \n                            <div class="flex gap-3 pt-4">\n                                <button type="button" \n                                        onclick="saveTieredPricing('${t.id}')" \n                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition">\n                                    Simpan\n                                </button>\n                                <button type="button" \n                                        onclick="cancelTieredPricing('${t.id}')" \n                                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 rounded-lg transition">\n                                    Batal\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `:""}\n            </div>\n        `}).join(""):t.innerHTML='<div class="text-center py-10 text-gray-500">Belum ada produk.</div>')}function renderTierInput(t,e,r){return`\n        <div class="flex gap-3 items-end">\n            <div class="flex-1">\n                <label class="block text-xs font-bold text-gray-600 mb-1">Min. Qty</label>\n                <input type="number" \n                       class="w-full p-2 border border-gray-300 rounded-lg outline-none focus:border-green-500 text-sm" \n                       value="${e.min_qty}" \n                       data-tier-min-qty="${r}"\n                       data-product-id="${t}"\n                       min="1">\n            </div>\n            <div class="flex-1">\n                <label class="block text-xs font-bold text-gray-600 mb-1">Harga per Unit (Rp)</label>\n                <input type="number" \n                       class="w-full p-2 border border-gray-300 rounded-lg outline-none focus:border-green-500 text-sm" \n                       value="${e.price}" \n                       data-tier-price="${r}"\n                       data-product-id="${t}"\n                       min="0">\n            </div>\n            <button type="button" \n                    onclick="removeTierInput('${t}', ${r})" \n                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>\n                </svg>\n            </button>\n        </div>\n    `}function parseGrosirData(t){if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e.sort((t,e)=>e.min_qty-t.min_qty):[]}catch(t){return console.error("Error parsing grosir data:",t),[]}}async function toggleTieredPricing(t){const e=tieredPricingProducts.find(e=>e.id===t);if(!e)return;const r=parseGrosirData(e.grosir),n=r&&r.length>0;try{if(n)await updateProductGrosir(t,[]),showAdminToast("Harga grosir dinonaktifkan","success");else{const r=[{min_qty:5,price:.95*parseInt(e.harga)}];await updateProductGrosir(t,r),showAdminToast("Harga grosir diaktifkan","success")}fetchTieredPricingProducts()}catch(t){console.error("Error toggling tiered pricing:",t),showAdminToast("Gagal mengubah status harga grosir","error")}}function addTierInput(t){const e=document.getElementById(`tiers-container-${t}`),r=e.querySelectorAll("[data-tier-min-qty]"),n=r.length,i=r[r.length-1],a=i?parseInt(i.value):5,o=e.querySelector(`[data-tier-price="${r.length-1}"]`),s=o?parseInt(o.value):0,d=renderTierInput(t,{min_qty:a+5,price:Math.max(0,s-100)},n),c=document.createElement("div");c.innerHTML=d,e.appendChild(c.firstElementChild)}function removeTierInput(t,e){const r=document.querySelectorAll(`[data-product-id="${t}"][data-tier-min-qty]`);if(r.length<=1)return void showAdminToast("Minimal harus ada satu tingkatan harga","warning");const n=Array.from(r).find(t=>t.getAttribute("data-tier-min-qty")===e.toString());n&&n.parentElement.parentElement.remove()}async function saveTieredPricing(t){if(!tieredPricingProducts.find(e=>e.id===t))return;const e=document.querySelectorAll(`[data-product-id="${t}"][data-tier-min-qty]`),r=document.querySelectorAll(`[data-product-id="${t}"][data-tier-price]`);if(0===e.length)return void showAdminToast("Tidak ada tingkatan harga untuk disimpan","warning");const n=[];if(e.forEach((t,e)=>{const i=parseInt(t.value),a=parseInt(r[e].value);if(isNaN(i)||isNaN(a)||i<1||a<0)throw new Error("Input tidak valid");n.push({min_qty:i,price:a})}),validateTiers(n))try{n.sort((t,e)=>e.min_qty-t.min_qty),await updateProductGrosir(t,n),showAdminToast("Harga grosir berhasil disimpan!","success"),fetchTieredPricingProducts()}catch(t){console.error("Error saving tiered pricing:",t),showAdminToast("Gagal menyimpan harga grosir","error")}else showAdminToast("Tingkatan harga tidak valid. Pastikan min_qty naik dan harga turun","error")}function validateTiers(t){if(t.length<=1)return!0;const e=[...t].sort((t,e)=>t.min_qty-e.min_qty);for(let t=0;t<e.length-1;t++){if(e[t].min_qty>=e[t+1].min_qty)return!1;if(e[t].price<=e[t+1].price)return!1}return!0}function cancelTieredPricing(t){fetchTieredPricingProducts()}async function updateProductGrosir(t,e){const r=JSON.stringify(e);try{const e=await fetch(`${API_URL}/id/${t}?sheet=${PRODUCTS_SHEET}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:{grosir:r}})}),n=await e.json();if(!e.ok)throw new Error(n.message||"Failed to update product");return n}catch(t){throw console.error("Error updating product grosir:",t),t}}function calculateTieredPrice(t,e,r){if(!r||0===r.length)return t;const n=[...r].sort((t,e)=>e.min_qty-t.min_qty);let i=t;for(const t of n)if(e>=t.min_qty){i=t.price;break}return i}function showAdminToast(t,e="info"){const r=document.getElementById("admin-toast"),n=document.getElementById("admin-toast-content");if(!r||!n)return;const i={success:"bg-green-600",error:"bg-red-600",warning:"bg-yellow-500",info:"bg-blue-600"};r.className=`fixed bottom-5 right-5 ${i[e]||i.info} text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300 transform translate-y-0 opacity-100 z-50`,n.textContent=t,setTimeout(()=>{r.classList.add("translate-y-20","opacity-0")},3e3)}