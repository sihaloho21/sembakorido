const ADMIN_SESSION_KEY="sembako_admin_session_v1",ADMIN_SESSION_TTL_MS=432e5,TOKEN_STORAGE_KEYS=["sembako_admin_write_token","sembako_admin_api_token","sembako_admin_token"],ROLE_STORAGE_KEYS=["sembako_admin_role","admin_role"];function readStorageValue(e){for(let t=0;t<e.length;t+=1){const n=e[t],a=String(sessionStorage.getItem(n)||"").trim();if(a)return a;const i=String(localStorage.getItem(n)||"").trim();if(i)return i}return""}function normalizeRole(e){const t=String(e||"").trim().toLowerCase();return"superadmin"===t||"manager"===t||"operator"===t||"viewer"===t?t:"superadmin"}function clearLegacyAdminFlags(){localStorage.removeItem("admin_logged_in")}function persistAdminSession(e,t){const n=Date.now(),a={role:t,issued_at:n,expires_at:n+432e5};sessionStorage.setItem(ADMIN_SESSION_KEY,JSON.stringify(a)),sessionStorage.setItem("sembako_admin_write_token",e),sessionStorage.setItem("sembako_admin_api_token",e),sessionStorage.setItem("sembako_admin_role",t),localStorage.setItem("sembako_admin_role",t),clearLegacyAdminFlags()}function hasValidSession(){const e=String(sessionStorage.getItem(ADMIN_SESSION_KEY)||"").trim();if(!e)return!1;try{const t=JSON.parse(e);return!(Number(t.expires_at||0)<=Date.now())&&Boolean(readStorageValue(TOKEN_STORAGE_KEYS))}catch(e){return!1}}function resolveAdminApiUrl(){return"undefined"!=typeof CONFIG&&"function"==typeof CONFIG.getAdminApiUrl?CONFIG.getAdminApiUrl():""}async function verifyAdminToken(e){const t=resolveAdminApiUrl();if(!t)return{ok:!1,message:"API admin belum dikonfigurasi."};const n="superadmin",a={action:"admin_ping",sheet:"settings",token:e,admin_token:e,role:n,admin_role:n,data:{}},i=new FormData;let o;i.append("json",JSON.stringify(a)),i.append("token",e),i.append("admin_token",e),i.append("role",n),i.append("admin_role",n);try{o=await fetch(t,{method:"POST",body:i})}catch(e){return{ok:!1,message:"Gagal terhubung ke API admin."}}let s={};try{s=await o.json()}catch(e){s={}}const r=String(s.error||"").trim();return o.ok?"ADMIN_TOKEN_NOT_CONFIGURED"===r?{ok:!1,message:"ADMIN_TOKEN di GAS belum dikonfigurasi."}:"Unauthorized"===r?{ok:!1,message:"ADMIN_TOKEN tidak valid."}:r&&"Invalid action"!==r?{ok:!1,message:String(s.message||r||"Verifikasi token gagal.")}:{ok:!0}:{ok:!1,message:`HTTP ${o.status}: ${r||"Gagal verifikasi token."}`}}hasValidSession()&&(window.location.href="/admin/index.html"),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("admin-token"),t=document.getElementById("admin-role"),n=document.getElementById("error-message"),a=document.getElementById("login-button"),i=document.getElementById("login-form");if(!(i&&e&&t&&n&&a))return;const o=readStorageValue(TOKEN_STORAGE_KEYS),s=normalizeRole(readStorageValue(ROLE_STORAGE_KEYS)||t.value);o&&(e.value=o),t.value=s,i.addEventListener("submit",async i=>{i.preventDefault(),n.classList.add("hidden");const o=String(e.value||"").trim(),s=normalizeRole(t.value);if(!o)return n.textContent="ADMIN_TOKEN wajib diisi.",void n.classList.remove("hidden");a.disabled=!0,a.textContent="Memverifikasi...";try{const e=await verifyAdminToken(o);if(!e.ok)return n.textContent=e.message||"Token tidak valid atau akses ditolak.",void n.classList.remove("hidden");persistAdminSession(o,s),window.location.href="/admin/index.html"}finally{a.disabled=!1,a.textContent="Masuk"}})});